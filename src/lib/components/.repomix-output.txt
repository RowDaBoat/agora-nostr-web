This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where empty lines have been removed.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*, .cursorrules, .cursor/rules/*, .clinerules, CLAUDE.md
- Files matching these patterns are excluded: .*.*, **/*.pbxproj, **/node_modules/**, **/dist/**, **/build/**, **/compile/**, **/*.spec.*, **/*.pyc, **/.env, **/.env.*, **/*.env, **/*.env.*, **/*.lock, **/*.lockb, **/package-lock.*, **/pnpm-lock.*, **/*.tsbuildinfo, **/certdata.txt
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Empty lines have been removed from all files
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
agora/
  IntroductionCard.svelte
  InviterLeaderboard.svelte
  NewMemberCard.svelte
  TopInvitersPodium.svelte
backup/
  PassphraseInput.svelte
  QuorumSelector.svelte
  SecurePasswordField.svelte
  TrusteeSelector.svelte
  WarningBanner.svelte
headers/
  FeedHeader.svelte
  PageHeader.svelte
invite/
  CreateInviteModal.svelte
marketplace/
  SellerSidebar.svelte
messages/
  ConversationList.svelte
  ConversationListItem.svelte
  ConversationThread.svelte
  MessageComposer.svelte
  NewMessageModal.svelte
notifications/
  ActorList.svelte
  InviteAcceptanceNotification.svelte
  MentionNotification.svelte
  NotificationBase.svelte
  NotificationItem.svelte
  QuoteNotification.svelte
  ReactionNotification.svelte
  ReplyNotification.svelte
  RepostNotification.svelte
  ZapNotification.svelte
onboarding/
  PictureUpload.svelte
settings/
  BlossomSettings.svelte
  DebugSettings.svelte
  DMRelaySettings.svelte
  HashtagSettings.svelte
  KeyManagementSettings.svelte
  ProfileSettings.svelte
  RelayDetailsComponent.svelte
  RelaySettings.svelte
  ThemeSettings.svelte
  WalletSettings.svelte
  ZapSettings.svelte
trades/
  CreateOrderModal.svelte
  OrderBook.svelte
  OrderCard.svelte
  TakeOrderModal.svelte
  TradeFilters.svelte
ui/
  button/
    button.svelte
    index.ts
  card/
    card-action.svelte
    card-content.svelte
    card-description.svelte
    card-footer.svelte
    card-header.svelte
    card-title.svelte
    card.svelte
    index.ts
  dialog/
    dialog-close.svelte
    dialog-content.svelte
    dialog-description.svelte
    dialog-footer.svelte
    dialog-header.svelte
    dialog-overlay.svelte
    dialog-title.svelte
    dialog-trigger.svelte
    dialog.svelte
    index.ts
  drawer/
    drawer-close.svelte
    drawer-content.svelte
    drawer-description.svelte
    drawer-footer.svelte
    drawer-header.svelte
    drawer-nested.svelte
    drawer-overlay.svelte
    drawer-title.svelte
    drawer-trigger.svelte
    drawer.svelte
    index.ts
  input/
    index.ts
    input.svelte
  label/
    index.ts
    label.svelte
  responsive-dialog/
    index.ts
    ResponsiveDialog.svelte
  select/
    index.ts
    select-content.svelte
    select-group-heading.svelte
    select-group.svelte
    select-item.svelte
    select-label.svelte
    select-scroll-down-button.svelte
    select-scroll-up-button.svelte
    select-separator.svelte
    select-trigger.svelte
  separator/
    index.ts
    separator.svelte
  switch/
    index.ts
    switch.svelte
  textarea/
    index.ts
    textarea.svelte
  tooltip/
    index.ts
    tooltip-content.svelte
    tooltip-trigger.svelte
    tooltip.svelte
UserSelector/
  SelectedUserBadge.svelte
  UserListItem.svelte
  UserSelectorDropdown.svelte
wallet/
  BalanceCard.svelte
  DepositModal.svelte
  InvoiceDetails.svelte
  MintBrowser.svelte
  MintManager.svelte
  NutzapMonitor.svelte
  QRCode.svelte
  QRScanner.svelte
  ReceiveTokenModal.svelte
  ReceiveView.svelte
  SendModal.svelte
  SendView.svelte
  TransactionList.svelte
  WalletWidget.svelte
ArticleContent.svelte
ArticleHeader.svelte
ArticleList.svelte
ArticlePreviewCard.svelte
CommentCard.svelte
CommentForm.svelte
CommentList.svelte
CommentSection.svelte
ComposeDialog.svelte
ContentComposer.svelte
CreateFollowPackDialog.svelte
CreateListingModal.svelte
CreateMediaPostModal.svelte
EmbeddedNote.svelte
EventActions.svelte
EventCardHeader.svelte
EventOptionsMenu.svelte
FeaturedArticleCard.svelte
FollowButton.svelte
FollowPackMemberItem.svelte
Hashtag.svelte
HashtagHoverCard.svelte
HashtagSelector.svelte
HighlightCard.svelte
HighlightList.svelte
InvitedByBadge.svelte
JournalistsSidebar.svelte
Layout.svelte
LoadMoreTrigger.svelte
LoginButton.svelte
LoginModal.svelte
MarketplaceSidebar.svelte
MediaGrid.svelte
MediaTypeFilters.svelte
MediaViewerModal.svelte
Mention.svelte
MentionPicker.svelte
MentionPickerItem.svelte
MissingEventCard.svelte
MissingEventModal.svelte
MobileBottomNav.svelte
MobileComposeFAB.svelte
NewMembersWidget.svelte
NoteCard.svelte
PackCard.svelte
ProfileHeader.svelte
PWAInstallPrompt.svelte
RelayAuthModal.svelte
RelayBadge.svelte
RelayIcon.svelte
RelayPublishDropdownContent.svelte
RelayPublishSelector.svelte
RelaySelector.svelte
ReplyIndicator.svelte
ReportModal.svelte
SelectedPackMemberItem.svelte
ShareProfileModal.svelte
SplashScreen.svelte
TextHighlightToolbar.svelte
TikTokVideoFeed.svelte
TimeAgo.svelte
Toaster.svelte
User.svelte
UserCard.svelte
UserDropdown.svelte
UserHoverCard.svelte
UserMenu.svelte
UserSelectableItem.svelte
UserSelector.svelte
ZapAmountModal.svelte
ZapButton.svelte
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="agora/IntroductionCard.svelte">
<script lang="ts">
	import { ndk } from '$lib/ndk.svelte';
	import { formatTimeAgo } from '$lib/utils/formatTime';
	import { Avatar } from '@nostr-dev-kit/svelte';
	import type { NDKEvent, NDKUserProfile } from '@nostr-dev-kit/ndk';
	interface Props {
		event: NDKEvent;
		invitedBy: string | undefined;
	}
	const { event, invitedBy }: Props = $props();
	let profile = $state<NDKUserProfile | null>(null);
	let inviterProfile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		event.author.fetchProfile().then(p => { profile = p; });
	});
	$effect(() => {
		if (!invitedBy) {
			inviterProfile = null;
			return;
		}
		ndk.fetchUser(invitedBy).then(u => {
			u?.fetchProfile().then(p => { inviterProfile = p; });
		});
	});
</script>
<div class="border border-border rounded-lg p-4 hover:border-primary/50 transition-colors">
	<!-- Author Header -->
	<div class="flex items-center gap-3 mb-3">
		<Avatar {ndk} pubkey={event.pubkey} class="w-12 h-12 rounded-full" />
		<div class="flex-1 min-w-0">
			<div class="flex items-center gap-2">
				<span class="text-lg">üëã</span>
				<span class="font-semibold text-foreground">
					{profile?.displayName || profile?.name || 'Anonymous'}
				</span>
			</div>
			<div class="text-sm text-muted-foreground">
				{formatTimeAgo(event.created_at || 0)}
			</div>
		</div>
	</div>
	<!-- Content -->
	<div class="mb-3 text-foreground whitespace-pre-wrap line-clamp-4">
		{event.content}
	</div>
	<!-- Footer -->
	<div class="flex items-center justify-between text-sm">
		{#if inviterProfile}
			<div class="text-muted-foreground">
				Invited by <span class="font-medium text-primary">@{inviterProfile.name || 'anonymous'}</span>
			</div>
		{:else}
			<div></div>
		{/if}
	</div>
</div>
</file>

<file path="agora/InviterLeaderboard.svelte">
<script lang="ts">
	import { ndk } from '$lib/ndk.svelte';
	import { Avatar } from '@nostr-dev-kit/svelte';
	import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
	interface InviterStats {
		pubkey: string;
		totalInvites: number;
		successfulInvites: number;
		rank: number;
	}
	interface Props {
		stats: InviterStats[];
	}
	const { stats }: Props = $props();
	function getRankEmoji(rank: number): string {
		if (rank === 1) return 'ü•á';
		if (rank === 2) return 'ü•à';
		if (rank === 3) return 'ü•â';
		return '';
	}
	const maxSuccess = $derived(Math.max(...stats.map(s => s.successfulInvites), 1));
	let profiles = $state<Map<string, NDKUserProfile | null>>(new Map());
	$effect(() => {
		profiles.clear();
		stats.forEach(stat => {
			ndk.fetchUser(stat.pubkey).then(u => {
				u?.fetchProfile().then(p => {
					profiles.set(stat.pubkey, p || null);
					profiles = new Map(profiles);
				});
			});
		});
	});
</script>
<div class="bg-card rounded-xl border border-border p-6">
	<h2 class="text-xl font-bold text-foreground mb-4">Top Inviters</h2>
	{#if stats.length === 0}
		<p class="text-muted-foreground text-center py-8">No invites yet in this Agora</p>
	{:else}
		<div class="space-y-3">
			{#each stats as stat (stat.pubkey)}
				{@const profile = profiles.get(stat.pubkey)}
				<div class="flex items-center gap-4 p-3 rounded-lg hover:bg-muted/50 transition-colors">
					<div class="flex items-center gap-3 flex-1">
						<span class="text-2xl w-8 text-center">{getRankEmoji(stat.rank)}</span>
						<span class="text-lg font-semibold text-muted-foreground w-8">{stat.rank}.</span>
						<Avatar {ndk} pubkey={stat.pubkey} class="w-10 h-10 rounded-full" />
						<div class="flex-1 min-w-0">
							<div class="font-medium text-foreground truncate">
								{profile?.displayName || profile?.name || 'Anonymous'}
							</div>
							<div class="text-sm text-muted-foreground">
								{stat.totalInvites} {stat.totalInvites === 1 ? 'invite' : 'invites'} ¬∑ {stat.successfulInvites} joined
							</div>
						</div>
					</div>
					<!-- Progress Bar -->
					<div class="hidden md:block w-32">
						<div class="h-2 bg-muted rounded-full overflow-hidden">
							<div
								class="h-full bg-gradient-to-r from-primary to-primary/60 transition-all duration-500"
								style="width: {Math.min(100, (stat.successfulInvites / maxSuccess) * 100)}%"
							></div>
						</div>
					</div>
				</div>
			{/each}
		</div>
	{/if}
</div>
</file>

<file path="agora/NewMemberCard.svelte">
<script lang="ts">
	import { ndk } from '$lib/ndk.svelte';
	import User from '../User.svelte';
	import FollowButton from '../FollowButton.svelte';
	import { formatTimeAgo } from '$lib/utils/formatTime';
	import type { NDKUser, NDKUserProfile } from '@nostr-dev-kit/ndk';
	interface Props {
		memberPubkey: string;
		inviterPubkey: string | null;
		joinedAt: number;
	}
	let { memberPubkey, inviterPubkey, joinedAt }: Props = $props();
	let inviterUser = $state<NDKUser | undefined>(undefined);
	let inviterProfile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		if (!inviterPubkey) {
			inviterUser = undefined;
			inviterProfile = null;
			return;
		}
		ndk.fetchUser(inviterPubkey).then(u => {
			inviterUser = u;
			u?.fetchProfile().then(p => { inviterProfile = p; });
		});
	});
</script>
<div class="p-3 rounded-lg hover:bg-muted/50 transition-colors">
	<div class="flex items-start justify-between gap-3">
		<div class="flex-1 min-w-0">
			<User
				pubkey={memberPubkey}
				variant="avatar-name-handle"
				avatarSize="w-12 h-12"
				nameSize="text-base font-semibold"
				handleSize="text-sm text-muted-foreground"
			/>
			<div class="ml-[60px]">
				<div class="flex items-center flex-wrap gap-x-2 gap-y-1 mt-2 text-xs text-muted-foreground">
					<span>Joined {formatTimeAgo(joinedAt)}</span>
					{#if inviterPubkey && inviterProfile && (inviterProfile.name || inviterProfile.displayName)}
						<span>‚Ä¢</span>
						<span>
							Invited by
							<a href="/p/{inviterUser?.npub}" class="text-primary hover:underline">
								{inviterProfile.displayName || inviterProfile.name || 'someone'}
							</a>
						</span>
					{/if}
				</div>
			</div>
		</div>
		<div class="flex-shrink-0">
			<FollowButton pubkey={memberPubkey} iconOnly={true} />
		</div>
	</div>
</div>
</file>

<file path="agora/TopInvitersPodium.svelte">
<script lang="ts">
	import { ndk } from '$lib/ndk.svelte';
	import { Avatar } from '@nostr-dev-kit/svelte';
	import { getProfileUrl } from '$lib/utils/navigation';
	import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
	interface InviterStats {
		pubkey: string;
		totalInvites: number;
		successfulInvites: number;
		rank: number;
	}
	interface Props {
		stats: InviterStats[];
	}
	const { stats }: Props = $props();
	let expanded = $state(false);
	function getRankEmoji(rank: number): string {
		if (rank === 1) return 'ü•á';
		if (rank === 2) return 'ü•à';
		if (rank === 3) return 'ü•â';
		return '';
	}
	const top3 = $derived(stats.slice(0, 3));
	const remaining = $derived(stats.slice(3, 10));
	const maxSuccess = $derived(Math.max(...stats.map(s => s.successfulInvites), 1));
	let profiles = $state<Map<string, NDKUserProfile | null>>(new Map());
	$effect(() => {
		profiles.clear();
		stats.forEach(stat => {
			ndk.fetchUser(stat.pubkey).then(u => {
				u?.fetchProfile().then(p => {
					profiles.set(stat.pubkey, p || null);
					profiles = new Map(profiles);
				});
			});
		});
	});
</script>
<div>
	<h2 class="text-xl font-bold text-foreground mb-6">üèÜ Top Inviters</h2>
	{#if stats.length === 0}
		<p class="text-muted-foreground text-center py-8">No invites yet in this Agora</p>
	{:else}
		<!-- Top 3 Podium - Horizontal Portrait Cards -->
		<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
			{#each top3 as stat (stat.pubkey)}
				{@const profile = profiles.get(stat.pubkey)}
				<a
					href={getProfileUrl(stat.pubkey)}
					class="relative bg-gradient-to-b from-primary/5 to-transparent border border-border rounded-xl p-6 hover:border-primary/50 transition-all hover:shadow-lg group"
				>
					<!-- Rank Badge -->
					<div class="absolute -top-3 left-1/2 -translate-x-1/2">
						<div class="w-12 h-12 rounded-full bg-card border-2 border-border flex items-center justify-center text-2xl group-hover:border-primary transition-colors">
							{getRankEmoji(stat.rank)}
						</div>
					</div>
					<!-- Avatar -->
					<div class="flex justify-center mt-6 mb-4">
						<Avatar {ndk} pubkey={stat.pubkey} class="w-24 h-24 rounded-full ring-4 ring-primary/20" />
					</div>
					<!-- Name -->
					<div class="text-center mb-4">
						<h3 class="font-bold text-lg text-foreground truncate mb-1">
							{profile?.displayName || profile?.name || 'Anonymous'}
						</h3>
						{#if profile?.nip05}
							<p class="text-xs text-muted-foreground truncate">
								{profile.nip05}
							</p>
						{/if}
					</div>
					<!-- Stats -->
					<div class="bg-muted/50 rounded-lg p-3">
						<div class="text-center">
							<div class="text-3xl font-bold text-primary mb-1">{stat.successfulInvites}</div>
							<div class="text-xs text-muted-foreground">{stat.successfulInvites === 1 ? 'person joined' : 'people joined'}</div>
						</div>
					</div>
					<!-- Progress Bar -->
					<div class="mt-3">
						<div class="h-1.5 bg-muted rounded-full overflow-hidden">
							<div
								class="h-full bg-gradient-to-r from-primary to-primary/60 transition-all duration-500"
								style="width: {Math.min(100, (stat.successfulInvites / maxSuccess) * 100)}%"
							></div>
						</div>
					</div>
				</a>
			{/each}
		</div>
		<!-- Expand/Collapse Button -->
		{#if stats.length > 3}
			<button
				onclick={() => expanded = !expanded}
				class="w-full flex items-center justify-center gap-2 py-3 text-sm font-medium text-primary hover:text-primary/80 transition-colors"
			>
				<span>{expanded ? 'Show Less' : `View Top ${stats.length} Inviters`}</span>
				<svg
					class="w-4 h-4 transition-transform duration-200 {expanded ? 'rotate-180' : ''}"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
				</svg>
			</button>
		{/if}
		<!-- Expanded Rankings (4-10) -->
		{#if expanded && remaining.length > 0}
			<div class="mt-4 space-y-2 border-t border-border pt-4">
				{#each remaining as stat (stat.pubkey)}
					{@const profile = profiles.get(stat.pubkey)}
					<a
						href={getProfileUrl(stat.pubkey)}
						class="flex items-center gap-4 p-3 rounded-lg hover:bg-muted/50 transition-colors"
					>
						<div class="flex items-center gap-3 flex-1">
							<span class="text-lg font-semibold text-muted-foreground w-8">{stat.rank}.</span>
							<Avatar {ndk} pubkey={stat.pubkey} class="w-10 h-10 rounded-full" />
							<div class="flex-1 min-w-0">
								<div class="font-medium text-foreground truncate">
									{profile?.displayName || profile?.name || 'Anonymous'}
								</div>
								<div class="text-sm text-muted-foreground">
									{stat.successfulInvites} {stat.successfulInvites === 1 ? 'person joined' : 'people joined'}
								</div>
							</div>
						</div>
						<!-- Progress Bar -->
						<div class="hidden md:block w-32">
							<div class="h-2 bg-muted rounded-full overflow-hidden">
								<div
									class="h-full bg-gradient-to-r from-primary to-primary/60 transition-all duration-500"
									style="width: {Math.min(100, (stat.successfulInvites / maxSuccess) * 100)}%"
								></div>
							</div>
						</div>
					</a>
				{/each}
			</div>
		{/if}
	{/if}
</div>
</file>

<file path="backup/PassphraseInput.svelte">
<script lang="ts">
  import { validatePassphraseStrength } from '$lib/backup/utils/passphrase';
  import SecurePasswordField from './SecurePasswordField.svelte';
  import WarningBanner from './WarningBanner.svelte';
  interface Props {
    value: string;
    confirmValue: string;
    onChange: (value: string) => void;
    onConfirmChange: (value: string) => void;
    onValidChange: (isValid: boolean) => void;
  }
  let { value, confirmValue, onChange, onConfirmChange, onValidChange }: Props = $props();
  let touched = $state({ passphrase: false, confirm: false });
  let validation = $derived(validatePassphraseStrength(value));
  let passphraseMatch = $derived(value === confirmValue && value.length > 0);
  $effect(() => {
    onValidChange(validation.valid && passphraseMatch);
  });
</script>
<div class="space-y-4">
  <WarningBanner
    title="Passphrase Warning"
    description="Your passphrase encrypts your key shards. If you forget it, your backup cannot be recovered. Write it down and store it securely."
    variant="warning"
  />
  <SecurePasswordField
    label="Passphrase"
    {value}
    placeholder="Enter a strong passphrase"
    onChange={(v) => onChange(v)}
    onBlur={() => touched = { ...touched, passphrase: true }}
    isValid={validation.valid}
    touched={touched.passphrase}
    errors={validation.errors}
    successMessage="Strong passphrase"
  />
  <SecurePasswordField
    label="Confirm Passphrase"
    value={confirmValue}
    placeholder="Confirm your passphrase"
    onChange={(v) => onConfirmChange(v)}
    onBlur={() => touched = { ...touched, confirm: true }}
    isValid={passphraseMatch}
    touched={touched.confirm}
    errors={passphraseMatch ? [] : ['Passphrases do not match']}
    successMessage="Passphrases match"
  />
</div>
</file>

<file path="backup/QuorumSelector.svelte">
<script lang="ts">
  import { SHARD_CONSTANTS } from '$lib/backup/utils/shamir';
  interface Props {
    threshold: number;
    totalShards: number;
    onThresholdChange: (threshold: number) => void;
    onTotalShardsChange: (totalShards: number) => void;
    maxShards: number;
  }
  let { threshold, totalShards, onThresholdChange, onTotalShardsChange, maxShards }: Props = $props();
  let effectiveMaxShards = $derived(Math.min(maxShards, SHARD_CONSTANTS.MAX_TOTAL_SHARDS));
  let effectiveMaxThreshold = $derived(Math.min(SHARD_CONSTANTS.MAX_THRESHOLD, totalShards));
  let thresholdOptions = $derived(Array.from(
    { length: effectiveMaxThreshold - SHARD_CONSTANTS.MIN_THRESHOLD + 1 },
    (_, i) => i + SHARD_CONSTANTS.MIN_THRESHOLD
  ));
  let shardsOptions = $derived(Array.from(
    { length: effectiveMaxShards - SHARD_CONSTANTS.MIN_TOTAL_SHARDS + 1 },
    (_, i) => i + SHARD_CONSTANTS.MIN_TOTAL_SHARDS
  ));
  function handleTotalShardsChange(newTotal: number) {
    onTotalShardsChange(newTotal);
    if (threshold > newTotal) {
      onThresholdChange(Math.min(threshold, newTotal));
    }
  }
</script>
<div class="space-y-6">
  <!-- Total Shards -->
  <div>
    <label class="block text-sm font-medium text-foreground mb-2">
      Total Key Pieces
    </label>
    <p class="text-xs text-muted-foreground mb-3">
      How many pieces should your key be split into?
    </p>
    <select
      value={totalShards}
      onchange={(e) => handleTotalShardsChange(parseInt(e.currentTarget.value))}
      class="w-full px-3 py-2 bg-card border border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      {#each shardsOptions as num}
        <option value={num}>{num} pieces</option>
      {/each}
    </select>
  </div>
  <!-- Threshold -->
  <div>
    <label class="block text-sm font-medium text-foreground mb-2">
      Required for Recovery
    </label>
    <p class="text-xs text-muted-foreground mb-3">
      How many pieces are needed to recover your key?
    </p>
    <select
      value={threshold}
      onchange={(e) => onThresholdChange(parseInt(e.currentTarget.value))}
      class="w-full px-3 py-2 bg-card border border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      {#each thresholdOptions as num}
        <option value={num}>{num} pieces</option>
      {/each}
    </select>
  </div>
  <!-- Explanation -->
  <div class="p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-900 rounded-lg">
    <div class="flex gap-3">
      <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div class="flex-1 text-sm text-blue-900 dark:text-blue-200">
        <p class="font-medium mb-1">
          What This Means
        </p>
        <p class="text-xs text-blue-700 dark:text-blue-300">
          Your key will be split into {totalShards} pieces. You'll need any {threshold} of them to recover your key.
          Individual pieces are useless without the required number.
        </p>
      </div>
    </div>
  </div>
</div>
</file>

<file path="backup/SecurePasswordField.svelte">
<script lang="ts">
  interface Props {
    label: string;
    value: string;
    placeholder: string;
    onChange: (value: string) => void;
    onBlur?: () => void;
    isValid?: boolean;
    touched?: boolean;
    errors?: string[];
    successMessage?: string;
  }
  let {
    label,
    value,
    placeholder,
    onChange,
    onBlur,
    isValid = true,
    touched = false,
    errors = [],
    successMessage
  }: Props = $props();
  let showPassword = $state(false);
  let hasErrors = $derived(touched && errors.length > 0);
  let showSuccess = $derived(touched && isValid && value.length > 0 && successMessage);
</script>
<div>
  <label class="block text-sm font-medium text-foreground mb-2">
    {label}
  </label>
  <div class="relative">
    <input
      type={showPassword ? 'text' : 'password'}
      {value}
      oninput={(e) => onChange(e.currentTarget.value)}
      onblur={onBlur}
      {placeholder}
      class="w-full px-3 py-2 pr-10 bg-card border rounded-lg text-sm focus:outline-none focus:ring-2 {hasErrors ? 'border-red-500 focus:ring-red-500' : 'border focus:ring-orange-500'}"
    />
    <button
      type="button"
      onclick={() => showPassword = !showPassword}
      class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-neutral-700 dark:hover:text-muted-foreground"
    >
      {#if showPassword}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
        </svg>
      {:else}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
      {/if}
    </button>
  </div>
  {#if hasErrors}
    <div class="mt-2 space-y-1">
      {#each errors as error}
        <p class="text-xs text-red-500 flex items-center gap-1">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          {error}
        </p>
      {/each}
    </div>
  {/if}
  {#if showSuccess}
    <p class="mt-2 text-xs text-green-600 dark:text-green-400 flex items-center gap-1">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      {successMessage}
    </p>
  {/if}
</div>
</file>

<file path="backup/TrusteeSelector.svelte">
<script lang="ts">
  import type { Trustee } from '$lib/backup/types';
  import { ndk } from '$lib/ndk.svelte';
  import User from '$lib/components/User.svelte';
  import { useProfileSearch } from '$lib/composables/useProfileSearch.svelte';
  interface Props {
    trustees: Trustee[];
    maxTrustees: number;
    onTrusteesChange: (trustees: Trustee[]) => void;
  }
  let { trustees, maxTrustees, onTrusteesChange }: Props = $props();
  let searchValue = $state('');
  let followsList = $derived(Array.from(ndk.$sessions.follows));
  // Get available follows (excluding already selected trustees)
  const availableFollows = $derived.by(() =>
    followsList.filter(pubkey => !trustees.some(t => t.pubkey === pubkey))
  );
  // Use profile search composable for filtering
  const { filteredPubkeys: filteredFollows } = useProfileSearch({
    searchQuery: () => searchValue,
    availablePubkeys: () => availableFollows,
    limit: 10
  });
  function handleAddTrustee(pubkey: string) {
    if (trustees.length >= maxTrustees) return;
    if (trustees.some(t => t.pubkey === pubkey)) return;
    onTrusteesChange([...trustees, { pubkey, selected: true }]);
  }
  function handleRemoveTrustee(pubkey: string) {
    onTrusteesChange(trustees.filter(t => t.pubkey !== pubkey));
  }
</script>
<div class="space-y-4">
  <div>
    <label class="block text-sm font-medium text-foreground mb-2">
      Select Trustees
    </label>
    <p class="text-xs text-muted-foreground mb-3">
      Choose trusted contacts who will receive encrypted pieces of your key
    </p>
  </div>
  <!-- Selected trustees -->
  {#if trustees.length > 0}
    <div class="space-y-2">
      {#each trustees as trustee}
        <div class="flex items-center gap-3 p-3 bg-neutral-100 dark:bg-card border border rounded-lg">
          <User pubkey={trustee.pubkey} variant="avatar-name-handle" showHoverCard={false} class="flex-1 min-w-0" />
          <button
            onclick={() => handleRemoveTrustee(trustee.pubkey)}
            class="p-2 hover:bg-neutral-200 dark:hover:bg-muted rounded-lg transition-colors"
          >
            <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      {/each}
    </div>
  {/if}
  <div class="flex items-center justify-between text-sm mb-2">
    <span class="text-muted-foreground">
      Selected {trustees.length} of {maxTrustees}
    </span>
  </div>
  <!-- Search follows -->
  {#if trustees.length < maxTrustees}
    <div>
      <input
        type="text"
        bind:value={searchValue}
        placeholder="Search your follows..."
        class="w-full px-3 py-2 bg-card border border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
      />
    </div>
    {#if filteredFollows.length === 0}
      <div class="text-center py-8 text-muted-foreground text-sm border border rounded-lg">
        {#if followsList.length === 0}
          No follows found. Follow some people first.
        {:else}
          All follows have been selected
        {/if}
      </div>
    {:else}
      <div class="border border rounded-lg max-h-64 overflow-y-auto">
        {#each filteredFollows as pubkey}
          <button
            onclick={() => handleAddTrustee(pubkey)}
            class="w-full p-3 hover:bg-neutral-100 dark:hover:bg-card transition-colors border-b border last:border-b-0"
          >
            <User {pubkey} variant="avatar-name-handle" showHoverCard={false} class="w-full" />
          </button>
        {/each}
      </div>
    {/if}
  {/if}
</div>
</file>

<file path="backup/WarningBanner.svelte">
<script lang="ts">
  interface Props {
    title: string;
    description: string;
    variant?: 'warning' | 'danger';
  }
  let { title, description, variant = 'warning' }: Props = $props();
  let bgColor = $derived(variant === 'danger'
    ? 'bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-900'
    : 'bg-amber-50 dark:bg-amber-950/20 border-amber-200 dark:border-amber-900');
  let iconColor = $derived(variant === 'danger'
    ? 'text-red-600 dark:text-red-400'
    : 'text-amber-600 dark:text-amber-400');
  let textColor = $derived(variant === 'danger'
    ? 'text-red-900 dark:text-red-200'
    : 'text-amber-900 dark:text-amber-200');
  let descColor = $derived(variant === 'danger'
    ? 'text-red-700 dark:text-red-300'
    : 'text-amber-700 dark:text-amber-300');
</script>
<div class="p-4 border rounded-lg {bgColor}">
  <div class="flex gap-3">
    <svg class="w-5 h-5 flex-shrink-0 mt-0.5 {iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <div class="flex-1 text-sm {textColor}">
      <p class="font-semibold mb-1">
        {title}
      </p>
      <p class="text-xs {descColor}">
        {description}
      </p>
    </div>
  </div>
</div>
</file>

<file path="headers/FeedHeader.svelte">
<script lang="ts">
  import type { Snippet } from 'svelte';
  import RelaySelector from '$lib/components/RelaySelector.svelte';
  import MediaTypeFilters from '$lib/components/MediaTypeFilters.svelte';
  import { ndk, hashtagInterests } from '$lib/ndk.svelte';
  import { hashtagFilter } from '$lib/stores/hashtagFilter.svelte';
  import { createNotificationsManager } from '$lib/utils/useNotifications.svelte';
  import { formatBalance } from '$lib/utils/formatBalance';
  interface HeaderTitle {
    type: 'logo' | 'text';
    text?: string;
  }
  interface Props {
    headerTitle: HeaderTitle | null;
    selectedFilter: 'conversations' | 'images' | 'videos' | 'articles';
    onFilterChange: (filter: 'conversations' | 'images' | 'videos' | 'articles') => void;
  }
  let { headerTitle, selectedFilter, onFilterChange }: Props = $props();
  const isVideoMode = $derived(selectedFilter === 'videos');
  const wallet = ndk.$wallet;
  const notificationsManager = createNotificationsManager(ndk);
  let headerElement = $state<HTMLDivElement | null>(null);
  $effect(() => {
    if (!headerElement) return;
    const updateHeaderHeight = () => {
      const height = isVideoMode ? 0 : headerElement.offsetHeight;
      document.documentElement.style.setProperty('--header-height', `${height}px`);
    };
    updateHeaderHeight();
    window.addEventListener('resize', updateHeaderHeight);
    return () => {
      window.removeEventListener('resize', updateHeaderHeight);
    };
  });
</script>
<div bind:this={headerElement} class="sticky top-0 z-10 bg-background/90 backdrop-blur-xl border-b border-border {isVideoMode ? 'hidden' : ''}">
  <div class="py-2 pl-2 sm:p-4 w-full">
    <div class="flex items-center gap-2 min-w-0">
      <!-- Relay/Following selector icon (always visible) -->
      <div class="flex-shrink-0 relative z-20">
        <RelaySelector iconOnly={true} />
      </div>
      <!-- Hashtags scroll container OR Title -->
      <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide flex-1 min-w-0 max-w-full">
      {#if hashtagInterests.interests.length > 0}
        {#each hashtagInterests.interests as hashtag}
          <button
            onclick={() => hashtagFilter.toggleHashtag(hashtag)}
            class="flex-shrink-0 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all {
              hashtagFilter.isSelected(hashtag)
                ? 'bg-primary text-foreground border-2 border-primary-400'
                : 'bg-muted text-muted-foreground border-2 border-border hover:border'
            }"
          >
            <span class="text-xs">#</span>
            <span>{hashtag}</span>
          </button>
        {/each}
        {#if hashtagFilter.hasFilters}
          <button
            onclick={() => hashtagFilter.clearAll()}
            class="flex-shrink-0 inline-flex items-center gap-1 px-2 py-1.5 rounded-full text-xs font-medium bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all"
            title="Clear all filters"
          >
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        {/if}
      {:else if headerTitle}
        <h1 class="text-xl font-bold text-foreground">{headerTitle.text}</h1>
      {/if}
      </div>
      <!-- Mobile-only: Wallet and Notifications -->
      <div class="lg:hidden flex items-center gap-2 flex-shrink-0">
        <!-- Notifications -->
        <a
          href="/notifications"
          class="relative flex items-center justify-center p-2 rounded-lg hover:bg-muted transition-colors text-foreground"
          aria-label="Notifications"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          {#if notificationsManager.counts.all > 0}
            <div class="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-primary flex items-center justify-center">
              <span class="text-[10px] font-bold text-primary-foreground">
                {notificationsManager.counts.all > 9 ? '9+' : notificationsManager.counts.all}
              </span>
            </div>
          {/if}
        </a>
        <!-- Wallet -->
        <a
          href="/wallet"
          class="relative flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg hover:bg-muted transition-colors text-foreground"
          aria-label="Wallet"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3" />
          </svg>
          <span class="text-xs font-medium">{formatBalance(wallet.balance)}</span>
        </a>
      </div>
    </div>
  </div>
  <!-- Media Type Filters -->
  <MediaTypeFilters {selectedFilter} onFilterChange={onFilterChange} />
</div>
</file>

<file path="headers/PageHeader.svelte">
<script lang="ts">
  import type { Snippet } from 'svelte';
  interface Props {
    title: string;
    subtitle?: string;
    actions?: Snippet;
    icon?: Snippet;
  }
  let { title, subtitle, actions, icon }: Props = $props();
</script>
<div class="border-b border-border bg-background">
  <div class="px-4 sm:px-6 lg:px-8 py-3">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3 min-w-0 flex-1">
        {#if icon}
          <div class="flex-shrink-0">
            {@render icon()}
          </div>
        {/if}
        <div class="min-w-0">
          <h1 class="text-2xl sm:text-3xl font-bold text-foreground">{title}</h1>
          {#if subtitle}
            <p class="text-sm text-muted-foreground mt-1">{subtitle}</p>
          {/if}
        </div>
      </div>
      {#if actions}
        <div class="flex-shrink-0">
          {@render actions()}
        </div>
      {/if}
    </div>
  </div>
</div>
</file>

<file path="invite/CreateInviteModal.svelte">
<script lang="ts">
	import { ndk } from '$lib/ndk.svelte';
	import { NDKEvent, NDKRelaySet, type NDKRelay } from '@nostr-dev-kit/ndk';
	import { settings } from '$lib/stores/settings.svelte';
	import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
	import { clickOutside } from '$lib/utils/clickOutside';
	import { portal } from '$lib/utils/portal.svelte';
	import { isAgoraRelay } from '$lib/utils/relayUtils';
	import {
		generateDTag,
		generateEncryptionKey,
		generateInviteCode,
		encryptInvitePayload
	} from '$lib/utils/inviteEncryption';
	import { MediaQuery } from 'svelte/reactivity';
	import * as Dialog from '$lib/components/ui/dialog';
	import * as Drawer from '$lib/components/ui/drawer';
	import { Button } from '$lib/components/ui/button';
	import { Input } from '$lib/components/ui/input';
	import { Label } from '$lib/components/ui/label';
	import { Textarea } from '$lib/components/ui/textarea';
	import RelayIcon from '$lib/components/RelayIcon.svelte';
	const isDesktop = new MediaQuery('(min-width: 768px)');
	interface Props {
		isOpen: boolean;
		onClose: () => void;
	}
	let { isOpen = $bindable(), onClose }: Props = $props();
	const DEFAULT_WELCOME_MESSAGE = `Welcome to Agora! üéâ
I'm inviting you to join Agora, a new kind of social network where you own your identity and content. No algorithms, no ads, just authentic connections.
Looking forward to connecting with you on the open social web!`;
	let welcomeMessage = $state(DEFAULT_WELCOME_MESSAGE);
	let isPersonalized = $state(false);
	let recipientName = $state('');
	let cashuAmount = $state('');
	let maxUses = $state(10);
	let inviteLink = $state('');
	let isGenerating = $state(false);
	let isCopied = $state(false);
	let selectedRelayUrls = $state<string[]>([]);
	let isRelayDropdownOpen = $state(false);
	// Get enabled Agora write relays
	const agoraRelays = $derived(settings.relays.filter(r => r.enabled && r.write && isAgoraRelay(r.url)));
	// Initialize with selected relay if one is set and it's an Agora relay
	$effect(() => {
		if (isOpen && settings.selectedRelay && selectedRelayUrls.length === 0 && isAgoraRelay(settings.selectedRelay)) {
			// Only preselect if the selected relay is also an Agora write relay
			const isAgoraWriteRelay = agoraRelays.some(r => r.url === settings.selectedRelay);
			if (isAgoraWriteRelay) {
				selectedRelayUrls = [settings.selectedRelay];
			}
		}
	});
	function toggleRelay(url: string) {
		if (selectedRelayUrls.includes(url)) {
			selectedRelayUrls = selectedRelayUrls.filter(r => r !== url);
		} else {
			selectedRelayUrls = [...selectedRelayUrls, url];
		}
	}
	const selectedRelayInfo = $derived.by(() => {
		if (selectedRelayUrls.length === 0) return null;
		if (selectedRelayUrls.length === 1) {
			return {
				url: selectedRelayUrls[0],
				info: useRelayInfoCached(selectedRelayUrls[0])
			};
		}
		return null;
	});
	const selectedRelayName = $derived.by(() => {
		if (selectedRelayUrls.length === 0) return 'Select Agora...';
		if (selectedRelayUrls.length === 1) {
			const relayInfo = useRelayInfoCached(selectedRelayUrls[0]);
			return relayInfo.info?.name || selectedRelayUrls[0].replace('wss://', '').replace('ws://', '');
		}
		return `${selectedRelayUrls.length} Agoras selected`;
	});
	async function generateInvite() {
		if (!ndk.$currentUser) {
			console.error("No user logged in");
			return;
		}
		if (selectedRelayUrls.length === 0) {
			alert('Please select at least one Agora to publish the invite to.');
			return;
		}
		isGenerating = true;
		try {
			// Generate d-tag and encryption key
			const dTag = generateDTag();
			const encryptionKey = isPersonalized ? generateEncryptionKey() : '';
			// Generate invite codes (one for each max use)
			const inviteCodes: string[] = [];
			for (let i = 0; i < maxUses; i++) {
				inviteCodes.push(generateInviteCode());
			}
			// Create payload
			const payload = {
				welcomeMessage,
				recipientName: isPersonalized ? recipientName : undefined,
				cashuToken: isPersonalized && cashuAmount ? `cashu:${cashuAmount}` : undefined,
				createdAt: Date.now(),
				inviter: ndk.$currentUser.pubkey,
			};
			// Encrypt payload if personalized, otherwise just JSON
			const content = isPersonalized
				? await encryptInvitePayload(JSON.stringify(payload), encryptionKey)
				: JSON.stringify(payload);
			// Create invite event (kind 513 - Agora Invite)
			const inviteEvent = new NDKEvent(ndk);
			inviteEvent.kind = 513;
			inviteEvent.content = content;
			inviteEvent.tags = [
				['d', dTag],
				...inviteCodes.map(code => ['code', code])
			];
			inviteEvent.isProtected = true;
			await inviteEvent.sign();
			// Mark as protected before publishing
			inviteEvent.isProtected = true;
			console.log('Publishing invite event to selected Agoras...', inviteEvent.id, selectedRelayUrls);
			// Publish to specific Agora relays only
			const relays = new Set<NDKRelay>();
			for (const url of selectedRelayUrls) {
				const relay = ndk.pool.getRelay(url, true);
				if (relay) {
					relays.add(relay);
				}
			}
			const relaySet = new NDKRelaySet(relays, ndk);
			await inviteEvent.publish(relaySet);
			// Generate invite link: /i/{dTag}{encryptionKey}
			// dTag = 12 chars, encryptionKey = 24 chars (optional)
			const code = isPersonalized ? `${dTag}${encryptionKey}` : dTag;
			const link = `${window.location.origin}/i/${code}`;
			inviteLink = link;
			console.log('Invite created:', link);
		} catch (error) {
			console.error('Failed to generate invite:', error);
			alert('Failed to generate invite. Check console for details.');
		} finally {
			isGenerating = false;
		}
	}
	async function copyToClipboard() {
		try {
			await navigator.clipboard.writeText(inviteLink);
			isCopied = true;
			setTimeout(() => (isCopied = false), 2000);
		} catch (error) {
			console.error('Failed to copy:', error);
		}
	}
	async function shareInvite() {
		if (!navigator.share) {
			console.log('Web Share API not supported, falling back to copy');
			await copyToClipboard();
			return;
		}
		try {
			await navigator.share({
				title: 'Join Agora',
				text: isPersonalized && recipientName
					? `${recipientName}, you're invited to join Agora!`
					: 'You\'re invited to join Agora, a new kind of social network!',
				url: inviteLink
			});
		} catch (error) {
			if ((error as Error).name !== 'AbortError') {
				console.error('Failed to share:', error);
			}
		}
	}
	function handleClose() {
		// Reset form
		welcomeMessage = DEFAULT_WELCOME_MESSAGE;
		isPersonalized = false;
		recipientName = '';
		cashuAmount = '';
		maxUses = 10;
		inviteLink = '';
		selectedRelayUrls = [];
		isRelayDropdownOpen = false;
		onClose();
	}
	function handleRelayDropdownClickOutside() {
		isRelayDropdownOpen = false;
	}
	function handleBackdropClick(e: MouseEvent) {
		if (e.target === e.currentTarget) {
			handleClose();
		}
	}
</script>
{#if isDesktop.current}
<Dialog.Root open={isOpen} onOpenChange={(newOpen) => {
    isOpen = newOpen;
    if (!newOpen) handleClose();
  }}>
	<Dialog.Content class="max-w-lg max-h-[90vh] overflow-y-auto">
		<Dialog.Header>
			<Dialog.Title>Create an Invite</Dialog.Title>
			<Dialog.Description>
				Invite someone to join Agora with a personal message
			</Dialog.Description>
		</Dialog.Header>
		<div class="space-y-6">
			{#if !inviteLink}
					<!-- Welcome Message -->
					<div>
						<Label for="welcome-message">Welcome Message</Label>
						<Textarea
							id="welcome-message"
							bind:value={welcomeMessage}
							rows={6}
							placeholder="Write a welcome message..."
							class="mt-2 resize-none"
						/>
					</div>
					<!-- Agora Selection -->
					<div class="relative">
						<label class="block text-sm font-medium text-muted-foreground mb-2">
							Invite to Agora
						</label>
						<button
							type="button"
							onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
							class="w-full px-4 py-2.5 text-left rounded-lg bg-muted/50 text-muted-foreground hover:bg-muted transition-colors flex items-center gap-3 group"
						>
							{#if selectedRelayUrls.length === 0}
								<img src="/logo-icon.svg" alt="Agora" class="w-6 h-6 flex-shrink-0" />
								<span class="text-sm text-muted-foreground flex-1">Select Agora...</span>
							{:else if selectedRelayUrls.length === 1 && selectedRelayInfo}
								<RelayIcon relayUrl={selectedRelayInfo.url} size="lg" />
								<span class="text-sm text-muted-foreground flex-1">{selectedRelayName}</span>
							{:else}
								<img src="/logo-icon.svg" alt="Agora" class="w-6 h-6 flex-shrink-0" />
								<span class="text-sm text-muted-foreground flex-1">{selectedRelayUrls.length} Agoras selected</span>
							{/if}
							<svg class="w-4 h-4 text-muted-foreground transition-transform flex-shrink-0 {isRelayDropdownOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
							</svg>
						</button>
						{#if isRelayDropdownOpen}
							<div
								use:clickOutside={handleRelayDropdownClickOutside}
								class="absolute z-[60] mt-1 w-full bg-popover border border-border rounded-xl shadow-lg max-h-64 overflow-y-auto"
							>
								{#if agoraRelays.length === 0}
									<p class="text-sm text-muted-foreground text-center py-4">No Agora relays configured</p>
								{:else}
									{#each agoraRelays as relay (relay.url)}
										{@const relayInfo = useRelayInfoCached(relay.url)}
										<button
											type="button"
											onclick={() => {
												toggleRelay(relay.url);
											}}
											class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-muted cursor-pointer transition-colors text-left"
										>
											<input
												type="checkbox"
												checked={selectedRelayUrls.includes(relay.url)}
												class="w-4 h-4 text-primary border rounded focus:ring-orange-500 pointer-events-none"
											/>
											<RelayIcon relayUrl={relay.url} size="md" />
											<div class="flex-1 min-w-0">
												<div class="flex items-center gap-1.5">
													<div class="text-sm font-medium text-foreground truncate">
														{relayInfo.info?.name || relay.url.replace('wss://', '').replace('ws://', '')}
													</div>
													<span class="flex-shrink-0 px-1.5 py-0.5 text-[10px] font-semibold bg-primary/20 text-primary rounded uppercase tracking-wide">
														Agora
													</span>
												</div>
												{#if relayInfo.info?.description}
													<div class="text-xs text-muted-foreground truncate">
														{relayInfo.info.description}
													</div>
												{/if}
											</div>
										</button>
									{/each}
								{/if}
							</div>
						{/if}
						{#if selectedRelayUrls.length > 1}
							<p class="mt-1 text-xs text-muted-foreground">
								{selectedRelayUrls.length} Agoras selected
							</p>
						{/if}
					</div>
					<!-- Max Uses -->
					<div>
						<Label for="max-uses">Maximum Uses</Label>
						<Input
							id="max-uses"
							type="number"
							bind:value={maxUses}
							min="1"
							max="500"
							class="mt-2"
						/>
						<p class="mt-1 text-xs text-muted-foreground">
							How many people can use this invite (1-500)
						</p>
					</div>
					<!-- Personalization Toggle -->
					<div class="flex items-center space-x-3">
						<input
							type="checkbox"
							id="personalize"
							bind:checked={isPersonalized}
							class="w-5 h-5 text-primary border rounded focus:ring-orange-500"
						/>
						<label
							for="personalize"
							class="text-sm font-medium text-muted-foreground cursor-pointer"
						>
							Personalize this invite
						</label>
					</div>
					<!-- Personalization Options -->
					{#if isPersonalized}
						<div class="space-y-4 border-l-4 border-primary pl-4">
							<div>
								<Label for="recipient-name" class="flex items-center gap-2">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
									</svg>
									Recipient's Name
								</Label>
								<Input
									id="recipient-name"
									type="text"
									bind:value={recipientName}
									placeholder="John Doe"
									class="mt-2"
								/>
							</div>
							<div>
								<Label for="cashu-amount" class="flex items-center gap-2">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
									</svg>
									Include Cashu Token (sats)
								</Label>
								<Input
									id="cashu-amount"
									type="number"
									bind:value={cashuAmount}
									placeholder="Amount in sats (optional)"
									class="mt-2"
								/>
								<p class="mt-1 text-xs text-muted-foreground">
									Add sats to help them get started on Nostr
								</p>
							</div>
						</div>
					{/if}
					<!-- Generate Button -->
					<Button
						onclick={generateInvite}
						disabled={isGenerating || !welcomeMessage.trim() || selectedRelayUrls.length === 0}
						class="w-full"
					>
						{#if isGenerating}
							<div
								class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"
							></div>
							Generating Invite...
						{:else}
							Generate Invite Link
						{/if}
					</Button>
			{:else}
				<div class="space-y-6">
					<div class="text-center py-8">
						<div
							class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4"
						>
							<svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
							</svg>
						</div>
						<h3 class="text-lg font-semibold text-foreground mb-2">
							Invite Created!
						</h3>
						<p class="text-sm text-muted-foreground">
							{isPersonalized && recipientName
								? `Your personalized invite for ${recipientName} is ready`
								: 'Your invite link is ready to share'}
						</p>
					</div>
					<div class="bg-muted rounded-xl p-4 space-y-3">
						<div class="flex items-center space-x-2">
							<Input
								type="text"
								value={inviteLink}
								readonly
								class="flex-1 bg-transparent"
							/>
							<Button
								onclick={copyToClipboard}
								size="sm"
							>
								{#if isCopied}
									<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
									</svg>
									Copied!
								{:else}
									<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
									</svg>
									Copy
								{/if}
							</Button>
						</div>
						<Button
							onclick={shareInvite}
							variant="outline"
							class="w-full"
						>
							<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
							</svg>
							Share
						</Button>
					</div>
					<Dialog.Footer class="flex gap-3 sm:space-x-0">
						<Button
							variant="outline"
							onclick={() => (inviteLink = '')}
							class="flex-1"
						>
							Create Another
						</Button>
						<Button
							onclick={handleClose}
							class="flex-1"
						>
							Done
						</Button>
					</Dialog.Footer>
				</div>
			{/if}
		</div>
	</Dialog.Content>
</Dialog.Root>
{:else}
<Drawer.Root open={isOpen} onOpenChange={(newOpen) => {
    isOpen = newOpen;
    if (!newOpen) handleClose();
  }}>
	<Drawer.Content>
		<Drawer.Header class="text-left">
			<Drawer.Title>Create an Invite</Drawer.Title>
			<Drawer.Description>
				Invite someone to join Agora with a personal message
			</Drawer.Description>
		</Drawer.Header>
		<div class="space-y-6 px-4 overflow-y-auto pb-4">
			{#if !inviteLink}
					<!-- Welcome Message -->
					<div>
						<Label for="welcome-message">Welcome Message</Label>
						<Textarea
							id="welcome-message"
							bind:value={welcomeMessage}
							rows={6}
							placeholder="Write a welcome message..."
							class="mt-2 resize-none"
						/>
					</div>
					<!-- Agora Selection -->
					<div class="relative">
						<label class="block text-sm font-medium text-muted-foreground mb-2">
							Invite to Agora
						</label>
						<button
							type="button"
							onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
							class="w-full px-4 py-2.5 text-left rounded-lg bg-muted/50 text-muted-foreground hover:bg-muted transition-colors flex items-center gap-3 group"
						>
							{#if selectedRelayUrls.length === 0}
								<img src="/logo-icon.svg" alt="Agora" class="w-6 h-6 flex-shrink-0" />
								<span class="text-sm text-muted-foreground flex-1">Select Agora...</span>
							{:else if selectedRelayUrls.length === 1 && selectedRelayInfo}
								<RelayIcon relayUrl={selectedRelayInfo.url} size="lg" />
								<span class="text-sm text-muted-foreground flex-1">{selectedRelayName}</span>
							{:else}
								<img src="/logo-icon.svg" alt="Agora" class="w-6 h-6 flex-shrink-0" />
								<span class="text-sm text-muted-foreground flex-1">{selectedRelayUrls.length} Agoras selected</span>
							{/if}
							<svg class="w-4 h-4 text-muted-foreground transition-transform flex-shrink-0 {isRelayDropdownOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
							</svg>
						</button>
						{#if isRelayDropdownOpen}
							<div
								use:clickOutside={handleRelayDropdownClickOutside}
								class="absolute z-[60] mt-1 w-full bg-popover border border-border rounded-xl shadow-lg max-h-64 overflow-y-auto"
							>
								{#if agoraRelays.length === 0}
									<p class="text-sm text-muted-foreground text-center py-4">No Agora relays configured</p>
								{:else}
									{#each agoraRelays as relay (relay.url)}
										{@const relayInfo = useRelayInfoCached(relay.url)}
										<button
											type="button"
											onclick={() => {
												toggleRelay(relay.url);
											}}
											class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-muted cursor-pointer transition-colors text-left"
										>
											<input
												type="checkbox"
												checked={selectedRelayUrls.includes(relay.url)}
												class="w-4 h-4 text-primary border rounded focus:ring-orange-500 pointer-events-none"
											/>
											<RelayIcon relayUrl={relay.url} size="md" />
											<div class="flex-1 min-w-0">
												<div class="flex items-center gap-1.5">
													<div class="text-sm font-medium text-foreground truncate">
														{relayInfo.info?.name || relay.url.replace('wss://', '').replace('ws://', '')}
													</div>
													<span class="flex-shrink-0 px-1.5 py-0.5 text-[10px] font-semibold bg-primary/20 text-primary rounded uppercase tracking-wide">
														Agora
													</span>
												</div>
												{#if relayInfo.info?.description}
													<div class="text-xs text-muted-foreground truncate">
														{relayInfo.info.description}
													</div>
												{/if}
											</div>
										</button>
									{/each}
								{/if}
							</div>
						{/if}
						{#if selectedRelayUrls.length > 1}
							<p class="mt-1 text-xs text-muted-foreground">
								{selectedRelayUrls.length} Agoras selected
							</p>
						{/if}
					</div>
					<!-- Max Uses -->
					<div>
						<Label for="max-uses">Maximum Uses</Label>
						<Input
							id="max-uses"
							type="number"
							bind:value={maxUses}
							min="1"
							max="500"
							class="mt-2"
						/>
						<p class="mt-1 text-xs text-muted-foreground">
							How many people can use this invite (1-500)
						</p>
					</div>
					<!-- Personalization Toggle -->
					<div class="flex items-center space-x-3">
						<input
							type="checkbox"
							id="personalize"
							bind:checked={isPersonalized}
							class="w-5 h-5 text-primary border rounded focus:ring-orange-500"
						/>
						<label
							for="personalize"
							class="text-sm font-medium text-muted-foreground cursor-pointer"
						>
							Personalize this invite
						</label>
					</div>
					<!-- Personalization Options -->
					{#if isPersonalized}
						<div class="space-y-4 border-l-4 border-primary pl-4">
							<div>
								<Label for="recipient-name" class="flex items-center gap-2">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
									</svg>
									Recipient's Name
								</Label>
								<Input
									id="recipient-name"
									type="text"
									bind:value={recipientName}
									placeholder="John Doe"
									class="mt-2"
								/>
							</div>
							<div>
								<Label for="cashu-amount" class="flex items-center gap-2">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
									</svg>
									Include Cashu Token (sats)
								</Label>
								<Input
									id="cashu-amount"
									type="number"
									bind:value={cashuAmount}
									placeholder="Amount in sats (optional)"
									class="mt-2"
								/>
								<p class="mt-1 text-xs text-muted-foreground">
									Add sats to help them get started on Nostr
								</p>
							</div>
						</div>
					{/if}
					<!-- Generate Button -->
					<Button
						onclick={generateInvite}
						disabled={isGenerating || !welcomeMessage.trim() || selectedRelayUrls.length === 0}
						class="w-full"
					>
						{#if isGenerating}
							<div
								class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"
							></div>
							Generating Invite...
						{:else}
							Generate Invite Link
						{/if}
					</Button>
			{:else}
				<div class="space-y-6">
					<div class="text-center py-8">
						<div
							class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4"
						>
							<svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
							</svg>
						</div>
						<h3 class="text-lg font-semibold text-foreground mb-2">
							Invite Created!
						</h3>
						<p class="text-sm text-muted-foreground">
							{isPersonalized && recipientName
								? `Your personalized invite for ${recipientName} is ready`
								: 'Your invite link is ready to share'}
						</p>
					</div>
					<div class="bg-muted rounded-xl p-4 space-y-3">
						<div class="flex items-center space-x-2">
							<Input
								type="text"
								value={inviteLink}
								readonly
								class="flex-1 bg-transparent"
							/>
							<Button
								onclick={copyToClipboard}
								size="sm"
							>
								{#if isCopied}
									<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
									</svg>
									Copied!
								{:else}
									<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
									</svg>
									Copy
								{/if}
							</Button>
						</div>
						<Button
							onclick={shareInvite}
							variant="outline"
							class="w-full"
						>
							<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
							</svg>
							Share
						</Button>
					</div>
					<Drawer.Footer class="pt-2">
						<div class="flex gap-3 w-full">
							<Button
								variant="outline"
								onclick={() => (inviteLink = '')}
								class="flex-1"
							>
								Create Another
							</Button>
							<Button
								onclick={handleClose}
								class="flex-1"
							>
								Done
							</Button>
						</div>
					</Drawer.Footer>
				</div>
			{/if}
		</div>
	</Drawer.Content>
</Drawer.Root>
{/if}
</file>

<file path="marketplace/SellerSidebar.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { goto } from '$app/navigation';
  import { toast } from '$lib/stores/toast.svelte';
  import { NDKEvent, type NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    listing: NDKEvent | null;
  }
  const { listing }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    if (!listing) {
      profile = null;
      return;
    }
    listing.author.fetchProfile().then(p => { profile = p; });
  });
  const isOwner = $derived(ndk.$sessions.current?.pubkey === listing?.pubkey);
  function handleShare() {
    if (typeof navigator.clipboard !== 'undefined') {
      navigator.clipboard.writeText(window.location.href)
        .then(() => toast.success('Link copied to clipboard'))
        .catch(() => toast.error('Failed to copy link'));
    }
  }
  async function handleDelete() {
    if (!listing || !confirm('Are you sure you want to delete this listing?')) return;
    try {
      // Create a deletion event (kind 5)
      const deleteEvent = new NDKEvent(ndk);
      deleteEvent.kind = 5;
      deleteEvent.tags = [['e', listing.id]];
      await deleteEvent.publish();
      toast.success('Listing deleted');
      goto('/marketplace');
    } catch (error) {
      console.error('Failed to delete listing:', error);
      toast.error('Failed to delete listing');
    }
  }
</script>
<div class="p-4 bg-card rounded-lg border border-border">
  {#if listing}
    <div class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-foreground font-bold text-lg">
        {(profile?.displayName || profile?.name || listing.pubkey).slice(0, 2).toUpperCase()}
      </div>
      <div>
        <p class="text-sm text-muted-foreground">Listed by</p>
        <p class="font-medium text-foreground truncate">{profile?.displayName || profile?.name || `${listing.pubkey.slice(0, 16)}...`}</p>
      </div>
    </div>
    <div class="space-y-3">
      {#if isOwner}
        <button
          onclick={handleDelete}
          class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-foreground font-medium rounded-lg transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete Listing
        </button>
      {:else}
        <button
          class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary hover:bg-accent-dark text-foreground font-medium rounded-lg transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          Contact Seller
        </button>
      {/if}
      <button
        onclick={handleShare}
        class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-muted hover:bg-muted text-foreground font-medium rounded-lg transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
        </svg>
        Share Listing
      </button>
    </div>
  {/if}
</div>
</file>

<file path="messages/ConversationList.svelte">
<script lang="ts">
  import type { NDKConversation } from '@nostr-dev-kit/messages';
  import ConversationListItem from './ConversationListItem.svelte';
  interface Props {
    conversations: NDKConversation[];
  }
  const { conversations }: Props = $props();
</script>
<div class="divide-y divide-neutral-800/50">
  {#if conversations.length === 0}
    <!-- Empty state -->
    <div class="flex flex-col items-center justify-center py-16 px-6 text-center">
      <svg class="w-20 h-20 text-neutral-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <h3 class="text-xl font-semibold text-white mb-2">No messages yet</h3>
      <p class="text-neutral-400 max-w-sm">
        Start a conversation by visiting someone's profile and clicking the message button
      </p>
    </div>
  {:else}
    {#each conversations as conversation (conversation.id)}
      <ConversationListItem {conversation} />
    {/each}
  {/if}
</div>
</file>

<file path="messages/ConversationListItem.svelte">
<script lang="ts">
  import { goto } from '$app/navigation';
  import type { NDKConversation } from '@nostr-dev-kit/messages';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import TimeAgo from '../TimeAgo.svelte';
  import { ndk } from '$lib/ndk.svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    conversation: NDKConversation;
  }
  const { conversation }: Props = $props();
  const participant = conversation.getOtherParticipant();
  const lastMessage = conversation.getLastMessage();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    if (!participant?.pubkey) {
      profile = null;
      return;
    }
    ndk.fetchUser(participant.pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  function openConversation() {
    if (!participant) return;
    goto(`/messages/${participant.npub}`);
  }
</script>
<button
  onclick={openConversation}
  class="w-full flex items-center gap-3 px-4 py-4 hover:bg-neutral-900/50 transition-colors text-left"
>
  <!-- Avatar -->
  {#if participant}
    <Avatar {ndk} pubkey={participant.pubkey} class="w-12 h-12 flex-shrink-0" />
  {/if}
  <!-- Content -->
  <div class="flex-1 min-w-0">
    <!-- Name and time -->
    <div class="flex items-center justify-between mb-1">
      <div class="font-semibold text-white truncate">
        {profile?.name || profile?.displayName || 'Anonymous'}
      </div>
      {#if lastMessage}
        <div class="text-xs text-neutral-500 flex-shrink-0 ml-2">
          <TimeAgo timestamp={lastMessage.timestamp} />
        </div>
      {/if}
    </div>
    <!-- Message preview -->
    <div class="flex items-center justify-between">
      <p class="text-sm text-neutral-400 truncate flex-1">
        {#if lastMessage}
          {#if lastMessage.sender.pubkey === ndk.activeUser?.pubkey}
            <span class="text-neutral-500">You: </span>
          {/if}
          {lastMessage.content}
        {:else}
          No messages yet
        {/if}
      </p>
      <!-- Unread badge -->
      {#if conversation.getUnreadCount() > 0}
        <div class="ml-2 flex-shrink-0 min-w-[20px] h-5 px-1.5 rounded-full bg-primary flex items-center justify-center">
          <span class="text-xs font-bold text-primary-foreground">
            {conversation.getUnreadCount() > 99 ? '99+' : conversation.getUnreadCount()}
          </span>
        </div>
      {/if}
    </div>
  </div>
</button>
</file>

<file path="messages/ConversationThread.svelte">
<script lang="ts">
  import type { NDKMessage } from '@nostr-dev-kit/messages';
  import { NDKEvent } from '@nostr-dev-kit/ndk';
  import { EventContent } from '@nostr-dev-kit/svelte';
  import TimeAgo from '../TimeAgo.svelte';
  import { onMount } from 'svelte';
  import { ndk } from '$lib/ndk.svelte';
  interface Props {
    messages: NDKMessage[];
  }
  const { messages }: Props = $props();
  let scrollContainer: HTMLDivElement | null = $state(null);
  let shouldAutoScroll = $state(true);
  function scrollToBottom(smooth = true) {
    if (scrollContainer && shouldAutoScroll) {
      scrollContainer.scrollTo({
        top: scrollContainer.scrollHeight,
        behavior: smooth ? 'smooth' : 'instant'
      });
    }
  }
  function handleScroll() {
    if (!scrollContainer) return;
    const { scrollTop, scrollHeight, clientHeight } = scrollContainer;
    const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
    shouldAutoScroll = isNearBottom;
  }
  // Scroll to bottom on mount and when new messages arrive
  $effect(() => {
    if (messages.length > 0) {
      scrollToBottom(messages.length > 1);
    }
  });
  onMount(() => {
    scrollToBottom(false);
  });
  function formatTime(timestamp: number): string {
    return new Date(timestamp * 1000).toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit'
    });
  }
  function shouldShowDate(currentMessage: NDKMessage, previousMessage: NDKMessage | null): boolean {
    if (!previousMessage) return true;
    const currentDate = new Date(currentMessage.timestamp * 1000).toDateString();
    const previousDate = new Date(previousMessage.timestamp * 1000).toDateString();
    return currentDate !== previousDate;
  }
  function formatDate(timestamp: number): string {
    const date = new Date(timestamp * 1000);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === today.toDateString()) {
      return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Yesterday';
    } else {
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
      });
    }
  }
</script>
<div
  bind:this={scrollContainer}
  onscroll={handleScroll}
  class="flex-1 overflow-y-auto px-4 py-6 space-y-4"
>
  {#if messages.length === 0}
    <div class="flex items-center justify-center h-full">
      <div class="text-center text-neutral-500">
        <p>No messages yet</p>
        <p class="text-sm mt-1">Start the conversation!</p>
      </div>
    </div>
  {:else}
    {#each messages as message, index (message.id)}
      {@const previousMessage = index > 0 ? messages[index - 1] : null}
      <!-- Date separator -->
      {#if shouldShowDate(message, previousMessage)}
        <div class="flex items-center justify-center my-6">
          <div class="px-3 py-1 bg-neutral-900 rounded-full text-xs text-neutral-400 font-medium">
            {formatDate(message.timestamp)}
          </div>
        </div>
      {/if}
      <!-- Message bubble -->
      <div class="flex {message.sender.pubkey === ndk.activeUser?.pubkey ? 'justify-end' : 'justify-start'}">
        <div class="max-w-[70%] {message.sender.pubkey === ndk.activeUser?.pubkey ? 'items-end' : 'items-start'} flex flex-col gap-1">
          <!-- Message content -->
          <div
            class="px-4 py-2 rounded-2xl {message.sender.pubkey === ndk.activeUser?.pubkey
              ? 'bg-primary text-primary-foreground rounded-tr-sm'
              : 'bg-neutral-900 text-white rounded-tl-sm'}"
          >
            <div class="whitespace-pre-wrap break-words line-clamp-[20] hover:line-clamp-none transition-all">
              {#if message.rumor}
                <EventContent {ndk} event={new NDKEvent(ndk, message.rumor)} />
              {:else}
                {message.content}
              {/if}
            </div>
          </div>
          <!-- Timestamp -->
          <div class="text-xs text-neutral-500 px-2">
            {formatTime(message.timestamp)}
          </div>
        </div>
      </div>
    {/each}
  {/if}
</div>
<!-- Scroll to bottom button (when not auto-scrolling) -->
{#if !shouldAutoScroll && messages.length > 0}
  <button
    onclick={() => {
      shouldAutoScroll = true;
      scrollToBottom();
    }}
    class="fixed bottom-24 right-8 p-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-full shadow-lg transition-colors"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
    </svg>
  </button>
{/if}
</file>

<file path="messages/MessageComposer.svelte">
<script lang="ts">
  import type { NDKUser } from '@nostr-dev-kit/ndk';
  import { messagesStore } from '$lib/stores/messages.svelte';
  import { ndk } from '$lib/ndk.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  interface Props {
    recipient: NDKUser;
    onMessageSent?: () => void;
  }
  const { recipient, onMessageSent }: Props = $props();
  let message = $state('');
  let sending = $state(false);
  let textareaElement: HTMLTextAreaElement | null = $state(null);
  async function handleSend() {
    if (!message.trim() || sending) return;
    sending = true;
    try {
      await messagesStore.sendMessage(recipient.npub, message.trim());
      message = '';
      onMessageSent?.();
      // Reset textarea height
      if (textareaElement) {
        textareaElement.style.height = 'auto';
      }
    } catch (error) {
      console.error('Failed to send message:', error);
      toast.error('Failed to send message');
    } finally {
      sending = false;
    }
  }
  function handleKeyDown(e: KeyboardEvent) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  }
  function handleInput() {
    // Auto-resize textarea
    if (textareaElement) {
      textareaElement.style.height = 'auto';
      textareaElement.style.height = `${Math.min(textareaElement.scrollHeight, 200)}px`;
    }
  }
</script>
<div class="sticky bottom-0 border-t border-neutral-800/50 bg-black p-4">
  <div class="flex items-end gap-3">
    <div class="flex-1 relative">
      <textarea
        bind:this={textareaElement}
        bind:value={message}
        onkeydown={handleKeyDown}
        oninput={handleInput}
        placeholder="Type a message..."
        rows="1"
        class="w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none min-h-[48px] max-h-[200px]"
        disabled={sending}
      />
      <div class="absolute right-3 bottom-3 text-xs text-neutral-600">
        {message.length}
      </div>
    </div>
    <button
      onclick={handleSend}
      disabled={!message.trim() || sending}
      class="px-6 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 h-[48px]"
    >
      {#if sending}
        <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
        </svg>
      {:else}
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      {/if}
    </button>
  </div>
</div>
</file>

<file path="messages/NewMessageModal.svelte">
<script lang="ts">
  import { goto } from '$app/navigation';
  import { ndk } from '$lib/ndk.svelte';
  import type { NDKUser } from '@nostr-dev-kit/ndk';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import UserSelectableItem from '$lib/components/UserSelectableItem.svelte';
  interface Props {
    isOpen: boolean;
    onClose: () => void;
  }
  const { isOpen, onClose }: Props = $props();
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let searchQuery = $state('');
  let searching = $state(false);
  let searchResults = $state<NDKUser[]>([]);
  let selectedUser = $state<NDKUser | null>(null);
  async function handleSearch() {
    if (!searchQuery.trim()) {
      searchResults = [];
      return;
    }
    searching = true;
    try {
      // Try to parse as npub/nprofile first
      if (searchQuery.startsWith('npub') || searchQuery.startsWith('nprofile')) {
        try {
          const user = await ndk.fetchUser(searchQuery.trim());
          if (user) {
            searchResults = [user];
          } else {
            searchResults = [];
          }
        } catch (error) {
          console.error('Invalid npub:', error);
          searchResults = [];
        }
      }
      // Search by name using NDK's fetchUser
      else {
        try {
          const user = await ndk.fetchUser(searchQuery.trim());
          if (user) {
            searchResults = [user];
          } else {
            searchResults = [];
          }
        } catch (error) {
          console.error('Search error:', error);
          searchResults = [];
        }
      }
    } catch (error) {
      console.error('Search error:', error);
      searchResults = [];
    } finally {
      searching = false;
    }
  }
  function handleUserSelect(user: NDKUser) {
    selectedUser = user;
    goto(`/messages/${user.npub}`);
    onClose();
  }
  function handleKeyDown(e: KeyboardEvent) {
    if (e.key === 'Enter' && !searching) {
      handleSearch();
    }
  }
  // Auto-search as user types (debounced)
  let searchTimeout: ReturnType<typeof setTimeout> | null = null;
  $effect(() => {
    if (searchQuery.trim()) {
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        handleSearch();
      }, 500);
    } else {
      searchResults = [];
    }
    return () => {
      if (searchTimeout) clearTimeout(searchTimeout);
    };
  });
  // Focus search input when modal opens
  let searchInput: HTMLInputElement | null = $state(null);
  $effect(() => {
    if (isOpen && searchInput) {
      setTimeout(() => searchInput?.focus(), 100);
    }
  });
</script>
{#if isDesktop.current}
  <Dialog.Root open={isOpen} onOpenChange={(newOpen) => { if (!newOpen) onClose(); }}>
    <Dialog.Content class="max-w-md" onkeydown={handleKeyDown}>
      <Dialog.Header>
        <Dialog.Title>New Message</Dialog.Title>
      </Dialog.Header>
      <!-- Search -->
      <div class="mb-4">
        <div class="relative">
          <input
            bind:this={searchInput}
            bind:value={searchQuery}
            type="text"
            placeholder="Search by name or paste npub..."
            class="w-full px-4 py-3 pl-12 bg-card border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          />
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>
      <!-- Results -->
      <div class="max-h-96 overflow-y-auto">
        {#if searching}
          <div class="flex items-center justify-center py-12">
            <svg class="w-8 h-8 text-primary animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
          </div>
        {:else if searchQuery.trim() && searchResults.length === 0}
          <div class="flex flex-col items-center justify-center py-12 px-6 text-center">
            <svg class="w-16 h-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <p class="text-muted-foreground">No users found</p>
            <p class="text-sm text-muted-foreground/60 mt-1">Try a different search term</p>
          </div>
        {:else if searchResults.length > 0}
          <div class="divide-y divide-border">
            {#each searchResults as user (user.pubkey)}
              <UserSelectableItem
                {user}
                onClick={handleUserSelect}
                showArrow={true}
                size="lg"
              />
            {/each}
          </div>
        {:else}
          <div class="flex flex-col items-center justify-center py-12 px-6 text-center">
            <svg class="w-16 h-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <p class="text-muted-foreground">Search for someone to message</p>
            <p class="text-sm text-muted-foreground/60 mt-1">Enter a name or paste an npub</p>
          </div>
        {/if}
      </div>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={isOpen} onOpenChange={(newOpen) => { if (!newOpen) onClose(); }}>
    <Drawer.Content onkeydown={handleKeyDown}>
      <Drawer.Header class="text-left">
        <Drawer.Title>New Message</Drawer.Title>
      </Drawer.Header>
      <!-- Search -->
      <div class="px-4 mb-4">
        <div class="relative">
          <input
            bind:this={searchInput}
            bind:value={searchQuery}
            type="text"
            placeholder="Search by name or paste npub..."
            class="w-full px-4 py-3 pl-12 bg-card border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          />
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>
      <!-- Results -->
      <div class="overflow-y-auto pb-4">
        {#if searching}
          <div class="flex items-center justify-center py-12">
            <svg class="w-8 h-8 text-primary animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
          </div>
        {:else if searchQuery.trim() && searchResults.length === 0}
          <div class="flex flex-col items-center justify-center py-12 px-6 text-center">
            <svg class="w-16 h-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <p class="text-muted-foreground">No users found</p>
            <p class="text-sm text-muted-foreground/60 mt-1">Try a different search term</p>
          </div>
        {:else if searchResults.length > 0}
          <div class="divide-y divide-border">
            {#each searchResults as user (user.pubkey)}
              <UserSelectableItem
                {user}
                onClick={handleUserSelect}
                showArrow={true}
                size="lg"
              />
            {/each}
          </div>
        {:else}
          <div class="flex flex-col items-center justify-center py-12 px-6 text-center">
            <svg class="w-16 h-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <p class="text-muted-foreground">Search for someone to message</p>
            <p class="text-sm text-muted-foreground/60 mt-1">Enter a name or paste an npub</p>
          </div>
        {/if}
      </div>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="notifications/ActorList.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { navigateToProfile } from '$lib/utils/navigation';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkeys: string[];
    maxVisible?: number;
  }
  const { pubkeys, maxVisible = 2 }: Props = $props();
  let profilesMap = $state<Map<string, NDKUserProfile | null>>(new Map());
  $effect(() => {
    profilesMap.clear();
    const visiblePubkeys = pubkeys.slice(0, maxVisible);
    visiblePubkeys.forEach(pubkey => {
      ndk.fetchUser(pubkey).then(u => {
        u?.fetchProfile().then(p => {
          profilesMap.set(pubkey, p || null);
          profilesMap = new Map(profilesMap);
        });
      });
    });
  });
  const profiles = $derived(
    pubkeys.slice(0, maxVisible).map((pubkey) => ({
      pubkey,
      profile: profilesMap.get(pubkey),
    }))
  );
  const displayNames = $derived(
    profiles.map((p) => p.profile?.name || p.profile?.displayName || 'Anonymous')
  );
  const othersCount = $derived(Math.max(0, pubkeys.length - maxVisible));
  function handleProfileClick(pubkey: string, e: MouseEvent) {
    e.stopPropagation();
    navigateToProfile(pubkey);
  }
</script>
<span class="inline-flex items-center gap-1 flex-wrap">
  {#each profiles as { pubkey }, i}
    <button
      type="button"
      onclick={(e) => handleProfileClick(pubkey, e)}
      class="font-semibold hover:underline text-foreground"
    >
      {displayNames[i]}{#if i < profiles.length - 1 || othersCount > 0},{/if}
    </button>
  {/each}
  {#if othersCount > 0}
    <span class="text-muted-foreground">
      and {othersCount} {othersCount === 1 ? 'other' : 'others'}
    </span>
  {/if}
</span>
</file>

<file path="notifications/InviteAcceptanceNotification.svelte">
<script lang="ts">
	import type { InviteAcceptanceNotification } from '$lib/utils/useNotifications.svelte';
	import { ndk } from '$lib/ndk.svelte';
	import User from '../User.svelte';
	import FollowButton from '../FollowButton.svelte';
	import NotificationBase from './NotificationBase.svelte';
	import TimeAgo from '../TimeAgo.svelte';
	import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
	interface Props {
		notification: InviteAcceptanceNotification;
	}
	const { notification }: Props = $props();
	let profile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		ndk.fetchUser(notification.inviteePubkey).then(u => {
			u?.fetchProfile().then(p => { profile = p; });
		});
	});
	const follows = $derived(ndk.$sessions?.follows ?? new Set());
	const isFollowing = $derived.by(() => follows.has(notification.inviteePubkey));
</script>
<NotificationBase testId="invite-acceptance-notification" timestamp={notification.timestamp}>
	{#snippet avatar()}
		<div class="flex-1 min-w-0">
			<User
				pubkey={notification.inviteePubkey}
				variant="avatar-name-meta"
				avatarSize="w-10 h-10"
				nameSize="text-base font-semibold"
			>
				{#snippet meta()}
					<p class="text-sm text-muted-foreground">
						accepted your invite üéâ
					</p>
				{/snippet}
			</User>
		</div>
	{/snippet}
	{#snippet icon()}
		<svg
			class="w-4 h-4 text-green-500 flex-shrink-0"
			fill="none"
			stroke="currentColor"
			viewBox="0 0 24 24"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
			/>
		</svg>
	{/snippet}
	{#snippet message()}
		<!-- User component handles the name and message -->
	{/snippet}
	{#snippet content()}
		{#if profile?.about}
			<p class="text-sm text-muted-foreground mt-1 line-clamp-2 break-words ml-[54px]">
				{profile.about}
			</p>
		{/if}
		<div class="flex items-center gap-2 mt-2 ml-[54px]">
			{#if !isFollowing}
				<FollowButton pubkey={notification.inviteePubkey} variant="outline" />
			{/if}
		</div>
	{/snippet}
</NotificationBase>
</file>

<file path="notifications/MentionNotification.svelte">
<script lang="ts">
	import type { NDKEvent, NDKUserProfile } from '@nostr-dev-kit/ndk';
	import { Avatar, EventContent } from '@nostr-dev-kit/svelte';
	import { ndk } from '$lib/ndk.svelte';
	import { navigateToProfile } from '$lib/utils/navigation';
	import NotificationBase from './NotificationBase.svelte';
	interface Props {
		event: NDKEvent;
	}
	const { event }: Props = $props();
	let profile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		event.author.fetchProfile().then(p => { profile = p; });
	});
	const displayName = $derived(profile?.name || profile?.displayName || 'Anonymous');
	function handleProfileClick() {
		navigateToProfile(event.pubkey);
	}
</script>
<NotificationBase timestamp={event.created_at}>
	{#snippet avatar()}
		<button type="button" onclick={handleProfileClick} class="flex-shrink-0">
			<Avatar
				{ndk}
				pubkey={event.pubkey}
				class="w-10 h-10 cursor-pointer hover:opacity-80 transition-opacity"
			/>
		</button>
	{/snippet}
	{#snippet icon()}
		<svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"
			/>
		</svg>
	{/snippet}
	{#snippet message()}
		<button
			type="button"
			onclick={handleProfileClick}
			class="font-semibold hover:underline text-foreground"
		>
			{displayName}
		</button>
		mentioned you
	{/snippet}
	{#snippet content()}
		<div class="text-foreground leading-relaxed break-words">
			<EventContent {ndk} content={event.content} emojiTags={event.tags} />
		</div>
	{/snippet}
</NotificationBase>
</file>

<file path="notifications/NotificationBase.svelte">
<script lang="ts">
	import TimeAgo from '../TimeAgo.svelte';
	import type { Snippet } from 'svelte';
	interface Props {
		avatar: Snippet;
		icon?: Snippet;
		message: Snippet;
		timestamp?: number;
		content?: Snippet;
		preview?: string;
		previewColor?: string;
		testId?: string;
	}
	const { avatar, icon, message, timestamp, content, preview, previewColor, testId }: Props =
		$props();
</script>
<div
	data-testid={testId}
	class="flex gap-3 p-4 hover:bg-muted/50 transition-colors border-b border-border"
>
	<div class="flex-shrink-0">
		{@render avatar()}
	</div>
	<div class="flex-1 min-w-0">
		<div class="flex items-center gap-2 mb-1 flex-wrap">
			{#if icon}
				{@render icon()}
			{/if}
			<span class="text-sm text-muted-foreground">
				{@render message()}
			</span>
			{#if timestamp}
				<TimeAgo {timestamp} class="text-sm text-muted-foreground ml-auto" />
			{/if}
		</div>
		{#if content}
			{@render content()}
		{/if}
		{#if preview}
			<div
				class="text-sm text-muted-foreground bg-muted/30 rounded p-2 border-l-2 border-{previewColor}/50 break-words"
			>
				{preview}
			</div>
		{/if}
	</div>
</div>
</file>

<file path="notifications/NotificationItem.svelte">
<script lang="ts">
  import type { NotificationGroup } from '$lib/utils/useNotifications.svelte';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import ReplyNotification from './ReplyNotification.svelte';
  import MentionNotification from './MentionNotification.svelte';
  import QuoteNotification from './QuoteNotification.svelte';
  import ReactionNotification from './ReactionNotification.svelte';
  import RepostNotification from './RepostNotification.svelte';
  import ZapNotification from './ZapNotification.svelte';
  import InviteAcceptanceNotification from './InviteAcceptanceNotification.svelte';
  interface Props {
    notification: NotificationGroup;
    targetEventsCache: Map<string, NDKEvent>;
  }
  const { notification, targetEventsCache }: Props = $props();
  // Get target event from cache
  const targetEvent = $derived.by(() => {
    if (notification.type === 'reply') {
      return targetEventsCache.get(notification.replyToEventId);
    } else if (notification.type === 'quote') {
      return targetEventsCache.get(notification.quotedEventId);
    } else if (notification.type === 'reaction' || notification.type === 'repost' || notification.type === 'zap') {
      return targetEventsCache.get(notification.targetEventId);
    }
    return undefined;
  });
</script>
{#if notification.type === 'reply'}
  <ReplyNotification event={notification.event} {targetEvent} />
{:else if notification.type === 'mention'}
  <MentionNotification event={notification.event} />
{:else if notification.type === 'quote'}
  <QuoteNotification event={notification.event} {targetEvent} />
{:else if notification.type === 'reaction'}
  <ReactionNotification
    emoji={notification.emoji}
    reactors={notification.reactors}
    {targetEvent}
    timestamp={notification.timestamp}
  />
{:else if notification.type === 'repost'}
  <RepostNotification reposts={notification.reposts} {targetEvent} timestamp={notification.timestamp} />
{:else if notification.type === 'zap'}
  <ZapNotification zaps={notification.zaps} {targetEvent} timestamp={notification.timestamp} />
{:else if notification.type === 'invite_acceptance'}
  <InviteAcceptanceNotification notification={notification} />
{/if}
</file>

<file path="notifications/QuoteNotification.svelte">
<script lang="ts">
	import type { NDKEvent, NDKUserProfile } from '@nostr-dev-kit/ndk';
	import { Avatar, EventContent } from '@nostr-dev-kit/svelte';
	import { ndk } from '$lib/ndk.svelte';
	import { navigateToProfile } from '$lib/utils/navigation';
	import { truncateContent } from '$lib/utils/contentPreview';
	import NotificationBase from './NotificationBase.svelte';
	interface Props {
		event: NDKEvent;
		targetEvent?: NDKEvent;
	}
	const { event, targetEvent }: Props = $props();
	let profile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		event.author.fetchProfile().then(p => { profile = p; });
	});
	const displayName = $derived(profile?.name || profile?.displayName || 'Anonymous');
	function handleProfileClick() {
		navigateToProfile(event.pubkey);
	}
	const originalPreview = $derived(truncateContent(targetEvent?.content ?? ''));
</script>
<NotificationBase timestamp={event.created_at} preview={originalPreview} previewColor="purple-500">
	{#snippet avatar()}
		<button type="button" onclick={handleProfileClick} class="flex-shrink-0">
			<Avatar
				{ndk}
				pubkey={event.pubkey}
				class="w-10 h-10 cursor-pointer hover:opacity-80 transition-opacity"
			/>
		</button>
	{/snippet}
	{#snippet icon()}
		<svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
			/>
		</svg>
	{/snippet}
	{#snippet message()}
		<button
			type="button"
			onclick={handleProfileClick}
			class="font-semibold hover:underline text-foreground"
		>
			{displayName}
		</button>
		quoted your note
	{/snippet}
	{#snippet content()}
		<div class="text-foreground leading-relaxed mb-2 break-words">
			<EventContent {ndk} content={event.content} emojiTags={event.tags} />
		</div>
	{/snippet}
</NotificationBase>
</file>

<file path="notifications/ReactionNotification.svelte">
<script lang="ts">
	import type { NDKEvent } from '@nostr-dev-kit/ndk';
	import { truncateContent } from '$lib/utils/contentPreview';
	import ActorList from './ActorList.svelte';
	import NotificationBase from './NotificationBase.svelte';
	interface Props {
		emoji: string;
		reactors: Array<{ pubkey: string; event: NDKEvent }>;
		targetEvent?: NDKEvent;
		timestamp: number;
	}
	const { emoji, reactors, targetEvent, timestamp }: Props = $props();
	const actorPubkeys = $derived(reactors.map((r) => r.pubkey));
	const originalPreview = $derived(truncateContent(targetEvent?.content ?? ''));
</script>
<NotificationBase {timestamp} preview={originalPreview} previewColor="red-500">
	{#snippet avatar()}
		<div class="flex-shrink-0 w-10 h-10 flex items-center justify-center text-2xl">
			{emoji}
		</div>
	{/snippet}
	{#snippet icon()}
		<svg
			class="w-4 h-4 text-red-500 flex-shrink-0"
			fill="none"
			stroke="currentColor"
			viewBox="0 0 24 24"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
			/>
		</svg>
	{/snippet}
	{#snippet message()}
		<ActorList pubkeys={actorPubkeys} maxVisible={2} />
		{reactors.length === 1 ? 'reacted' : 'reacted'}
		<span class="text-lg mx-1">{emoji}</span>
		to your note
	{/snippet}
</NotificationBase>
</file>

<file path="notifications/ReplyNotification.svelte">
<script lang="ts">
	import type { NDKEvent, NDKUserProfile } from '@nostr-dev-kit/ndk';
	import { Avatar, EventContent } from '@nostr-dev-kit/svelte';
	import { ndk } from '$lib/ndk.svelte';
	import { navigateToProfile } from '$lib/utils/navigation';
	import { truncateContent } from '$lib/utils/contentPreview';
	import NotificationBase from './NotificationBase.svelte';
	interface Props {
		event: NDKEvent;
		targetEvent?: NDKEvent;
	}
	const { event, targetEvent }: Props = $props();
	let profile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		event.author.fetchProfile().then(p => { profile = p; });
	});
	const displayName = $derived(profile?.name || profile?.displayName || 'Anonymous');
	function handleProfileClick() {
		navigateToProfile(event.pubkey);
	}
	const originalPreview = $derived(truncateContent(targetEvent?.content ?? ''));
</script>
<NotificationBase timestamp={event.created_at} preview={originalPreview} previewColor="primary">
	{#snippet avatar()}
		<button type="button" onclick={handleProfileClick} class="flex-shrink-0">
			<Avatar
				{ndk}
				pubkey={event.pubkey}
				class="w-10 h-10 cursor-pointer hover:opacity-80 transition-opacity"
			/>
		</button>
	{/snippet}
	{#snippet icon()}
		<svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
			/>
		</svg>
	{/snippet}
	{#snippet message()}
		<button
			type="button"
			onclick={handleProfileClick}
			class="font-semibold hover:underline text-foreground"
		>
			{displayName}
		</button>
		replied to your note
	{/snippet}
	{#snippet content()}
		<div class="text-foreground leading-relaxed mb-2 break-words">
			<EventContent {ndk} content={event.content} emojiTags={event.tags} />
		</div>
	{/snippet}
</NotificationBase>
</file>

<file path="notifications/RepostNotification.svelte">
<script lang="ts">
	import type { NDKEvent } from '@nostr-dev-kit/ndk';
	import { truncateContent } from '$lib/utils/contentPreview';
	import ActorList from './ActorList.svelte';
	import NotificationBase from './NotificationBase.svelte';
	interface Props {
		reposts: NDKEvent[];
		targetEvent?: NDKEvent;
		timestamp: number;
	}
	const { reposts, targetEvent, timestamp }: Props = $props();
	const actorPubkeys = $derived(reposts.map((r) => r.pubkey));
	const originalPreview = $derived(truncateContent(targetEvent?.content ?? ''));
</script>
<NotificationBase {timestamp} preview={originalPreview} previewColor="green-500">
	{#snippet avatar()}
		<div class="flex-shrink-0 w-10 h-10 flex items-center justify-center">
			<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
				/>
			</svg>
		</div>
	{/snippet}
	{#snippet message()}
		<ActorList pubkeys={actorPubkeys} maxVisible={2} />
		{reposts.length === 1 ? 'reposted' : 'reposted'}
		your note
	{/snippet}
</NotificationBase>
</file>

<file path="notifications/ZapNotification.svelte">
<script lang="ts">
	import type { NDKEvent } from '@nostr-dev-kit/ndk';
	import { truncateContent } from '$lib/utils/contentPreview';
	import ActorList from './ActorList.svelte';
	import NotificationBase from './NotificationBase.svelte';
	interface Props {
		zaps: Array<{ event: NDKEvent; amount: number; sender: string }>;
		targetEvent?: NDKEvent;
		timestamp: number;
	}
	const { zaps, targetEvent, timestamp }: Props = $props();
	const actorPubkeys = $derived(zaps.map((z) => z.sender));
	const totalAmount = $derived(zaps.reduce((sum, z) => sum + z.amount, 0));
	const formattedAmount = $derived(totalAmount.toLocaleString());
	const originalPreview = $derived(truncateContent(targetEvent?.content ?? ''));
</script>
<NotificationBase {timestamp} preview={originalPreview} previewColor="yellow-500">
	{#snippet avatar()}
		<div class="flex-shrink-0 w-10 h-10 flex items-center justify-center">
			<svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
				<path d="M13 10V3L4 14h7v7l9-11h-7z" />
			</svg>
		</div>
	{/snippet}
	{#snippet message()}
		<ActorList pubkeys={actorPubkeys} maxVisible={2} />
		{zaps.length === 1 ? 'zapped' : 'zapped'}
		<span class="font-semibold text-yellow-600 dark:text-yellow-400 mx-1">
			{formattedAmount} sats
		</span>
		{#if targetEvent}
			to your note
		{:else}
			to you
		{/if}
	{/snippet}
</NotificationBase>
</file>

<file path="onboarding/PictureUpload.svelte">
<script lang="ts">
  import { NDKBlossom } from '@nostr-dev-kit/blossom';
  import { createBlossomUpload } from '@nostr-dev-kit/svelte';
  import type { NDK } from '@nostr-dev-kit/ndk';
  interface Props {
    ndk: NDK;
    onUploadComplete: (url: string) => void;
    currentImageUrl?: string;
    fallbackInitials?: string;
  }
  let { ndk, onUploadComplete, currentImageUrl, fallbackInitials }: Props = $props();
  const blossom = new NDKBlossom(ndk);
  const upload = createBlossomUpload(blossom);
  let fileInput: HTMLInputElement;
  let previewUrl = $state<string | null>(currentImageUrl || null);
  let isDragging = $state(false);
  async function handleFileSelect(file: File) {
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }
    // Show preview immediately
    const reader = new FileReader();
    reader.onload = (e) => {
      previewUrl = e.target?.result as string;
    };
    reader.readAsDataURL(file);
    try {
      await upload.upload(file, {
        fallbackServer: 'https://blossom.primal.net'
      });
      if (upload.result?.url) {
        onUploadComplete(upload.result.url);
      }
    } catch (error) {
      console.error('Upload failed:', error);
      previewUrl = null;
    }
  }
  function handleFileInputChange(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (file) {
      handleFileSelect(file);
    }
  }
  function handleDragOver(event: DragEvent) {
    event.preventDefault();
    isDragging = true;
  }
  function handleDragLeave() {
    isDragging = false;
  }
  async function handleDrop(event: DragEvent) {
    event.preventDefault();
    isDragging = false;
    const file = event.dataTransfer?.files[0];
    if (file) {
      await handleFileSelect(file);
    }
  }
  function triggerFileInput() {
    fileInput?.click();
  }
</script>
<div class="w-full">
  <input
    bind:this={fileInput}
    type="file"
    accept="image/*"
    onchange={handleFileInputChange}
    class="hidden"
  />
  <div
    role="button"
    tabindex="0"
    onclick={triggerFileInput}
    onkeydown={(e) => e.key === 'Enter' && triggerFileInput()}
    ondragover={handleDragOver}
    ondragleave={handleDragLeave}
    ondrop={handleDrop}
    class={`
      relative w-32 h-32 rounded-full overflow-hidden cursor-pointer
      border-4 border-background
      transition-all duration-200
      ${isDragging ? 'scale-105 border-foreground' : ''}
      ${upload.status === 'uploading' ? 'pointer-events-none' : ''}
    `}
  >
    {#if previewUrl && upload.status !== 'uploading'}
      <img
        src={previewUrl}
        alt="Profile"
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-background/0 hover:bg-background/40 transition-all flex items-center justify-center opacity-0 hover:opacity-100">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
      </div>
    {:else if upload.status === 'uploading'}
      <div class="w-full h-full bg-neutral-100 dark:bg-muted flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border border-t-neutral-900 dark:border-t-white rounded-full animate-spin"></div>
        {#if upload.progress}
          <p class="text-xs mt-2 text-muted-foreground">{upload.progress.percentage}%</p>
        {/if}
      </div>
    {:else}
      <div class="w-full h-full bg-card dark:bg-white text-foreground dark:text-black hover:bg-muted dark:hover:bg-neutral-100 transition-colors flex flex-col items-center justify-center gap-2 group">
        {#if fallbackInitials}
          <span class="text-3xl font-bold group-hover:opacity-50 transition-opacity">
            {fallbackInitials}
          </span>
          <div class="opacity-0 group-hover:opacity-100 transition-opacity absolute inset-0 flex items-center justify-center bg-background/40">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg>
          </div>
        {:else}
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-muted-foreground">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
            <circle cx="12" cy="13" r="4"></circle>
          </svg>
        {/if}
      </div>
    {/if}
  </div>
  {#if upload.status === 'error'}
    <p class="text-xs text-red-600 dark:text-red-400 mt-2 text-center">
      {upload.error?.message || 'Upload failed'}
    </p>
  {/if}
</div>
</file>

<file path="settings/BlossomSettings.svelte">
<script lang="ts">
  import { toast } from '$lib/stores/toast.svelte';
  import { ndk } from '$lib/ndk.svelte';
  import { NDKBlossomList, NDKKind } from '@nostr-dev-kit/ndk';
  const DEFAULT_SERVERS = [
    'https://blossom.primal.net',
    'https://blossom.nostr.hu',
    'https://blossom.oxtr.dev'
  ];
  let blossomListEvent = $state<NDKBlossomList | null>(null);
  let servers = $state<string[]>([]);
  let pendingServers = $state<string[]>([]);
  let newServer = $state('');
  let isAddingServer = $state(false);
  let isLoading = $state(true);
  let isSaving = $state(false);
  // Computed state to check if there are unsaved changes
  let hasChanges = $derived.by(() => {
    if (!blossomListEvent) return servers.length > 0 && pendingServers.length > 0;
    const savedServers = blossomListEvent.servers;
    if (savedServers.length !== pendingServers.length) return true;
    return !savedServers.every((server, index) => server === pendingServers[index]);
  });
  // Load the user's blossom list on mount
  $effect(() => {
    loadBlossomList();
  });
  async function loadBlossomList() {
    isLoading = true;
    try {
      const user = ndk.activeUser;
      if (!user) {
        // No user logged in, use localStorage fallback
        const stored = localStorage.getItem('blossomServers');
        if (stored) {
          try {
            servers = JSON.parse(stored);
            pendingServers = [...servers];
          } catch {
            servers = [DEFAULT_SERVERS[0]];
            pendingServers = [...servers];
          }
        } else {
          servers = [DEFAULT_SERVERS[0]];
          pendingServers = [...servers];
        }
        isLoading = false;
        return;
      }
      // Fetch the user's blossom list event
      const filter = {
        kinds: [NDKKind.BlossomList],
        authors: [user.pubkey]
      };
      const event = await ndk.fetchEvent(filter);
      if (event) {
        blossomListEvent = NDKBlossomList.from(event);
        servers = blossomListEvent.servers;
        pendingServers = [...servers];
        // Save to localStorage as backup
        localStorage.setItem('blossomServers', JSON.stringify(servers));
      } else {
        // Create a new blossom list event
        blossomListEvent = new NDKBlossomList(ndk);
        // Check localStorage for existing servers
        const stored = localStorage.getItem('blossomServers');
        if (stored) {
          try {
            servers = JSON.parse(stored);
          } catch {
            servers = [DEFAULT_SERVERS[0]];
          }
        } else {
          servers = [DEFAULT_SERVERS[0]];
        }
        pendingServers = [...servers];
        blossomListEvent.servers = servers;
      }
    } catch (error) {
      console.error('Failed to load blossom list:', error);
      toast.error('Failed to load your Blossom servers');
      // Fallback to localStorage
      const stored = localStorage.getItem('blossomServers');
      if (stored) {
        try {
          servers = JSON.parse(stored);
          pendingServers = [...servers];
        } catch {
          servers = [DEFAULT_SERVERS[0]];
          pendingServers = [...servers];
        }
      } else {
        servers = [DEFAULT_SERVERS[0]];
        pendingServers = [...servers];
      }
    } finally {
      isLoading = false;
    }
  }
  async function saveChanges() {
    if (!hasChanges || isSaving) return;
    isSaving = true;
    try {
      if (!ndk.activeUser) {
        // No user logged in, save to localStorage only
        servers = [...pendingServers];
        localStorage.setItem('blossomServers', JSON.stringify(servers));
        toast.success('Servers saved locally');
        return;
      }
      if (!blossomListEvent) {
        blossomListEvent = new NDKBlossomList(ndk);
      }
      blossomListEvent.servers = pendingServers;
      await blossomListEvent.sign();
      await blossomListEvent.publishReplaceable();
      servers = [...pendingServers];
      localStorage.setItem('blossomServers', JSON.stringify(servers));
      toast.success('Blossom servers saved to Nostr');
    } catch (error) {
      console.error('Failed to save blossom list:', error);
      toast.error('Failed to save Blossom servers to Nostr');
    } finally {
      isSaving = false;
    }
  }
  function addServer() {
    if (!newServer.trim()) return;
    try {
      const url = new URL(newServer.trim());
      if (!url.protocol.startsWith('http')) {
        toast.error('Please enter a valid HTTP or HTTPS URL');
        return;
      }
      const cleanUrl = url.origin + url.pathname.replace(/\/$/, '');
      if (pendingServers.includes(cleanUrl)) {
        toast.error('This server is already in your list');
        return;
      }
      pendingServers = [...pendingServers, cleanUrl];
      newServer = '';
      isAddingServer = false;
    } catch {
      toast.error('Please enter a valid URL');
    }
  }
  function removeServer(serverToRemove: string) {
    if (pendingServers.length === 1) {
      toast.error('You must have at least one Blossom server');
      return;
    }
    pendingServers = pendingServers.filter(s => s !== serverToRemove);
  }
  function moveServerUp(index: number) {
    if (index === 0) return;
    const newServers = [...pendingServers];
    [newServers[index - 1], newServers[index]] = [newServers[index], newServers[index - 1]];
    pendingServers = newServers;
  }
  function moveServerDown(index: number) {
    if (index === pendingServers.length - 1) return;
    const newServers = [...pendingServers];
    [newServers[index], newServers[index + 1]] = [newServers[index + 1], newServers[index]];
    pendingServers = newServers;
  }
  function discardChanges() {
    pendingServers = [...servers];
  }
</script>
<div class="space-y-6">
  <div>
    <h3 class="text-lg font-semibold mb-2">Blossom Media Servers</h3>
    <p class="text-sm text-muted-foreground mb-4">
      Configure your Blossom servers for uploading images and media. The first server is your primary upload destination, and additional servers are used as mirrors for redundancy.
    </p>
  </div>
  <!-- Save/Discard buttons when there are changes -->
  {#if hasChanges}
    <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg">
      <div class="flex items-center space-x-2 text-sm text-orange-800 dark:text-orange-200">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>You have unsaved changes</span>
      </div>
      <div class="flex space-x-2">
        <button
          onclick={discardChanges}
          disabled={isSaving}
          class="px-3 py-1.5 text-sm border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Discard
        </button>
        <button
          onclick={saveChanges}
          disabled={isSaving}
          class="px-3 py-1.5 text-sm bg-primary hover:bg-accent-dark text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
        >
          {#if isSaving}
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Saving...</span>
          {:else}
            <span>Save Changes</span>
          {/if}
        </button>
      </div>
    </div>
  {/if}
  <!-- Current servers -->
  <div class="space-y-3">
    <label class="text-sm font-medium">Your Blossom Servers</label>
    {#if isLoading}
      <div class="flex items-center justify-center p-8">
        <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    {:else}
      <div class="space-y-2">
        {#each pendingServers as server, index (server)}
          <div class="flex items-center justify-between p-3 bg-neutral-50 dark:bg-background rounded-lg">
            <div class="flex items-center space-x-3">
              <div class="flex flex-col space-y-1">
                <button
                  onclick={() => moveServerUp(index)}
                  disabled={index === 0}
                  class="text-muted-foreground hover:text-muted-foreground dark:hover:text-muted-foreground disabled:opacity-30 disabled:cursor-not-allowed p-0.5"
                  aria-label="Move up"
                >
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                  </svg>
                </button>
                <button
                  onclick={() => moveServerDown(index)}
                  disabled={index === pendingServers.length - 1}
                  class="text-muted-foreground hover:text-muted-foreground dark:hover:text-muted-foreground disabled:opacity-30 disabled:cursor-not-allowed p-0.5"
                  aria-label="Move down"
                >
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
              </div>
              <div>
                <div class="flex items-center space-x-2">
                  <span class="font-medium">{server}</span>
                  {#if index === 0}
                    <span class="text-xs bg-primary-100 dark:bg-primary-900/50 text-primary dark:text-primary-300 px-2 py-0.5 rounded">
                      Primary
                    </span>
                  {/if}
                </div>
                <a
                  href={server}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm text-muted-foreground hover:text-primary dark:hover:text-primary flex items-center space-x-1"
                >
                  <span>Visit server</span>
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </a>
              </div>
            </div>
            {#if pendingServers.length > 1}
              <button
                onclick={() => removeServer(server)}
                class="text-red-500 hover:text-red-600 p-2"
                aria-label="Remove server"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
  </div>
  <!-- Add server -->
  {#if isAddingServer}
    <div class="border border rounded-lg p-4">
      <label for="new-server" class="block text-sm font-medium mb-2">Add Blossom Server</label>
      <div class="flex space-x-2">
        <input
          id="new-server"
          type="text"
          bind:value={newServer}
          placeholder="https://blossom.example.com"
          onkeypress={(e) => e.key === 'Enter' && addServer()}
          class="flex-1 px-3 py-2 bg-card border border dark:border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
        />
        <button
          onclick={addServer}
          class="px-4 py-2 bg-primary hover:bg-accent-dark text-foreground rounded-lg transition-colors"
        >
          Add
        </button>
        <button
          onclick={() => {
            isAddingServer = false;
            newServer = '';
          }}
          class="p-2 text-muted-foreground hover:text-neutral-700 dark:hover:text-muted-foreground"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  {:else}
    <button
      onclick={() => isAddingServer = true}
      class="flex items-center space-x-2 px-4 py-2 text-primary dark:text-primary hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-colors"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      <span>Add Server</span>
    </button>
  {/if}
  <!-- Suggested servers -->
  <div class="border-t border pt-4">
    <label class="text-sm font-medium block mb-3">Suggested Servers</label>
    <p class="text-sm text-muted-foreground mb-3">
      Popular public Blossom servers you can add to your list
    </p>
    <div class="space-y-2">
      {#each DEFAULT_SERVERS.filter(s => !pendingServers.includes(s)) as server}
        <div class="flex items-center justify-between p-3 bg-neutral-50 dark:bg-background rounded-lg">
          <span class="text-sm">{server}</span>
          <button
            onclick={() => pendingServers = [...pendingServers, server]}
            class="text-sm text-primary dark:text-primary hover:text-accent-dark dark:hover:text-primary-300"
          >
            Add
          </button>
        </div>
      {/each}
      {#if DEFAULT_SERVERS.every(s => pendingServers.includes(s))}
        <p class="text-sm text-muted-foreground">
          All suggested servers have been added
        </p>
      {/if}
    </div>
  </div>
</div>
</file>

<file path="settings/DebugSettings.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import type { NDKCacheAdapterSqliteWasm, CacheStats } from '@nostr-dev-kit/cache-sqlite-wasm';
  let stats = $state<CacheStats | null>(null);
  let loading = $state(true);
  let error = $state<string | null>(null);
  async function loadCacheStats() {
    loading = true;
    error = null;
    try {
      const cacheAdapter = ndk.cacheAdapter as NDKCacheAdapterSqliteWasm;
      if (!cacheAdapter) {
        throw new Error('Cache adapter not found');
      }
      if (!cacheAdapter.getCacheStats) {
        throw new Error('getCacheStats method not available');
      }
      stats = await cacheAdapter.getCacheStats();
    } catch (e) {
      error = e instanceof Error ? e.message : 'Unknown error occurred';
      console.error('Failed to load cache stats:', e);
    } finally {
      loading = false;
    }
  }
  $effect(() => {
    loadCacheStats();
  });
  function getKindName(kind: number): string {
    const kindNames: Record<number, string> = {
      0: 'Profile Metadata',
      1: 'Short Text Note',
      3: 'Contacts',
      4: 'Encrypted DM',
      5: 'Event Deletion',
      6: 'Repost',
      7: 'Reaction',
      9735: 'Zap',
      9321: 'NIP-61 Nutzap',
      10000: 'Mute List',
      10002: 'Relay List',
      30000: 'People List',
      30008: 'Profile Badges',
      30009: 'Badge Definition',
      37375: 'NIP-60 Wallet',
      7375: 'Cashu Token',
    };
    return kindNames[kind] || `Kind ${kind}`;
  }
</script>
<div class="space-y-6">
  <!-- Header with refresh button -->
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-lg font-semibold text-foreground">Cache Statistics</h2>
      <p class="text-sm text-muted-foreground mt-1">
        Local database cache information
      </p>
    </div>
    <button
      onclick={loadCacheStats}
      class="p-2 hover:bg-neutral-200/50 dark:hover:bg-muted/30 rounded-lg transition-all"
      title="Refresh"
    >
      <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    </button>
  </div>
  {#if loading}
    <div class="flex flex-col items-center justify-center py-12 gap-3">
      <div class="w-10 h-10 border-4 border border-t-orange-500 rounded-full animate-spin"></div>
      <p class="text-sm text-muted-foreground">Loading cache statistics...</p>
    </div>
  {:else if error}
    <div class="flex flex-col items-center justify-center py-12 gap-3">
      <p class="text-sm text-red-500">‚ùå {error}</p>
      <button
        onclick={loadCacheStats}
        class="px-4 py-2 bg-primary/10 border border-primary/30 rounded-lg text-sm text-primary hover:bg-primary/20 transition-all"
      >
        Retry
      </button>
    </div>
  {:else if stats}
    <div class="space-y-6">
      <!-- Overview Section -->
      <div>
        <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">
          Cache Overview
        </h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.totalEvents.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Total Events
            </div>
          </div>
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.totalProfiles.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Profiles
            </div>
          </div>
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.totalEventTags.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Event Tags
            </div>
          </div>
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.eventRelays.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Event-Relay Links
            </div>
          </div>
        </div>
      </div>
      <!-- Events by Kind Section -->
      <div>
        <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">
          Events by Kind
        </h3>
        <div class="space-y-2">
          {#each Object.entries(stats.eventsByKind).sort((a, b) => b[1] - a[1]) as [kind, count]}
            <div class="bg-neutral-100 dark:bg-card border border rounded-lg p-3 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="font-mono text-sm text-primary font-semibold min-w-[3rem]">
                  {kind}
                </span>
                <span class="text-sm text-muted-foreground">
                  {getKindName(Number(kind))}
                </span>
              </div>
              <div class="text-sm font-semibold text-foreground">
                {count.toLocaleString()}
              </div>
            </div>
          {/each}
        </div>
      </div>
      <!-- Other Tables Section -->
      <div>
        <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">
          Other Cache Tables
        </h3>
        <div class="grid grid-cols-3 gap-3">
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.totalDecryptedEvents.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Decrypted Events
            </div>
          </div>
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.totalUnpublishedEvents.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Unpublished Events
            </div>
          </div>
          <div class="bg-neutral-100 dark:bg-card border border rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary mb-1">
              {stats.cacheData.toLocaleString()}
            </div>
            <div class="text-xs text-muted-foreground font-medium">
              Cache Data
            </div>
          </div>
        </div>
      </div>
    </div>
  {/if}
</div>
</file>

<file path="settings/DMRelaySettings.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { messagesStore } from '$lib/stores/messages.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { NDKKind } from '@nostr-dev-kit/ndk';
  let activeUser = $derived(ndk.$currentUser);
  let saving = $state(false);
  let newRelay = $state('');
  let relays = $state<string[]>([]);
  // Reactively fetch DM relay list
  const dmRelayEvents = ndk.$fetchEvents(() => activeUser ? {
    filters: {
      kinds: [NDKKind.DirectMessageReceiveRelayList],
      authors: [activeUser.pubkey],
      limit: 1
    }
  } : undefined);
  // Update relays when event loads
  $effect(() => {
    const event = dmRelayEvents[0];
    if (event) {
      relays = event.tags
        .filter(tag => tag[0] === 'relay')
        .map(tag => tag[1])
        .filter(url => url);
    }
  });
  async function saveRelays() {
    if (!ndk.activeUser) return;
    try {
      saving = true;
      const messenger = messagesStore.getMessenger();
      if (messenger) {
        await messenger.publishDMRelays(relays);
      } else {
        throw new Error('Messenger not initialized');
      }
      toast.success('DM relays updated successfully');
    } catch (error) {
      console.error('Failed to update DM relays:', error);
      toast.error('Failed to update DM relays');
    } finally {
      saving = false;
    }
  }
  function addRelay() {
    const url = newRelay.trim();
    if (!url) return;
    // Basic URL validation
    if (!url.startsWith('wss://') && !url.startsWith('ws://')) {
      toast.error('Relay URL must start with wss:// or ws://');
      return;
    }
    // Check if already added
    if (relays.includes(url)) {
      toast.error('Relay already added');
      return;
    }
    // NIP-17 recommends 1-3 relays
    if (relays.length >= 3) {
      toast.error('Maximum 3 relays recommended per NIP-17');
      return;
    }
    relays = [...relays, url];
    newRelay = '';
  }
  function removeRelay(url: string) {
    relays = relays.filter(r => r !== url);
  }
</script>
<div class="space-y-6">
  <!-- Header -->
  <div>
    <h3 class="text-lg font-semibold text-white mb-2">DM Relay Settings</h3>
    <p class="text-sm text-neutral-400">
      Configure which relays to use for direct messages. Per NIP-17, it's recommended to keep this list small (1-3 relays).
    </p>
  </div>
  {#if !activeUser}
    <!-- Loading state -->
    <div class="flex items-center justify-center py-8">
      <svg class="w-6 h-6 text-primary animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
      </svg>
    </div>
  {:else}
    <!-- Add relay input -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-neutral-300">
        Add DM Relay
      </label>
      <div class="flex gap-2">
        <input
          type="text"
          bind:value={newRelay}
          onkeydown={(e) => e.key === 'Enter' && addRelay()}
          placeholder="wss://relay.example.com"
          class="flex-1 px-4 py-2 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
        />
        <button
          onclick={addRelay}
          disabled={!newRelay.trim() || relays.length >= 3}
          class="px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Add
        </button>
      </div>
      {#if relays.length >= 3}
        <p class="text-xs text-orange-500">
          Maximum of 3 relays recommended (you have {relays.length})
        </p>
      {:else}
        <p class="text-xs text-neutral-500">
          {3 - relays.length} more relay{relays.length === 2 ? '' : 's'} can be added
        </p>
      {/if}
    </div>
    <!-- Current relays -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-neutral-300">
        Current DM Relays ({relays.length})
      </label>
      {#if relays.length === 0}
        <div class="p-4 bg-neutral-900 border border-neutral-800 rounded-lg text-center">
          <p class="text-neutral-500 text-sm">
            No DM relays configured. Add at least one relay to receive direct messages.
          </p>
        </div>
      {:else}
        <div class="space-y-2">
          {#each relays as relay}
            <div class="flex items-center justify-between p-3 bg-neutral-900 border border-neutral-800 rounded-lg">
              <div class="flex-1 min-w-0">
                <p class="text-sm text-white truncate">{relay}</p>
              </div>
              <button
                onclick={() => removeRelay(relay)}
                class="ml-3 p-1.5 hover:bg-neutral-800 rounded transition-colors text-neutral-400 hover:text-red-500"
                title="Remove relay"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          {/each}
        </div>
      {/if}
    </div>
    <!-- Save button -->
    <div class="flex items-center justify-between pt-4 border-t border-neutral-800">
      <p class="text-xs text-neutral-500">
        Changes will be published to your relays
      </p>
      <button
        onclick={saveRelays}
        disabled={saving || relays.length === 0}
        class="px-6 py-2 bg-primary hover:bg-primary/90 text-primary-foreground font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {#if saving}
          Saving...
        {:else}
          Save Changes
        {/if}
      </button>
    </div>
  {/if}
</div>
</file>

<file path="settings/HashtagSettings.svelte">
<script lang="ts">
  import { hashtagInterests } from '$lib/ndk.svelte';
  let newHashtag = $state('');
  let isAdding = $state(false);
  let error = $state<string | null>(null);
  async function addHashtag() {
    if (!newHashtag.trim()) return;
    isAdding = true;
    error = null;
    try {
      const hashtag = newHashtag.trim().replace(/^#/, ''); // Remove leading # if present
      await hashtagInterests.addHashtag(hashtag);
      newHashtag = '';
    } catch (err) {
      error = err instanceof Error ? err.message : 'Failed to add hashtag';
    } finally {
      isAdding = false;
    }
  }
  async function removeHashtag(hashtag: string) {
    try {
      await hashtagInterests.removeHashtag(hashtag);
    } catch (err) {
      error = err instanceof Error ? err.message : 'Failed to remove hashtag';
    }
  }
  function handleKeyDown(e: KeyboardEvent) {
    if (e.key === 'Enter') {
      e.preventDefault();
      addHashtag();
    }
  }
</script>
<div class="space-y-6">
  <!-- Description -->
  <div class="text-sm text-muted-foreground">
    <p>Follow hashtags to see related content in your home feed. Your followed hashtags will appear as filters at the top of your home page.</p>
  </div>
  <!-- Add New Hashtag -->
  <div class="space-y-3">
    <label class="block">
      <span class="text-sm font-medium text-muted-foreground mb-2 block">Add Hashtag</span>
      <div class="flex gap-2">
        <div class="relative flex-1">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-lg">#</span>
          <input
            type="text"
            bind:value={newHashtag}
            onkeydown={handleKeyDown}
            placeholder="bitcoin"
            class="w-full pl-8 pr-3 py-2 bg-neutral-100 dark:bg-card border border rounded-lg text-foreground placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-orange-500"
            disabled={isAdding}
          />
        </div>
        <button
          onclick={addHashtag}
          disabled={isAdding || !newHashtag.trim()}
          class="px-4 py-2 bg-primary text-foreground rounded-lg hover:bg-primary disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
        >
          {isAdding ? 'Adding...' : 'Add'}
        </button>
      </div>
    </label>
    {#if error}
      <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-600 dark:text-red-400 text-sm">
        {error}
      </div>
    {/if}
  </div>
  <!-- Followed Hashtags List -->
  <div class="space-y-3">
    <h3 class="text-sm font-medium text-muted-foreground">Followed Hashtags</h3>
    {#if hashtagInterests.isLoading}
      <div class="flex items-center justify-center py-8 text-muted-foreground">
        <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Loading...
      </div>
    {:else if hashtagInterests.interests.length === 0}
      <div class="text-center py-8 text-muted-foreground">
        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
        </svg>
        <p class="text-sm">No hashtags followed yet</p>
        <p class="text-xs mt-1">Add hashtags above to start following topics</p>
      </div>
    {:else}
      <div class="space-y-2">
        {#each hashtagInterests.interests as hashtag}
          <div class="flex items-center justify-between p-3 bg-neutral-100 dark:bg-card border border rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-primary font-medium">#</span>
              <span class="text-foreground font-medium">{hashtag}</span>
            </div>
            <button
              onclick={() => removeHashtag(hashtag)}
              class="p-1.5 hover:bg-red-500/10 rounded-lg transition-colors group"
              title="Remove hashtag"
            >
              <svg class="w-4 h-4 text-muted-foreground group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        {/each}
      </div>
    {/if}
  </div>
  <!-- Info Box -->
  <div class="p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
    <div class="flex gap-3">
      <svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div class="text-sm text-blue-700 dark:text-blue-300">
        <p class="font-medium mb-1">How it works</p>
        <ul class="space-y-1 text-xs">
          <li>‚Ä¢ Click hashtag pills on your home feed to filter by specific hashtags</li>
          <li>‚Ä¢ When viewing a specific relay, hashtag filters will search within that relay</li>
          <li>‚Ä¢ When in "Following" mode, hashtag filters will search within your follows</li>
          <li>‚Ä¢ Your hashtag interests are stored on Nostr (kind 10015)</li>
        </ul>
      </div>
    </div>
  </div>
</div>
</file>

<file path="settings/KeyManagementSettings.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKPrivateKeySigner } from '@nostr-dev-kit/ndk';
  import type { Trustee, BackupProgress } from '$lib/backup/types';
  import { BackupError, BackupErrorCode } from '$lib/backup/errors';
  import { createEncryptedShards } from '$lib/backup/utils/shamir';
  import { publishShard, storeShardLocally } from '$lib/backup/services/shardPublisher';
  import { publishBackupMetadata } from '$lib/backup/services/metadataPublisher';
  import TrusteeSelector from '$lib/components/backup/TrusteeSelector.svelte';
  import QuorumSelector from '$lib/components/backup/QuorumSelector.svelte';
  import PassphraseInput from '$lib/components/backup/PassphraseInput.svelte';
  import WarningBanner from '$lib/components/backup/WarningBanner.svelte';
  const MAX_PUBLISH_OFFSET_DAYS = 2;
  const OFFSET_INCREMENT_DAYS = 3;
  const MAX_RELAYS = 5;
  let activeTab = $state<'view' | 'backup'>('view');
  let showNsec = $state(false);
  let copySuccess = $state(false);
  let step = $state<'setup' | 'progress'>('setup');
  let threshold = $state(2);
  let totalShards = $state(3);
  let trustees = $state<Trustee[]>([]);
  let passphrase = $state('');
  let confirmPassphrase = $state('');
  let isPassphraseValid = $state(false);
  let progress = $state<BackupProgress>({
    status: 'idle',
    currentStep: 0,
    totalSteps: 0,
    message: ''
  });
  const isPrivateKeySigner = $derived(ndk.signer instanceof NDKPrivateKeySigner);
  const nsec = $derived.by(() => {
    if (!isPrivateKeySigner || !ndk.signer) return null;
    const signer = ndk.signer as NDKPrivateKeySigner;
    return signer.nsec;
  });
  let canProceed = $derived(trustees.length >= totalShards && isPassphraseValid);
  async function copyToClipboard() {
    if (!nsec) return;
    try {
      await navigator.clipboard.writeText(nsec);
      copySuccess = true;
      setTimeout(() => {
        copySuccess = false;
      }, 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  }
  function toggleShowNsec() {
    showNsec = !showNsec;
  }
  function getUserRelays(): string[] {
    return Array.from(ndk.pool?.relays.values() || [])
      .map(relay => relay.url)
      .slice(0, MAX_RELAYS);
  }
  function getPrivateKey(): string {
    if (!isPrivateKeySigner || !ndk.signer) {
      throw new BackupError(
        BackupErrorCode.NO_PRIVATE_KEY,
        'No private key signer available'
      );
    }
    const signer = ndk.signer as NDKPrivateKeySigner;
    const privateKey = signer.privateKey;
    if (!privateKey) {
      throw new BackupError(
        BackupErrorCode.NO_PRIVATE_KEY,
        'Private key not found in signer'
      );
    }
    return privateKey;
  }
  async function handleCreateBackup() {
    if (!ndk.$currentUser) {
      throw new BackupError(BackupErrorCode.NO_USER, 'No authenticated user found');
    }
    try {
      step = 'progress';
      const privateKey = getPrivateKey();
      const totalSteps = totalShards + 2;
      progress = {
        status: 'creating-shards',
        currentStep: 0,
        totalSteps,
        message: 'Starting backup creation...'
      };
      const encryptedShards = await createEncryptedShards(
        privateKey,
        passphrase,
        { threshold, totalShards }
      );
      progress = {
        ...progress,
        currentStep: 2,
        status: 'publishing',
        message: 'Publishing shards...'
      };
      const publishedShards = [];
      const userRelays = getUserRelays();
      const selectedTrustees = trustees.slice(0, totalShards);
      for (let i = 0; i < encryptedShards.length; i++) {
        const shard = encryptedShards[i];
        const trustee = selectedTrustees[i];
        progress = {
          ...progress,
          currentStep: 2 + i,
          message: `Publishing shard ${i + 1} of ${totalShards}...`
        };
        const createdAtOffset = i === 0 ? 0 : i * OFFSET_INCREMENT_DAYS;
        if (createdAtOffset > MAX_PUBLISH_OFFSET_DAYS) {
          storeShardLocally(shard, trustee.pubkey, userRelays);
        } else {
          const published = await publishShard(ndk, {
            shard,
            recipientPubkey: trustee.pubkey,
            createdAtOffset,
            relays: userRelays
          });
          publishedShards.push(published);
        }
      }
      progress = {
        ...progress,
        currentStep: totalShards + 1,
        message: 'Publishing metadata...'
      };
      await publishBackupMetadata(ndk, publishedShards, threshold, privateKey);
      progress = {
        ...progress,
        status: 'complete',
        currentStep: totalSteps,
        message: 'Backup created successfully!'
      };
    } catch (error) {
      console.error('Backup creation failed:', error);
      const backupError = error instanceof BackupError
        ? error
        : new BackupError(
            BackupErrorCode.UNKNOWN_ERROR,
            error instanceof Error ? error.message : 'Unknown error',
            error
          );
      progress = {
        ...progress,
        status: 'error',
        message: backupError.getUserMessage(),
        error: backupError.message
      };
    }
  }
  function resetProgress() {
    step = 'setup';
    progress = {
      status: 'idle',
      currentStep: 0,
      totalSteps: 0,
      message: ''
    };
  }
</script>
{#if isPrivateKeySigner && nsec}
  <div class="space-y-6">
    <!-- Tab Navigation -->
    <div class="flex gap-2 p-1 bg-neutral-100 dark:bg-card rounded-lg">
      <button
        onclick={() => activeTab = 'view'}
        class="flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors {activeTab === 'view'
          ? 'bg-white dark:bg-muted text-foreground shadow-sm'
          : 'text-muted-foreground hover:text-neutral-900 dark:hover:text-foreground'}"
      >
        View Key
      </button>
      <button
        onclick={() => activeTab = 'backup'}
        class="flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors {activeTab === 'backup'
          ? 'bg-white dark:bg-muted text-foreground shadow-sm'
          : 'text-muted-foreground hover:text-neutral-900 dark:hover:text-foreground'}"
      >
        Create Backup
      </button>
    </div>
    {#if activeTab === 'view'}
      <!-- View Private Key Tab -->
      <div class="space-y-6">
        <!-- Warning Banner -->
        <div class="bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-900 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-red-600 dark:text-red-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-red-900 dark:text-red-100 mb-1">
                Critical Security Warning
              </h3>
              <p class="text-xs text-red-800 dark:text-red-200">
                Your private key (nsec) is the only way to access your account. Anyone with access to this key has full control of your identity. Never share it with anyone and store it securely offline.
              </p>
            </div>
          </div>
        </div>
        <!-- Private Key Display Section -->
        <div class="space-y-4">
          <div>
            <h3 class="text-sm font-medium text-foreground mb-1">
              Your Private Key (nsec)
            </h3>
            <p class="text-xs text-muted-foreground">
              You are logged in with a private key signer. Save this key somewhere safe.
            </p>
          </div>
          <div class="space-y-3">
            <!-- Key Display -->
            <div class="relative">
              <div class="bg-neutral-100 dark:bg-card border border rounded-lg p-4">
                {#if showNsec}
                  <code class="text-xs text-foreground break-all font-mono">
                    {nsec}
                  </code>
                {:else}
                  <div class="text-xs text-muted-foreground font-mono">
                    {'‚Ä¢'.repeat(63)}
                  </div>
                {/if}
              </div>
            </div>
            <!-- Action Buttons -->
            <div class="flex gap-2">
              <button
                onclick={toggleShowNsec}
                class="flex-1 px-4 py-2 bg-neutral-200 dark:bg-muted text-muted-foreground rounded-lg hover:bg-neutral-300 dark:hover:bg-muted transition-colors text-sm font-medium flex items-center justify-center gap-2"
              >
                {#if showNsec}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                  Hide Key
                {:else}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  Show Key
                {/if}
              </button>
              <button
                onclick={copyToClipboard}
                disabled={!showNsec}
                class="flex-1 px-4 py-2 bg-primary text-foreground rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {#if copySuccess}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Copied!
                {:else}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                  Copy Key
                {/if}
              </button>
            </div>
            <p class="text-xs text-muted-foreground text-center">
              Make sure nobody is watching your screen before revealing your key
            </p>
          </div>
        </div>
        <!-- Best Practices -->
        <div class="bg-neutral-50 dark:bg-card border border rounded-lg p-4">
          <h4 class="text-sm font-medium text-foreground mb-2">
            Security Best Practices
          </h4>
          <ul class="space-y-2 text-xs text-muted-foreground">
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 text-primary mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Write down your nsec on paper and store it in a safe place</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 text-primary mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Never share your nsec via email, messaging apps, or websites</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 text-primary mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Consider using a browser extension signer for better security</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-4 h-4 text-primary mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Use the "Create Backup" tab to create encrypted shards with trusted contacts</span>
            </li>
          </ul>
        </div>
      </div>
    {:else}
      <!-- Create Backup Tab -->
      <div class="space-y-6">
        {#if step === 'progress'}
          <!-- Progress View -->
          <div class="flex flex-col items-center justify-center py-12">
            {#if progress.status === 'complete'}
              <div class="w-16 h-16 bg-green-100 dark:bg-green-950/30 rounded-full flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            {:else if progress.status === 'error'}
              <div class="w-16 h-16 bg-red-100 dark:bg-red-950/30 rounded-full flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
            {:else}
              <div class="w-16 h-16 bg-blue-100 dark:bg-blue-950/30 rounded-full flex items-center justify-center mb-4 animate-spin">
                <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </div>
            {/if}
            <h3 class="text-lg font-semibold text-foreground mb-2">
              {progress.message}
            </h3>
            {#if progress.status !== 'complete' && progress.status !== 'error'}
              <p class="text-sm text-muted-foreground">
                Step {progress.currentStep} of {progress.totalSteps}
              </p>
            {/if}
            {#if progress.status === 'error' && progress.error}
              <p class="text-sm text-red-600 dark:text-red-400 mt-2 text-center max-w-md">
                {progress.error}
              </p>
            {/if}
            {#if progress.status === 'complete' || progress.status === 'error'}
              <button
                onclick={resetProgress}
                class="mt-6 px-4 py-2 bg-neutral-200 dark:bg-muted text-muted-foreground rounded-lg hover:bg-neutral-300 dark:hover:bg-muted transition-colors"
              >
                Close
              </button>
            {/if}
          </div>
        {:else}
          <!-- Setup View -->
          <WarningBanner
            title="Security Warning"
            description="Key backup splits your private key into encrypted pieces. Choose trustworthy contacts and a strong passphrase you won't forget."
            variant="danger"
          />
          <QuorumSelector
            {threshold}
            {totalShards}
            onThresholdChange={(t) => threshold = t}
            onTotalShardsChange={(t) => totalShards = t}
            maxShards={10}
          />
          <TrusteeSelector
            {trustees}
            maxTrustees={totalShards}
            onTrusteesChange={(t) => trustees = t}
          />
          {#if trustees.length >= totalShards}
            <PassphraseInput
              value={passphrase}
              confirmValue={confirmPassphrase}
              onChange={(v) => passphrase = v}
              onConfirmChange={(v) => confirmPassphrase = v}
              onValidChange={(v) => isPassphraseValid = v}
            />
          {/if}
          {#if canProceed}
            <button
              onclick={handleCreateBackup}
              class="w-full px-4 py-3 bg-primary text-foreground rounded-lg hover:bg-primary-700 transition-colors font-medium flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              Create Backup
            </button>
          {/if}
        {/if}
      </div>
    {/if}
  </div>
{:else}
  <div class="text-center py-8">
    <div class="w-16 h-16 bg-neutral-100 dark:bg-card rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <h3 class="text-sm font-medium text-foreground mb-2">
      Not Using Private Key Signer
    </h3>
    <p class="text-xs text-muted-foreground max-w-sm mx-auto">
      You are not logged in with a private key signer. This section is only available for users who logged in with an nsec.
    </p>
  </div>
{/if}
</file>

<file path="settings/ProfileSettings.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKEvent, NDKRelaySet } from '@nostr-dev-kit/ndk';
  import { NDKBlossom } from '@nostr-dev-kit/blossom';
  import { createBlossomUpload } from '@nostr-dev-kit/svelte';
    import { AGORA_RELAYS } from '$lib/utils/relayUtils';
  interface Props {
    hideSubmitButton?: boolean;
    onSubmit?: (handler: () => Promise<void>) => void;
    onFormStateChange?: (state: { isSubmitting: boolean; isUploading: boolean }) => void;
  }
  let { hideSubmitButton = false, onSubmit, onFormStateChange }: Props = $props();
  let user = $derived(ndk.$currentUser);
  let profile = $state<import('@nostr-dev-kit/ndk').NDKUserProfile | null>(null);
  $effect(() => {
    const pubkey = user?.pubkey;
    if (!pubkey) {
      profile = null;
      return;
    }
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  // Fetch the profile event reactively to get hashtags
  let profileEvent = $state<NDKEvent | null>(null);
  $effect(() => {
    if (!user?.pubkey) {
      profileEvent = null;
      return;
    }
    ndk.fetchEvent({
      kinds: [0],
      authors: [user.pubkey]
    }).then(event => {
      profileEvent = event || null;
    });
  });
  let isSubmitting = $state(false);
  let isSaved = $state(false);
  let error = $state<string | null>(null);
  // Initialize Blossom for image uploads - create reactively after user is available
  let blossom = $derived.by(() => {
    if (!user) return null;
    return new NDKBlossom(ndk);
  });
  let pictureUpload = $derived.by(() => {
    if (!blossom) return null;
    return createBlossomUpload(blossom);
  });
  let bannerUpload = $derived.by(() => {
    if (!blossom) return null;
    return createBlossomUpload(blossom);
  });
  // Form state
  let formData = $state({
    name: profile?.name || '',
    displayName: profile?.displayName || '',
    about: profile?.about || '',
    picture: profile?.image || '',
    banner: profile?.banner || '',
    nip05: profile?.nip05 || '',
    lud16: profile?.lud16 || '',
    website: profile?.website || '',
    hashtags: '' // Comma-separated hashtags
  });
  // Update form when profile loads
  $effect(() => {
    // Only update if we have profile data (check for any profile property)
    if (profile.name || profile.displayName || profile.about || profile.image || profile.banner) {
      // Extract hashtags from profile event
      const hashtags = profileEvent?.tags
        ?.filter(tag => tag[0] === 't')
        ?.map(tag => tag[1])
        ?.join(', ') || '';
      formData = {
        name: profile.name || '',
        displayName: profile.displayName || '',
        about: profile.about || '',
        picture: profile.image || '',
        banner: profile.banner || '',
        nip05: profile.nip05 || '',
        lud16: profile.lud16 || '',
        website: profile.website || '',
        hashtags
      };
    }
  });
  // Expose submit handler to parent
  $effect(() => {
    if (onSubmit) {
      onSubmit(handleSubmit);
    }
  });
  // Notify parent of form state changes
  $effect(() => {
    if (onFormStateChange) {
      const isUploading = pictureUpload?.status === 'uploading' || bannerUpload?.status === 'uploading';
      onFormStateChange({ isSubmitting, isUploading });
    }
  });
  let pictureInput: HTMLInputElement;
  let bannerInput: HTMLInputElement;
  async function handlePictureUpload(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (!file) return;
    if (!pictureUpload) {
      error = 'Upload not available. Please ensure you are logged in.';
      return;
    }
    if (!file.type.startsWith('image/')) {
      error = 'Please select an image file';
      return;
    }
    error = null;
    try {
      const uploadOptions = {
        fallbackServer: 'https://blossom.primal.net'
      };
      console.log('Calling pictureUpload.upload with options:', uploadOptions);
      await pictureUpload.upload(file, uploadOptions);
      if (pictureUpload.result?.url) {
        formData.picture = pictureUpload.result.url;
      }
    } catch (err) {
      console.error('Upload failed:', err);
      error = 'Failed to upload image. Please try again.';
    }
  }
  async function handleBannerUpload(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (!file) return;
    if (!bannerUpload) {
      error = 'Upload not available. Please ensure you are logged in.';
      return;
    }
    if (!file.type.startsWith('image/')) {
      error = 'Please select an image file';
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      error = 'Image size must be less than 5MB';
      return;
    }
    error = null;
    try {
      await bannerUpload.upload(file, {
        fallbackServer: 'https://blossom.primal.net'
      });
      if (bannerUpload.result?.url) {
        formData.banner = bannerUpload.result.url;
      }
    } catch (err) {
      console.error('Upload failed:', err);
      error = 'Failed to upload banner. Please try again.';
    }
  }
  async function handleSubmit() {
    if (!ndk.signer) {
      error = 'No signer available';
      return;
    }
    isSubmitting = true;
    error = null;
    isSaved = false;
    try {
      const event = new NDKEvent(ndk);
      event.kind = 0;
      event.content = JSON.stringify({
        name: formData.name,
        display_name: formData.displayName,
        about: formData.about,
        picture: formData.picture,
        banner: formData.banner,
        nip05: formData.nip05,
        lud16: formData.lud16,
        website: formData.website
      });
      // Add hashtags as "t" tags (lowercase)
      if (formData.hashtags.trim()) {
        const hashtags = formData.hashtags
          .split(',')
          .map(tag => tag.trim().toLowerCase())
          .filter(tag => tag.length > 0);
        event.tags = hashtags.map(tag => ['t', tag]);
      }
      await event.publishReplaceable();
      const profileRelaySet = NDKRelaySet.fromRelayUrls([ 'wss://purplepag.es/', ...AGORA_RELAYS ], ndk)
      event.publishReplaceable(profileRelaySet);
      isSaved = true;
      setTimeout(() => isSaved = false, 3000);
    } catch (err) {
      console.error('Failed to save profile:', err);
      error = 'Failed to save profile. Please try again.';
    } finally {
      isSubmitting = false;
    }
  }
  function getInitials(name: string) {
    if (!name) return '?';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  }
</script>
<div class="max-w-2xl mx-auto space-y-8">
  <!-- Success/Error Messages -->
  {#if isSaved}
    <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-4 flex items-center gap-3">
      <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <span class="text-sm font-medium text-green-800 dark:text-green-200">Profile updated successfully!</span>
    </div>
  {/if}
  {#if error}
    <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-4 flex items-center gap-3">
      <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span class="text-sm font-medium text-red-800 dark:text-red-200">{error}</span>
    </div>
  {/if}
  <!-- Banner -->
  <div class="space-y-2">
    <label class="block text-sm font-medium text-foreground">
      Banner Image
    </label>
    <input
      bind:this={bannerInput}
      type="file"
      accept="image/*"
      onchange={handleBannerUpload}
      class="hidden"
    />
    <button
      type="button"
      onclick={() => bannerInput?.click()}
      disabled={bannerUpload?.status === 'uploading'}
      class="w-full h-48 rounded-xl overflow-hidden relative group bg-gradient-to-br from-primary-500 to-primary-600 hover:opacity-90 transition-opacity"
      style={formData.banner ? `background-image: url(${formData.banner}); background-size: cover; background-position: center;` : ''}
    >
      <div class="absolute inset-0 bg-background/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
        {#if bannerUpload?.status === 'uploading'}
          <div class="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span class="text-foreground text-sm font-medium">{bannerUpload.progress?.percentage}%</span>
        {:else}
          <svg class="w-10 h-10 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span class="text-foreground text-sm font-medium">Click to upload banner</span>
        {/if}
      </div>
    </button>
  </div>
  <!-- Profile Picture -->
  <div class="space-y-2">
    <label class="block text-sm font-medium text-foreground">
      Profile Picture
    </label>
    <input
      bind:this={pictureInput}
      type="file"
      accept="image/*"
      onchange={handlePictureUpload}
      class="hidden"
    />
    <div class="flex items-center gap-4">
      <button
        type="button"
        onclick={() => pictureInput?.click()}
        disabled={pictureUpload?.status === 'uploading'}
        class="w-24 h-24 rounded-full overflow-hidden relative group bg-gradient-to-br from-primary-500 to-primary-600 hover:ring-4 hover:ring-orange-500/20 transition-all flex items-center justify-center"
      >
        {#if formData.picture}
          <img src={formData.picture} alt="Profile" class="w-full h-full object-cover" />
        {:else}
          <span class="text-foreground text-2xl font-bold">{getInitials(formData.name)}</span>
        {/if}
        <div class="absolute inset-0 bg-background/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
          {#if pictureUpload?.status === 'uploading'}
            <div class="flex flex-col items-center gap-1">
              <div class="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              <span class="text-foreground text-xs">{pictureUpload.progress?.percentage}%</span>
            </div>
          {:else}
            <svg class="w-8 h-8 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          {/if}
        </div>
      </button>
      <div class="flex-1">
        <input
          type="url"
          bind:value={formData.picture}
          placeholder="Or paste image URL"
          class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
          disabled={pictureUpload?.status === 'uploading'}
        />
      </div>
    </div>
  </div>
  <!-- Name -->
  <div class="space-y-2">
    <label for="name" class="block text-sm font-medium text-foreground">
      Name
    </label>
    <input
      id="name"
      type="text"
      bind:value={formData.name}
      placeholder="Satoshi Nakamoto"
      class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    />
  </div>
  <!-- Display Name -->
  <div class="space-y-2">
    <label for="displayName" class="block text-sm font-medium text-foreground">
      Display Name
      <span class="text-muted-foreground text-xs font-normal">(optional)</span>
    </label>
    <input
      id="displayName"
      type="text"
      bind:value={formData.displayName}
      placeholder="satoshi"
      class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    />
  </div>
  <!-- About -->
  <div class="space-y-2">
    <label for="about-textarea" class="block text-sm font-medium text-foreground">
      About
    </label>
    <textarea
      id="about-textarea"
      bind:value={formData.about}
      placeholder="Tell the world about yourself..."
      rows="5"
      class="w-full px-4 py-3 rounded-lg border border bg-card text-foreground placeholder-neutral-500 resize-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    ></textarea>
  </div>
  <!-- NIP-05 -->
  <div class="space-y-2">
    <label for="nip05" class="block text-sm font-medium text-foreground">
      NIP-05 Verification
      <span class="text-muted-foreground text-xs font-normal">(optional)</span>
    </label>
    <input
      id="nip05"
      type="text"
      bind:value={formData.nip05}
      placeholder="name@domain.com"
      class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    />
  </div>
  <!-- Lightning Address -->
  <div class="space-y-2">
    <label for="lud16" class="block text-sm font-medium text-foreground">
      Lightning Address
      <span class="text-muted-foreground text-xs font-normal">(optional)</span>
    </label>
    <input
      id="lud16"
      type="text"
      bind:value={formData.lud16}
      placeholder="name@getalby.com"
      class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    />
  </div>
  <!-- Website -->
  <div class="space-y-2">
    <label for="website" class="block text-sm font-medium text-foreground">
      Website
      <span class="text-muted-foreground text-xs font-normal">(optional)</span>
    </label>
    <input
      id="website"
      type="url"
      bind:value={formData.website}
      placeholder="https://example.com"
      class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    />
  </div>
  <!-- Hashtags -->
  <div class="space-y-2">
    <label for="hashtags" class="block text-sm font-medium text-foreground">
      Interest Hashtags
      <span class="text-muted-foreground text-xs font-normal">(optional)</span>
    </label>
    <input
      id="hashtags"
      type="text"
      bind:value={formData.hashtags}
      placeholder="bitcoin, nostr, freedom (comma-separated)"
      class="w-full px-4 py-2 rounded-lg border border bg-card text-foreground placeholder-neutral-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"
    />
    <p class="text-xs text-muted-foreground">
      Add hashtags that describe your interests. Separate multiple tags with commas.
    </p>
  </div>
  <!-- Save Button -->
  {#if !hideSubmitButton}
    <div class="flex justify-end pt-4">
      <button
        type="button"
        onclick={handleSubmit}
        disabled={isSubmitting || pictureUpload?.status === 'uploading' || bannerUpload?.status === 'uploading'}
        class="px-6 py-3 bg-primary hover:bg-accent-dark text-foreground font-medium rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
      >
        {#if isSubmitting}
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span>Saving...</span>
        {:else}
          <span>Save Profile</span>
        {/if}
      </button>
    </div>
  {/if}
</div>
</file>

<file path="settings/RelayDetailsComponent.svelte">
<script lang="ts">
  import { settings } from '$lib/stores/settings.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  interface Props {
    relay: { url: string; read: boolean; write: boolean };
    status: string;
    connectionStatus: Record<string, string>;
  }
  let { relay, status, connectionStatus }: Props = $props();
  let { info } = useRelayInfoCached(relay.url);
</script>
<div class="flex-1 min-w-0">
  <div class="flex flex-wrap items-center gap-2">
    <!-- Icon -->
    {#if info?.limitation?.payment_required}
      <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
    {:else if info?.limitation?.auth_required}
      <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
    {:else if info?.software}
      <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
      </svg>
    {:else}
      <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    {/if}
    <!-- URL -->
    <span class="font-mono text-xs md:text-sm text-foreground break-all">
      {relay.url}
    </span>
    <!-- Status badges -->
    {#if status === 'connected'}
      <span class="text-xs bg-green-100 dark:bg-green-950 text-green-700 dark:text-green-400 px-2 py-0.5 rounded-full">
        Connected
      </span>
    {/if}
    {#if status === 'disconnected' && connectionStatus[relay.url] !== undefined}
      <span class="text-xs bg-red-100 dark:bg-red-950 text-red-700 dark:text-red-400 px-2 py-0.5 rounded-full">
        Offline
      </span>
    {/if}
    {#if status === 'testing'}
      <span class="text-xs bg-yellow-100 dark:bg-yellow-950 text-yellow-700 dark:text-yellow-400 px-2 py-0.5 rounded-full">
        Testing...
      </span>
    {/if}
  </div>
  {#if info}
    <div class="mt-2 space-y-1">
      {#if info.name}
        <div class="flex items-start gap-2">
          <span class="text-xs font-medium text-muted-foreground min-w-[60px]">Name:</span>
          <span class="text-sm font-semibold text-foreground">{info.name}</span>
        </div>
      {/if}
      {#if info.description}
        <div class="flex items-start gap-2">
          <span class="text-xs font-medium text-muted-foreground min-w-[60px]">About:</span>
          <span class="text-sm text-muted-foreground">{info.description}</span>
        </div>
      {/if}
      {#if info.software || info.version}
        <div class="flex items-start gap-2">
          <span class="text-xs font-medium text-muted-foreground min-w-[60px]">Software:</span>
          <span class="text-sm text-muted-foreground">
            {info.software}{info.version ? ` v${info.version}` : ''}
          </span>
        </div>
      {/if}
      {#if info.relay_countries && info.relay_countries.length > 0}
        <div class="flex items-start gap-2">
          <svg class="w-3 h-3 text-muted-foreground mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="text-sm text-muted-foreground">
            {info.relay_countries.join(', ')}
          </span>
        </div>
      {/if}
      {#if info.supported_nips && info.supported_nips.length > 0}
        <div class="flex items-start gap-2">
          <svg class="w-3 h-3 text-muted-foreground mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="flex-1">
            <span class="text-xs text-muted-foreground">
              Supports {info.supported_nips.length} NIPs: {info.supported_nips.slice(0, 5).join(', ')}
              {#if info.supported_nips.length > 5}...{/if}
            </span>
          </div>
        </div>
      {/if}
      <!-- Feature badges -->
      <div class="flex flex-wrap gap-2 mt-2">
        {#if info.limitation?.payment_required}
          <span class="text-xs bg-yellow-100 dark:bg-yellow-950 text-yellow-700 dark:text-yellow-400 px-2 py-0.5 rounded-full">
            üí∞ Paid
          </span>
        {/if}
        {#if info.limitation?.auth_required}
          <span class="text-xs bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-400 px-2 py-0.5 rounded-full">
            üîê Auth Required
          </span>
        {/if}
        {#if info.contact}
          <span class="text-xs bg-neutral-100 dark:bg-muted text-muted-foreground px-2 py-0.5 rounded-full">
            üìß {info.contact}
          </span>
        {/if}
      </div>
    </div>
  {/if}
  <!-- Read/Write toggles -->
  <div class="flex items-center gap-4 mt-3">
    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="checkbox"
        checked={relay.read}
        onchange={(e) => settings.updateRelay(relay.url, { read: e.currentTarget.checked })}
        class="w-4 h-4 text-primary rounded focus:ring-orange-500"
      />
      <span class="text-sm text-muted-foreground">
        Read
      </span>
    </label>
    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="checkbox"
        checked={relay.write}
        onchange={(e) => settings.updateRelay(relay.url, { write: e.currentTarget.checked })}
        class="w-4 h-4 text-primary rounded focus:ring-orange-500"
      />
      <span class="text-sm text-muted-foreground">
        Write
      </span>
    </label>
  </div>
</div>
</file>

<file path="settings/RelaySettings.svelte">
<script lang="ts">
  import { settings } from '$lib/stores/settings.svelte';
  import RelayDetailsComponent from './RelayDetailsComponent.svelte';
  let isAdding = $state(false);
  let newRelay = $state({ url: '', read: true, write: true });
  let testingRelay = $state<string | null>(null);
  let connectionStatus = $state<Record<string, 'connected' | 'disconnected' | 'testing'>>({});
  function handleAddRelay() {
    if (newRelay.url && !settings.relays.some(r => r.url === newRelay.url)) {
      const url = newRelay.url.startsWith('wss://') || newRelay.url.startsWith('ws://')
        ? newRelay.url
        : `wss://${newRelay.url}`;
      settings.addRelay({
        ...newRelay,
        enabled: true,
        url,
      });
      newRelay = { url: '', read: true, write: true };
      isAdding = false;
    }
  }
  async function testRelayConnection(url: string) {
    testingRelay = url;
    connectionStatus = { ...connectionStatus, [url]: 'testing' };
    // Mock connection test
    setTimeout(() => {
      const isConnected = Math.random() > 0.3; // 70% success rate for demo
      connectionStatus = {
        ...connectionStatus,
        [url]: isConnected ? 'connected' : 'disconnected'
      };
      testingRelay = null;
    }, 1500);
  }
  function getRelayStatus(url: string) {
    if (testingRelay === url) return 'testing';
    return connectionStatus[url] || 'disconnected';
  }
  let relays = $derived(settings.relays);
</script>
<div class="space-y-6">
  <div>
    <h2 class="text-xl font-semibold text-foreground mb-2">
      Relay Configuration
    </h2>
    <p class="text-sm text-muted-foreground">
      Configure which Nostr relays your app connects to for reading and publishing events.
    </p>
  </div>
  <!-- Relay Authentication Mode -->
  <div class="bg-card border rounded-lg p-4">
    <div class="flex items-start gap-3">
      <svg class="w-5 h-5 text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
      <div class="flex-1">
        <h3 class="font-medium text-foreground mb-1">Relay Authentication</h3>
        <p class="text-sm text-muted-foreground mb-3">
          Control how to handle relays that require authentication
        </p>
        <div class="space-y-2">
          <label class="flex items-start gap-3 cursor-pointer group">
            <input
              type="radio"
              name="authMode"
              value="always"
              checked={settings.relayAuth.mode === 'always'}
              onchange={() => settings.updateRelayAuth({ mode: 'always' })}
              class="w-4 h-4 text-primary mt-0.5 focus:ring-2 focus:ring-primary"
            />
            <div class="flex-1">
              <span class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">
                Always authenticate
              </span>
              <p class="text-xs text-muted-foreground mt-0.5">
                Automatically authenticate to any relay that requests it
              </p>
            </div>
          </label>
          <label class="flex items-start gap-3 cursor-pointer group">
            <input
              type="radio"
              name="authMode"
              value="ask"
              checked={settings.relayAuth.mode === 'ask'}
              onchange={() => settings.updateRelayAuth({ mode: 'ask' })}
              class="w-4 h-4 text-primary mt-0.5 focus:ring-2 focus:ring-primary"
            />
            <div class="flex-1">
              <span class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">
                Ask each time
              </span>
              <p class="text-xs text-muted-foreground mt-0.5">
                Show a confirmation dialog before authenticating to relays
              </p>
            </div>
          </label>
        </div>
      </div>
    </div>
  </div>
  <!-- Stats -->
  <div class="grid grid-cols-3 gap-2 md:gap-4">
    <div class="bg-neutral-50 dark:bg-background rounded-lg p-3 md:p-4">
      <div class="flex items-center gap-1 md:gap-2 text-green-600 dark:text-green-400 mb-1">
        <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
        </svg>
        <span class="text-xs md:text-sm font-medium">Active</span>
      </div>
      <div class="text-xl md:text-2xl font-bold text-foreground">
        {relays.filter(r => r.enabled).length}
      </div>
    </div>
    <div class="bg-neutral-50 dark:bg-background rounded-lg p-3 md:p-4">
      <div class="flex items-center gap-1 md:gap-2 text-blue-600 dark:text-blue-400 mb-1">
        <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        <span class="text-xs md:text-sm font-medium">Read</span>
      </div>
      <div class="text-xl md:text-2xl font-bold text-foreground">
        {relays.filter(r => r.enabled && r.read).length}
      </div>
    </div>
    <div class="bg-neutral-50 dark:bg-background rounded-lg p-3 md:p-4">
      <div class="flex items-center gap-1 md:gap-2 text-primary dark:text-primary mb-1">
        <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
        </svg>
        <span class="text-xs md:text-sm font-medium">Write</span>
      </div>
      <div class="text-xl md:text-2xl font-bold text-foreground">
        {relays.filter(r => r.enabled && r.write).length}
      </div>
    </div>
  </div>
  <!-- Relay List -->
  <div class="space-y-2">
    {#each relays as relay (relay.url)}
      {@const status = getRelayStatus(relay.url)}
      <div class="border rounded-lg p-4 transition-all {relay.enabled
        ? 'bg-card border'
        : 'bg-neutral-50 dark:bg-background border opacity-60'}">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div class="flex-1">
            <div class="flex items-start md:items-center gap-3">
              <button
                onclick={() => settings.toggleRelay(relay.url)}
                class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 mt-0.5 md:mt-0 {relay.enabled
                  ? 'bg-primary border-primary'
                  : 'bg-card border dark:border'}"
              >
                {#if relay.enabled}
                  <svg class="w-3 h-3 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                {/if}
              </button>
              <RelayDetailsComponent {relay} {status} {connectionStatus} />
            </div>
          </div>
          <div class="flex items-center gap-2 ml-8 md:ml-0">
            <button
              onclick={() => testRelayConnection(relay.url)}
              disabled={testingRelay === relay.url}
              class="p-1.5 md:p-2 hover:bg-neutral-100 dark:hover:bg-card rounded-lg transition-colors disabled:opacity-50"
              title="Test connection"
            >
              <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </button>
            <button
              onclick={() => settings.removeRelay(relay.url)}
              class="p-1.5 md:p-2 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg transition-colors group"
              title="Remove relay"
            >
              <svg class="w-4 h-4 text-muted-foreground group-hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    {/each}
    <!-- Add New Relay -->
    {#if isAdding}
      <div class="border-2 border-dashed border-primary-300 dark:border-primary-700 rounded-lg p-4">
        <div class="space-y-3">
          <input
            type="text"
            bind:value={newRelay.url}
            placeholder="wss://relay.example.com"
            class="w-full px-3 py-2 bg-card border border dark:border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
            autofocus
          />
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                bind:checked={newRelay.read}
                class="w-4 h-4 text-primary rounded focus:ring-orange-500"
              />
              <span class="text-sm text-muted-foreground">Read</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                bind:checked={newRelay.write}
                class="w-4 h-4 text-primary rounded focus:ring-orange-500"
              />
              <span class="text-sm text-muted-foreground">Write</span>
            </label>
          </div>
          <div class="flex gap-2">
            <button
              onclick={handleAddRelay}
              disabled={!newRelay.url}
              class="px-4 py-2 bg-primary text-foreground rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Add Relay
            </button>
            <button
              onclick={() => {
                isAdding = false;
                newRelay = { url: '', read: true, write: true };
              }}
              class="px-4 py-2 bg-neutral-200 dark:bg-background text-muted-foreground rounded-lg hover:bg-neutral-300 dark:hover:bg-card transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    {:else}
      <button
        onclick={() => isAdding = true}
        class="w-full border-2 border-dashed border rounded-lg p-4 hover:border-primary dark:hover:border-primary transition-colors group"
      >
        <div class="flex items-center justify-center gap-2 text-muted-foreground group-hover:text-primary dark:group-hover:text-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          <span class="font-medium">Add Relay</span>
        </div>
      </button>
    {/if}
  </div>
  <!-- Warning -->
  <div class="bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
    <div class="flex gap-3">
      <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div class="text-sm text-yellow-800 dark:text-yellow-300">
        <p class="font-medium mb-1">Important</p>
        <p>Changes to relay configuration will take effect after refreshing the app.</p>
      </div>
    </div>
  </div>
</div>
</file>

<file path="settings/ThemeSettings.svelte">
<script lang="ts">
  import { settings } from '$lib/stores/settings.svelte';
  import { t } from 'svelte-i18n';
  import type { ThemeColor } from '$lib/theme/colors';
  function handleThemeChange(newTheme: 'light' | 'dark' | 'system') {
    settings.setTheme(newTheme);
  }
  function handleThemeColorChange(newColor: ThemeColor) {
    settings.setThemeColor(newColor);
  }
  function handleLanguageChange(newLanguage: 'en' | 'es' | 'fa' | 'km' | 'sn') {
    settings.setLanguage(newLanguage);
  }
  const colorOptions = [
    { id: 'orange' as const, name: 'Orange', hex: '#FF6B35', description: 'Warm orange' },
    { id: 'red' as const, name: 'Red', hex: '#E4104D', description: 'Magenta / Raspberry red' },
    { id: 'cyan' as const, name: 'Cyan', hex: '#00B7D3', description: 'Bright cyan / Turquoise' },
    { id: 'yellow' as const, name: 'Yellow', hex: '#FFD900', description: 'Vivid yellow' },
    { id: 'lime' as const, name: 'Lime', hex: '#97BF0D', description: 'Lime green' }
  ];
</script>
<div class="space-y-6">
  <div>
    <h2 class="text-lg font-semibold text-foreground mb-4">
      {$t('settings.sections.appearance.title')}
    </h2>
    <p class="text-sm text-muted-foreground mb-6">
      {$t('settings.sections.appearance.description')}
    </p>
  </div>
  <!-- Language Selection -->
  <div class="border-b border pb-6">
    <div class="flex items-center gap-3 mb-4">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-base font-medium text-foreground">
        {$t('settings.sections.appearance.language')}
      </h3>
    </div>
    <p class="text-sm text-muted-foreground mb-4">
      {$t('settings.sections.appearance.languageDescription')}
    </p>
    <div class="grid grid-cols-2 gap-3">
      <button
        onclick={() => handleLanguageChange('en')}
        class="px-4 py-3 rounded-lg transition-all {settings.language === 'en'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex items-center justify-center gap-2">
          <span class="text-lg">üá∫üá∏</span>
          <span class="font-medium">English</span>
        </div>
      </button>
      <button
        onclick={() => handleLanguageChange('es')}
        class="px-4 py-3 rounded-lg transition-all {settings.language === 'es'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex items-center justify-center gap-2">
          <span class="text-lg">üá™üá∏</span>
          <span class="font-medium">Espa√±ol</span>
        </div>
      </button>
      <button
        onclick={() => handleLanguageChange('fa')}
        class="px-4 py-3 rounded-lg transition-all {settings.language === 'fa'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex items-center justify-center gap-2">
          <span class="text-lg">üáÆüá∑</span>
          <span class="font-medium">ŸÅÿßÿ±ÿ≥€å</span>
        </div>
      </button>
      <button
        onclick={() => handleLanguageChange('km')}
        class="px-4 py-3 rounded-lg transition-all {settings.language === 'km'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex items-center justify-center gap-2">
          <span class="text-lg">üá∞üá≠</span>
          <span class="font-medium">·ûÅ·üí·ûò·üÇ·ûö</span>
        </div>
      </button>
      <button
        onclick={() => handleLanguageChange('sn')}
        class="px-4 py-3 rounded-lg transition-all {settings.language === 'sn'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex items-center justify-center gap-2">
          <span class="text-lg">üáøüáº</span>
          <span class="font-medium">Shona</span>
        </div>
      </button>
    </div>
  </div>
  <!-- Theme Selection -->
  <div class="border-b border pb-6">
    <div class="flex items-center gap-3 mb-4">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
      </svg>
      <h3 class="text-base font-medium text-foreground">
        {$t('settings.sections.appearance.theme')}
      </h3>
    </div>
    <p class="text-sm text-muted-foreground mb-4">
      {$t('settings.sections.appearance.themeDescription')}
    </p>
    <div class="grid grid-cols-3 gap-3">
      <button
        onclick={() => handleThemeChange('light')}
        class="px-4 py-3 rounded-lg transition-all {settings.theme === 'light'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">‚òÄÔ∏è</span>
          <span class="text-sm font-medium">{$t('settings.sections.appearance.themes.light')}</span>
        </div>
      </button>
      <button
        onclick={() => handleThemeChange('dark')}
        class="px-4 py-3 rounded-lg transition-all {settings.theme === 'dark'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">üåô</span>
          <span class="text-sm font-medium">{$t('settings.sections.appearance.themes.dark')}</span>
        </div>
      </button>
      <button
        onclick={() => handleThemeChange('system')}
        class="px-4 py-3 rounded-lg transition-all {settings.theme === 'system'
          ? 'bg-primary-50 dark:bg-primary-950/30 text-primary dark:text-primary'
          : 'bg-card text-muted-foreground hover:bg-accent'}"
      >
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">üíª</span>
          <span class="text-sm font-medium">{$t('settings.sections.appearance.themes.system')}</span>
        </div>
      </button>
    </div>
  </div>
  <!-- Theme Color Selection -->
  <div>
    <div class="flex items-center gap-3 mb-4">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
      </svg>
      <h3 class="text-base font-medium text-foreground">
        Accent Color
      </h3>
    </div>
    <p class="text-sm text-muted-foreground mb-4">
      Choose your preferred accent color
    </p>
    <div class="grid grid-cols-2 gap-3">
      {#each colorOptions as option}
        <button
          onclick={() => handleThemeColorChange(option.id)}
          class="px-4 py-3 rounded-lg transition-all {settings.themeColor === option.id
            ? 'bg-primary-50 dark:bg-primary-950/30'
            : 'bg-card hover:bg-accent'}"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 rounded-full flex-shrink-0"
              style="background-color: {option.hex}"
            ></div>
            <div class="flex flex-col items-start">
              <span class="font-medium text-foreground">{option.name}</span>
              <span class="text-xs text-muted-foreground">{option.description}</span>
            </div>
          </div>
        </button>
      {/each}
    </div>
  </div>
</div>
</file>

<file path="settings/WalletSettings.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import type { Mint } from '@nostr-dev-kit/svelte';
  import MintBrowser from '$lib/components/wallet/MintBrowser.svelte';
  import { npubCash } from '$lib/stores/npubcash.svelte';
  let isAddingMint = $state(false);
  let isAddingRelay = $state(false);
  let isBrowsingMints = $state(false);
  let newMintUrl = $state('');
  let newRelayUrl = $state('');
  let error = $state<string | null>(null);
  let successMessage = $state<string | null>(null);
  let isSaving = $state(false);
  const wallet = $derived(ndk.$wallet);
  // Track pending changes locally
  let pendingMints = $state<string[]>([]);
  let pendingRelays = $state<string[]>([]);
  let hasPendingChanges = $state(false);
  // Initialize pending state from wallet
  $effect(() => {
    if (!hasPendingChanges && wallet) {
      pendingMints = wallet.mints.map(m => typeof m === 'string' ? m : m.url);
      pendingRelays = wallet.relays;
    }
  });
  const mints = $derived(hasPendingChanges ? pendingMints : (wallet?.mints.map(m => typeof m === 'string' ? m : m.url) || []));
  const relays = $derived(hasPendingChanges ? pendingRelays : (wallet?.relays || []));
  const mintBalances = $derived.by(() => {
    const balances = new Map<string, number>();
    mints.forEach(mint => {
      const walletInstance = wallet.wallet;
      if (walletInstance?.mintBalance) {
        balances.set(mint, walletInstance.mintBalance(mint));
      }
    });
    return balances;
  });
  // Shared utilities
  function clearMessages() {
    error = null;
    successMessage = null;
  }
  function showSuccess(message: string) {
    successMessage = message;
    setTimeout(() => {
      successMessage = null;
    }, 3000);
  }
  function showError(e: unknown) {
    error = e instanceof Error ? e.message : 'Operation failed';
  }
  function markChanges() {
    hasPendingChanges = true;
  }
  async function saveChanges() {
    clearMessages();
    isSaving = true;
    try {
      await wallet.save({
        mints: pendingMints,
        relays: pendingRelays.length > 0 ? pendingRelays : undefined
      });
      hasPendingChanges = false;
      showSuccess('Changes saved successfully!');
    } catch (e) {
      showError(e);
    } finally {
      isSaving = false;
    }
  }
  function validateMintUrl(url: string): boolean {
    const trimmed = url.trim();
    if (!trimmed) return false;
    try {
      const parsed = new URL(trimmed);
      return (parsed.protocol === 'https:' || parsed.protocol === 'http:') && !!parsed.hostname;
    } catch {
      return false;
    }
  }
  function validateRelayUrl(url: string): boolean {
    const trimmed = url.trim();
    if (!trimmed) return false;
    try {
      const parsed = new URL(trimmed);
      return (parsed.protocol === 'wss:' || parsed.protocol === 'ws:') && !!parsed.hostname;
    } catch {
      return false;
    }
  }
  function handleAddMint() {
    if (!validateMintUrl(newMintUrl)) {
      error = 'Invalid mint URL. Must be a valid HTTP/HTTPS URL.';
      return;
    }
    const trimmedUrl = newMintUrl.trim();
    if (mints.some(mint => mint === trimmedUrl)) {
      error = 'This mint is already added.';
      return;
    }
    pendingMints = [...pendingMints, trimmedUrl];
    markChanges();
    newMintUrl = '';
    isAddingMint = false;
    clearMessages();
  }
  function handleRemoveMint(mint: string) {
    pendingMints = pendingMints.filter(m => m !== mint);
    markChanges();
    clearMessages();
  }
  function handleAddRelay() {
    let trimmedUrl = newRelayUrl.trim();
    // Auto-add wss:// if missing
    if (!trimmedUrl.startsWith('wss://') && !trimmedUrl.startsWith('ws://')) {
      trimmedUrl = `wss://${trimmedUrl}`;
    }
    if (!validateRelayUrl(trimmedUrl)) {
      error = 'Invalid relay URL. Must be a valid WebSocket URL (wss:// or ws://).';
      return;
    }
    if (relays.includes(trimmedUrl)) {
      error = 'This relay is already added.';
      return;
    }
    pendingRelays = [...pendingRelays, trimmedUrl];
    markChanges();
    newRelayUrl = '';
    isAddingRelay = false;
    clearMessages();
  }
  function handleRemoveRelay(relay: string) {
    pendingRelays = pendingRelays.filter(r => r !== relay);
    markChanges();
    clearMessages();
  }
  function getMintName(mintUrl: string): string {
    try {
      const url = new URL(mintUrl);
      return url.hostname;
    } catch {
      return mintUrl;
    }
  }
  function getRelayName(relayUrl: string): string {
    try {
      const url = new URL(relayUrl);
      return url.hostname;
    } catch {
      return relayUrl;
    }
  }
  function formatSats(amount: number): string {
    return new Intl.NumberFormat('en-US').format(amount);
  }
  function handleBrowseMints(selectedMints: string[]) {
    const newMints = selectedMints.filter(mintUrl => !mints.includes(mintUrl));
    if (newMints.length > 0) {
      pendingMints = [...pendingMints, ...newMints];
      markChanges();
      clearMessages();
    }
    isBrowsingMints = false;
  }
  function handleNpubCashToggle() {
    npubCash.setEnabled(!npubCash.enabled);
  }
</script>
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-start justify-between gap-4">
    <div>
      <h2 class="text-xl font-semibold text-foreground mb-2">
        Wallet Configuration
      </h2>
      <p class="text-sm text-muted-foreground">
        Manage your Cashu mints, wallet relays, and Lightning integration.
      </p>
    </div>
    {#if hasPendingChanges}
      <button
        onclick={saveChanges}
        disabled={isSaving}
        class="px-6 py-2 bg-primary text-foreground rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium flex items-center gap-2 flex-shrink-0"
      >
        {#if isSaving}
          <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Saving...
        {:else}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Save
        {/if}
      </button>
    {/if}
  </div>
  <!-- Success/Error Messages -->
  {#if successMessage}
    <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-4">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-sm text-green-800 dark:text-green-300">{successMessage}</p>
      </div>
    </div>
  {/if}
  {#if error}
    <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-4">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-sm text-red-800 dark:text-red-300">{error}</p>
      </div>
    </div>
  {/if}
  <!-- Cashu Mints Section -->
  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-foreground">
        Cashu Mints
      </h3>
      <span class="text-sm text-muted-foreground">
        {mints.length} {mints.length === 1 ? 'mint' : 'mints'}
      </span>
    </div>
    <!-- Mint List -->
    <div class="space-y-2">
      {#each mints as mint (mint)}
        <div class="border rounded-lg p-4 bg-card border">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-foreground truncate">
                    {getMintName(mint)}
                  </div>
                  <div class="text-xs text-muted-foreground truncate">
                    {mint}
                  </div>
                </div>
              </div>
              {#if mintBalances.has(mint)}
                <div class="mt-2 text-sm">
                  <span class="text-primary dark:text-primary font-semibold">
                    {formatSats(mintBalances.get(mint) || 0)} sats
                  </span>
                </div>
              {/if}
            </div>
            <button
              onclick={() => handleRemoveMint(mint)}
              class="ml-3 p-2 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg transition-colors group"
              title="Remove mint"
            >
              <svg class="w-5 h-5 text-muted-foreground group-hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
      {/each}
      {#if mints.length === 0}
        <div class="text-center py-8 text-muted-foreground">
          <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          <p class="text-sm">No mints configured</p>
        </div>
      {/if}
      <!-- Add New Mint -->
      <button
        onclick={() => isBrowsingMints = true}
        class="w-full border rounded-lg p-3 hover:bg-muted transition-colors group"
      >
        <div class="flex items-center justify-center gap-2 text-muted-foreground group-hover:text-primary dark:group-hover:text-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          <span class="font-medium">Add Mint</span>
        </div>
      </button>
    </div>
  </div>
  <!-- Wallet Relays Section -->
  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-foreground">
        Wallet Relays
      </h3>
      <span class="text-sm text-muted-foreground">
        {relays.length} {relays.length === 1 ? 'relay' : 'relays'}
      </span>
    </div>
    <!-- Relay List -->
    <div class="space-y-2">
      {#each relays as relay (relay)}
        <div class="border rounded-lg p-4 bg-card border">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                </svg>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-foreground truncate">
                    {getRelayName(relay)}
                  </div>
                  <div class="text-xs text-muted-foreground truncate">
                    {relay}
                  </div>
                </div>
              </div>
            </div>
            <button
              onclick={() => handleRemoveRelay(relay)}
              class="ml-3 p-2 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg transition-colors group"
              title="Remove relay"
            >
              <svg class="w-5 h-5 text-muted-foreground group-hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
      {/each}
      {#if relays.length === 0}
        <div class="text-center py-8 text-muted-foreground">
          <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
          </svg>
          <p class="text-sm">No relays configured</p>
        </div>
      {/if}
      <!-- Add New Relay -->
      {#if isAddingRelay}
        <div class="border-2 border-dashed border-blue-300 dark:border-blue-700 rounded-lg p-4">
          <div class="space-y-3">
            <input
              type="text"
              bind:value={newRelayUrl}
              placeholder="wss://relay.example.com"
              class="w-full px-3 py-2 bg-card border border dark:border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-foreground"
              autofocus
            />
            <div class="text-xs text-muted-foreground">
              URL will automatically be prefixed with wss:// if not provided
            </div>
            <div class="flex gap-2">
              <button
                onclick={handleAddRelay}
                disabled={!newRelayUrl.trim()}
                class="px-4 py-2 bg-blue-600 text-foreground rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Add Relay
              </button>
              <button
                onclick={() => {
                  isAddingRelay = false;
                  newRelayUrl = '';
                  error = null;
                }}
                class="px-4 py-2 bg-neutral-200 dark:bg-muted text-muted-foreground rounded-lg hover:bg-neutral-300 dark:hover:bg-muted transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      {:else}
        <button
          onclick={() => isAddingRelay = true}
          class="w-full border rounded-lg p-3 hover:bg-muted transition-colors group"
        >
          <div class="flex items-center justify-center gap-2 text-muted-foreground group-hover:text-primary dark:group-hover:text-primary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <span class="font-medium">Add Relay</span>
          </div>
        </button>
      {/if}
    </div>
  </div>
  <!-- npub.cash Lightning Integration -->
  <div class="border rounded-lg p-4 bg-card">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <div>
          <h3 class="text-lg font-semibold text-foreground">
            npub.cash Lightning Zaps
          </h3>
          <p class="text-sm text-muted-foreground">
            Automatically redeem Lightning zaps received via npub.cash into your wallet.
          </p>
        </div>
      </div>
      <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
        <input
          type="checkbox"
          checked={npubCash.enabled}
          onchange={handleNpubCashToggle}
          class="sr-only peer"
        />
        <div class="w-11 h-6 bg-neutral-300 dark:bg-neutral-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
      </label>
    </div>
  </div>
</div>
<!-- Mint Browser Modal -->
<MintBrowser
  bind:open={isBrowsingMints}
  onSelectMints={handleBrowseMints}
  onClose={() => isBrowsingMints = false}
/>
</file>

<file path="settings/ZapSettings.svelte">
<script lang="ts">
  import { settings } from '$lib/stores/settings.svelte';
  const amounts = [10, 21, 50, 100, 500, 1000, 2100, 5000];
  let customAmount = $state('');
  let isEditingCustom = $state(false);
  function formatAmount(amount: number): string {
    if (amount >= 1000) {
      return `${(amount / 1000).toFixed(amount % 1000 === 0 ? 0 : 1)}K`;
    }
    return amount.toString();
  }
  function handleCustomAmount() {
    const parsed = Number.parseInt(customAmount);
    if (!Number.isNaN(parsed) && parsed > 0) {
      settings.updateZap({ defaultAmount: parsed });
      customAmount = '';
      isEditingCustom = false;
    }
  }
  function handleCustomKeydown(e: KeyboardEvent) {
    if (e.key === 'Enter') {
      handleCustomAmount();
    } else if (e.key === 'Escape') {
      customAmount = '';
      isEditingCustom = false;
    }
  }
</script>
<div class="space-y-6">
  <div>
    <h3 class="text-lg font-semibold text-foreground mb-4">
      Default Zap Amount
    </h3>
    <p class="text-sm text-muted-foreground mb-4">
      Choose the default amount for quick zaps. Long-press the zap button to choose a custom amount.
    </p>
    <div class="grid grid-cols-4 gap-3">
      {#each amounts as amount}
        <button
          onclick={() => settings.updateZap({ defaultAmount: amount })}
          class="relative overflow-hidden rounded-xl p-4 transition-all duration-200 {settings.zap.defaultAmount === amount
            ? 'bg-gradient-to-br from-primary-600 to-primary-700 dark:bg-primary text-foreground shadow-lg shadow-primary/30 dark:shadow-primary/50 scale-105'
            : 'bg-neutral-100 dark:bg-muted hover:bg-neutral-200 dark:hover:bg-muted text-foreground hover:scale-105'}"
          type="button"
        >
          <div class="flex flex-col items-center gap-2">
            <span class="text-xl">‚ö°</span>
            <span class="text-sm font-bold">{formatAmount(amount)}</span>
          </div>
        </button>
      {/each}
    </div>
    <!-- Custom Amount -->
    <div class="mt-4">
      {#if isEditingCustom}
        <div class="flex gap-2">
          <input
            type="number"
            bind:value={customAmount}
            onkeydown={handleCustomKeydown}
            placeholder="Enter custom amount..."
            class="flex-1 px-4 py-3 bg-neutral-100 dark:bg-muted border-2 border-primary dark:border-primary rounded-xl text-foreground placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none font-semibold"
            autofocus
          />
          <button
            onclick={handleCustomAmount}
            class="px-6 py-3 bg-gradient-to-br from-primary-600 to-primary-700 hover:opacity-90 text-foreground font-semibold rounded-xl transition-all"
            type="button"
          >
            Set
          </button>
          <button
            onclick={() => { customAmount = ''; isEditingCustom = false; }}
            class="px-6 py-3 bg-neutral-100 dark:bg-muted hover:bg-neutral-200 dark:hover:bg-muted text-foreground font-semibold rounded-xl transition-all"
            type="button"
          >
            Cancel
          </button>
        </div>
      {:else}
        <button
          onclick={() => isEditingCustom = true}
          class="w-full px-4 py-3 bg-neutral-100 dark:bg-muted hover:bg-neutral-200 dark:hover:bg-muted border-2 border-dashed border dark:border rounded-xl text-muted-foreground font-semibold transition-all flex items-center justify-center gap-2"
          type="button"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Custom Amount
        </button>
      {/if}
    </div>
  </div>
  <div class="p-4 bg-neutral-100 dark:bg-card border border rounded-xl">
    <div class="flex items-start gap-3">
      <div class="mt-0.5">
        <svg class="w-5 h-5 text-primary dark:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="flex-1">
        <h4 class="text-sm font-semibold text-foreground mb-1">
          How to Zap
        </h4>
        <ul class="text-sm text-muted-foreground space-y-1">
          <li><strong>Tap:</strong> Send default zap amount ({settings.zap.defaultAmount} sats)</li>
          <li><strong>Long-press:</strong> Choose custom amount from modal</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="p-4 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800/30 rounded-xl">
    <div class="flex items-center gap-2 mb-2">
      <span class="text-2xl">‚ö°</span>
      <h4 class="text-sm font-semibold text-primary-900 dark:text-primary-100">
        Current Default
      </h4>
    </div>
    <p class="text-3xl font-bold bg-gradient-to-r from-primary-600 to-primary-700 bg-clip-text text-transparent">
      {settings.zap.defaultAmount.toLocaleString()} sats
    </p>
  </div>
</div>
</file>

<file path="trades/CreateOrderModal.svelte">
<script lang="ts">
  import { NDKEvent, NDKRelaySet } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { clickOutside } from '$lib/utils/clickOutside';
  import { portal } from '$lib/utils/portal.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  import RelayPublishDropdownContent from '$lib/components/RelayPublishDropdownContent.svelte';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    open: boolean;
    onClose: () => void;
  }
  let { open = $bindable(false), onClose }: Props = $props();
  const currencies = [
    { code: 'USD', symbol: '$', name: 'US Dollar' },
    { code: 'EUR', symbol: '‚Ç¨', name: 'Euro' },
    { code: 'GBP', symbol: '¬£', name: 'British Pound' },
    { code: 'BRL', symbol: 'R$', name: 'Brazilian Real' },
    { code: 'ARS', symbol: '$', name: 'Argentine Peso' },
    { code: 'PLN', symbol: 'z≈Ç', name: 'Polish Z≈Çoty' },
  ];
  const paymentMethods = [
    { id: 'Cash (F2F)', name: 'Cash (F2F)', icon: 'üíµ', requiresLocation: true },
    { id: 'Revolut', name: 'Revolut', icon: 'üí≥' },
    { id: 'PIX', name: 'PIX (Brazil)', icon: 'üîÑ' },
    { id: 'BLIK', name: 'BLIK (Poland)', icon: 'üì±' },
    { id: 'Zelle', name: 'Zelle', icon: 'üè¶' },
    { id: 'CashApp', name: 'Cash App', icon: 'üì≤' },
    { id: 'custom', name: 'Other...', icon: '‚úèÔ∏è' },
  ];
  function encodeGeohash(lat: number, lon: number, precision = 5): string {
    const base32 = '0123456789bcdefghjkmnpqrstuvwxyz';
    let idx = 0;
    let bit = 0;
    let evenBit = true;
    let geohash = '';
    let latRange = [-90.0, 90.0];
    let lonRange = [-180.0, 180.0];
    while (geohash.length < precision) {
      if (evenBit) {
        const mid = (lonRange[0] + lonRange[1]) / 2;
        if (lon >= mid) {
          idx |= (1 << (4 - bit));
          lonRange[0] = mid;
        } else {
          lonRange[1] = mid;
        }
      } else {
        const mid = (latRange[0] + latRange[1]) / 2;
        if (lat >= mid) {
          idx |= (1 << (4 - bit));
          latRange[0] = mid;
        } else {
          latRange[1] = mid;
        }
      }
      evenBit = !evenBit;
      bit++;
      if (bit === 5) {
        geohash += base32[idx];
        bit = 0;
        idx = 0;
      }
    }
    return geohash;
  }
  let orderType = $state<'buy' | 'sell'>('buy');
  let currency = $state('USD');
  let satsAmount = $state('100000');
  let fiatAmount = $state('50');
  let paymentMethod = $state('Cash (F2F)');
  let customPaymentMethod = $state('');
  let location = $state('');
  let geohash = $state('');
  let premium = $state('0');
  let expirationHours = $state('24');
  let creating = $state(false);
  let selectedRelayUrls = $state<string[]>([]);
  let isProtected = $state(false);
  let isRelayDropdownOpen = $state(false);
  let relayButtonElement = $state<HTMLElement | null>(null);
  let dropdownPosition = $state({ top: 0, left: 0 });
  const allRelays = $derived(settings.relays.filter(r => r.enabled));
  // Initialize selected relays from current relay filter or use all write relays
  $effect(() => {
    if (open) {
      if (settings.selectedRelay) {
        selectedRelayUrls = [settings.selectedRelay];
      } else if (selectedRelayUrls.length === 0) {
        selectedRelayUrls = allRelays.filter(r => r.write).map(r => r.url);
      }
    }
  });
  const showLocationPicker = $derived(
    paymentMethods.find(m => m.id === paymentMethod)?.requiresLocation || false
  );
  $effect(() => {
    if (!showLocationPicker) {
      location = '';
      geohash = '';
    }
  });
  function handleLocationRequest() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const gh = encodeGeohash(lat, lon, 5);
          geohash = gh;
          location = `Near ${gh} (auto-detected)`;
          toast.success('Location detected');
        },
        (error) => {
          console.error('Error getting location:', error);
          toast.error('Could not get your location. Please enter city/area manually.');
        }
      );
    } else {
      toast.error('Geolocation is not supported by your browser');
    }
  }
  function toggleRelay(url: string) {
    if (selectedRelayUrls.includes(url)) {
      selectedRelayUrls = selectedRelayUrls.filter(u => u !== url);
    } else {
      selectedRelayUrls = [...selectedRelayUrls, url];
    }
  }
  function selectOnlyRelay(url: string) {
    selectedRelayUrls = [url];
    isRelayDropdownOpen = false;
  }
  function handleRelayDropdownClickOutside() {
    isRelayDropdownOpen = false;
  }
  function toggleRelayDropdown() {
    if (!isRelayDropdownOpen && relayButtonElement) {
      const rect = relayButtonElement.getBoundingClientRect();
      const dropdownHeight = 400; // max-h-[400px]
      const spaceBelow = window.innerHeight - rect.bottom;
      const shouldShowAbove = spaceBelow < dropdownHeight && rect.top > dropdownHeight;
      dropdownPosition = {
        top: shouldShowAbove ? rect.top - dropdownHeight - 8 : rect.bottom + 8,
        left: rect.left
      };
    }
    isRelayDropdownOpen = !isRelayDropdownOpen;
  }
  async function handleCreate() {
    const actualPaymentMethod = paymentMethod === 'custom' ? customPaymentMethod : paymentMethod;
    if (!actualPaymentMethod) {
      toast.error('Please specify a payment method');
      return;
    }
    if (paymentMethod === 'Cash (F2F)' && !location && !geohash) {
      toast.error('Please provide a location for face-to-face trades');
      return;
    }
    creating = true;
    try {
      const event = new NDKEvent(ndk);
      event.kind = 38383;
      const orderId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const tags: string[][] = [
        ['d', orderId],
        ['k', orderType],
        ['f', currency],
        ['s', 'pending'],
        ['amt', satsAmount],
        ['fa', fiatAmount],
        ['pm', actualPaymentMethod],
        ['premium', premium],
        ['y', 'Agora'],
        ['z', 'order'],
        ['network', 'mainnet'],
        ['layer', 'lightning'],
        ['expiration', (Math.floor(Date.now() / 1000) + Number.parseInt(expirationHours) * 3600).toString()]
      ];
      if (geohash) {
        tags.push(['g', geohash]);
      }
      // Add protected flag if enabled (NIP-70)
      if (isProtected) {
        tags.push(['-']);
      }
      event.tags = tags;
      event.content = '';
      // Publish to selected relays
      const relaySet = NDKRelaySet.fromRelayUrls(selectedRelayUrls, ndk);
      await event.publish(relaySet);
      toast.success('Order created successfully');
      open = false;
      onClose();
    } catch (error) {
      console.error('Failed to create order:', error);
      toast.error('Failed to create order');
    } finally {
      creating = false;
    }
  }
  const btcAmount = $derived(parseInt(satsAmount) / 100000000);
  const pricePerBtc = $derived(parseFloat(fiatAmount) / btcAmount);
</script>
{#if isDesktop.current}
<Dialog.Root {open} onOpenChange={(newOpen) => {
    open = newOpen;
    if (!newOpen) onClose();
  }}>
  <Dialog.Content class="max-w-lg max-h-[90vh] overflow-y-auto">
    <Dialog.Header>
      <Dialog.Title>Create P2P Order</Dialog.Title>
    </Dialog.Header>
    <div class="space-y-6">
      <!-- Order Type -->
      <div>
        <Label class="block mb-2">Order Type</Label>
        <div class="grid grid-cols-2 gap-3">
          <Button
            variant={orderType === 'buy' ? 'default' : 'outline'}
            onclick={() => orderType = 'buy'}
            class={orderType === 'buy' ? 'border-green-500 bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/40' : ''}
          >
            I want to buy Bitcoin
          </Button>
          <Button
            variant={orderType === 'sell' ? 'default' : 'outline'}
            onclick={() => orderType = 'sell'}
            class={orderType === 'sell' ? 'border-red-500 bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40' : ''}
          >
            I want to sell Bitcoin
          </Button>
        </div>
      </div>
      <!-- Bitcoin Amount -->
      <div>
        <Label for="sats-amount">Bitcoin Amount (sats)</Label>
        <div class="relative mt-2">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-primary" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
          </svg>
          <Input
            id="sats-amount"
            type="number"
            bind:value={satsAmount}
            class="pl-10"
            placeholder="100000"
          />
        </div>
        <p class="mt-1 text-xs text-muted-foreground">
          = {btcAmount.toFixed(8)} BTC
        </p>
      </div>
      <!-- Fiat Amount & Currency -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <Label for="fiat-amount">Fiat Amount</Label>
          <Input
            id="fiat-amount"
            type="number"
            bind:value={fiatAmount}
            placeholder="50"
            class="mt-2"
          />
          <p class="mt-1 text-xs text-muted-foreground">
            ‚âà ${pricePerBtc.toFixed(2)}/BTC
          </p>
        </div>
        <div>
          <Label for="currency">Currency</Label>
          <select
            id="currency"
            bind:value={currency}
            class="mt-2 w-full px-3 py-2 border border-input rounded-md bg-background text-foreground"
          >
            {#each currencies as curr}
              <option value={curr.code}>
                {curr.symbol} {curr.code}
              </option>
            {/each}
          </select>
        </div>
      </div>
      <!-- Payment Method -->
      <div>
        <Label class="block mb-2">Payment Method</Label>
        <div class="grid grid-cols-2 gap-3">
          {#each paymentMethods as method}
            <Button
              variant={paymentMethod === method.id ? 'default' : 'outline'}
              onclick={() => paymentMethod = method.id}
              class="justify-start h-auto py-2 {paymentMethod === method.id ? 'border-primary' : ''}"
            >
              <span class="text-lg mr-2">{method.icon}</span>
              <span class="text-sm">{method.name}</span>
            </Button>
          {/each}
        </div>
        {#if paymentMethod === 'custom'}
          <div class="mt-3">
            <Input
              bind:value={customPaymentMethod}
              placeholder="Enter payment method (e.g., Bank Transfer, PayPal, etc.)"
              autofocus
            />
          </div>
        {/if}
      </div>
      <!-- Location for F2F -->
      {#if showLocationPicker}
        <div>
          <Label for="location" class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Location (Required for F2F)
          </Label>
          <div class="space-y-2 mt-2">
            <div class="flex gap-2">
              <Input
                id="location"
                bind:value={location}
                placeholder="City, neighborhood, or area"
                class="flex-1"
              />
              <Button
                variant="outline"
                size="icon"
                onclick={handleLocationRequest}
                title="Use current location"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </Button>
            </div>
            {#if geohash}
              <p class="text-xs text-muted-foreground">
                Geohash: {geohash} (approximate location)
              </p>
            {/if}
          </div>
        </div>
      {/if}
      <!-- Premium -->
      <div>
        <Label for="premium">Premium (%)</Label>
        <Input
          id="premium"
          type="number"
          bind:value={premium}
          placeholder="0"
          class="mt-2"
        />
        <p class="mt-1 text-xs text-muted-foreground">
          Positive for above market, negative for below
        </p>
      </div>
      <!-- Expiration -->
      <div>
        <Label for="expiration">Expiration (hours)</Label>
        <select
          id="expiration"
          bind:value={expirationHours}
          class="mt-2 w-full px-3 py-2 border border-input rounded-md bg-background text-foreground"
        >
          <option value="1">1 hour</option>
          <option value="6">6 hours</option>
          <option value="12">12 hours</option>
          <option value="24">24 hours</option>
          <option value="48">48 hours</option>
          <option value="72">72 hours</option>
        </select>
      </div>
    </div>
    <Dialog.Footer class="mt-6 flex items-center justify-between gap-4">
      <div class="relative">
        <Button
          bind:ref={relayButtonElement}
          type="button"
          variant="outline"
          size="icon"
          onclick={toggleRelayDropdown}
          disabled={creating}
          class="h-10 w-10"
          title="Select relays"
        >
          {#if selectedRelayUrls.length <= 2 && selectedRelayUrls.length > 0}
            <div class="flex items-center -space-x-1">
              {#each selectedRelayUrls as relayUrl}
                {@const relay = allRelays.find(r => r.url === relayUrl)}
                {@const relayInfo = relay ? useRelayInfoCached(relay.url) : null}
                {#if relayInfo?.info?.icon}
                  <img src={relayInfo.info.icon} alt="" class="w-5 h-5 rounded border border-background" />
                {:else}
                  <div class="w-5 h-5 rounded bg-muted flex items-center justify-center border border-background">
                    <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                    </svg>
                  </div>
                {/if}
              {/each}
            </div>
          {:else}
            <div class="relative">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
              </svg>
              {#if selectedRelayUrls.length > 2}
                <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                  {selectedRelayUrls.length}
                </span>
              {/if}
            </div>
          {/if}
        </Button>
        {#if isRelayDropdownOpen}
          <div
            use:portal
            use:clickOutside={handleRelayDropdownClickOutside}
            style="position: fixed; top: {dropdownPosition.top}px; left: {dropdownPosition.left}px;"
            class="bg-popover border border-border rounded-lg shadow-xl z-50 w-80 max-h-[400px] overflow-y-auto"
          >
            <RelayPublishDropdownContent
              {selectedRelayUrls}
              bind:isProtected
              onToggleRelay={toggleRelay}
              onSelectOnly={selectOnlyRelay}
            />
          </div>
        {/if}
      </div>
      <div class="flex gap-2">
        <Button variant="outline" onclick={() => { open = false; onClose(); }}>
          Cancel
        </Button>
        <Button
          onclick={handleCreate}
          disabled={creating || !satsAmount || !fiatAmount}
        >
          {creating ? 'Creating...' : 'Create Order'}
        </Button>
      </div>
    </Dialog.Footer>
  </Dialog.Content>
</Dialog.Root>
{:else}
<Drawer.Root {open} onOpenChange={(newOpen) => {
    open = newOpen;
    if (!newOpen) onClose();
  }}>
  <Drawer.Content>
    <Drawer.Header class="text-left">
      <Drawer.Title>Create P2P Order</Drawer.Title>
    </Drawer.Header>
    <div class="space-y-6 px-4 overflow-y-auto pb-4">
      <!-- Order Type -->
      <div>
        <Label class="block mb-2">Order Type</Label>
        <div class="grid grid-cols-2 gap-3">
          <Button
            variant={orderType === 'buy' ? 'default' : 'outline'}
            onclick={() => orderType = 'buy'}
            class={orderType === 'buy' ? 'border-green-500 bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/40' : ''}
          >
            I want to buy Bitcoin
          </Button>
          <Button
            variant={orderType === 'sell' ? 'default' : 'outline'}
            onclick={() => orderType = 'sell'}
            class={orderType === 'sell' ? 'border-red-500 bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40' : ''}
          >
            I want to sell Bitcoin
          </Button>
        </div>
      </div>
      <!-- Bitcoin Amount -->
      <div>
        <Label for="sats-amount">Bitcoin Amount (sats)</Label>
        <div class="relative mt-2">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-primary" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
          </svg>
          <Input
            id="sats-amount"
            type="number"
            bind:value={satsAmount}
            class="pl-10"
            placeholder="100000"
          />
        </div>
        <p class="mt-1 text-xs text-muted-foreground">
          = {btcAmount.toFixed(8)} BTC
        </p>
      </div>
      <!-- Fiat Amount & Currency -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <Label for="fiat-amount">Fiat Amount</Label>
          <Input
            id="fiat-amount"
            type="number"
            bind:value={fiatAmount}
            placeholder="50"
            class="mt-2"
          />
          <p class="mt-1 text-xs text-muted-foreground">
            ‚âà ${pricePerBtc.toFixed(2)}/BTC
          </p>
        </div>
        <div>
          <Label for="currency">Currency</Label>
          <select
            id="currency"
            bind:value={currency}
            class="mt-2 w-full px-3 py-2 border border-input rounded-md bg-background text-foreground"
          >
            {#each currencies as curr}
              <option value={curr.code}>
                {curr.symbol} {curr.code}
              </option>
            {/each}
          </select>
        </div>
      </div>
      <!-- Payment Method -->
      <div>
        <Label class="block mb-2">Payment Method</Label>
        <div class="grid grid-cols-2 gap-3">
          {#each paymentMethods as method}
            <Button
              variant={paymentMethod === method.id ? 'default' : 'outline'}
              onclick={() => paymentMethod = method.id}
              class="justify-start h-auto py-2 {paymentMethod === method.id ? 'border-primary' : ''}"
            >
              <span class="text-lg mr-2">{method.icon}</span>
              <span class="text-sm">{method.name}</span>
            </Button>
          {/each}
        </div>
        {#if paymentMethod === 'custom'}
          <div class="mt-3">
            <Input
              bind:value={customPaymentMethod}
              placeholder="Enter payment method (e.g., Bank Transfer, PayPal, etc.)"
              autofocus
            />
          </div>
        {/if}
      </div>
      <!-- Location for F2F -->
      {#if showLocationPicker}
        <div>
          <Label for="location" class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Location (Required for F2F)
          </Label>
          <div class="space-y-2 mt-2">
            <div class="flex gap-2">
              <Input
                id="location"
                bind:value={location}
                placeholder="City, neighborhood, or area"
                class="flex-1"
              />
              <Button
                variant="outline"
                size="icon"
                onclick={handleLocationRequest}
                title="Use current location"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </Button>
            </div>
            {#if geohash}
              <p class="text-xs text-muted-foreground">
                Geohash: {geohash} (approximate location)
              </p>
            {/if}
          </div>
        </div>
      {/if}
      <!-- Premium -->
      <div>
        <Label for="premium">Premium (%)</Label>
        <Input
          id="premium"
          type="number"
          bind:value={premium}
          placeholder="0"
          class="mt-2"
        />
        <p class="mt-1 text-xs text-muted-foreground">
          Positive for above market, negative for below
        </p>
      </div>
      <!-- Expiration -->
      <div>
        <Label for="expiration">Expiration (hours)</Label>
        <select
          id="expiration"
          bind:value={expirationHours}
          class="mt-2 w-full px-3 py-2 border border-input rounded-md bg-background text-foreground"
        >
          <option value="1">1 hour</option>
          <option value="6">6 hours</option>
          <option value="12">12 hours</option>
          <option value="24">24 hours</option>
          <option value="48">48 hours</option>
          <option value="72">72 hours</option>
        </select>
      </div>
    </div>
    <Drawer.Footer class="pt-2">
      <div class="flex items-center justify-between gap-4 w-full">
        <div class="relative">
          <Button
            bind:ref={relayButtonElement}
            type="button"
            variant="outline"
            size="icon"
            onclick={toggleRelayDropdown}
            disabled={creating}
            class="h-10 w-10"
            title="Select relays"
          >
            {#if selectedRelayUrls.length <= 2 && selectedRelayUrls.length > 0}
              <div class="flex items-center -space-x-1">
                {#each selectedRelayUrls as relayUrl}
                  {@const relay = allRelays.find(r => r.url === relayUrl)}
                  {@const relayInfo = relay ? useRelayInfoCached(relay.url) : null}
                  {#if relayInfo?.info?.icon}
                    <img src={relayInfo.info.icon} alt="" class="w-5 h-5 rounded border border-background" />
                  {:else}
                    <div class="w-5 h-5 rounded bg-muted flex items-center justify-center border border-background">
                      <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                      </svg>
                    </div>
                  {/if}
                {/each}
              </div>
            {:else}
              <div class="relative">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                </svg>
                {#if selectedRelayUrls.length > 2}
                  <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                    {selectedRelayUrls.length}
                  </span>
                {/if}
              </div>
            {/if}
          </Button>
          {#if isRelayDropdownOpen}
            <div
              use:portal
              use:clickOutside={handleRelayDropdownClickOutside}
              style="position: fixed; top: {dropdownPosition.top}px; left: {dropdownPosition.left}px;"
              class="bg-popover border border-border rounded-lg shadow-xl z-50 w-80 max-h-[400px] overflow-y-auto"
            >
              <RelayPublishDropdownContent
                {selectedRelayUrls}
                bind:isProtected
                onToggleRelay={toggleRelay}
                onSelectOnly={selectOnlyRelay}
              />
            </div>
          {/if}
        </div>
        <div class="flex gap-2">
          <Button variant="outline" onclick={() => { open = false; onClose(); }}>
            Cancel
          </Button>
          <Button
            onclick={handleCreate}
            disabled={creating || !satsAmount || !fiatAmount}
          >
            {creating ? 'Creating...' : 'Create Order'}
          </Button>
        </div>
      </div>
    </Drawer.Footer>
  </Drawer.Content>
</Drawer.Root>
{/if}
</file>

<file path="trades/OrderBook.svelte">
<script lang="ts">
  import type { NDKEvent, NDKFilter } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import OrderCard from './OrderCard.svelte';
  interface Order {
    id: string;
    pubkey: string;
    type: 'buy' | 'sell';
    currency: string;
    status: string;
    paymentMethod: string;
    satsAmount: number;
    fiatAmount: number;
    premium?: number;
    rating?: number;
    platform?: string;
    geohash?: string;
    source?: string;
    createdAt: number;
    event: NDKEvent;
  }
  interface Props {
    filters: {
      currency: string;
      paymentMethod: string;
      orderType: 'all' | 'buy' | 'sell';
      minAmount: number;
      maxAmount: number;
    };
  }
  let { filters }: Props = $props();
  const subscription = ndk.$subscribe(() => ({
    filters: [{ kinds: [38383], limit: 100 }],
    closeOnEose: false,
  }));
  const events = $derived(subscription.events);
  const orders = $derived.by(() => {
    const parsedOrders: Order[] = [];
    events.forEach((event: NDKEvent) => {
      const tags = event.tags;
      // Skip info events
      const zTag = tags.find((t: string[]) => t[0] === 'z');
      if (zTag && zTag[1] === 'info') return;
      // Extract order data from tags
      const orderType = tags.find((t: string[]) => t[0] === 'k')?.[1] as 'buy' | 'sell';
      const currency = tags.find((t: string[]) => t[0] === 'f')?.[1];
      const status = tags.find((t: string[]) => t[0] === 's')?.[1];
      const paymentMethod = tags.find((t: string[]) => t[0] === 'pm')?.[1];
      const satsAmount = parseInt(tags.find((t: string[]) => t[0] === 'amt')?.[1] || '0');
      const fiatAmount = parseFloat(tags.find((t: string[]) => t[0] === 'fa')?.[1] || '0');
      const premium = parseFloat(tags.find((t: string[]) => t[0] === 'premium')?.[1] || '0');
      const rating = parseFloat(tags.find((t: string[]) => t[0] === 'rating')?.[1] || '0');
      const platform = tags.find((t: string[]) => t[0] === 'y')?.[1];
      const geohash = tags.find((t: string[]) => t[0] === 'g')?.[1];
      const source = tags.find((t: string[]) => t[0] === 'source')?.[1];
      const dTag = tags.find((t: string[]) => t[0] === 'd')?.[1];
      // Only include active orders
      if (status === 'pending' && orderType && currency && dTag) {
        parsedOrders.push({
          id: dTag,
          pubkey: event.pubkey,
          type: orderType,
          currency,
          status,
          paymentMethod: paymentMethod || 'Unknown',
          satsAmount,
          fiatAmount,
          premium,
          rating,
          platform,
          geohash,
          source,
          createdAt: event.created_at || Date.now() / 1000,
          event
        });
      }
    });
    // Sort by created date, newest first
    parsedOrders.sort((a, b) => b.createdAt - a.createdAt);
    return parsedOrders;
  });
  // Filter orders based on user preferences
  const filteredOrders = $derived(orders.filter(order => {
    if (filters.currency !== 'all' && order.currency !== filters.currency) return false;
    if (filters.paymentMethod !== 'all' && order.paymentMethod !== filters.paymentMethod) return false;
    if (filters.orderType !== 'all' && order.type !== filters.orderType) return false;
    if (order.satsAmount < filters.minAmount || order.satsAmount > filters.maxAmount) return false;
    return true;
  }));
</script>
<div class="w-full">
  <div class="grid gap-3 md:gap-4">
    {#if filteredOrders.length === 0}
      <div class="text-center py-12 text-muted-foreground">
        No orders available matching your filters
      </div>
    {:else}
      {#each filteredOrders as order (order.id)}
        <OrderCard {order} />
      {/each}
    {/if}
  </div>
</div>
</file>

<file path="trades/OrderCard.svelte">
<script lang="ts">
  import type { NDKEvent, NDKUserProfile } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import TakeOrderModal from './TakeOrderModal.svelte';
  import TimeAgo from '../TimeAgo.svelte';
  import EventOptionsMenu from '../EventOptionsMenu.svelte';
  interface Props {
    order: {
      id: string;
      pubkey: string;
      type: 'buy' | 'sell';
      currency: string;
      status: string;
      paymentMethod: string;
      satsAmount: number;
      fiatAmount: number;
      premium?: number;
      rating?: number;
      platform?: string;
      geohash?: string;
      source?: string;
      createdAt: number;
      event: NDKEvent;
    };
  }
  let { order }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    order.event.author.fetchProfile().then(p => { profile = p; });
  });
  let showTakeModal = $state(false);
  const currencyData: { [key: string]: { symbol: string; flag: string } } = {
    USD: { symbol: '$', flag: 'üá∫üá∏' },
    EUR: { symbol: '‚Ç¨', flag: 'üá™üá∫' },
    GBP: { symbol: '¬£', flag: 'üá¨üáß' },
    BRL: { symbol: 'R$', flag: 'üáßüá∑' },
    ARS: { symbol: '$', flag: 'üá¶üá∑' },
    PLN: { symbol: 'z≈Ç', flag: 'üáµüá±' },
    JPY: { symbol: '¬•', flag: 'üáØüáµ' },
    CHF: { symbol: 'Fr', flag: 'üá®üá≠' },
    PEN: { symbol: 'S/', flag: 'üáµüá™' },
    UYU: { symbol: '$', flag: 'üá∫üáæ' },
    VES: { symbol: 'Bs', flag: 'üáªüá™' },
    RUB: { symbol: '‚ÇΩ', flag: 'üá∑üá∫' },
    SEK: { symbol: 'kr', flag: 'üá∏üá™' },
    NOK: { symbol: 'kr', flag: 'üá≥üá¥' },
    AUD: { symbol: '$', flag: 'üá¶üá∫' },
    CUP: { symbol: '$', flag: 'üá®üá∫' },
  };
  const paymentMethodData: { [key: string]: { icon: string; region: string } } = {
    'Cash': { icon: 'üíµ', region: 'Universal' },
    'Cash (F2F)': { icon: 'üíµ', region: 'Local' },
    'PIX': { icon: 'üîÑ', region: 'Brazil' },
    'BLIK': { icon: 'üì±', region: 'Poland' },
    'Revolut': { icon: 'üí≥', region: 'Europe' },
    'Zelle': { icon: 'üè¶', region: 'USA' },
    'CashApp': { icon: 'üì≤', region: 'USA' },
    'CVU': { icon: 'üèß', region: 'Argentina' },
    'MP': { icon: 'üì≤', region: 'Argentina' },
    'f2f': { icon: 'ü§ù', region: 'Local' },
    '–°–ë–ü': { icon: 'üè¶', region: 'Russia' },
  };
  const currencyInfo = $derived(currencyData[order.currency] || { symbol: order.currency, flag: 'üåç' });
  const paymentInfo = $derived(paymentMethodData[order.paymentMethod] || { icon: 'üí∞', region: '' });
  // Calculate price per BTC
  const pricePerBtc = $derived(order.fiatAmount > 0 && order.satsAmount > 0
    ? (order.fiatAmount / order.satsAmount) * 100000000
    : 0);
</script>
<div class="bg-card rounded-lg md:rounded-xl border border p-3 md:p-4 hover:shadow-lg transition-shadow">
  <div class="flex items-start justify-between mb-2 md:mb-3">
    <div class="flex items-center gap-3">
      {#if profile?.picture}
        <img
          src={profile.picture}
          alt={profile.name || 'User'}
          class="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover"
        />
      {:else}
        <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br bg-primary rounded-full" />
      {/if}
      <div>
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-sm md:text-base text-foreground">
            {profile?.name || `@${order.pubkey.slice(0, 6)}...`}
          </h3>
          {#if order.rating && order.rating > 0}
            <div class="flex items-center gap-1 text-yellow-500">
              <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span class="text-sm">{order.rating.toFixed(1)}</span>
            </div>
          {/if}
        </div>
        <p class="text-xs text-muted-foreground">
          <TimeAgo timestamp={order.createdAt} />
          {#if order.platform}
            ‚Ä¢ {order.platform}
          {/if}
          {#if order.geohash && order.paymentMethod.includes('F2F')}
            <span class="inline-flex items-center gap-1 ml-2">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span>Near {order.geohash.substring(0, 4)}</span>
            </span>
          {/if}
        </p>
      </div>
    </div>
    <div class="flex items-center gap-1 md:gap-2">
      <span class="text-lg md:text-2xl">{currencyInfo.flag}</span>
      <div class={`px-2 md:px-3 py-0.5 md:py-1 rounded-full text-xs md:text-sm font-medium ${
        order.type === 'buy'
          ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
          : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
      }`}>
        {order.type === 'buy' ? 'Buying' : 'Selling'}
      </div>
      <EventOptionsMenu event={order.event} />
    </div>
  </div>
  <div class="grid grid-cols-3 gap-2 md:gap-4 mb-3 md:mb-4">
    <div>
      <p class="text-xs text-muted-foreground mb-0.5 md:mb-1">Amount</p>
      <div class="flex items-center gap-1 md:gap-2">
        <svg class="w-3 h-3 md:w-4 md:h-4 text-primary" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
        </svg>
        <span class="font-mono font-semibold text-xs md:text-base text-foreground">
          {(order.satsAmount / 100000000).toFixed(4)}
        </span>
      </div>
      <p class="text-xs text-muted-foreground mt-0.5 md:mt-1 hidden md:block">
        {order.satsAmount.toLocaleString()} sats
      </p>
    </div>
    <div>
      <p class="text-xs text-muted-foreground mb-0.5 md:mb-1">Price</p>
      <div class="flex items-center gap-1">
        <span class="text-sm md:text-base hidden md:inline">{currencyInfo.flag}</span>
        <p class="text-sm md:text-lg font-semibold text-foreground">
          {currencyInfo.symbol}{order.fiatAmount.toFixed(0)}
        </p>
      </div>
      {#if pricePerBtc > 0}
        <p class="text-xs text-muted-foreground mt-1">
          {currencyInfo.symbol}{pricePerBtc.toFixed(2)}/BTC
          {#if order.premium && order.premium !== 0}
            <span class={order.premium > 0 ? 'text-red-500' : 'text-green-500'}>
              ({order.premium > 0 ? '+' : ''}{order.premium}%)
            </span>
          {/if}
        </p>
      {/if}
    </div>
    <div class="min-w-0">
      <p class="text-xs text-muted-foreground mb-0.5 md:mb-1">Payment</p>
      <div class="flex items-center gap-1 md:gap-2">
        <span class="text-sm md:text-lg flex-shrink-0">{paymentInfo.icon}</span>
        <div class="flex flex-col min-w-0">
          <span class="font-medium text-xs md:text-base text-foreground truncate max-w-[80px] md:max-w-none">
            {order.paymentMethod}
          </span>
          {#if paymentInfo.region}
            <span class="text-xs text-muted-foreground hidden md:inline">
              {paymentInfo.region}
            </span>
          {/if}
        </div>
      </div>
    </div>
  </div>
  <div class="flex items-center gap-2">
    {#if order.source}
      <a
        href={order.source}
        target="_blank"
        rel="noopener noreferrer"
        class="flex-1 flex items-center justify-center gap-1 md:gap-2 px-3 md:px-4 py-1.5 md:py-2 bg-primary text-foreground rounded-lg hover:bg-primary-700 transition-colors text-sm md:text-base"
        title="View on {order.platform || 'external site'}"
      >
        <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
        <span class="hidden md:inline">View on {order.platform || 'Site'}</span>
        <span class="md:hidden">View</span>
      </a>
    {:else}
      <button
        onclick={() => showTakeModal = true}
        class="flex-1 flex items-center justify-center gap-1 md:gap-2 px-3 md:px-4 py-1.5 md:py-2 bg-primary text-foreground rounded-lg hover:bg-primary-700 transition-colors text-sm md:text-base"
      >
        <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
        </svg>
        <span class="hidden md:inline">{order.type === 'buy' ? 'Sell to User' : 'Buy from User'}</span>
        <span class="md:hidden">{order.type === 'buy' ? 'Sell' : 'Buy'}</span>
      </button>
    {/if}
    <button class="p-1.5 md:p-2 border border rounded-lg hover:bg-accent transition-colors">
      <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
      </svg>
    </button>
    <button class="p-1.5 md:p-2 border border rounded-lg hover:bg-accent transition-colors hidden md:block">
      <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
      </svg>
    </button>
  </div>
</div>
{#if showTakeModal}
  <TakeOrderModal {order} onClose={() => showTakeModal = false} />
{/if}
</file>

<file path="trades/TakeOrderModal.svelte">
<script lang="ts">
  import { NDKEvent, type NDKUserProfile } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    open: boolean;
    order: {
      id: string;
      pubkey: string;
      type: 'buy' | 'sell';
      currency: string;
      status: string;
      paymentMethod: string;
      satsAmount: number;
      fiatAmount: number;
      premium?: number;
      rating?: number;
      platform?: string;
      createdAt: number;
      event: NDKEvent;
    };
    onClose: () => void;
  }
  let { open = $bindable(false), order, onClose }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    order.event.author.fetchProfile().then(p => { profile = p; });
  });
  let step = $state<'confirm' | 'processing' | 'complete'>('confirm');
  let accepted = $state(false);
  async function handleTakeOrder() {
    step = 'processing';
    try {
      // Create a take order event
      const event = new NDKEvent(ndk);
      event.kind = 38383;
      // Create response event with reference to original order
      event.tags = [
        ['d', `take-${order.id}-${Date.now()}`],
        ['e', order.event.id],
        ['p', order.pubkey],
        ['k', order.type === 'buy' ? 'sell' : 'buy'],
        ['f', order.currency],
        ['s', 'in-progress'],
        ['amt', order.satsAmount.toString()],
        ['fa', order.fiatAmount.toString()],
        ['pm', order.paymentMethod],
        ['y', 'Agora'],
        ['z', 'take-order']
      ];
      event.content = `Taking order ${order.id}`;
      await event.publish();
      // Update original order status (in real implementation, this would be handled by the maker)
      const statusUpdate = new NDKEvent(ndk);
      statusUpdate.kind = 38383;
      statusUpdate.tags = [
        ...order.event.tags.filter(t => t[0] !== 's'),
        ['s', 'in-progress']
      ];
      statusUpdate.content = '';
      await statusUpdate.publish();
      step = 'complete';
      // Close modal after a delay
      setTimeout(() => {
        open = false;
        onClose();
      }, 2000);
    } catch (error) {
      console.error('Failed to take order:', error);
      step = 'confirm';
    }
  }
  const currencySymbol = $derived({ USD: '$', EUR: '‚Ç¨', GBP: '¬£', BRL: 'R$' }[order.currency as 'USD' | 'EUR' | 'GBP' | 'BRL'] || order.currency);
</script>
{#if isDesktop.current}
<Dialog.Root {open} onOpenChange={(newOpen) => {
    open = newOpen;
    if (!newOpen) onClose();
  }}>
  <Dialog.Content class="max-w-md">
    {#if step === 'confirm'}
      <Dialog.Header>
        <Dialog.Title>Confirm Trade</Dialog.Title>
      </Dialog.Header>
      <div class="space-y-4">
        <!-- Trade Summary -->
        <div class="bg-neutral-50 dark:bg-background rounded-lg p-4 space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">You will {order.type === 'buy' ? 'sell' : 'buy'}</span>
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
              </svg>
              <span class="font-mono font-semibold">{(order.satsAmount / 100000000).toFixed(8)} BTC</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">For</span>
            <span class="font-semibold">{currencySymbol}{order.fiatAmount.toFixed(2)}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">Via</span>
            <span class="font-medium">{order.paymentMethod}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">Trading with</span>
            <div class="flex items-center gap-2">
              <span class="font-medium">{profile?.name || 'Anonymous'}</span>
              {#if order.rating}
                <span class="text-yellow-500 text-sm">‚òÖ {order.rating.toFixed(1)}</span>
              {/if}
            </div>
          </div>
        </div>
        <!-- Warning -->
        <div class="flex items-start gap-3 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
          <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div class="text-sm text-yellow-800 dark:text-yellow-300">
            <p class="font-medium mb-1">Trade Safely</p>
            <ul class="space-y-1 text-xs">
              <li>‚Ä¢ Never release funds before confirming payment</li>
              <li>‚Ä¢ Use escrow when available</li>
              <li>‚Ä¢ Communicate only through secure channels</li>
              <li>‚Ä¢ Report suspicious behavior immediately</li>
            </ul>
          </div>
        </div>
        <!-- Terms Acceptance -->
        <label class="flex items-start gap-3 cursor-pointer">
          <input
            type="checkbox"
            bind:checked={accepted}
            class="mt-1 w-4 h-4 text-primary border rounded focus:ring-orange-500"
          />
          <span class="text-sm text-muted-foreground">
            I understand the risks and agree to proceed with this P2P trade
          </span>
        </label>
      </div>
      <Dialog.Footer>
        <Button variant="outline" onclick={() => { open = false; onClose(); }}>
          Cancel
        </Button>
        <Button onclick={handleTakeOrder} disabled={!accepted}>
          Take Order
        </Button>
      </Dialog.Footer>
    {/if}
    {#if step === 'processing'}
      <div class="py-12 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <p class="text-foreground font-medium">Processing Trade...</p>
        <p class="text-sm text-muted-foreground mt-2">
          Connecting with trader
        </p>
      </div>
    {/if}
    {#if step === 'complete'}
      <div class="py-12 text-center">
        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <p class="text-foreground font-medium">Trade Initiated!</p>
        <p class="text-sm text-muted-foreground mt-2">
          Check your messages for next steps
        </p>
      </div>
    {/if}
  </Dialog.Content>
</Dialog.Root>
{:else}
<Drawer.Root {open} onOpenChange={(newOpen) => {
    open = newOpen;
    if (!newOpen) onClose();
  }}>
  <Drawer.Content>
    {#if step === 'confirm'}
      <Drawer.Header class="text-left">
        <Drawer.Title>Confirm Trade</Drawer.Title>
      </Drawer.Header>
      <div class="space-y-4 px-4 overflow-y-auto pb-4">
        <!-- Trade Summary -->
        <div class="bg-neutral-50 dark:bg-background rounded-lg p-4 space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">You will {order.type === 'buy' ? 'sell' : 'buy'}</span>
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
              </svg>
              <span class="font-mono font-semibold">{(order.satsAmount / 100000000).toFixed(8)} BTC</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">For</span>
            <span class="font-semibold">{currencySymbol}{order.fiatAmount.toFixed(2)}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">Via</span>
            <span class="font-medium">{order.paymentMethod}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">Trading with</span>
            <div class="flex items-center gap-2">
              <span class="font-medium">{profile?.name || 'Anonymous'}</span>
              {#if order.rating}
                <span class="text-yellow-500 text-sm">‚òÖ {order.rating.toFixed(1)}</span>
              {/if}
            </div>
          </div>
        </div>
        <!-- Warning -->
        <div class="flex items-start gap-3 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
          <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div class="text-sm text-yellow-800 dark:text-yellow-300">
            <p class="font-medium mb-1">Trade Safely</p>
            <ul class="space-y-1 text-xs">
              <li>‚Ä¢ Never release funds before confirming payment</li>
              <li>‚Ä¢ Use escrow when available</li>
              <li>‚Ä¢ Communicate only through secure channels</li>
              <li>‚Ä¢ Report suspicious behavior immediately</li>
            </ul>
          </div>
        </div>
        <!-- Terms Acceptance -->
        <label class="flex items-start gap-3 cursor-pointer">
          <input
            type="checkbox"
            bind:checked={accepted}
            class="mt-1 w-4 h-4 text-primary border rounded focus:ring-orange-500"
          />
          <span class="text-sm text-muted-foreground">
            I understand the risks and agree to proceed with this P2P trade
          </span>
        </label>
      </div>
      <Drawer.Footer class="pt-2">
        <div class="flex gap-2 w-full">
          <Button variant="outline" onclick={() => { open = false; onClose(); }} class="flex-1">
            Cancel
          </Button>
          <Button onclick={handleTakeOrder} disabled={!accepted} class="flex-1">
            Take Order
          </Button>
        </div>
      </Drawer.Footer>
    {/if}
    {#if step === 'processing'}
      <div class="py-12 text-center px-4">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <p class="text-foreground font-medium">Processing Trade...</p>
        <p class="text-sm text-muted-foreground mt-2">
          Connecting with trader
        </p>
      </div>
    {/if}
    {#if step === 'complete'}
      <div class="py-12 text-center px-4">
        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <p class="text-foreground font-medium">Trade Initiated!</p>
        <p class="text-sm text-muted-foreground mt-2">
          Check your messages for next steps
        </p>
      </div>
    {/if}
  </Drawer.Content>
</Drawer.Root>
{/if}
</file>

<file path="trades/TradeFilters.svelte">
<script lang="ts">
  import { useAvailableCurrencies } from '$lib/composables/useAvailableCurrencies.svelte';
  import { useAvailablePaymentMethods } from '$lib/composables/useAvailablePaymentMethods.svelte';
  interface TradeFiltersProps {
    filters: {
      currency: string;
      paymentMethod: string;
      orderType: 'all' | 'buy' | 'sell';
      minAmount: number;
      maxAmount: number;
    };
    onChange: (filters: any) => void;
  }
  let { filters, onChange }: TradeFiltersProps = $props();
  const { currencies } = useAvailableCurrencies();
  const { paymentMethods } = useAvailablePaymentMethods();
</script>
<div class="grid grid-cols-2 lg:grid-cols-1 gap-3 lg:gap-4">
  <!-- Currency Filter -->
  <div>
    <label class="flex items-center gap-1.5 text-xs lg:text-sm font-medium text-neutral-400 mb-1 lg:mb-2">
      <svg class="w-3.5 h-3.5 lg:w-4 lg:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Currency
    </label>
    <select
      value={filters.currency}
      onchange={(e) => onChange({ ...filters, currency: e.currentTarget.value })}
      class="w-full px-2 py-1.5 lg:px-3 lg:py-2 text-sm border border-border rounded-lg bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
    >
      {#each currencies as curr}
        <option value={curr.code}>
          {curr.code === 'all' ? curr.name : `${curr.flag} ${curr.code} - ${curr.name}`}
        </option>
      {/each}
    </select>
  </div>
  <!-- Payment Method Filter -->
  <div>
    <label class="flex items-center gap-1.5 text-xs lg:text-sm font-medium text-neutral-400 mb-1 lg:mb-2">
      <svg class="w-3.5 h-3.5 lg:w-4 lg:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      Payment Method
    </label>
    <select
      value={filters.paymentMethod}
      onchange={(e) => onChange({ ...filters, paymentMethod: e.currentTarget.value })}
      class="w-full px-2 py-1.5 lg:px-3 lg:py-2 text-sm border border-border rounded-lg bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
    >
      {#each paymentMethods as method}
        <option value={method.id}>
          {method.icon} {method.name}
        </option>
      {/each}
    </select>
  </div>
  <!-- Order Type Filter -->
  <div>
    <label class="flex items-center gap-1.5 text-xs lg:text-sm font-medium text-neutral-400 mb-1 lg:mb-2">
      <svg class="w-3.5 h-3.5 lg:w-4 lg:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
      </svg>
      Order Type
    </label>
    <select
      value={filters.orderType}
      onchange={(e) => onChange({ ...filters, orderType: e.currentTarget.value as 'all' | 'buy' | 'sell' })}
      class="w-full px-2 py-1.5 lg:px-3 lg:py-2 text-sm border border-border rounded-lg bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
    >
      <option value="all">All Orders</option>
      <option value="buy">Buy Orders</option>
      <option value="sell">Sell Orders</option>
    </select>
  </div>
  <!-- Amount Range -->
  <div>
    <label class="text-xs lg:text-sm font-medium text-neutral-400 mb-1 lg:mb-2 block">
      Amount Range (sats)
    </label>
    <div class="flex items-center gap-2">
      <input
        type="number"
        value={filters.minAmount}
        oninput={(e) => onChange({ ...filters, minAmount: parseInt(e.currentTarget.value) || 0 })}
        class="w-full px-2 py-1.5 lg:py-2 border border-border rounded-lg bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-primary"
        placeholder="Min"
      />
      <span class="text-neutral-500 text-sm">-</span>
      <input
        type="number"
        value={filters.maxAmount}
        oninput={(e) => onChange({ ...filters, maxAmount: parseInt(e.currentTarget.value) || 1000000 })}
        class="w-full px-2 py-1.5 lg:py-2 border border-border rounded-lg bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-primary"
        placeholder="Max"
      />
    </div>
  </div>
</div>
</file>

<file path="ui/button/button.svelte">
<script lang="ts" module>
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAnchorAttributes, HTMLButtonAttributes } from "svelte/elements";
	import { type VariantProps, tv } from "tailwind-variants";
	export const buttonVariants = tv({
		base: "focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive inline-flex shrink-0 items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium outline-none transition-all focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none [&_svg]:shrink-0",
		variants: {
			variant: {
				default: "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
				destructive:
					"bg-destructive text-destructive-foreground shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
				outline:
					"bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50 border",
				secondary: "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
				ghost: "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
				link: "text-primary underline-offset-4 hover:underline",
			},
			size: {
				default: "h-9 px-4 py-2 has-[>svg]:px-3",
				sm: "h-8 gap-1.5 rounded-md px-3 has-[>svg]:px-2.5",
				lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
				icon: "size-9",
				"icon-sm": "size-8",
				"icon-lg": "size-10",
			},
		},
		defaultVariants: {
			variant: "default",
			size: "default",
		},
	});
	export type ButtonVariant = VariantProps<typeof buttonVariants>["variant"];
	export type ButtonSize = VariantProps<typeof buttonVariants>["size"];
	export type ButtonProps = WithElementRef<HTMLButtonAttributes> &
		WithElementRef<HTMLAnchorAttributes> & {
			variant?: ButtonVariant;
			size?: ButtonSize;
		};
</script>
<script lang="ts">
	let {
		class: className,
		variant = "default",
		size = "default",
		ref = $bindable(null),
		href = undefined,
		type = "button",
		disabled,
		children,
		...restProps
	}: ButtonProps = $props();
</script>
{#if href}
	<a
		bind:this={ref}
		data-slot="button"
		class={cn(buttonVariants({ variant, size }), className)}
		href={disabled ? undefined : href}
		aria-disabled={disabled}
		role={disabled ? "link" : undefined}
		tabindex={disabled ? -1 : undefined}
		{...restProps}
	>
		{@render children?.()}
	</a>
{:else}
	<button
		bind:this={ref}
		data-slot="button"
		class={cn(buttonVariants({ variant, size }), className)}
		{type}
		{disabled}
		{...restProps}
	>
		{@render children?.()}
	</button>
{/if}
</file>

<file path="ui/button/index.ts">
import Root, {
	type ButtonProps,
	type ButtonSize,
	type ButtonVariant,
	buttonVariants,
} from "./button.svelte";
export {
	Root,
	type ButtonProps as Props,
	//
	Root as Button,
	buttonVariants,
	type ButtonProps,
	type ButtonSize,
	type ButtonVariant,
};
</file>

<file path="ui/card/card-action.svelte">
<script lang="ts">
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="card-action"
	class={cn("col-start-2 row-span-2 row-start-1 self-start justify-self-end", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/card/card-content.svelte">
<script lang="ts">
	import type { HTMLAttributes } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div bind:this={ref} data-slot="card-content" class={cn("px-6", className)} {...restProps}>
	{@render children?.()}
</div>
</file>

<file path="ui/card/card-description.svelte">
<script lang="ts">
	import type { HTMLAttributes } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLParagraphElement>> = $props();
</script>
<p
	bind:this={ref}
	data-slot="card-description"
	class={cn("text-muted-foreground text-sm", className)}
	{...restProps}
>
	{@render children?.()}
</p>
</file>

<file path="ui/card/card-footer.svelte">
<script lang="ts">
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="card-footer"
	class={cn("[.border-t]:pt-6 flex items-center px-6", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/card/card-header.svelte">
<script lang="ts">
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="card-header"
	class={cn(
		"@container/card-header has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6 grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6",
		className
	)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/card/card-title.svelte">
<script lang="ts">
	import type { HTMLAttributes } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="card-title"
	class={cn("font-semibold leading-none", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/card/card.svelte">
<script lang="ts">
	import type { HTMLAttributes } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="card"
	class={cn(
		"bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
		className
	)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/card/index.ts">
import Root from "./card.svelte";
import Content from "./card-content.svelte";
import Description from "./card-description.svelte";
import Footer from "./card-footer.svelte";
import Header from "./card-header.svelte";
import Title from "./card-title.svelte";
import Action from "./card-action.svelte";
export {
	Root,
	Content,
	Description,
	Footer,
	Header,
	Title,
	Action,
	//
	Root as Card,
	Content as CardContent,
	Description as CardDescription,
	Footer as CardFooter,
	Header as CardHeader,
	Title as CardTitle,
	Action as CardAction,
};
</file>

<file path="ui/dialog/dialog-close.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	let { ref = $bindable(null), ...restProps }: DialogPrimitive.CloseProps = $props();
</script>
<DialogPrimitive.Close bind:ref data-slot="dialog-close" {...restProps} />
</file>

<file path="ui/dialog/dialog-content.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	import XIcon from "@lucide/svelte/icons/x";
	import type { Snippet } from "svelte";
	import * as Dialog from "./index.js";
	import { cn, type WithoutChildrenOrChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		portalProps,
		children,
		showCloseButton = true,
		...restProps
	}: WithoutChildrenOrChild<DialogPrimitive.ContentProps> & {
		portalProps?: DialogPrimitive.PortalProps;
		children: Snippet;
		showCloseButton?: boolean;
	} = $props();
</script>
<Dialog.Portal {...portalProps}>
	<Dialog.Overlay />
	<DialogPrimitive.Content
		bind:ref
		data-slot="dialog-content"
		class={cn(
			"bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed left-[50%] top-[50%] z-[1001] grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
			className
		)}
		{...restProps}
	>
		{@render children?.()}
		{#if showCloseButton}
			<DialogPrimitive.Close
				class="ring-offset-background focus:ring-ring rounded-xs focus:outline-hidden absolute end-4 top-4 opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 disabled:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none [&_svg]:shrink-0"
			>
				<XIcon />
				<span class="sr-only">Close</span>
			</DialogPrimitive.Close>
		{/if}
	</DialogPrimitive.Content>
</Dialog.Portal>
</file>

<file path="ui/dialog/dialog-description.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: DialogPrimitive.DescriptionProps = $props();
</script>
<DialogPrimitive.Description
	bind:ref
	data-slot="dialog-description"
	class={cn("text-muted-foreground text-sm", className)}
	{...restProps}
/>
</file>

<file path="ui/dialog/dialog-footer.svelte">
<script lang="ts">
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="dialog-footer"
	class={cn("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/dialog/dialog-header.svelte">
<script lang="ts">
	import type { HTMLAttributes } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="dialog-header"
	class={cn("flex flex-col gap-2 text-center sm:text-left", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/dialog/dialog-overlay.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: DialogPrimitive.OverlayProps = $props();
</script>
<DialogPrimitive.Overlay
	bind:ref
	data-slot="dialog-overlay"
	class={cn(
		"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-[1001] bg-black/50",
		className
	)}
	{...restProps}
/>
</file>

<file path="ui/dialog/dialog-title.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: DialogPrimitive.TitleProps = $props();
</script>
<DialogPrimitive.Title
	bind:ref
	data-slot="dialog-title"
	class={cn("text-lg font-semibold leading-none", className)}
	{...restProps}
/>
</file>

<file path="ui/dialog/dialog-trigger.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	let { ref = $bindable(null), ...restProps }: DialogPrimitive.TriggerProps = $props();
</script>
<DialogPrimitive.Trigger bind:ref data-slot="dialog-trigger" {...restProps} />
</file>

<file path="ui/dialog/dialog.svelte">
<script lang="ts">
	import { Dialog as DialogPrimitive } from "bits-ui";
	const props = $props<DialogPrimitive.RootProps>();
	const open = $bindable(props.open ?? false);
	const { onOpenChange, ...restProps } = props;
</script>
<DialogPrimitive.Root bind:open {onOpenChange} {...restProps} />
</file>

<file path="ui/dialog/index.ts">
import { Dialog as DialogPrimitive } from "bits-ui";
import Title from "./dialog-title.svelte";
import Footer from "./dialog-footer.svelte";
import Header from "./dialog-header.svelte";
import Overlay from "./dialog-overlay.svelte";
import Content from "./dialog-content.svelte";
import Description from "./dialog-description.svelte";
import Trigger from "./dialog-trigger.svelte";
import Close from "./dialog-close.svelte";
const Root = DialogPrimitive.Root;
const Portal = DialogPrimitive.Portal;
export {
	Root,
	Title,
	Portal,
	Footer,
	Header,
	Trigger,
	Overlay,
	Content,
	Description,
	Close,
	//
	Root as Dialog,
	Title as DialogTitle,
	Portal as DialogPortal,
	Footer as DialogFooter,
	Header as DialogHeader,
	Trigger as DialogTrigger,
	Overlay as DialogOverlay,
	Content as DialogContent,
	Description as DialogDescription,
	Close as DialogClose,
};
</file>

<file path="ui/drawer/drawer-close.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	let { ref = $bindable(null), ...restProps }: Drawer.CloseProps = $props();
</script>
<Drawer.Close bind:ref data-slot="drawer-close" {...restProps} />
</file>

<file path="ui/drawer/drawer-content.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	import DrawerOverlay from "./drawer-overlay.svelte";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		portalProps,
		children,
		...restProps
	}: Drawer.ContentProps & {
		portalProps?: Drawer.PortalProps;
	} = $props();
</script>
<Drawer.Portal {...portalProps}>
	<DrawerOverlay />
	<Drawer.Content
		bind:ref
		data-slot="drawer-content"
		class={cn(
			"group/drawer-content bg-background fixed z-[1001] flex h-auto flex-col",
			"data-[vaul-drawer-direction=top]:inset-x-0 data-[vaul-drawer-direction=top]:top-0 data-[vaul-drawer-direction=top]:mb-24 data-[vaul-drawer-direction=top]:max-h-[80vh] data-[vaul-drawer-direction=top]:rounded-b-lg data-[vaul-drawer-direction=top]:border-b",
			"data-[vaul-drawer-direction=bottom]:inset-x-0 data-[vaul-drawer-direction=bottom]:bottom-0 data-[vaul-drawer-direction=bottom]:mt-24 data-[vaul-drawer-direction=bottom]:max-h-[80vh] data-[vaul-drawer-direction=bottom]:rounded-t-lg data-[vaul-drawer-direction=bottom]:border-t",
			"data-[vaul-drawer-direction=right]:inset-y-0 data-[vaul-drawer-direction=right]:right-0 data-[vaul-drawer-direction=right]:w-3/4 data-[vaul-drawer-direction=right]:border-l data-[vaul-drawer-direction=right]:sm:max-w-sm",
			"data-[vaul-drawer-direction=left]:inset-y-0 data-[vaul-drawer-direction=left]:left-0 data-[vaul-drawer-direction=left]:w-3/4 data-[vaul-drawer-direction=left]:border-r data-[vaul-drawer-direction=left]:sm:max-w-sm",
			className
		)}
		{...restProps}
	>
		<div
			class="bg-muted mx-auto mt-4 hidden h-2 w-[100px] shrink-0 rounded-full group-data-[vaul-drawer-direction=bottom]/drawer-content:block"
		></div>
		{@render children?.()}
	</Drawer.Content>
</Drawer.Portal>
</file>

<file path="ui/drawer/drawer-description.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: Drawer.DescriptionProps = $props();
</script>
<Drawer.Description
	bind:ref
	data-slot="drawer-description"
	class={cn("text-muted-foreground text-sm", className)}
	{...restProps}
/>
</file>

<file path="ui/drawer/drawer-footer.svelte">
<script lang="ts">
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="drawer-footer"
	class={cn("mt-auto flex flex-col gap-2 p-4", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/drawer/drawer-header.svelte">
<script lang="ts">
	import type { HTMLAttributes } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> = $props();
</script>
<div
	bind:this={ref}
	data-slot="drawer-header"
	class={cn("flex flex-col gap-1.5 p-4", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/drawer/drawer-nested.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	let {
		shouldScaleBackground = true,
		open = $bindable(false),
		activeSnapPoint = $bindable(null),
		...restProps
	}: Drawer.RootProps = $props();
</script>
<Drawer.NestedRoot {shouldScaleBackground} bind:open bind:activeSnapPoint {...restProps} />
</file>

<file path="ui/drawer/drawer-overlay.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: Drawer.OverlayProps = $props();
</script>
<Drawer.Overlay
	bind:ref
	data-slot="drawer-overlay"
	class={cn(
		"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-[1001] bg-black/50",
		className
	)}
	{...restProps}
/>
</file>

<file path="ui/drawer/drawer-title.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: Drawer.TitleProps = $props();
</script>
<Drawer.Title
	bind:ref
	data-slot="drawer-title"
	class={cn("text-foreground font-semibold", className)}
	{...restProps}
/>
</file>

<file path="ui/drawer/drawer-trigger.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	let { ref = $bindable(null), ...restProps }: Drawer.TriggerProps = $props();
</script>
<Drawer.Trigger bind:ref data-slot="drawer-trigger" {...restProps} />
</file>

<file path="ui/drawer/drawer.svelte">
<script lang="ts">
	import { Drawer } from "vaul-svelte";
	let {
		shouldScaleBackground = true,
		open = $bindable(false),
		activeSnapPoint = $bindable(null),
		...restProps
	}: Drawer.RootProps = $props();
</script>
<Drawer.Root {shouldScaleBackground} bind:open bind:activeSnapPoint {...restProps} />
</file>

<file path="ui/drawer/index.ts">
import { Drawer } from "vaul-svelte";
import Root from "./drawer.svelte";
import Content from "./drawer-content.svelte";
import Description from "./drawer-description.svelte";
import Overlay from "./drawer-overlay.svelte";
import Footer from "./drawer-footer.svelte";
import Header from "./drawer-header.svelte";
import Title from "./drawer-title.svelte";
import NestedRoot from "./drawer-nested.svelte";
import Close from "./drawer-close.svelte";
import Trigger from "./drawer-trigger.svelte";
const Portal = Drawer.Portal;
export {
	Root,
	NestedRoot,
	Content,
	Description,
	Overlay,
	Footer,
	Header,
	Title,
	Trigger,
	Portal,
	Close,
	//
	Root as Drawer,
	NestedRoot as DrawerNestedRoot,
	Content as DrawerContent,
	Description as DrawerDescription,
	Overlay as DrawerOverlay,
	Footer as DrawerFooter,
	Header as DrawerHeader,
	Title as DrawerTitle,
	Trigger as DrawerTrigger,
	Portal as DrawerPortal,
	Close as DrawerClose,
};
</file>

<file path="ui/input/index.ts">
import Root from "./input.svelte";
export {
	Root,
	//
	Root as Input,
};
</file>

<file path="ui/input/input.svelte">
<script lang="ts">
	import type { HTMLInputAttributes, HTMLInputTypeAttribute } from "svelte/elements";
	import { cn, type WithElementRef } from "$lib/utils.js";
	type InputType = Exclude<HTMLInputTypeAttribute, "file">;
	type Props = WithElementRef<
		Omit<HTMLInputAttributes, "type"> &
			({ type: "file"; files?: FileList } | { type?: InputType; files?: undefined })
	>;
	let {
		ref = $bindable(null),
		value = $bindable(),
		type,
		files = $bindable(),
		class: className,
		"data-slot": dataSlot = "input",
		...restProps
	}: Props = $props();
</script>
{#if type === "file"}
	<input
		bind:this={ref}
		data-slot={dataSlot}
		class={cn(
			"selection:bg-primary dark:bg-input/30 selection:text-primary-foreground border-input ring-offset-background placeholder:text-muted-foreground shadow-xs flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 pt-1.5 text-sm font-medium outline-none transition-[color,box-shadow] disabled:cursor-not-allowed disabled:opacity-50",
			"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
			"aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
			className
		)}
		type="file"
		bind:files
		bind:value
		{...restProps}
	/>
{:else}
	<input
		bind:this={ref}
		data-slot={dataSlot}
		class={cn(
			"border-input bg-background selection:bg-primary dark:bg-input/30 selection:text-primary-foreground ring-offset-background placeholder:text-muted-foreground shadow-xs flex h-9 w-full min-w-0 rounded-md border px-3 py-1 text-base outline-none transition-[color,box-shadow] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
			"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
			"aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
			className
		)}
		{type}
		bind:value
		{...restProps}
	/>
{/if}
</file>

<file path="ui/label/index.ts">
import Root from "./label.svelte";
export {
	Root,
	//
	Root as Label,
};
</file>

<file path="ui/label/label.svelte">
<script lang="ts">
	import { Label as LabelPrimitive } from "bits-ui";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: LabelPrimitive.RootProps = $props();
</script>
<LabelPrimitive.Root
	bind:ref
	data-slot="label"
	class={cn(
		"flex select-none items-center gap-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-50 group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50",
		className
	)}
	{...restProps}
/>
</file>

<file path="ui/responsive-dialog/index.ts">
import ResponsiveDialog from './ResponsiveDialog.svelte';
import * as Dialog from '$lib/components/ui/dialog';
import * as Drawer from '$lib/components/ui/drawer';
export {
	ResponsiveDialog,
	Dialog,
	Drawer
};
</file>

<file path="ui/responsive-dialog/ResponsiveDialog.svelte">
<script lang="ts">
	import { MediaQuery } from 'svelte/reactivity';
	import * as Dialog from '$lib/components/ui/dialog';
	import * as Drawer from '$lib/components/ui/drawer';
	import type { Snippet } from 'svelte';
	let {
		open = $bindable(false),
		onOpenChange,
		breakpoint = '(min-width: 768px)',
		children
	}: {
		open?: boolean;
		onOpenChange?: (open: boolean) => void;
		breakpoint?: string;
		children: Snippet<[{ isDesktop: boolean }]>;
	} = $props();
	const isDesktop = new MediaQuery(breakpoint);
</script>
{#if isDesktop.current}
	<Dialog.Root bind:open {onOpenChange}>
		{@render children({ isDesktop: true })}
	</Dialog.Root>
{:else}
	<Drawer.Root bind:open {onOpenChange}>
		{@render children({ isDesktop: false })}
	</Drawer.Root>
{/if}
</file>

<file path="ui/select/index.ts">
import { Select as SelectPrimitive } from "bits-ui";
import Group from "./select-group.svelte";
import Label from "./select-label.svelte";
import Item from "./select-item.svelte";
import Content from "./select-content.svelte";
import Trigger from "./select-trigger.svelte";
import Separator from "./select-separator.svelte";
import ScrollDownButton from "./select-scroll-down-button.svelte";
import ScrollUpButton from "./select-scroll-up-button.svelte";
import GroupHeading from "./select-group-heading.svelte";
const Root = SelectPrimitive.Root;
export {
	Root,
	Group,
	Label,
	Item,
	Content,
	Trigger,
	Separator,
	ScrollDownButton,
	ScrollUpButton,
	GroupHeading,
	//
	Root as Select,
	Group as SelectGroup,
	Label as SelectLabel,
	Item as SelectItem,
	Content as SelectContent,
	Trigger as SelectTrigger,
	Separator as SelectSeparator,
	ScrollDownButton as SelectScrollDownButton,
	ScrollUpButton as SelectScrollUpButton,
	GroupHeading as SelectGroupHeading,
};
</file>

<file path="ui/select/select-content.svelte">
<script lang="ts">
	import { Select as SelectPrimitive } from "bits-ui";
	import SelectScrollUpButton from "./select-scroll-up-button.svelte";
	import SelectScrollDownButton from "./select-scroll-down-button.svelte";
	import { cn, type WithoutChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		sideOffset = 4,
		portalProps,
		children,
		...restProps
	}: WithoutChild<SelectPrimitive.ContentProps> & {
		portalProps?: SelectPrimitive.PortalProps;
	} = $props();
</script>
<SelectPrimitive.Portal {...portalProps}>
	<SelectPrimitive.Content
		bind:ref
		{sideOffset}
		data-slot="select-content"
		class={cn(
			"bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 max-h-(--bits-select-content-available-height) origin-(--bits-select-content-transform-origin) relative z-50 min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border shadow-md data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
			className
		)}
		{...restProps}
	>
		<SelectScrollUpButton />
		<SelectPrimitive.Viewport
			class={cn(
				"h-(--bits-select-anchor-height) min-w-(--bits-select-anchor-width) w-full scroll-my-1 p-1"
			)}
		>
			{@render children?.()}
		</SelectPrimitive.Viewport>
		<SelectScrollDownButton />
	</SelectPrimitive.Content>
</SelectPrimitive.Portal>
</file>

<file path="ui/select/select-group-heading.svelte">
<script lang="ts">
	import { Select as SelectPrimitive } from "bits-ui";
	import { cn } from "$lib/utils.js";
	import type { ComponentProps } from "svelte";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: ComponentProps<typeof SelectPrimitive.GroupHeading> = $props();
</script>
<SelectPrimitive.GroupHeading
	bind:ref
	data-slot="select-group-heading"
	class={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
	{...restProps}
>
	{@render children?.()}
</SelectPrimitive.GroupHeading>
</file>

<file path="ui/select/select-group.svelte">
<script lang="ts">
	import { Select as SelectPrimitive } from "bits-ui";
	let { ref = $bindable(null), ...restProps }: SelectPrimitive.GroupProps = $props();
</script>
<SelectPrimitive.Group data-slot="select-group" {...restProps} />
</file>

<file path="ui/select/select-item.svelte">
<script lang="ts">
	import CheckIcon from "@lucide/svelte/icons/check";
	import { Select as SelectPrimitive } from "bits-ui";
	import { cn, type WithoutChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		value,
		label,
		children: childrenProp,
		...restProps
	}: WithoutChild<SelectPrimitive.ItemProps> = $props();
</script>
<SelectPrimitive.Item
	bind:ref
	{value}
	data-slot="select-item"
	class={cn(
		"data-[highlighted]:bg-accent data-[highlighted]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground outline-hidden *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2 relative flex w-full cursor-default select-none items-center gap-2 rounded-sm py-1.5 pl-2 pr-8 text-sm data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none [&_svg]:shrink-0",
		className
	)}
	{...restProps}
>
	{#snippet children({ selected, highlighted })}
		<span class="absolute right-2 flex size-3.5 items-center justify-center">
			{#if selected}
				<CheckIcon class="size-4" />
			{/if}
		</span>
		{#if childrenProp}
			{@render childrenProp({ selected, highlighted })}
		{:else}
			{label || value}
		{/if}
	{/snippet}
</SelectPrimitive.Item>
</file>

<file path="ui/select/select-label.svelte">
<script lang="ts">
	import { cn, type WithElementRef } from "$lib/utils.js";
	import type { HTMLAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		class: className,
		children,
		...restProps
	}: WithElementRef<HTMLAttributes<HTMLDivElement>> & {} = $props();
</script>
<div
	bind:this={ref}
	data-slot="select-label"
	class={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
	{...restProps}
>
	{@render children?.()}
</div>
</file>

<file path="ui/select/select-scroll-down-button.svelte">
<script lang="ts">
	import ChevronDownIcon from "@lucide/svelte/icons/chevron-down";
	import { Select as SelectPrimitive } from "bits-ui";
	import { cn, type WithoutChildrenOrChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: WithoutChildrenOrChild<SelectPrimitive.ScrollDownButtonProps> = $props();
</script>
<SelectPrimitive.ScrollDownButton
	bind:ref
	data-slot="select-scroll-down-button"
	class={cn("flex cursor-default items-center justify-center py-1", className)}
	{...restProps}
>
	<ChevronDownIcon class="size-4" />
</SelectPrimitive.ScrollDownButton>
</file>

<file path="ui/select/select-scroll-up-button.svelte">
<script lang="ts">
	import ChevronUpIcon from "@lucide/svelte/icons/chevron-up";
	import { Select as SelectPrimitive } from "bits-ui";
	import { cn, type WithoutChildrenOrChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: WithoutChildrenOrChild<SelectPrimitive.ScrollUpButtonProps> = $props();
</script>
<SelectPrimitive.ScrollUpButton
	bind:ref
	data-slot="select-scroll-up-button"
	class={cn("flex cursor-default items-center justify-center py-1", className)}
	{...restProps}
>
	<ChevronUpIcon class="size-4" />
</SelectPrimitive.ScrollUpButton>
</file>

<file path="ui/select/select-separator.svelte">
<script lang="ts">
	import type { Separator as SeparatorPrimitive } from "bits-ui";
	import { Separator } from "$lib/components/ui/separator/index.js";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		...restProps
	}: SeparatorPrimitive.RootProps = $props();
</script>
<Separator
	bind:ref
	data-slot="select-separator"
	class={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
	{...restProps}
/>
</file>

<file path="ui/select/select-trigger.svelte">
<script lang="ts">
	import { Select as SelectPrimitive } from "bits-ui";
	import ChevronDownIcon from "@lucide/svelte/icons/chevron-down";
	import { cn, type WithoutChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		children,
		size = "default",
		...restProps
	}: WithoutChild<SelectPrimitive.TriggerProps> & {
		size?: "sm" | "default";
	} = $props();
</script>
<SelectPrimitive.Trigger
	bind:ref
	data-slot="select-trigger"
	data-size={size}
	class={cn(
		"border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 shadow-xs flex w-fit select-none items-center justify-between gap-2 whitespace-nowrap rounded-md border bg-transparent px-3 py-2 text-sm outline-none transition-[color,box-shadow] focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none [&_svg]:shrink-0",
		className
	)}
	{...restProps}
>
	{@render children?.()}
	<ChevronDownIcon class="size-4 opacity-50" />
</SelectPrimitive.Trigger>
</file>

<file path="ui/separator/index.ts">
import Root from "./separator.svelte";
export {
	Root,
	//
	Root as Separator,
};
</file>

<file path="ui/separator/separator.svelte">
<script lang="ts">
	import { Separator as SeparatorPrimitive } from "bits-ui";
	import { cn } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		"data-slot": dataSlot = "separator",
		...restProps
	}: SeparatorPrimitive.RootProps = $props();
</script>
<SeparatorPrimitive.Root
	bind:ref
	data-slot={dataSlot}
	class={cn(
		"bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=vertical]:h-full data-[orientation=horizontal]:w-full data-[orientation=vertical]:w-px",
		className
	)}
	{...restProps}
/>
</file>

<file path="ui/switch/index.ts">
import Root from "./switch.svelte";
export {
	Root,
	//
	Root as Switch,
};
</file>

<file path="ui/switch/switch.svelte">
<script lang="ts">
	import { Switch as SwitchPrimitive } from "bits-ui";
	import { cn, type WithoutChildrenOrChild } from "$lib/utils.js";
	let {
		ref = $bindable(null),
		class: className,
		checked = $bindable(false),
		...restProps
	}: WithoutChildrenOrChild<SwitchPrimitive.RootProps> = $props();
</script>
<SwitchPrimitive.Root
	bind:ref
	bind:checked
	data-slot="switch"
	class={cn(
		"data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 shadow-xs peer inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent outline-none transition-all focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
		className
	)}
	{...restProps}
>
	<SwitchPrimitive.Thumb
		data-slot="switch-thumb"
		class={cn(
			"bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
		)}
	/>
</SwitchPrimitive.Root>
</file>

<file path="ui/textarea/index.ts">
import Root from "./textarea.svelte";
export {
	Root,
	//
	Root as Textarea,
};
</file>

<file path="ui/textarea/textarea.svelte">
<script lang="ts">
	import { cn, type WithElementRef, type WithoutChildren } from "$lib/utils.js";
	import type { HTMLTextareaAttributes } from "svelte/elements";
	let {
		ref = $bindable(null),
		value = $bindable(),
		class: className,
		"data-slot": dataSlot = "textarea",
		...restProps
	}: WithoutChildren<WithElementRef<HTMLTextareaAttributes>> = $props();
</script>
<textarea
	bind:this={ref}
	data-slot={dataSlot}
	class={cn(
		"border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 field-sizing-content shadow-xs flex min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base outline-none transition-[color,box-shadow] focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
		className
	)}
	bind:value
	{...restProps}
></textarea>
</file>

<file path="ui/tooltip/index.ts">
import Root from "./tooltip.svelte";
import Trigger from "./tooltip-trigger.svelte";
import Content from "./tooltip-content.svelte";
export {
	Root,
	Trigger,
	Content,
	//
	Root as Tooltip,
	Trigger as TooltipTrigger,
	Content as TooltipContent,
};
</file>

<file path="ui/tooltip/tooltip-content.svelte">
<script lang="ts">
  import { Tooltip as TooltipPrimitive } from 'bits-ui';
  import { cn } from '$lib/utils';
  import type { Snippet } from 'svelte';
  let {
    class: className,
    side = 'top',
    sideOffset = 4,
    children
  }: {
    class?: string;
    side?: 'top' | 'bottom' | 'left' | 'right';
    sideOffset?: number;
    children: Snippet;
  } = $props();
</script>
<TooltipPrimitive.Content
  {side}
  {sideOffset}
  class={cn(
    'z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2',
    className
  )}
>
  {@render children()}
</TooltipPrimitive.Content>
</file>

<file path="ui/tooltip/tooltip-trigger.svelte">
<script lang="ts">
  import { Tooltip as TooltipPrimitive } from 'bits-ui';
  import type { Snippet } from 'svelte';
  let {
    asChild = false,
    children
  }: {
    asChild?: boolean;
    children: Snippet<[{ builder: any }]>;
  } = $props();
</script>
<TooltipPrimitive.Trigger {asChild} let:builder>
  {@render children({ builder })}
</TooltipPrimitive.Trigger>
</file>

<file path="ui/tooltip/tooltip.svelte">
<script lang="ts">
  import { Tooltip as TooltipPrimitive } from 'bits-ui';
  import type { Snippet } from 'svelte';
  let {
    open = $bindable(),
    openDelay = 700,
    closeDelay = 0,
    children
  }: {
    open?: boolean;
    openDelay?: number;
    closeDelay?: number;
    children: Snippet;
  } = $props();
</script>
<TooltipPrimitive.Root bind:open {openDelay} {closeDelay}>
  {@render children()}
</TooltipPrimitive.Root>
</file>

<file path="UserSelector/SelectedUserBadge.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
    onRemove: (pubkey: string) => void;
  }
  let { pubkey, onRemove }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  const displayName = $derived(profile?.displayName || profile?.name || `${pubkey.slice(0, 8)}...`);
</script>
<button
  type="button"
  onclick={() => onRemove(pubkey)}
  class="inline-flex items-center gap-1 px-2 py-1 bg-primary/20 hover:bg-primary/30 text-foreground rounded-full text-xs transition-colors"
>
  <Avatar {ndk} {pubkey} size={14} class="flex-shrink-0" />
  <span class="max-w-[100px] truncate">
    {displayName}
  </span>
  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
  </svg>
</button>
</file>

<file path="UserSelector/UserListItem.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
    isSelected: boolean;
    showCheckbox: boolean;
    onToggle: (pubkey: string) => void;
  }
  let { pubkey, isSelected, showCheckbox, onToggle }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  const displayName = $derived(profile?.displayName || profile?.name || `${pubkey.slice(0, 8)}...`);
</script>
<button
  type="button"
  onclick={() => onToggle(pubkey)}
  class={`w-full flex items-center gap-2 p-2 rounded-md transition-colors ${
    isSelected
      ? 'bg-primary/20'
      : 'hover:bg-muted'
  }`}
>
  <Avatar {ndk} {pubkey} size={32} class="flex-shrink-0" />
  <div class="flex-1 min-w-0 text-left">
    <div class="text-sm font-medium text-foreground truncate">
      {displayName}
    </div>
    {#if profile?.nip05}
      <div class="text-xs text-muted-foreground truncate">
        {profile.nip05}
      </div>
    {/if}
  </div>
  {#if showCheckbox}
    <div class={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 ${
      isSelected
        ? 'bg-primary border-primary'
        : 'border-border'
    }`}>
      {#if isSelected}
        <svg class="w-3 h-3 text-primary-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
        </svg>
      {/if}
    </div>
  {/if}
</button>
</file>

<file path="UserSelector/UserSelectorDropdown.svelte">
<script lang="ts">
  import SelectedUserBadge from './SelectedUserBadge.svelte';
  import UserListItem from './UserListItem.svelte';
  interface Props {
    searchQuery: string;
    isIdentifierInput: boolean;
    selectedPubkeys: string[];
    filteredFollows: string[];
    multiple: boolean;
    onSearchQueryChange: (value: string) => void;
    onAddByIdentifier: () => void;
    onRemoveUser: (pubkey: string) => void;
    onToggleUser: (pubkey: string) => void;
  }
  let {
    searchQuery = $bindable(),
    isIdentifierInput,
    selectedPubkeys,
    filteredFollows,
    multiple,
    onSearchQueryChange,
    onAddByIdentifier,
    onRemoveUser,
    onToggleUser
  }: Props = $props();
</script>
<div class="flex flex-col max-h-[400px]">
  <!-- Header -->
  <div class="p-3 border-b border-border">
    <h3 class="font-semibold text-sm mb-2">Tag people</h3>
    <div class="relative">
      <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        bind:value={searchQuery}
        placeholder="Search or paste npub/identifier..."
        class="w-full pl-8 pr-16 py-2 bg-muted border border-border rounded-lg text-foreground text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
        onkeydown={(e) => {
          if (e.key === 'Enter' && isIdentifierInput) {
            onAddByIdentifier();
          }
        }}
      />
      {#if isIdentifierInput}
        <button
          type="button"
          onclick={onAddByIdentifier}
          class="absolute right-1 top-1/2 -translate-y-1/2 px-2 py-1 bg-primary hover:bg-primary/90 text-primary-foreground rounded text-xs font-medium transition-colors"
        >
          Add
        </button>
      {/if}
    </div>
    {#if !searchQuery}
      <p class="text-xs text-muted-foreground mt-1.5">
        Search follows or paste npub/hex/NIP-05
      </p>
    {/if}
  </div>
  <!-- Selected users -->
  {#if selectedPubkeys.length > 0}
    <div class="px-3 py-2 border-b border-border bg-muted/30">
      <div class="text-xs font-medium text-muted-foreground mb-2">
        Selected ({selectedPubkeys.length})
      </div>
      <div class="flex flex-wrap gap-1.5">
        {#each selectedPubkeys as pubkey (pubkey)}
          <SelectedUserBadge {pubkey} onRemove={onRemoveUser} />
        {/each}
      </div>
    </div>
  {/if}
  <!-- Follows list -->
  <div class="overflow-y-auto flex-1">
    {#if filteredFollows.length === 0}
      <div class="text-center py-8 px-3 text-muted-foreground text-sm">
        {searchQuery ? 'No matches found' : 'You don\'t follow anyone yet'}
      </div>
    {:else}
      <div class="p-2 space-y-1">
        {#each filteredFollows as pubkey (pubkey)}
          <UserListItem
            {pubkey}
            isSelected={selectedPubkeys.includes(pubkey)}
            showCheckbox={multiple}
            onToggle={onToggleUser}
          />
        {/each}
      </div>
    {/if}
  </div>
</div>
</file>

<file path="wallet/BalanceCard.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKWalletStatus } from '@nostr-dev-kit/wallet';
  const wallet = ndk.$wallet;
  const balance = $derived(wallet.balance || 0);
  const status = $derived(wallet.status === NDKWalletStatus.READY ? 'idle' : wallet.status === NDKWalletStatus.ERROR ? 'error' : 'loading');
  function formatBalance(sats: number): string {
    return new Intl.NumberFormat('en-US').format(sats);
  }
</script>
<div class="balance-card">
  <div class="balance-amount">
    <span class="amount gradient-text">{formatBalance(balance)}</span>
    <span class="unit">sats</span>
  </div>
  {#if status === 'loading'}
    <div class="status-badge loading">
      <div class="spinner"></div>
      <span>Loading wallet...</span>
    </div>
  {:else if status === 'error'}
    <div class="status-badge error">
      ‚ö†Ô∏è Error loading wallet
    </div>
  {/if}
</div>
<style>
  .balance-card {
    position: relative;
    padding: 2rem 1rem;
    text-align: center;
  }
  .balance-amount {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .amount {
    font-size: 4rem;
    font-weight: 800;
    line-height: 1;
    letter-spacing: -0.02em;
  }
  .gradient-text {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .unit {
    font-size: 1.5rem;
    color: rgba(255, 255, 255, 0.5);
    font-weight: 600;
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  .status-badge.loading {
    background: rgba(249, 115, 22, 0.1);
    border: 1px solid rgba(249, 115, 22, 0.2);
    color: #f97316;
  }
  .status-badge.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    color: #ef4444;
  }
  .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(249, 115, 22, 0.2);
    border-top-color: #f97316;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @media (max-width: 640px) {
    .amount {
      font-size: 3rem;
    }
    .unit {
      font-size: 1.25rem;
    }
  }
</style>
</file>

<file path="wallet/DepositModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { ndk } from '$lib/ndk.svelte';
  import type { NDKCashuDeposit } from '@nostr-dev-kit/wallet';
  import QRCode from './QRCode.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let { isOpen = $bindable(false) } = $props();
  let amount = $state(1000);
  let invoice = $state<string | null>(null);
  let deposit = $state<NDKCashuDeposit | undefined>();
  let isLoading = $state(false);
  let error = $state<string | null>(null);
  async function handleDeposit() {
    isLoading = true;
    error = null;
    try {
      deposit = ndk.$wallet.deposit(amount);
      if (!deposit) {
        throw new Error('Failed to create deposit - no Cashu wallet available');
      }
      deposit.on('success', () => {
        invoice = null;
        deposit = undefined;
        close();
      });
      deposit.on('error', (err) => {
        error = typeof err === 'string' ? err : err?.message || 'Deposit failed';
        isLoading = false;
      });
      const invoiceStr = await deposit.start();
      invoice = invoiceStr;
    } catch (e) {
      error = e instanceof Error ? e.message : String(e);
    } finally {
      isLoading = false;
    }
  }
  function close() {
    isOpen = false;
    invoice = null;
    deposit = undefined;
    error = null;
    amount = 1000;
  }
  function copyToClipboard(text: string) {
    navigator.clipboard.writeText(text);
  }
</script>
{#if isDesktop.current}
  <Dialog.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) close();
    }}>
    <Dialog.Content class="max-w-md">
      {#if !invoice}
        <Dialog.Header>
          <Dialog.Title>Deposit Funds</Dialog.Title>
        </Dialog.Header>
        <div class="space-y-4">
          <div>
            <Label for="amount">Amount (sats)</Label>
            <Input
              id="amount"
              type="number"
              bind:value={amount}
              min="1"
              step="100"
              class="mt-2"
            />
          </div>
          <Button
            onclick={handleDeposit}
            disabled={isLoading || amount < 1}
            class="w-full"
          >
            {isLoading ? 'Creating Invoice...' : 'Create Invoice'}
          </Button>
        </div>
      {:else}
        <Dialog.Header>
          <Dialog.Title>Pay Invoice</Dialog.Title>
        </Dialog.Header>
        <div class="space-y-4">
          {#if invoice}
            <div class="flex justify-center">
              <QRCode value={invoice} size={256} />
            </div>
          {/if}
          <div class="bg-card border border-border rounded-lg p-3 break-all text-sm text-muted-foreground">
            {invoice}
          </div>
          <Button
            onclick={() => copyToClipboard(invoice || '')}
            variant="outline"
            class="w-full"
          >
            Copy Invoice
          </Button>
          <p class="text-center text-muted-foreground text-sm">Waiting for payment...</p>
        </div>
      {/if}
      {#if error}
        <div class="mt-4 p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
          {error}
        </div>
      {/if}
      <Dialog.Footer>
        <Button variant="ghost" onclick={close} class="w-full">
          Close
        </Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) close();
    }}>
    <Drawer.Content>
      {#if !invoice}
        <Drawer.Header class="text-left">
          <Drawer.Title>Deposit Funds</Drawer.Title>
        </Drawer.Header>
        <div class="px-4 space-y-4 overflow-y-auto pb-4">
          <div>
            <Label for="amount-mobile">Amount (sats)</Label>
            <Input
              id="amount-mobile"
              type="number"
              bind:value={amount}
              min="1"
              step="100"
              class="mt-2"
            />
          </div>
          {#if error}
            <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
              {error}
            </div>
          {/if}
        </div>
        <Drawer.Footer class="pt-2">
          <Button
            onclick={handleDeposit}
            disabled={isLoading || amount < 1}
            class="w-full"
          >
            {isLoading ? 'Creating Invoice...' : 'Create Invoice'}
          </Button>
          <Button variant="outline" onclick={close} class="w-full">
            Close
          </Button>
        </Drawer.Footer>
      {:else}
        <Drawer.Header class="text-left">
          <Drawer.Title>Pay Invoice</Drawer.Title>
        </Drawer.Header>
        <div class="px-4 space-y-4 overflow-y-auto pb-4">
          {#if invoice}
            <div class="flex justify-center">
              <QRCode value={invoice} size={256} />
            </div>
          {/if}
          <div class="bg-card border border-border rounded-lg p-3 break-all text-sm text-muted-foreground">
            {invoice}
          </div>
          <p class="text-center text-muted-foreground text-sm">Waiting for payment...</p>
          {#if error}
            <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
              {error}
            </div>
          {/if}
        </div>
        <Drawer.Footer class="pt-2">
          <Button
            onclick={() => copyToClipboard(invoice || '')}
            variant="outline"
            class="w-full"
          >
            Copy Invoice
          </Button>
          <Button variant="outline" onclick={close} class="w-full">
            Close
          </Button>
        </Drawer.Footer>
      {/if}
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="wallet/InvoiceDetails.svelte">
<script lang="ts">
  import { decode } from 'light-bolt11-decoder';
  let {
    invoice = $bindable<string>(''),
    onPay = $bindable<(invoice: string) => void>(() => {}),
    onCancel = $bindable<() => void>(() => {})
  } = $props();
  let decoded = $state<any>(null);
  let error = $state<string | null>(null);
  $effect(() => {
    if (invoice) {
      try {
        // Remove lightning: prefix if present
        const cleanInvoice = invoice.trim().toLowerCase().startsWith('lightning:')
          ? invoice.trim().substring(10)
          : invoice.trim();
        decoded = decode(cleanInvoice);
        error = null;
      } catch (e) {
        error = e instanceof Error ? e.message : 'Invalid lightning invoice';
        decoded = null;
      }
    }
  });
  function getSection(name: string) {
    return decoded?.sections?.find((s: any) => s.name === name);
  }
  function formatAmount(): string {
    const amountSection = getSection('amount');
    if (!amountSection?.value) return 'No amount specified';
    // value is in millisatoshis
    const sats = Math.floor(Number(amountSection.value) / 1000);
    return `${new Intl.NumberFormat('en-US').format(sats)} sats`;
  }
  function getAmountInSats(): number {
    const amountSection = getSection('amount');
    if (!amountSection?.value) return 0;
    return Math.floor(Number(amountSection.value) / 1000);
  }
  function formatDate(): string {
    const timestampSection = getSection('timestamp');
    if (!timestampSection?.value) return 'N/A';
    return new Date(timestampSection.value * 1000).toLocaleString();
  }
  function formatExpiry(): string {
    const timestampSection = getSection('timestamp');
    const expirySection = getSection('expiry');
    if (!timestampSection?.value || !expirySection?.value) return 'N/A';
    const expiryDate = new Date((timestampSection.value + expirySection.value) * 1000);
    const now = new Date();
    if (expiryDate < now) {
      return 'Expired';
    }
    const diffMs = expiryDate.getTime() - now.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours > 24) {
      return `${Math.floor(diffHours / 24)} days`;
    } else if (diffHours > 0) {
      return `${diffHours} hours`;
    } else {
      return `${diffMins} minutes`;
    }
  }
  function getDescription(): string {
    const descSection = getSection('description');
    return descSection?.value || 'No description';
  }
  function getPaymentHash(): string {
    const hashSection = getSection('payment_hash');
    return hashSection?.value || '';
  }
  function handlePay() {
    if (decoded && invoice) {
      onPay(invoice);
    }
  }
  const isExpired = $derived(() => {
    const timestampSection = getSection('timestamp');
    const expirySection = getSection('expiry');
    if (!timestampSection?.value || !expirySection?.value) return false;
    const expiryDate = (timestampSection.value + expirySection.value) * 1000;
    return expiryDate < Date.now();
  });
</script>
{#if error}
  <div class="invoice-error">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Invalid Invoice</h3>
    <p class="error-message">{error}</p>
    <button class="button-secondary" onclick={onCancel}>
      Go Back
    </button>
  </div>
{:else if decoded}
  <div class="invoice-details">
    <div class="invoice-header">
      <div class="amount-section">
        <div class="amount-label">Amount</div>
        <div class="amount-value">{formatAmount()}</div>
      </div>
    </div>
    <div class="details-section">
      <div class="detail-row">
        <span class="detail-label">Description</span>
        <span class="detail-value">{getDescription()}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Created</span>
        <span class="detail-value">{formatDate()}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Expires in</span>
        <span class="detail-value" class:expired={isExpired()}>
          {formatExpiry()}
        </span>
      </div>
      {#if getPaymentHash()}
        <div class="detail-row">
          <span class="detail-label">Payment Hash</span>
          <span class="detail-value monospace">{getPaymentHash().substring(0, 16)}...</span>
        </div>
      {/if}
    </div>
    <div class="invoice-string">
      <div class="invoice-label">Invoice</div>
      <div class="invoice-text">{invoice}</div>
    </div>
    <div class="actions">
      {#if isExpired()}
        <button class="button-secondary full-width" onclick={onCancel}>
          Close
        </button>
      {:else}
        <button class="button-secondary" onclick={onCancel}>
          Cancel
        </button>
        <button class="button-primary" onclick={handlePay}>
          Pay {formatAmount()}
        </button>
      {/if}
    </div>
  </div>
{:else}
  <div class="loading">
    <div class="spinner"></div>
    <p>Decoding invoice...</p>
  </div>
{/if}
<style>
  .invoice-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    text-align: center;
    min-height: 400px;
  }
  .error-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }
  .invoice-error h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-foreground);
    margin-bottom: 0.5rem;
  }
  .error-message {
    color: var(--color-muted-foreground);
    margin-bottom: 2rem;
    max-width: 400px;
  }
  .invoice-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 1rem;
    max-width: 600px;
    margin: 0 auto;
  }
  .invoice-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark, #2563eb) 100%);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    color: white;
  }
  .amount-label {
    font-size: 0.875rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .amount-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
  }
  .details-section {
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-border);
  }
  .detail-row:last-child {
    border-bottom: none;
  }
  .detail-label {
    font-size: 0.875rem;
    color: var(--color-muted-foreground);
    font-weight: 600;
    flex-shrink: 0;
  }
  .detail-value {
    font-size: 0.875rem;
    color: var(--color-foreground);
    text-align: right;
    word-break: break-word;
  }
  .detail-value.expired {
    color: var(--color-destructive);
    font-weight: 600;
  }
  .detail-value.monospace {
    font-family: monospace;
    font-size: 0.8rem;
  }
  .invoice-string {
    background: var(--color-muted);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1rem;
  }
  .invoice-label {
    font-size: 0.875rem;
    color: var(--color-muted-foreground);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .invoice-text {
    font-family: monospace;
    font-size: 0.75rem;
    color: var(--color-foreground);
    word-break: break-all;
    line-height: 1.5;
    max-height: 100px;
    overflow-y: auto;
  }
  .actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }
  .button-primary,
  .button-secondary {
    flex: 1;
    padding: 1rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .button-primary {
    background: var(--color-primary);
    border: none;
    color: white;
  }
  .button-primary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }
  .button-secondary {
    background: var(--color-card);
    border: 1px solid var(--color-border);
    color: var(--color-foreground);
  }
  .button-secondary:hover {
    background: var(--color-muted);
  }
  .button-secondary.full-width {
    width: 100%;
  }
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    text-align: center;
    min-height: 400px;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  .loading p {
    color: var(--color-muted-foreground);
    font-size: 0.9rem;
  }
  @media (max-width: 640px) {
    .invoice-details {
      padding: 0.5rem;
    }
    .invoice-header {
      padding: 1.5rem 1rem;
    }
    .amount-value {
      font-size: 2rem;
    }
    .detail-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
    .detail-value {
      text-align: left;
    }
  }
</style>
</file>

<file path="wallet/MintBrowser.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { createMintDiscoveryStore, type MintMetadata } from '@nostr-dev-kit/wallet';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  interface Props {
    open: boolean;
    onSelectMints: (mints: string[]) => void;
    onClose: () => void;
  }
  let { open = $bindable(false), onSelectMints, onClose }: Props = $props();
  const isDesktop = new MediaQuery('(min-width: 768px)');
  // Create mint discovery store
  const mintStore = createMintDiscoveryStore(ndk, {
    network: 'mainnet',
    timeout: 0, // No auto-timeout
  });
  let discoveredMints = $state<MintMetadata[]>([]);
  let selectedMints = $state<Set<string>>(new Set());
  let showManualInput = $state(false);
  let manualMintUrl = $state('');
  let manualMintError = $state('');
  // Subscribe to the Zustand store
  $effect(() => {
    const unsubscribe = mintStore.subscribe((state) => {
      discoveredMints = state.mints;
    });
    return () => {
      unsubscribe();
      mintStore.getState().stop();
    };
  });
  function getHostnameFromUrl(url: string): string {
    try {
      return new URL(url).hostname;
    } catch {
      return url;
    }
  }
  function toggleMint(url: string) {
    const newSelection = new Set(selectedMints);
    if (newSelection.has(url)) {
      newSelection.delete(url);
    } else {
      newSelection.add(url);
    }
    selectedMints = newSelection;
  }
  function addManualMint() {
    const trimmedUrl = manualMintUrl.trim();
    // Validate URL
    try {
      const url = new URL(trimmedUrl);
      if (url.protocol !== 'https:' && url.protocol !== 'http:') {
        manualMintError = 'Please use https:// or http:// URL';
        return;
      }
    } catch {
      manualMintError = 'Please enter a valid mint URL';
      return;
    }
    // Check if already added
    if (selectedMints.has(trimmedUrl)) {
      manualMintError = 'This mint has already been selected';
      return;
    }
    if (discoveredMints.some((m) => m.url === trimmedUrl)) {
      manualMintError = 'This mint is already in the list below';
      return;
    }
    // Add to selected mints
    const newSelection = new Set(selectedMints);
    newSelection.add(trimmedUrl);
    selectedMints = newSelection;
    // Reset form
    manualMintUrl = '';
    showManualInput = false;
    manualMintError = '';
  }
  function toggleManualInput() {
    showManualInput = !showManualInput;
    manualMintUrl = '';
    manualMintError = '';
  }
  function handleAddSelected() {
    if (selectedMints.size === 0) return;
    onSelectMints(Array.from(selectedMints));
    open = false;
  }
  function handleClose() {
    open = false;
    onClose();
  }
  // Custom mints that were manually added (not in discovered list)
  const customMints = $derived(
    Array.from(selectedMints).filter(
      (mintUrl) => !discoveredMints.some((m) => m.url === mintUrl)
    )
  );
</script>
{#if isDesktop.current}
  <Dialog.Root {open} onOpenChange={(newOpen) => { if (!newOpen) handleClose(); }}>
    <Dialog.Content class="max-w-2xl max-h-[90vh] flex flex-col p-0">
      <Dialog.Header class="px-6 py-4 border-b border-border">
        <Dialog.Title>Browse Mints</Dialog.Title>
      </Dialog.Header>
      <!-- Body -->
      <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
        <!-- Info Card -->
        <div class="flex gap-3 p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
          <div class="text-lg flex-shrink-0">‚ÑπÔ∏è</div>
          <div class="text-sm text-muted-foreground">
            Mints are custodial services that issue ecash tokens. Select multiple mints to spread risk.
          </div>
        </div>
        <!-- Manual mint input -->
        <div class="flex flex-col gap-3 p-4 bg-muted/30 border border-border rounded-lg">
          <button
            class="flex items-center gap-2 text-left font-semibold text-foreground"
            onclick={toggleManualInput}
          >
            <span class="flex items-center justify-center w-6 h-6 bg-primary/20 text-primary rounded text-lg font-bold">
              {showManualInput ? '‚àí' : '+'}
            </span>
            Add Custom Mint
          </button>
          {#if showManualInput}
            <div class="flex gap-2">
              <Input
                type="url"
                bind:value={manualMintUrl}
                placeholder="https://mint.example.com"
                class="flex-1 font-mono text-sm"
              />
              <Button onclick={addManualMint} disabled={!manualMintUrl.trim()}>
                Add
              </Button>
            </div>
            {#if manualMintError}
              <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
                {manualMintError}
              </div>
            {/if}
          {/if}
        </div>
        <!-- Discovered mints -->
        {#if discoveredMints.length > 0}
          <div class="space-y-3">
            {#each discoveredMints as mint}
              <button
                class="w-full flex items-start gap-4 p-4 bg-muted/30 border rounded-lg text-left transition-all hover:bg-muted/50 hover:border-primary/30 {selectedMints.has(mint.url) ? 'bg-primary/15 border-primary/50' : 'border-border'}"
                onclick={() => toggleMint(mint.url)}
              >
                <div class="flex items-center pt-0.5">
                  <div class="w-6 h-6 border-2 rounded flex items-center justify-center transition-all {selectedMints.has(mint.url) ? 'bg-primary border-primary' : 'border-muted-foreground/30 bg-muted/50'}">
                    {#if selectedMints.has(mint.url)}
                      <span class="text-primary-foreground text-sm font-bold">‚úì</span>
                    {/if}
                  </div>
                </div>
                <div class="w-12 h-12 flex-shrink-0 rounded-lg overflow-hidden bg-primary/20 flex items-center justify-center">
                  {#if mint.icon}
                    <img src={mint.icon} alt={mint.name || mint.url} class="w-full h-full object-cover" />
                  {:else}
                    <span class="text-2xl">üè¶</span>
                  {/if}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-foreground mb-1">
                    {mint.name || getHostnameFromUrl(mint.url)}
                  </div>
                  {#if mint.description}
                    <div class="text-sm text-muted-foreground mb-1 line-clamp-2">
                      {mint.description}
                    </div>
                  {/if}
                  <div class="text-xs font-mono text-muted-foreground truncate">
                    {mint.url}
                  </div>
                  {#if mint.recommendations.length > 0}
                    <div class="text-xs text-yellow-500 mt-1">
                      ‚≠ê Recommended by {mint.recommendations.length} user{mint.recommendations.length === 1 ? '' : 's'}
                    </div>
                  {/if}
                  {#if mint.isOnline !== undefined}
                    <div class="text-xs mt-1 {mint.isOnline ? 'text-green-400' : 'text-red-400'}">
                      {mint.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                    </div>
                  {/if}
                </div>
              </button>
            {/each}
          </div>
        {:else}
          <div class="flex flex-col items-center justify-center py-12 px-4 text-center bg-muted/20 border border-dashed border-border rounded-lg">
            <div class="text-5xl mb-4">üîç</div>
            <p class="text-muted-foreground">Discovering mints from the network...</p>
            <p class="text-sm text-muted-foreground/60 mt-1">Add custom mints above or wait for discovery</p>
          </div>
        {/if}
        <!-- Custom mints section -->
        {#if customMints.length > 0}
          <div class="pt-2">
            <h4 class="text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-3">Custom Mints</h4>
            <div class="space-y-3">
              {#each customMints as mintUrl}
                <div class="flex items-start gap-4 p-4 bg-primary/15 border border-primary/50 rounded-lg">
                  <div class="w-12 h-12 flex-shrink-0 rounded-lg bg-primary/20 flex items-center justify-center">
                    <span class="text-2xl">üè¶</span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-foreground mb-1">
                      {getHostnameFromUrl(mintUrl)}
                    </div>
                    <div class="text-xs font-mono text-muted-foreground truncate">
                      {mintUrl}
                    </div>
                  </div>
                  <button
                    class="w-8 h-8 flex-shrink-0 self-center flex items-center justify-center bg-red-500/20 border border-red-500/30 rounded text-red-400 font-bold hover:bg-red-500/30 transition-colors"
                    onclick={() => toggleMint(mintUrl)}
                  >
                    ‚úï
                  </button>
                </div>
              {/each}
            </div>
          </div>
        {/if}
      </div>
      <!-- Footer -->
      <div class="px-6 py-4 border-t border-border space-y-3">
        {#if selectedMints.size > 0}
          <div class="flex items-center justify-center gap-2 p-3 bg-primary/10 border border-primary/20 rounded-lg text-sm font-semibold">
            <span class="text-primary">‚úì</span>
            {selectedMints.size} mint{selectedMints.size === 1 ? '' : 's'} selected
          </div>
        {/if}
        <div class="flex gap-3">
          <Button variant="outline" onclick={handleClose} class="flex-1">
            Cancel
          </Button>
          <Button onclick={handleAddSelected} disabled={selectedMints.size === 0} class="flex-1">
            Add Selected Mints
          </Button>
        </div>
      </div>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root {open} onOpenChange={(newOpen) => { if (!newOpen) handleClose(); }}>
    <Drawer.Content class="max-h-[90vh] flex flex-col">
      <Drawer.Header class="text-left">
        <Drawer.Title>Browse Mints</Drawer.Title>
      </Drawer.Header>
      <!-- Body -->
      <div class="flex-1 overflow-y-auto px-4 space-y-4 pb-4">
        <!-- Info Card -->
        <div class="flex gap-3 p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
          <div class="text-lg flex-shrink-0">‚ÑπÔ∏è</div>
          <div class="text-sm text-muted-foreground">
            Mints are custodial services that issue ecash tokens. Select multiple mints to spread risk.
          </div>
        </div>
        <!-- Manual mint input -->
        <div class="flex flex-col gap-3 p-4 bg-muted/30 border border-border rounded-lg">
          <button
            class="flex items-center gap-2 text-left font-semibold text-foreground"
            onclick={toggleManualInput}
          >
            <span class="flex items-center justify-center w-6 h-6 bg-primary/20 text-primary rounded text-lg font-bold">
              {showManualInput ? '‚àí' : '+'}
            </span>
            Add Custom Mint
          </button>
          {#if showManualInput}
            <div class="flex gap-2">
              <Input
                type="url"
                bind:value={manualMintUrl}
                placeholder="https://mint.example.com"
                class="flex-1 font-mono text-sm"
              />
              <Button onclick={addManualMint} disabled={!manualMintUrl.trim()}>
                Add
              </Button>
            </div>
            {#if manualMintError}
              <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
                {manualMintError}
              </div>
            {/if}
          {/if}
        </div>
        <!-- Discovered mints -->
        {#if discoveredMints.length > 0}
          <div class="space-y-3">
            {#each discoveredMints as mint}
              <button
                class="w-full flex items-start gap-4 p-4 bg-muted/30 border rounded-lg text-left transition-all {selectedMints.has(mint.url) ? 'bg-primary/15 border-primary/50' : 'border-border'}"
                onclick={() => toggleMint(mint.url)}
              >
                <div class="flex items-center pt-0.5">
                  <div class="w-6 h-6 border-2 rounded flex items-center justify-center transition-all {selectedMints.has(mint.url) ? 'bg-primary border-primary' : 'border-muted-foreground/30 bg-muted/50'}">
                    {#if selectedMints.has(mint.url)}
                      <span class="text-primary-foreground text-sm font-bold">‚úì</span>
                    {/if}
                  </div>
                </div>
                <div class="w-12 h-12 flex-shrink-0 rounded-lg overflow-hidden bg-primary/20 flex items-center justify-center">
                  {#if mint.icon}
                    <img src={mint.icon} alt={mint.name || mint.url} class="w-full h-full object-cover" />
                  {:else}
                    <span class="text-2xl">üè¶</span>
                  {/if}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-foreground mb-1">
                    {mint.name || getHostnameFromUrl(mint.url)}
                  </div>
                  {#if mint.description}
                    <div class="text-sm text-muted-foreground mb-1 line-clamp-2">
                      {mint.description}
                    </div>
                  {/if}
                  <div class="text-xs font-mono text-muted-foreground truncate">
                    {mint.url}
                  </div>
                  {#if mint.recommendations.length > 0}
                    <div class="text-xs text-yellow-500 mt-1">
                      ‚≠ê Recommended by {mint.recommendations.length} user{mint.recommendations.length === 1 ? '' : 's'}
                    </div>
                  {/if}
                  {#if mint.isOnline !== undefined}
                    <div class="text-xs mt-1 {mint.isOnline ? 'text-green-400' : 'text-red-400'}">
                      {mint.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                    </div>
                  {/if}
                </div>
              </button>
            {/each}
          </div>
        {:else}
          <div class="flex flex-col items-center justify-center py-12 px-4 text-center bg-muted/20 border border-dashed border-border rounded-lg">
            <div class="text-5xl mb-4">üîç</div>
            <p class="text-muted-foreground">Discovering mints from the network...</p>
            <p class="text-sm text-muted-foreground/60 mt-1">Add custom mints above or wait for discovery</p>
          </div>
        {/if}
        <!-- Custom mints section -->
        {#if customMints.length > 0}
          <div class="pt-2">
            <h4 class="text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-3">Custom Mints</h4>
            <div class="space-y-3">
              {#each customMints as mintUrl}
                <div class="flex items-start gap-4 p-4 bg-primary/15 border border-primary/50 rounded-lg">
                  <div class="w-12 h-12 flex-shrink-0 rounded-lg bg-primary/20 flex items-center justify-center">
                    <span class="text-2xl">üè¶</span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-foreground mb-1">
                      {getHostnameFromUrl(mintUrl)}
                    </div>
                    <div class="text-xs font-mono text-muted-foreground truncate">
                      {mintUrl}
                    </div>
                  </div>
                  <button
                    class="w-8 h-8 flex-shrink-0 self-center flex items-center justify-center bg-red-500/20 border border-red-500/30 rounded text-red-400 font-bold hover:bg-red-500/30 transition-colors"
                    onclick={() => toggleMint(mintUrl)}
                  >
                    ‚úï
                  </button>
                </div>
              {/each}
            </div>
          </div>
        {/if}
      </div>
      <!-- Footer -->
      <Drawer.Footer class="pt-2">
        {#if selectedMints.size > 0}
          <div class="flex items-center justify-center gap-2 p-3 bg-primary/10 border border-primary/20 rounded-lg text-sm font-semibold">
            <span class="text-primary">‚úì</span>
            {selectedMints.size} mint{selectedMints.size === 1 ? '' : 's'} selected
          </div>
        {/if}
        <Button onclick={handleAddSelected} disabled={selectedMints.size === 0} class="w-full">
          Add Selected Mints
        </Button>
        <Button variant="outline" onclick={handleClose} class="w-full">
          Cancel
        </Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="wallet/MintManager.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  const mints = $derived(ndk.$wallet.mints.map(m => typeof m === 'string' ? m : m.url));
  const mintBalances = $derived(() => {
    const balances = new Map<string, number>();
    mints.forEach(mint => {
      const walletInstance = ndk.$wallet.wallet;
      if (walletInstance?.mintBalance) {
        balances.set(mint, walletInstance.mintBalance(mint));
      }
    });
    return balances;
  });
  let newMintUrl = $state('');
  let isAdding = $state(false);
  let error = $state<string | null>(null);
  async function addMint() {
    if (!newMintUrl.trim()) {
      error = 'Please enter a mint URL';
      return;
    }
    if (!newMintUrl.startsWith('http://') && !newMintUrl.startsWith('https://')) {
      error = 'Mint URL must start with http:// or https://';
      return;
    }
    try {
      const currentMints = mints;
      const updatedMints = [...currentMints, newMintUrl.trim()];
      await ndk.$wallet.save({
        mints: updatedMints,
        relays: ndk.$wallet.relays
      });
      newMintUrl = '';
      error = null;
      isAdding = false;
    } catch (e) {
      error = e instanceof Error ? e.message : String(e);
    }
  }
  async function removeMint(mint: string) {
    if (confirm(`Remove mint: ${mint}?`)) {
      try {
        const currentMints = mints;
        const updatedMints = currentMints.filter(m => m !== mint);
        await ndk.$wallet.save({
          mints: updatedMints,
          relays: ndk.$wallet.relays
        });
      } catch (e) {
        error = e instanceof Error ? e.message : String(e);
      }
    }
  }
  function formatSats(amount: number): string {
    return amount.toLocaleString();
  }
  function getMintName(mintUrl: string): string {
    try {
      const url = new URL(mintUrl);
      return url.hostname;
    } catch {
      return mintUrl;
    }
  }
</script>
<div class="bg-background border border-border rounded-xl p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-foreground">Cashu Mints</h3>
    <button
      onclick={() => isAdding = !isAdding}
      class="px-3 py-1.5 bg-primary hover:bg-accent-dark text-foreground text-sm font-medium rounded-lg transition-colors"
    >
      {isAdding ? 'Cancel' : 'Add Mint'}
    </button>
  </div>
  {#if isAdding}
    <div class="mb-4 p-4 bg-card border border-border rounded-lg">
      <label class="block text-sm font-medium text-muted-foreground mb-2">
        Mint URL
      </label>
      <input
        type="url"
        bind:value={newMintUrl}
        placeholder="https://mint.example.com"
        class="w-full px-4 py-2 bg-background border border-border rounded-lg text-foreground placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-orange-500 mb-3"
      />
      <button
        onclick={addMint}
        class="w-full py-2 bg-primary hover:bg-accent-dark text-foreground font-medium rounded-lg transition-colors"
      >
        Add Mint
      </button>
      {#if error}
        <div class="mt-2 p-2 bg-red-900/20 border border-red-800 rounded text-red-400 text-sm">
          {error}
        </div>
      {/if}
    </div>
  {/if}
  {#if mints.length === 0}
    <div class="text-center py-8 text-muted-foreground">
      No mints configured
    </div>
  {:else}
    <div class="space-y-2">
      {#each mints as mint (mint)}
        <div class="flex items-center justify-between p-3 bg-card border border-border rounded-lg">
          <div class="flex-1 min-w-0">
            <div class="text-foreground font-medium truncate">{getMintName(mint)}</div>
            <div class="text-sm text-muted-foreground truncate">{mint}</div>
            {#if mintBalances.has(mint)}
              <div class="text-sm text-primary mt-1">
                Balance: {formatSats(mintBalances.get(mint) || 0)} sats
              </div>
            {/if}
          </div>
          <button
            onclick={() => removeMint(mint)}
            class="ml-3 p-2 text-muted-foreground hover:text-red-500 transition-colors"
            aria-label="Remove mint"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      {/each}
    </div>
  {/if}
</div>
</file>

<file path="wallet/NutzapMonitor.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  const nutzaps = $derived(ndk.$wallet.nutzaps);
  const pendingCount = $derived(nutzaps.pending.length);
  const redeemedCount = $derived(nutzaps.redeemed.length);
  const failedCount = $derived(nutzaps.failed.length);
  let showDetails = $state(false);
  function formatDate(timestamp: number): string {
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
  }
</script>
<div class="bg-background border border-border rounded-xl p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-foreground">Nutzap Monitor</h3>
    <button
      onclick={() => showDetails = !showDetails}
      class="text-sm text-primary hover:text-primary"
    >
      {showDetails ? 'Hide Details' : 'Show Details'}
    </button>
  </div>
  <div class="grid grid-cols-3 gap-3 mb-4">
    <div class="bg-card border border-border rounded-lg p-3 text-center">
      <div class="text-2xl font-bold text-yellow-500">{pendingCount}</div>
      <div class="text-xs text-muted-foreground mt-1">Pending</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-3 text-center">
      <div class="text-2xl font-bold text-green-500">{redeemedCount}</div>
      <div class="text-xs text-muted-foreground mt-1">Redeemed</div>
    </div>
    <div class="bg-card border border-border rounded-lg p-3 text-center">
      <div class="text-2xl font-bold text-red-500">{failedCount}</div>
      <div class="text-xs text-muted-foreground mt-1">Failed</div>
    </div>
  </div>
  {#if showDetails}
    <div class="space-y-4">
      {#if pendingCount > 0}
        <div>
          <h4 class="text-sm font-semibold text-yellow-500 mb-2">Pending Nutzaps</h4>
          <div class="space-y-2">
            {#each nutzaps.pending as nutzap (nutzap.id)}
              <div class="p-2 bg-card border border-border rounded text-sm">
                <div class="text-foreground">{nutzap.id.slice(0, 16)}...</div>
                <div class="text-muted-foreground text-xs">{formatDate(nutzap.created_at || 0)}</div>
              </div>
            {/each}
          </div>
        </div>
      {/if}
      {#if redeemedCount > 0}
        <div>
          <h4 class="text-sm font-semibold text-green-500 mb-2">Redeemed Nutzaps</h4>
          <div class="space-y-2">
            {#each nutzaps.redeemed.slice(0, 5) as nutzap (nutzap.id)}
              <div class="p-2 bg-card border border-border rounded text-sm">
                <div class="text-foreground">{nutzap.id.slice(0, 16)}...</div>
                <div class="text-muted-foreground text-xs">{formatDate(nutzap.created_at || 0)}</div>
              </div>
            {/each}
          </div>
        </div>
      {/if}
      {#if failedCount > 0}
        <div>
          <h4 class="text-sm font-semibold text-red-500 mb-2">Failed Nutzaps</h4>
          <div class="space-y-2">
            {#each nutzaps.failed.slice(0, 5) as nutzap (nutzap.id)}
              <div class="p-2 bg-card border border-border rounded text-sm">
                <div class="text-foreground">{nutzap.id.slice(0, 16)}...</div>
                <div class="text-muted-foreground text-xs">{formatDate(nutzap.created_at || 0)}</div>
              </div>
            {/each}
          </div>
        </div>
      {/if}
    </div>
  {/if}
  {#if pendingCount === 0 && redeemedCount === 0 && failedCount === 0}
    <div class="text-center py-8 text-muted-foreground">
      No nutzaps yet
    </div>
  {/if}
</div>
</file>

<file path="wallet/QRCode.svelte">
<script lang="ts">
  import QRCode from 'qrcode';
  interface Props {
    value: string;
    size?: number;
  }
  let { value, size = 300 }: Props = $props();
  let canvas: HTMLCanvasElement;
  $effect(() => {
    if (value && canvas) {
      generateQR();
    }
  });
  async function generateQR() {
    if (!canvas || !value) return;
    try {
      await QRCode.toCanvas(canvas, value, {
        width: size,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      });
    } catch (err) {
      console.error('QR Code generation failed:', err);
    }
  }
</script>
<canvas bind:this={canvas}></canvas>
<style>
  canvas {
    border-radius: 12px;
    background: white;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>
</file>

<file path="wallet/QRScanner.svelte">
<script lang="ts">
  import { browser } from '$app/environment';
  let { onScan = $bindable<(data: string) => void>(() => {}), onCancel = $bindable<() => void>(() => {}) } = $props();
  let isScanning = $state(false);
  let error = $state<string | null>(null);
  let pasteValue = $state('');
  let showPasteInput = $state(false);
  async function startScan() {
    if (!browser) return;
    try {
      // Make body background transparent so camera shows through
      document.body.style.background = 'transparent';
      document.documentElement.style.background = 'transparent';
      isScanning = true;
      error = null;
      // Dynamically import the scanner
      const { CapacitorBarcodeScanner } = await import('@capacitor/barcode-scanner');
      // Start scanning with minimal native UI
      const result = await CapacitorBarcodeScanner.scanBarcode({
        hint: 17, // QR_CODE format
        scanInstructions: '', // We'll show our own instructions
        scanButton: false,
        scanText: ''
      });
      if (result && result.ScanResult) {
        handleScannedData(result.ScanResult);
      }
    } catch (e) {
      error = e instanceof Error ? e.message : String(e);
      console.error('Scan error:', e);
    } finally {
      stopScan();
    }
  }
  function stopScan() {
    // Restore background
    if (browser && document?.body) {
      document.body.style.background = '';
      document.documentElement.style.background = '';
    }
    isScanning = false;
  }
  function handleScannedData(data: string) {
    // Clean up the data (remove lightning: prefix if present)
    const cleanData = data.trim().toLowerCase().startsWith('lightning:')
      ? data.trim().substring(10)
      : data.trim();
    onScan(cleanData);
  }
  function handlePaste() {
    if (pasteValue.trim()) {
      handleScannedData(pasteValue);
      pasteValue = '';
      showPasteInput = false;
    }
  }
  async function pasteFromClipboard() {
    try {
      const text = await navigator.clipboard.readText();
      if (text) {
        pasteValue = text;
        showPasteInput = true;
      }
    } catch (e) {
      // Fallback to manual input if clipboard access fails
      showPasteInput = true;
    }
  }
  function cancel() {
    stopScan();
    onCancel();
  }
  // Use effect with cleanup instead of onMount/onDestroy
  $effect(() => {
    if (browser) {
      startScan();
    }
    // Cleanup when component unmounts
    return () => {
      stopScan();
    };
  });
</script>
<div class="scanner-container">
  {#if error}
    <div class="error-overlay">
      <div class="error-content">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-message">{error}</p>
        <button class="button-primary" onclick={cancel}>Close</button>
      </div>
    </div>
  {/if}
  {#if isScanning}
    <!-- Custom UI overlay that doesn't block the camera -->
    <div class="scanner-overlay">
      <div class="scanner-frame">
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
      </div>
      <div class="scanner-instructions">
        <p>Position QR code within the frame</p>
      </div>
      <button class="cancel-button" onclick={cancel}>
        Cancel
      </button>
    </div>
  {/if}
  <!-- Paste button always available at bottom -->
  <div class="paste-section">
    {#if showPasteInput}
      <div class="paste-input-container">
        <textarea
          bind:value={pasteValue}
          placeholder="Paste lightning invoice here..."
          rows="3"
          class="paste-input"
        ></textarea>
        <div class="paste-actions">
          <button class="button-secondary" onclick={() => showPasteInput = false}>
            Cancel
          </button>
          <button
            class="button-primary"
            onclick={handlePaste}
            disabled={!pasteValue.trim()}
          >
            Continue
          </button>
        </div>
      </div>
    {:else}
      <button class="paste-button" onclick={pasteFromClipboard}>
        <svg class="paste-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        Paste Invoice
      </button>
    {/if}
  </div>
</div>
<style>
  .scanner-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    pointer-events: none; /* Allow camera interaction to pass through */
  }
  .scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    pointer-events: none; /* Allow camera interaction */
  }
  .scanner-frame {
    position: relative;
    width: 250px;
    height: 250px;
    margin-bottom: 2rem;
  }
  .corner {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid white;
  }
  .corner.top-left {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
  }
  .corner.top-right {
    top: 0;
    right: 0;
    border-left: none;
    border-bottom: none;
  }
  .corner.bottom-left {
    bottom: 0;
    left: 0;
    border-right: none;
    border-top: none;
  }
  .corner.bottom-right {
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: none;
  }
  .scanner-instructions {
    color: white;
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }
  .cancel-button {
    padding: 0.75rem 2rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    pointer-events: auto; /* Enable interaction for button */
  }
  .cancel-button:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  .paste-section {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    pointer-events: none; /* Allow camera interaction */
  }
  .paste-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border: none;
    border-radius: 12px;
    color: black;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    pointer-events: auto; /* Enable interaction for button */
  }
  .paste-button:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
  }
  .paste-button:active {
    transform: translateY(0);
  }
  .paste-icon {
    width: 1.5rem;
    height: 1.5rem;
  }
  .paste-input-container {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    pointer-events: auto; /* Enable interaction for container */
  }
  .paste-input {
    width: 100%;
    padding: 0.75rem;
    background: var(--color-muted, #f5f5f5);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    color: black;
    font-size: 0.9rem;
    font-family: monospace;
    resize: vertical;
    margin-bottom: 0.75rem;
  }
  .paste-input:focus {
    outline: none;
    border-color: var(--color-primary, #3b82f6);
  }
  .paste-actions {
    display: flex;
    gap: 0.75rem;
  }
  .button-primary,
  .button-secondary {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .button-primary {
    background: var(--color-primary, #3b82f6);
    border: none;
    color: white;
  }
  .button-primary:hover:not(:disabled) {
    opacity: 0.9;
  }
  .button-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .button-secondary {
    background: transparent;
    border: 1px solid var(--color-border, #e5e5e5);
    color: black;
  }
  .button-secondary:hover {
    background: var(--color-muted, #f5f5f5);
  }
  .error-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    z-index: 9999;
  }
  .error-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 400px;
    text-align: center;
  }
  .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  .error-message {
    color: black;
    margin-bottom: 1.5rem;
    font-size: 1rem;
  }
  @media (max-width: 640px) {
    .scanner-frame {
      width: 200px;
      height: 200px;
    }
    .corner {
      width: 30px;
      height: 30px;
      border-width: 2px;
    }
    .scanner-instructions {
      font-size: 0.875rem;
    }
  }
</style>
</file>

<file path="wallet/ReceiveTokenModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { ndk } from '$lib/ndk.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  import { Textarea } from '$lib/components/ui/textarea';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let { isOpen = $bindable(false) } = $props();
  let token = $state('');
  let description = $state('');
  let isReceiving = $state(false);
  let success = $state(false);
  let error = $state<string | null>(null);
  async function handleReceive() {
    if (!token.trim()) {
      error = 'Please enter a Cashu token';
      return;
    }
    isReceiving = true;
    error = null;
    success = false;
    try {
      await ndk.$wallet.receiveToken(token.trim(), description.trim() || undefined);
      success = true;
      setTimeout(() => {
        close();
      }, 2000);
    } catch (e) {
      error = e instanceof Error ? e.message : String(e);
    } finally {
      isReceiving = false;
    }
  }
  function close() {
    isOpen = false;
    token = '';
    description = '';
    success = false;
    error = null;
  }
</script>
{#if isDesktop.current}
  <Dialog.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) close();
    }}>
    <Dialog.Content class="max-w-md">
      <Dialog.Header>
        <Dialog.Title>Receive Cashu Token</Dialog.Title>
      </Dialog.Header>
      {#if success}
        <div class="p-4 bg-green-900/20 border border-green-800 rounded-lg text-green-400 text-center">
          ‚úì Token received successfully!
        </div>
      {/if}
      <div class="space-y-4">
        <div>
          <Label for="token">Cashu Token</Label>
          <Textarea
            id="token"
            bind:value={token}
            placeholder="Paste Cashu token here (cashuA...)"
            rows={4}
            class="mt-2 resize-none"
          />
        </div>
        <div>
          <Label for="description">Description (optional)</Label>
          <Input
            id="description"
            type="text"
            bind:value={description}
            placeholder="e.g., Coffee payment"
            class="mt-2"
          />
        </div>
        <Button
          onclick={handleReceive}
          disabled={isReceiving || !token.trim() || success}
          class="w-full"
        >
          {isReceiving ? 'Receiving...' : success ? 'Received!' : 'Receive Token'}
        </Button>
        {#if error}
          <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
            {error}
          </div>
        {/if}
      </div>
      <Dialog.Footer>
        <Button variant="ghost" onclick={close} class="w-full">
          Close
        </Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) close();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>Receive Cashu Token</Drawer.Title>
      </Drawer.Header>
      {#if success}
        <div class="px-4 mb-4">
          <div class="p-4 bg-green-900/20 border border-green-800 rounded-lg text-green-400 text-center">
            ‚úì Token received successfully!
          </div>
        </div>
      {/if}
      <div class="px-4 space-y-4">
        <div>
          <Label for="token-mobile">Cashu Token</Label>
          <Textarea
            id="token-mobile"
            bind:value={token}
            placeholder="Paste Cashu token here (cashuA...)"
            rows={4}
            class="mt-2 resize-none"
          />
        </div>
        <div>
          <Label for="description-mobile">Description (optional)</Label>
          <Input
            id="description-mobile"
            type="text"
            bind:value={description}
            placeholder="e.g., Coffee payment"
            class="mt-2"
          />
        </div>
        <Button
          onclick={handleReceive}
          disabled={isReceiving || !token.trim() || success}
          class="w-full"
        >
          {isReceiving ? 'Receiving...' : success ? 'Received!' : 'Receive Token'}
        </Button>
        {#if error}
          <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
            {error}
          </div>
        {/if}
      </div>
      <Drawer.Footer class="pt-2">
        <Button variant="ghost" onclick={close} class="w-full">
          Close
        </Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="wallet/ReceiveView.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import type { NDKCashuDeposit } from '@nostr-dev-kit/wallet';
  import QRCode from './QRCode.svelte';
  const wallet = ndk.$wallet;
  let activeTab = $state<'paste' | 'mint'>('mint');
  let tokenInput = $state('');
  let mintAmount = $state('');
  let isProcessing = $state(false);
  let error = $state('');
  let success = $state<{ amount: number } | null>(null);
  let depositInstance = $state<NDKCashuDeposit | null>(null);
  let depositInvoice = $state<string | null>(null);
  let isCheckingPayment = $state(false);
  let availableMints = $derived(wallet.mints?.map(m => typeof m === 'string' ? m : m.url) || []);
  let selectedMint = $state<string>('');
  $effect(() => {
    if (availableMints.length > 0 && !selectedMint) {
      selectedMint = availableMints[0];
    }
  });
  async function handleReceive() {
    if (!tokenInput.trim()) return;
    isProcessing = true;
    error = '';
    try {
      await wallet.receiveToken(tokenInput.trim());
      success = { amount: 0 };
      tokenInput = '';
    } catch (e: any) {
      error = e.message || 'Failed to receive token';
      console.error(e);
    } finally {
      isProcessing = false;
    }
  }
  async function handleMint() {
    const amount = Number(mintAmount);
    if (!amount || amount <= 0) return;
    if (!selectedMint) {
      error = 'No mint selected';
      return;
    }
    isProcessing = true;
    error = '';
    try {
      const deposit = wallet.deposit(amount, selectedMint);
      if (!deposit) {
        throw new Error('Failed to create deposit request');
      }
      depositInstance = deposit;
      deposit.on('success', () => {
        success = { amount };
        mintAmount = '';
        depositInstance = null;
        depositInvoice = null;
        isCheckingPayment = false;
        isProcessing = false;
      });
      deposit.on('error', (err) => {
        error = err.message || 'Deposit failed';
        isCheckingPayment = false;
        isProcessing = false;
      });
      const bolt11 = await deposit.start();
      depositInvoice = bolt11;
    } catch (e: any) {
      error = e.message || 'Failed to create mint request';
      console.error(e);
    } finally {
      isProcessing = false;
    }
  }
  function setPresetAmount(amount: number) {
    mintAmount = amount.toString();
  }
  async function checkMintQuote() {
    if (!depositInstance) return;
    isCheckingPayment = true;
    error = '';
    try {
      await depositInstance.check();
    } catch (e: any) {
      error = e.message || 'Failed to check payment status';
      console.error(e);
    } finally {
      isCheckingPayment = false;
    }
  }
  function copyInvoice() {
    if (depositInvoice) {
      navigator.clipboard.writeText(depositInvoice);
    }
  }
  function cancelMint() {
    depositInstance = null;
    depositInvoice = null;
    isCheckingPayment = false;
    error = '';
  }
  function reset() {
    success = null;
    error = '';
  }
</script>
<div class="receive-view">
  {#if success}
    <div class="success-screen">
      <div class="success-backdrop"></div>
      <div class="success-content">
        <div class="success-ring">
          <div class="success-checkmark">‚úì</div>
        </div>
        <h3 class="success-title">Payment Received!</h3>
        <p class="success-amount">{new Intl.NumberFormat('en-US').format(success.amount)} sats</p>
        <button class="primary" onclick={reset}>
          Continue
        </button>
      </div>
    </div>
  {:else}
    <div class="tabs">
      <button
        class:active={activeTab === 'mint'}
        onclick={() => activeTab = 'mint'}
      >
        Deposit
      </button>
      <button
        class:active={activeTab === 'paste'}
        onclick={() => activeTab = 'paste'}
      >
        Paste Token
      </button>
    </div>
    {#if activeTab === 'paste'}
      <div class="tab-content">
        <div class="form-section">
          <label for="token">Cashu Token</label>
          <textarea
            id="token"
            bind:value={tokenInput}
            placeholder="Paste cashu token here..."
            rows="6"
          ></textarea>
          <p class="hint">Paste a cashu token to redeem it into your wallet</p>
        </div>
        {#if error}
          <div class="error-message">{error}</div>
        {/if}
        <button
          class="primary"
          onclick={handleReceive}
          disabled={!tokenInput.trim() || isProcessing}
        >
          {#if isProcessing}
            Processing...
          {:else}
            Redeem Token
          {/if}
        </button>
      </div>
    {:else}
      <div class="tab-content">
        {#if !depositInstance}
          <div class="form-section">
            <label for="mint">Select Mint</label>
            <select id="mint" bind:value={selectedMint}>
              {#each availableMints as mint}
                <option value={mint}>{mint}</option>
              {/each}
            </select>
            {#if availableMints.length === 0}
              <p class="hint">No mints configured in your wallet</p>
            {/if}
          </div>
          <div class="form-section">
            <label for="amount">Amount (sats)</label>
            <div class="amount-input-group">
              <input
                id="amount"
                type="number"
                bind:value={mintAmount}
                placeholder="100"
                min="1"
              />
              <span class="amount-unit">sats</span>
            </div>
            <div class="preset-buttons">
              <button type="button" class="preset-btn" onclick={() => setPresetAmount(1000)}>1k</button>
              <button type="button" class="preset-btn" onclick={() => setPresetAmount(5000)}>5k</button>
              <button type="button" class="preset-btn" onclick={() => setPresetAmount(10000)}>10k</button>
              <button type="button" class="preset-btn" onclick={() => setPresetAmount(21000)}>21k</button>
              <button type="button" class="preset-btn" onclick={() => setPresetAmount(100000)}>100k</button>
            </div>
          </div>
          {#if error}
            <div class="error-message">{error}</div>
          {/if}
          <button
            class="primary"
            onclick={handleMint}
            disabled={!mintAmount || Number(mintAmount) <= 0 || !selectedMint || isProcessing}
          >
            {#if isProcessing}
              Creating Deposit...
            {:else}
              Create Deposit
            {/if}
          </button>
        {:else}
          <div class="quote-display">
            <h4>Lightning Invoice</h4>
            <p class="quote-amount">{Number(mintAmount).toLocaleString()} sats</p>
            {#if depositInvoice}
              <div class="qr-container">
                <div class="qr-wrapper">
                  <QRCode value={depositInvoice.toUpperCase()} size={280} />
                </div>
              </div>
              <div class="invoice-box">
                <label>Invoice String</label>
                <div class="invoice-text">{depositInvoice}</div>
                <button class="copy-button" onclick={copyInvoice}>
                  <span class="copy-icon">üìã</span> Copy Invoice
                </button>
              </div>
              <div class="waiting-status">
                <div class="spinner"></div>
                <p>Waiting for payment...</p>
              </div>
            {/if}
            <div class="quote-actions">
              <button onclick={cancelMint}>
                Cancel
              </button>
            </div>
            {#if error}
              <div class="error-message">{error}</div>
            {/if}
          </div>
        {/if}
      </div>
    {/if}
  {/if}
</div>
<style>
  .receive-view {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .tabs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    padding: 0.25rem;
    background: var(--color-muted);
    border-radius: 12px;
  }
  .tabs button {
    padding: 0.75rem 1rem;
    background: transparent;
    border: none;
    border-radius: 8px;
    transition: all 0.2s;
    color: var(--color-foreground);
  }
  .tabs button.active {
    background: var(--color-primary);
    color: white;
    font-weight: 600;
  }
  .tab-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .form-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  input, textarea, select {
    width: 100%;
    padding: 0.875rem 1rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-foreground);
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--color-primary);
    background: var(--color-muted);
  }
  select {
    cursor: pointer;
  }
  select option {
    background: var(--color-card);
    color: var(--color-foreground);
  }
  textarea {
    min-height: 120px;
    resize: vertical;
    font-family: monospace;
    font-size: 0.75rem;
  }
  .hint {
    font-size: 0.875rem;
    color: var(--color-muted-foreground);
    margin: 0;
  }
  .amount-input-group {
    position: relative;
    display: flex;
    align-items: center;
  }
  .amount-input-group input {
    padding-right: 60px;
  }
  .amount-unit {
    position: absolute;
    right: 1rem;
    color: var(--color-muted-foreground);
    font-weight: 600;
    pointer-events: none;
  }
  .error-message {
    background: var(--color-destructive);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--color-foreground);
    font-size: 0.875rem;
  }
  button {
    padding: 0.875rem 1.5rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-foreground);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  button:hover:not(:disabled) {
    background: var(--color-muted);
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  button.primary {
    background: var(--color-primary);
    border: none;
    color: white;
  }
  button.primary:hover:not(:disabled) {
    opacity: 0.9;
  }
  .preset-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }
  .preset-btn {
    flex: 1;
    padding: 0.5rem;
    background: var(--color-muted);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-primary);
    transition: all 0.2s;
  }
  .preset-btn:hover {
    background: var(--color-card);
    border-color: var(--color-primary);
    transform: translateY(-1px);
  }
  .success-screen {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .success-backdrop {
    position: absolute;
    inset: 0;
    background: var(--color-background);
    opacity: 0.95;
    animation: fadeIn 0.4s ease-out;
  }
  .success-content {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    padding: 2rem;
  }
  .success-ring {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: scaleIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .success-checkmark {
    font-size: 4rem;
    color: white;
    animation: checkmarkPop 0.4s 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) both;
  }
  .success-title {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-foreground);
    animation: fadeSlideUp 0.4s 0.5s ease-out both;
  }
  .success-amount {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0;
    animation: fadeSlideUp 0.4s 0.6s ease-out both;
  }
  .success-screen button {
    width: 100%;
    max-width: 200px;
    animation: fadeSlideUp 0.4s 0.7s ease-out both;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  @keyframes scaleIn {
    from {
      transform: scale(0);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  @keyframes checkmarkPop {
    from {
      transform: scale(0);
    }
    to {
      transform: scale(1);
    }
  }
  @keyframes fadeSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .quote-display {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 1rem 0;
  }
  .quote-display h4 {
    text-align: center;
    margin: 0;
    font-size: 1.25rem;
    color: var(--color-foreground);
  }
  .quote-amount {
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-primary);
    margin: 0;
  }
  .qr-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1.5rem;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }
  .qr-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    background: white;
    padding: 0.5rem;
    border-radius: 8px;
  }
  .waiting-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--color-muted);
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }
  .waiting-status p {
    margin: 0;
    color: var(--color-foreground);
    font-weight: 500;
  }
  .invoice-box {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1rem;
  }
  .invoice-box label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-muted-foreground);
    font-weight: 600;
  }
  .invoice-text {
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    font-size: 0.7rem;
    word-break: break-all;
    color: var(--color-foreground);
    line-height: 1.6;
    padding: 1rem;
    background: var(--color-muted);
    border-radius: 8px;
    max-height: 100px;
    overflow-y: auto;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }
  .copy-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: var(--color-muted);
    border: 1px solid var(--color-border);
    color: var(--color-primary);
    font-weight: 600;
  }
  .copy-button:hover {
    background: var(--color-card);
    border-color: var(--color-primary);
  }
  .copy-icon {
    font-size: 1.1rem;
  }
  .checking-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem 1rem;
    background: var(--color-muted);
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }
  .checking-status p {
    margin: 0;
    color: var(--color-foreground);
  }
  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--color-muted);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .quote-actions {
    display: flex;
    gap: 0.75rem;
  }
  .quote-actions button {
    flex: 1;
  }
</style>
</file>

<file path="wallet/SendModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { ndk } from '$lib/ndk.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let { isOpen = $bindable(false) } = $props();
  let amount = $state(100);
  let recipient = $state('');
  let comment = $state('');
  let isSending = $state(false);
  let success = $state(false);
  let error = $state<string | null>(null);
  async function handleSend() {
    if (amount < 1) {
      error = 'Amount must be at least 1 sat';
      return;
    }
    isSending = true;
    error = null;
    success = false;
    try {
      await ndk.$wallet.pay({
        amount,
        recipient: recipient.trim() || undefined,
        comment: comment.trim() || undefined,
        unit: 'sat',
      });
      success = true;
      setTimeout(() => {
        close();
      }, 2000);
    } catch (e) {
      error = e instanceof Error ? e.message : String(e);
    } finally {
      isSending = false;
    }
  }
  function close() {
    isOpen = false;
    amount = 100;
    recipient = '';
    comment = '';
    success = false;
    error = null;
  }
</script>
{#if isDesktop.current}
  <Dialog.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) close();
    }}>
    <Dialog.Content class="max-w-md">
      <Dialog.Header>
        <Dialog.Title>Send Payment</Dialog.Title>
      </Dialog.Header>
      {#if success}
        <div class="p-4 bg-green-900/20 border border-green-800 rounded-lg text-green-400 text-center">
          ‚úì Payment sent successfully!
        </div>
      {/if}
      <div class="space-y-4">
        <div>
          <Label for="amount">Amount (sats)</Label>
          <Input
            id="amount"
            type="number"
            bind:value={amount}
            min="1"
            step="100"
            class="mt-2"
          />
        </div>
        <div>
          <Label for="recipient">Recipient (optional)</Label>
          <Input
            id="recipient"
            type="text"
            bind:value={recipient}
            placeholder="npub... or lightning address"
            class="mt-2"
          />
        </div>
        <div>
          <Label for="comment">Comment (optional)</Label>
          <Input
            id="comment"
            type="text"
            bind:value={comment}
            placeholder="What's this payment for?"
            class="mt-2"
          />
        </div>
        <Button
          onclick={handleSend}
          disabled={isSending || amount < 1 || success}
          class="w-full"
        >
          {isSending ? 'Sending...' : success ? 'Sent!' : `Send ${amount} sats`}
        </Button>
        {#if error}
          <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
            {error}
          </div>
        {/if}
      </div>
      <Dialog.Footer>
        <Button variant="ghost" onclick={close} class="w-full">
          Close
        </Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) close();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>Send Payment</Drawer.Title>
      </Drawer.Header>
      <div class="px-4 space-y-4 overflow-y-auto pb-4">
        {#if success}
          <div class="p-4 bg-green-900/20 border border-green-800 rounded-lg text-green-400 text-center">
            ‚úì Payment sent successfully!
          </div>
        {/if}
        <div>
          <Label for="amount-mobile">Amount (sats)</Label>
          <Input
            id="amount-mobile"
            type="number"
            bind:value={amount}
            min="1"
            step="100"
            class="mt-2"
          />
        </div>
        <div>
          <Label for="recipient-mobile">Recipient (optional)</Label>
          <Input
            id="recipient-mobile"
            type="text"
            bind:value={recipient}
            placeholder="npub... or lightning address"
            class="mt-2"
          />
        </div>
        <div>
          <Label for="comment-mobile">Comment (optional)</Label>
          <Input
            id="comment-mobile"
            type="text"
            bind:value={comment}
            placeholder="What's this payment for?"
            class="mt-2"
          />
        </div>
        {#if error}
          <div class="p-3 bg-red-900/20 border border-red-800 rounded-lg text-red-400 text-sm">
            {error}
          </div>
        {/if}
      </div>
      <Drawer.Footer class="pt-2">
        <Button
          onclick={handleSend}
          disabled={isSending || amount < 1 || success}
          class="w-full"
        >
          {isSending ? 'Sending...' : success ? 'Sent!' : `Send ${amount} sats`}
        </Button>
        <Button variant="outline" onclick={close} class="w-full">
          Close
        </Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="wallet/SendView.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  const wallet = ndk.$wallet;
  let amount = $state('');
  let memo = $state('');
  let recipient = $state('');
  let isSending = $state(false);
  let token = $state<string | null>(null);
  let error = $state('');
  const balance = $derived(wallet.balance || 0);
  const amountNum = $derived(Number(amount) || 0);
  const canSend = $derived(amountNum > 0 && amountNum <= balance && !isSending);
  function formatBalance(sats: number): string {
    return new Intl.NumberFormat('en-US').format(sats);
  }
  async function handleSend() {
    if (!canSend) return;
    isSending = true;
    error = '';
    try {
      // Use wallet to generate token
      token = await wallet.send(amountNum, memo || undefined);
    } catch (e: any) {
      error = e.message || 'Failed to send';
      console.error(e);
    } finally {
      isSending = false;
    }
  }
  function copyToken() {
    if (token) {
      navigator.clipboard.writeText(token);
    }
  }
  function reset() {
    amount = '';
    memo = '';
    recipient = '';
    token = null;
    error = '';
  }
</script>
<div class="send-view">
  {#if !token}
    <div class="send-form">
      <div class="form-section">
        <label for="amount">Amount</label>
        <div class="amount-input-group">
          <input
            id="amount"
            type="number"
            bind:value={amount}
            placeholder="0"
            min="1"
            max={balance}
          />
          <span class="amount-unit">sats</span>
        </div>
        <div class="balance-info">
          Available: {formatBalance(balance)} sats
        </div>
      </div>
      <div class="form-section">
        <label for="memo">Memo (optional)</label>
        <textarea
          id="memo"
          bind:value={memo}
          placeholder="What's this for?"
        ></textarea>
      </div>
      {#if error}
        <div class="error-message">
          {error}
        </div>
      {/if}
      <button
        class="primary"
        onclick={handleSend}
        disabled={!canSend}
      >
        {#if isSending}
          Generating Token...
        {:else}
          Generate Token
        {/if}
      </button>
    </div>
  {:else}
    <div class="token-result">
      <div class="success-icon">‚úì</div>
      <h3>Token Generated!</h3>
      <p class="success-message">{formatBalance(amountNum)} sats ready to send</p>
      <div class="token-display">
        <div class="token-text">{token}</div>
        <button class="copy-button" onclick={copyToken}>
          üìã Copy
        </button>
      </div>
      {#if memo}
        <div class="memo-display">
          <strong>Memo:</strong> {memo}
        </div>
      {/if}
      <div class="actions">
        <button class="primary" onclick={reset}>Send Another</button>
      </div>
    </div>
  {/if}
</div>
<style>
  .send-view {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .send-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .form-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-foreground);
  }
  input, textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-foreground);
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    background: var(--color-muted);
  }
  textarea {
    min-height: 80px;
    resize: vertical;
  }
  .amount-input-group {
    position: relative;
    display: flex;
    align-items: center;
  }
  .amount-input-group input {
    padding-right: 60px;
  }
  .amount-unit {
    position: absolute;
    right: 1rem;
    color: var(--color-muted-foreground);
    font-weight: 600;
    pointer-events: none;
  }
  .balance-info {
    font-size: 0.875rem;
    color: var(--color-muted-foreground);
  }
  .error-message {
    background: var(--color-destructive);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--color-foreground);
    font-size: 0.875rem;
  }
  button {
    padding: 0.875rem 1.5rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-foreground);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  button:hover:not(:disabled) {
    background: var(--color-muted);
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  button.primary {
    background: var(--color-primary);
    border: none;
    color: white;
  }
  button.primary:hover:not(:disabled) {
    opacity: 0.9;
  }
  .token-result {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    padding: 2rem 1rem;
  }
  .success-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
  }
  h3 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-foreground);
  }
  .success-message {
    color: var(--color-muted-foreground);
    text-align: center;
  }
  .token-display {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1rem;
  }
  .token-text {
    font-family: monospace;
    font-size: 0.75rem;
    word-break: break-all;
    color: var(--color-foreground);
    line-height: 1.5;
  }
  .copy-button {
    width: 100%;
  }
  .memo-display {
    width: 100%;
    padding: 1rem;
    background: var(--color-muted);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 0.875rem;
    color: var(--color-foreground);
  }
  .actions {
    width: 100%;
    display: flex;
    gap: 0.75rem;
  }
  .actions button {
    flex: 1;
  }
</style>
</file>

<file path="wallet/TransactionList.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  const wallet = ndk.$wallet;
  const transactions = $derived(wallet.transactions || []);
  function formatDate(timestamp: number): string {
    const date = new Date(timestamp * 1000);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  }
  function formatAmount(sats: number): string {
    return new Intl.NumberFormat('en-US').format(sats);
  }
</script>
<div class="transaction-list">
  <div class="list-header">
    <h3>Recent Activity</h3>
    {#if transactions.length > 0}
      <span class="count">{transactions.length}</span>
    {/if}
  </div>
  {#if transactions.length === 0}
    <div class="empty-state">
      <div class="empty-icon">üìù</div>
      <p>No transactions yet</p>
      <p class="hint">Your wallet activity will appear here</p>
    </div>
  {:else}
    <div class="transactions">
      {#each transactions as tx}
        <div class="transaction-item">
          <div class="tx-icon" class:receive={tx.type === 'receive'} class:send={tx.type === 'send'}>
            {tx.type === 'receive' ? '‚Üì' : '‚Üë'}
          </div>
          <div class="tx-info">
            <div class="tx-title">
              {tx.type === 'receive' ? 'Received' : 'Sent'}
              {#if tx.memo}
                <span class="tx-memo">¬∑ {tx.memo}</span>
              {/if}
            </div>
            <div class="tx-date">{formatDate(tx.timestamp)}</div>
          </div>
          <div class="tx-amount" class:receive={tx.type === 'receive'} class:send={tx.type === 'send'}>
            {tx.type === 'receive' ? '+' : '-'}{formatAmount(tx.amount)}
          </div>
        </div>
      {/each}
    </div>
  {/if}
</div>
<style>
  .transaction-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 700;
  }
  .count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    padding: 0 0.5rem;
    background: rgba(249, 115, 22, 0.15);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #f97316;
  }
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 3rem 1rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px dashed rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    text-align: center;
  }
  .empty-icon {
    font-size: 3rem;
    opacity: 0.5;
  }
  .empty-state p {
    margin: 0;
    color: rgba(255, 255, 255, 0.6);
  }
  .empty-state .hint {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.4);
  }
  .transactions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .transaction-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    transition: all 0.2s;
  }
  .transaction-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }
  .tx-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 600;
    flex-shrink: 0;
  }
  .tx-icon.receive {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
    color: #10b981;
  }
  .tx-icon.send {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(234, 88, 12, 0.2) 100%);
    color: #f97316;
  }
  .tx-info {
    flex: 1;
    min-width: 0;
  }
  .tx-title {
    font-weight: 600;
    font-size: 0.9375rem;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .tx-memo {
    font-weight: 400;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .tx-date {
    font-size: 0.8125rem;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 0.125rem;
  }
  .tx-amount {
    font-weight: 700;
    font-size: 0.9375rem;
    white-space: nowrap;
  }
  .tx-amount.receive {
    color: #10b981;
  }
  .tx-amount.send {
    color: #f97316;
  }
</style>
</file>

<file path="wallet/WalletWidget.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { headerStore } from '$lib/stores/header.svelte';
  import BalanceCard from './BalanceCard.svelte';
  import SendView from './SendView.svelte';
  import ReceiveView from './ReceiveView.svelte';
  import QRScanner from './QRScanner.svelte';
  import InvoiceDetails from './InvoiceDetails.svelte';
  type TabView = 'wallet' | 'send' | 'receive' | 'scan' | 'invoice';
  let currentTab = $state<TabView>('wallet');
  let scannedInvoice = $state<string>('');
  function handleScan(data: string) {
    scannedInvoice = data;
    currentTab = 'invoice';
  }
  function handleCancelScan() {
    currentTab = 'wallet';
    scannedInvoice = '';
  }
  async function handlePayInvoice(invoice: string) {
    try {
      await ndk.$wallet.lnPay({
        pr: invoice,
      });
      currentTab = 'wallet';
      scannedInvoice = '';
    } catch (e) {
      console.error('Payment failed:', e);
      throw e;
    }
  }
  function handleCancelInvoice() {
    currentTab = 'wallet';
    scannedInvoice = '';
  }
  // Set up header config with consistent styling
  $effect(() => {
    const title =
      currentTab === 'wallet' ? 'Wallet' :
      currentTab === 'send' || currentTab === 'scan' ? 'Send' :
      currentTab === 'invoice' ? 'Payment Details' :
      currentTab === 'receive' ? 'Receive' : 'Wallet';
    headerStore.headerConfig = {
      title,
      backNav: currentTab !== 'wallet' ? { onclick: () => currentTab = 'wallet' } : undefined,
      actions: currentTab === 'wallet' ? settingsAction : undefined
    };
    return () => {
      headerStore.clear();
    };
  });
</script>
{#snippet settingsAction()}
  <a
    href="/settings?tab=wallet"
    class="inline-flex items-center justify-center p-2 rounded-lg hover:bg-muted transition-colors text-foreground"
  >
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
  </a>
{/snippet}
<div class="wallet-container">
  <!-- Content -->
  <div class="wallet-content">
    {#if currentTab === 'wallet'}
      <div class="balance-section">
        <BalanceCard />
      </div>
      <div class="action-buttons">
        <button class="action-btn send" onclick={() => currentTab = 'send'}>
          <span class="action-icon">‚Üë</span>
          <span class="action-label">Send</span>
        </button>
        <button class="action-btn scan" onclick={() => currentTab = 'scan'}>
          <svg class="action-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="4" y="4" width="6" height="6" stroke="currentColor" stroke-width="2" fill="none" rx="1"/>
            <rect x="14" y="4" width="6" height="6" stroke="currentColor" stroke-width="2" fill="none" rx="1"/>
            <rect x="4" y="14" width="6" height="6" stroke="currentColor" stroke-width="2" fill="none" rx="1"/>
            <rect x="14" y="14" width="6" height="6" stroke="currentColor" stroke-width="2" fill="none" rx="1"/>
          </svg>
          <span class="action-label">Scan QR</span>
        </button>
        <button class="action-btn receive" onclick={() => currentTab = 'receive'}>
          <span class="action-icon">‚Üì</span>
          <span class="action-label">Receive</span>
        </button>
      </div>
    {:else if currentTab === 'send'}
      <SendView />
    {:else if currentTab === 'scan'}
      <QRScanner onScan={handleScan} onCancel={handleCancelScan} />
    {:else if currentTab === 'invoice'}
      <InvoiceDetails invoice={scannedInvoice} onPay={handlePayInvoice} onCancel={handleCancelInvoice} />
    {:else if currentTab === 'receive'}
      <ReceiveView />
    {/if}
  </div>
</div>
<style>
  .wallet-container {
    width: 100%;
  }
  .wallet-content {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    padding: 1rem;
  }
  .balance-section {
    margin-bottom: 2rem;
  }
  .action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.75rem;
  }
  .action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1.5rem 1rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--color-foreground);
    font-size: 0.9rem;
    font-weight: 600;
  }
  .action-btn:hover {
    background: var(--color-muted);
    border-color: var(--color-primary);
    transform: translateY(-2px);
  }
  .action-btn:active {
    transform: translateY(0);
  }
  .action-icon {
    font-size: 1.75rem;
    line-height: 1;
    transition: transform 0.2s;
    color: var(--color-primary);
  }
  .action-icon-svg {
    width: 1.75rem;
    height: 1.75rem;
    transition: transform 0.2s;
    color: var(--color-primary);
  }
  .action-btn:hover .action-icon,
  .action-btn:hover .action-icon-svg {
    transform: scale(1.1);
  }
  .action-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-muted-foreground);
  }
  @media (max-width: 640px) {
    .wallet-container {
      padding: 0.5rem;
    }
    .wallet-card {
      padding: 1.5rem;
      border-radius: 8px;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .action-btn {
      padding: 1.25rem 0.75rem;
      gap: 0.5rem;
    }
    .action-icon {
      font-size: 1.5rem;
    }
    .action-icon-svg {
      width: 1.5rem;
      height: 1.5rem;
    }
    .action-label {
      font-size: 0.75rem;
    }
  }
</style>
</file>

<file path="ArticleContent.svelte">
<script lang="ts">
  import { marked } from 'marked';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { ndk } from '$lib/ndk.svelte';
  import { SvelteMap } from 'svelte/reactivity';
  interface Props {
    content: string;
    emojiTags?: string[][];
    highlights?: NDKEvent[];
    onTextSelected?: (text: string, range: Range) => void;
    onHighlightClick?: (highlight: NDKEvent) => void;
  }
  let { content, emojiTags, highlights = [], onTextSelected, onHighlightClick }: Props = $props();
  let contentElement = $state<HTMLDivElement>();
  let avatarData = $state<Array<{ pubkey: string; top: number; right: string }>>([]);
  const hasMarkdown = $derived.by(() => {
    const markdownPatterns = [
      /^#{1,6}\s/m,
      /\*\*[^*]+\*\*/,
      /\*[^*]+\*/,
      /\[([^\]]+)\]\([^)]+\)/,
      /^[-*+]\s/m,
      /^>\s/m,
      /```[\s\S]*?```/,
      /^\d+\.\s/m,
    ];
    return markdownPatterns.some(pattern => pattern.test(content));
  });
  const htmlContent = $derived.by(() => {
    if (hasMarkdown) {
      return marked.parse(content, { async: false }) as string;
    }
    return content;
  });
  function handleMouseUp() {
    if (!onTextSelected) return;
    const selection = window.getSelection();
    if (!selection || selection.isCollapsed) return;
    const selectedText = selection.toString().trim();
    if (selectedText.length === 0) return;
    // Check if selection is within the article content
    if (!contentElement?.contains(selection.anchorNode)) return;
    const range = selection.getRangeAt(0);
    onTextSelected(selectedText, range);
  }
  $effect(() => {
    if (contentElement && highlights.length > 0) {
      applyHighlights();
    }
  });
  // Recalculate avatar positions on resize
  $effect(() => {
    if (typeof window === 'undefined') return;
    const handleResize = () => {
      if (avatarData.length > 0) {
        // Re-run the avatar positioning logic
        addHighlightAvatars();
      }
    };
    window.addEventListener('resize', handleResize);
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  });
  function applyHighlights() {
    if (!contentElement) return;
    // Reset any existing highlights and avatars
    const existingMarks = contentElement.querySelectorAll('mark.nostr-highlight');
    existingMarks.forEach(mark => {
      const parent = mark.parentNode;
      if (parent) {
        parent.replaceChild(document.createTextNode(mark.textContent || ''), mark);
        parent.normalize();
      }
    });
    // Remove existing avatar containers
    const existingAvatars = contentElement.querySelectorAll('.highlight-avatar-container');
    existingAvatars.forEach(avatar => avatar.remove());
    // Apply each highlight
    highlights.forEach(highlight => {
      const highlightText = highlight.content.trim();
      if (!highlightText || !contentElement) return;
      try {
        highlightTextInElement(contentElement, highlightText, highlight);
      } catch (err) {
        console.warn('Failed to apply highlight:', err);
      }
    });
    // Add avatars after all highlights are applied
    addHighlightAvatars();
  }
  function highlightTextInElement(element: HTMLElement, searchText: string, highlightEvent: NDKEvent) {
    const walker = document.createTreeWalker(
      element,
      NodeFilter.SHOW_TEXT,
      null
    );
    const nodesToHighlight: { node: Text; offset: number }[] = [];
    let currentNode: Text | null;
    while ((currentNode = walker.nextNode() as Text | null)) {
      // Skip if parent is already a highlight
      if (currentNode.parentElement?.classList.contains('nostr-highlight')) continue;
      const text = currentNode.textContent || '';
      const index = text.indexOf(searchText);
      if (index !== -1) {
        nodesToHighlight.push({ node: currentNode, offset: index });
      }
    }
    // Apply highlights (do this after tree walk to avoid modifying while walking)
    nodesToHighlight.forEach(({ node, offset }) => {
      const text = node.textContent || '';
      const before = text.substring(0, offset);
      const highlighted = text.substring(offset, offset + searchText.length);
      const after = text.substring(offset + searchText.length);
      const mark = document.createElement('mark');
      mark.className = 'nostr-highlight';
      mark.dataset.pubkey = highlightEvent.pubkey;
      mark.dataset.highlightId = highlightEvent.id;
      mark.textContent = highlighted;
      // Add click handler if callback is provided
      if (onHighlightClick) {
        mark.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          onHighlightClick(highlightEvent);
        });
      }
      const parent = node.parentNode;
      if (parent) {
        if (before) parent.insertBefore(document.createTextNode(before), node);
        parent.insertBefore(mark, node);
        if (after) parent.insertBefore(document.createTextNode(after), node);
        parent.removeChild(node);
      }
    });
  }
  function addHighlightAvatars() {
    if (!contentElement) return;
    const marks = contentElement.querySelectorAll('mark.nostr-highlight');
    const containerRect = contentElement.getBoundingClientRect();
    // Group marks by their containing block element
    const blockMap = new SvelteMap<HTMLElement, Set<string>>();
    marks.forEach(mark => {
      // Find the containing block element (p, h1, h2, etc.)
      let block = mark.parentElement;
      while (block && block !== contentElement) {
        const tagName = block.tagName.toLowerCase();
        if (['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'blockquote', 'div'].includes(tagName)) {
          break;
        }
        block = block.parentElement;
      }
      if (block && block !== contentElement) {
        const pubkey = (mark as HTMLElement).dataset.pubkey;
        if (pubkey) {
          if (!blockMap.has(block)) {
            blockMap.set(block, new Set());
          }
          blockMap.get(block)?.add(pubkey);
        }
      }
    });
    // Prepare avatar data for rendering with calculated positions
    const newAvatarData: Array<{ pubkey: string; top: number; right: string }> = [];
    blockMap.forEach((pubkeys, block) => {
      const blockRect = block.getBoundingClientRect();
      const topPosition = blockRect.top - containerRect.top;
      // Add avatar data for each pubkey
      Array.from(pubkeys).forEach((pubkey, position) => {
        newAvatarData.push({
          pubkey,
          top: topPosition + (position * 40), // Stack avatars vertically if multiple
          right: '-3rem'
        });
      });
    });
    avatarData = newAvatarData;
  }
</script>
<div class="article-wrapper">
  {#if hasMarkdown}
    <div
      bind:this={contentElement}
      onmouseup={handleMouseUp}
      role="article"
      class="article-content prose prose-lg dark:prose-invert max-w-none select-text"
    >
      {@html htmlContent}
    </div>
  {:else}
    <div
      bind:this={contentElement}
      onmouseup={handleMouseUp}
      role="article"
      class="article-content text-lg leading-[1.8] font-serif whitespace-pre-wrap select-text"
    >
      {content}
    </div>
  {/if}
  <!-- Floating avatars for highlights -->
  {#each avatarData as { pubkey, top, right }, index (pubkey + index)}
    <div
      class="highlight-avatar"
      style="position: absolute; top: {top}px; right: {right};"
    >
      <Avatar {ndk} {pubkey} class="w-8 h-8 rounded-full ring-2 ring-background shadow-lg" />
    </div>
  {/each}
</div>
<style>
  @reference "../../app.css";
  .article-wrapper {
    position: relative;
  }
  .highlight-avatar {
    pointer-events: auto;
    z-index: 10;
  }
  .highlight-avatar:hover {
    transform: scale(1.1);
    transition: transform 0.2s;
  }
  :global(.article-content) {
    color: hsl(var(--foreground));
  }
  :global(.article-content h1) {
    @apply text-3xl sm:text-4xl font-bold mt-12 mb-6 font-serif;
    color: hsl(var(--foreground));
  }
  :global(.article-content h2) {
    @apply text-2xl sm:text-3xl font-bold mt-10 mb-5 font-serif;
    color: hsl(var(--foreground));
  }
  :global(.article-content h3) {
    @apply text-xl sm:text-2xl font-bold mt-8 mb-4 font-serif;
    color: hsl(var(--foreground));
  }
  :global(.article-content p) {
    @apply text-lg leading-[1.8] mb-6 font-serif;
    color: hsl(var(--foreground));
  }
  :global(.article-content a) {
    @apply text-blue-600 dark:text-blue-400 underline underline-offset-2 hover:text-blue-800 dark:hover:text-blue-300 transition-colors;
  }
  :global(.article-content img) {
    @apply w-full rounded-lg shadow-sm my-8;
  }
  :global(.article-content ul) {
    @apply list-disc pl-6 mb-6 space-y-2 text-lg font-serif;
    color: hsl(var(--foreground));
  }
  :global(.article-content ol) {
    @apply list-decimal pl-6 mb-6 space-y-2 text-lg font-serif;
    color: hsl(var(--foreground));
  }
  :global(.article-content li) {
    @apply leading-[1.8];
  }
  :global(.article-content blockquote) {
    @apply border-l-4 pl-6 my-8 italic text-xl font-serif leading-[1.8];
    border-color: hsl(var(--border));
    color: hsl(var(--muted-foreground));
  }
  :global(.article-content code) {
    @apply px-1.5 py-0.5 rounded text-sm font-mono;
    background-color: hsl(var(--muted));
    color: hsl(var(--foreground));
  }
  :global(.article-content pre) {
    @apply mb-6 overflow-hidden rounded-lg;
  }
  :global(.article-content pre code) {
    @apply block border rounded-lg p-4 overflow-x-auto text-sm font-mono leading-relaxed;
    background-color: hsl(var(--background));
    border-color: hsl(var(--border));
  }
  :global(.article-content hr) {
    @apply my-12 border-t;
    border-color: hsl(var(--border));
  }
  :global(.article-content strong) {
    @apply font-bold;
    color: hsl(var(--foreground));
  }
  :global(.article-content em) {
    @apply italic;
  }
  /* Nostr highlight styles */
  :global(mark.nostr-highlight) {
    background-color: color-mix(in srgb, var(--color-primary) 20%, transparent);
    border-bottom: 2px solid color-mix(in srgb, var(--color-primary) 60%, transparent);
    color: hsl(var(--foreground));
    @apply transition-all duration-200;
    @apply cursor-pointer;
    padding: 0.125rem 0;
    pointer-events: auto;
    user-select: none;
  }
  :global(mark.nostr-highlight:hover) {
    background-color: color-mix(in srgb, var(--color-primary) 30%, transparent);
    border-bottom-color: var(--color-primary);
  }
</style>
</file>

<file path="ArticleHeader.svelte">
<script lang="ts">
  import type { NDKArticle } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import User from './User.svelte';
  interface Props {
    article: NDKArticle;
  }
  let { article }: Props = $props();
  const title = $derived(article.title || 'Untitled');
  const summary = $derived(article.summary);
  const publishedAt = $derived(article.published_at);
  const wordsPerMinute = 200;
  const readingTime = $derived.by(() => {
    const words = article.content?.split(/\s+/).length || 0;
    return Math.ceil(words / wordsPerMinute);
  });
  const firstParagraph = $derived.by(() => {
    if (!article.content) return '';
    const paragraphs = article.content.trim().split(/\n\n+/);
    return paragraphs[0]?.trim() || '';
  });
  const shouldShowSummary = $derived.by(() => {
    if (!summary) return false;
    const normalizedSummary = summary.trim().toLowerCase();
    const normalizedFirstParagraph = firstParagraph.toLowerCase();
    return normalizedSummary !== normalizedFirstParagraph;
  });
</script>
<div class="mb-12">
  <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-foreground mb-6 leading-[1.1] tracking-tight font-serif">
    {title}
  </h1>
  {#if shouldShowSummary}
    <p class="text-xl sm:text-2xl text-muted-foreground mb-8 leading-relaxed font-light">
      {summary}
    </p>
  {/if}
  <div class="mb-8">
    <User
      pubkey={article.pubkey}
      variant="avatar-name-bio"
      avatarSize="w-12 h-12 sm:w-14 sm:h-14"
      nameSize="text-lg font-semibold"
      bioSize="text-sm text-muted-foreground line-clamp-1 max-w-md"
    />
  </div>
  <div class="flex items-center gap-2 text-sm text-muted-foreground">
    {#if publishedAt}
      <time datetime={new Date(publishedAt * 1000).toISOString()}>
        {new Date(publishedAt * 1000).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </time>
      <span>¬∑</span>
    {/if}
    <span>{readingTime} min read</span>
  </div>
  <div class="mt-8 border-t border"></div>
</div>
</file>

<file path="ArticleList.svelte">
<script lang="ts">
  import type { NDKArticle } from '@nostr-dev-kit/ndk';
  import ArticlePreviewCard from './ArticlePreviewCard.svelte';
  interface Props {
    articles: NDKArticle[];
    emptyMessage?: string;
  }
  const { articles, emptyMessage = 'No articles yet' }: Props = $props();
</script>
{#if articles.length === 0}
  <div class="text-center py-8 text-muted-foreground">
    {emptyMessage}
  </div>
{:else}
  <div class="divide-y divide-neutral-800/50">
    {#each articles as article (article.id)}
      <ArticlePreviewCard {article} />
    {/each}
  </div>
{/if}
</file>

<file path="ArticlePreviewCard.svelte">
<script lang="ts">
  import type { NDKArticle, NDKUser, NDKUserProfile } from '@nostr-dev-kit/ndk';
  import { nip19 } from 'nostr-tools';
  import { ndk } from '$lib/ndk.svelte';
  import TimeAgo from './TimeAgo.svelte';
  import { getArticleUrl } from '$lib/utils/articleUrl';
  interface Props {
    article: NDKArticle;
    variant?: 'default' | 'compact';
  }
  const MAX_EXCERPT_LENGTH = 150;
  const THUMBNAIL_SIZE = 'w-32 h-24 sm:w-40 sm:h-28';
  let { article, variant = 'default' }: Props = $props();
  let author = $state<NDKUser | undefined>(undefined);
  let authorProfile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    author = article.author;
    article.author.fetchProfile().then(p => { authorProfile = p; });
  });
  const title = $derived(article.title || 'Untitled');
  const summary = $derived(article.summary);
  const excerpt = $derived.by(() => {
    const text = summary || article.content;
    return text.slice(0, MAX_EXCERPT_LENGTH) + (text.length > MAX_EXCERPT_LENGTH ? '...' : '');
  });
  const publishedAt = $derived(article.published_at || article.created_at);
  const imageUrl = $derived(article.image);
  const articleUrl = $derived(getArticleUrl(article, author));
  const authorName = $derived(authorProfile?.name || authorProfile?.displayName || 'Anonymous');
</script>
{#if variant === 'compact'}
  <a
    href={articleUrl}
    class="block p-3 hover:bg-accent/50 transition-colors rounded-lg"
  >
    <div class="flex items-start gap-3">
      {#if imageUrl}
        <div class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden bg-muted">
          <img
            src={imageUrl}
            alt={title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
      {:else}
        <div class="flex-shrink-0 w-10 h-10 bg-primary/10 dark:bg-primary/20 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
      {/if}
      <div class="flex-1 min-w-0">
        <h3 class="font-semibold text-sm text-foreground line-clamp-2 mb-1">
          {title}
        </h3>
        <div class="flex items-center gap-2 text-xs text-muted-foreground">
          <span>{authorName}</span>
          {#if publishedAt}
            <span>¬∑</span>
            <TimeAgo timestamp={publishedAt} />
          {/if}
        </div>
      </div>
    </div>
  </a>
{:else}
  <a
    href={articleUrl}
    class="block p-4 sm:p-6 hover:bg-card/30 transition-colors border-b border-border last:border-b-0"
  >
    <div class="flex gap-4 sm:gap-6">
      <div class="flex-1 min-w-0">
        <h3 class="font-bold text-xl sm:text-2xl text-foreground mb-2 line-clamp-2 font-serif">
          {title}
        </h3>
        <p class="text-muted-foreground text-sm sm:text-base mb-4 line-clamp-3 leading-relaxed">
          {excerpt}
        </p>
        <div class="flex items-center gap-3 text-xs sm:text-sm text-muted-foreground">
          <span class="font-medium">{authorName}</span>
          {#if publishedAt}
            <span>¬∑</span>
            <span class="flex items-center gap-1">
              <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <TimeAgo timestamp={publishedAt} />
            </span>
          {/if}
        </div>
      </div>
      {#if imageUrl}
        <div class={`${THUMBNAIL_SIZE} flex-shrink-0 rounded-lg overflow-hidden bg-muted`}>
          <img
            src={imageUrl}
            alt={title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
      {:else}
        <div class={`${THUMBNAIL_SIZE} flex-shrink-0 rounded-lg bg-primary/10 flex items-center justify-center`}>
          <svg class="w-8 h-8 sm:w-10 sm:h-10 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
      {/if}
    </div>
  </a>
{/if}
</file>

<file path="CommentCard.svelte">
<script lang="ts">
  import type { NDKEvent, NDKUserProfile } from '@nostr-dev-kit/ndk';
  import { Avatar, EventContent } from '@nostr-dev-kit/svelte';
  import { ndk } from '$lib/ndk.svelte';
  import { navigateToProfile } from '$lib/utils/navigation';
  import TimeAgo from './TimeAgo.svelte';
  interface Props {
    event: NDKEvent;
  }
  let { event }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    event.author.fetchProfile().then(p => { profile = p; });
  });
  const displayName = $derived(profile?.name || profile?.displayName || 'Anonymous');
  function handleProfileClick() {
    navigateToProfile(event.pubkey);
  }
</script>
<div class="group">
  <div class="flex gap-3 items-start">
    <button type="button" onclick={handleProfileClick} class="flex-shrink-0">
      <Avatar {ndk} pubkey={event.pubkey} class="w-10 h-10 cursor-pointer hover:opacity-80 transition-opacity" />
    </button>
    <div class="flex-1 min-w-0">
      <div class="flex items-baseline gap-2 mb-1">
        <span class="font-semibold text-foreground">
          {displayName}
        </span>
        {#if event.created_at}
          <TimeAgo timestamp={event.created_at} class="text-sm text-muted-foreground" />
        {/if}
      </div>
      <div class="text-neutral-800 dark:text-foreground leading-relaxed whitespace-pre-wrap break-words">
        <EventContent {ndk} content={event.content} emojiTags={event.tags} />
      </div>
    </div>
  </div>
</div>
</file>

<file path="CommentForm.svelte">
<script lang="ts">
  import type { NDKArticle, NDKEvent } from '@nostr-dev-kit/ndk';
  import { NDKBlossom } from '@nostr-dev-kit/blossom';
  import { createBlossomUpload } from '@nostr-dev-kit/svelte';
  import { ndk } from '$lib/ndk.svelte';
  import User from '$lib/components/User.svelte';
  import { Button } from '$lib/components/ui/button';
  import { toast } from '$lib/stores/toast.svelte';
  import UserSelector from '$lib/components/UserSelector.svelte';
  interface Props {
    article: NDKArticle;
    onError: (error: string) => void;
  }
  let { article, onError }: Props = $props();
  let replyContent = $state('');
  let isSubmitting = $state(false);
  let isFocused = $state(false);
  let textareaElement: HTMLTextAreaElement;
  let fileInput: HTMLInputElement;
  let selectedMentions = $state<string[]>([]);
  const blossom = new NDKBlossom(ndk);
  const upload = createBlossomUpload(blossom);
  let isUploading = $state(false);
  const hasContent = $derived(replyContent.trim().length > 0);
  async function handleCommentPublish() {
    if (!ndk.$currentUser || !replyContent.trim()) return;
    isSubmitting = true;
    try {
      const replyEvent = article.reply();
      replyEvent.content = replyContent;
      await replyEvent.publish();
      if (replyEvent.publishStatus === 'error') {
        const error = replyEvent.publishError;
        const relayErrors = error?.relayErrors || {};
        const errorMessages = Object.entries(relayErrors)
          .map(([relay, err]) => `${relay}: ${err}`)
          .join('\n');
        onError(`Failed to publish:\n${errorMessages || 'Unknown error'}`);
        return;
      }
      replyContent = '';
      isFocused = false;
      selectedMentions = [];
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Failed to publish comment';
      onError(errorMessage);
    } finally {
      isSubmitting = false;
    }
  }
  function handleFocus() {
    isFocused = true;
  }
  function handleBlur() {
    setTimeout(() => {
      if (!replyContent.trim()) {
        isFocused = false;
      }
    }, 100);
  }
  function handleInput() {
    if (!textareaElement) return;
    textareaElement.style.height = 'auto';
    const newHeight = Math.min(150, Math.max(20, textareaElement.scrollHeight));
    textareaElement.style.height = newHeight + 'px';
  }
  async function handleFileSelect(file: File) {
    if (!file.type.startsWith('image/')) {
      toast.error('Please select an image file');
      return;
    }
    isUploading = true;
    try {
      await upload.upload(file, {
        fallbackServer: 'https://blossom.primal.net'
      });
      if (upload.result?.url) {
        insertImageUrl(upload.result.url);
        toast.success('Image uploaded');
      }
    } catch (error) {
      console.error('Upload failed:', error);
      toast.error('Failed to upload image');
    } finally {
      isUploading = false;
    }
  }
  function insertImageUrl(url: string) {
    const textarea = textareaElement;
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const imageMarkdown = `\n${url}\n`;
    replyContent = replyContent.slice(0, start) + imageMarkdown + replyContent.slice(end);
    setTimeout(() => {
      textarea.selectionStart = textarea.selectionEnd = start + imageMarkdown.length;
      textarea.focus();
      handleInput();
    }, 0);
  }
  function handleFileInputChange(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (file) {
      handleFileSelect(file);
    }
    input.value = '';
  }
  function triggerFileInput() {
    fileInput?.click();
  }
</script>
{#if ndk.$currentUser}
  <div class="mb-8">
    <div class="flex gap-2.5 items-end max-md:items-start">
      <User
        pubkey={ndk.$currentUser.pubkey}
        variant="avatar"
        avatarSize={isFocused ? 'w-9 h-9' : 'w-8 h-8'}
        class="transition-all duration-300 max-md:mt-0.5"
      />
      <div class="flex-1 flex flex-col gap-2">
        <div class="bg-neutral-50 dark:bg-card border border rounded-[18px] {isFocused ? 'rounded-[14px] p-3' : 'py-2.5 px-3.5'} transition-all duration-300 {isFocused ? 'border-neutral-300 dark:border-neutral-700' : 'border-neutral-200 dark:border-neutral-800'} flex {isFocused ? 'flex-col' : 'items-center'} gap-2">
          <input bind:this={fileInput} type="file" accept="image/*" onchange={handleFileInputChange} class="hidden" />
          <textarea
            bind:this={textareaElement}
            bind:value={replyContent}
            onfocus={handleFocus}
            onblur={handleBlur}
            oninput={handleInput}
            disabled={isSubmitting}
            placeholder="Share your thoughts..."
            class="w-full bg-transparent text-foreground placeholder-neutral-500 resize-none focus:outline-none text-[15px] leading-[1.4] transition-all duration-300 {isFocused ? 'max-h-[150px]' : 'max-h-9'} overflow-hidden"
            rows="1"
          ></textarea>
          {#if hasContent && !isFocused}
            <button
              type="button"
              onclick={handleCommentPublish}
              disabled={isSubmitting}
              class="w-7 h-7 bg-accent text-white rounded-full flex items-center justify-center flex-shrink-0 transition-all duration-200 active:scale-90"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
          {/if}
          {#if isFocused}
            <div class="flex items-center justify-between pt-2 border-t border-neutral-200 dark:border-neutral-800 opacity-100 transition-opacity duration-200">
              <div class="flex gap-1">
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={triggerFileInput}
                  disabled={isSubmitting || isUploading}
                  class="h-8 w-8"
                >
                  <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </Button>
                <UserSelector
                  bind:selectedPubkeys={selectedMentions}
                  disabled={isSubmitting}
                />
              </div>
              <button
                type="button"
                onclick={handleCommentPublish}
                disabled={!hasContent || isSubmitting}
                class="px-[18px] py-2 bg-accent text-white rounded-[18px] font-semibold text-[14px] transition-all duration-150 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
              >
                {isSubmitting ? 'Posting...' : 'Comment'}
              </button>
            </div>
          {/if}
        </div>
      </div>
    </div>
  </div>
{/if}
</file>

<file path="CommentList.svelte">
<script lang="ts">
  import type { NDKArticle, NDKEvent } from '@nostr-dev-kit/ndk';
  import { NDKKind } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import NoteCard from './NoteCard.svelte';
  interface Props {
    article: NDKArticle;
  }
  let { article }: Props = $props();
  const commentsSubscription = ndk.$subscribe(() => ({
    filters: [{
      kinds: [NDKKind.Text, NDKKind.GenericReply],
      '#a': [`${article.kind}:${article.pubkey}:${article.dTag}`]
    }],
    bufferMs: 100,
    subId: 'comments'
  }));
  const comments = $derived.by(() => {
    return [...commentsSubscription.events].sort((a, b) => (a.created_at || 0) - (b.created_at || 0));
  });
</script>
{#if comments.length === 0}
  <div class="py-12 text-center text-muted-foreground">
    No comments yet. Be the first to share your thoughts!
  </div>
{:else}
  <div>
    {#each comments as comment (comment.id)}
      <NoteCard event={comment} variant="default" />
    {/each}
  </div>
{/if}
</file>

<file path="CommentSection.svelte">
<script lang="ts">
  import type { NDKArticle } from '@nostr-dev-kit/ndk';
  import CommentForm from './CommentForm.svelte';
  import CommentList from './CommentList.svelte';
  interface Props {
    article: NDKArticle;
    onError: (error: string) => void;
  }
  let { article, onError }: Props = $props();
</script>
<div class="border-t border pt-12">
  <div class="mb-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-foreground font-serif mb-2">
      Discussion
    </h2>
  </div>
  <CommentForm {article} {onError} />
  <CommentList {article} />
</div>
</file>

<file path="ComposeDialog.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKEvent, NDKRelaySet } from '@nostr-dev-kit/ndk';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { clickOutside } from '$lib/utils/clickOutside';
  import { portal } from '$lib/utils/portal.svelte';
  import { browser } from '$app/environment';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Label } from '$lib/components/ui/label';
  import ContentComposer from '$lib/components/ContentComposer.svelte';
  import RelayPublishDropdownContent from '$lib/components/RelayPublishDropdownContent.svelte';
  import { useModalRelaySelection } from '$lib/composables/useModalRelaySelection.svelte';
  import NoteCard from '$lib/components/NoteCard.svelte';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    open?: boolean;
    onClose?: () => void;
    replyTo?: NDKEvent;
    quotedEvent?: NDKEvent;
    onPublished?: () => void;
  }
  let { open = $bindable(false), onClose, replyTo, quotedEvent, onPublished }: Props = $props();
  let content = $state('');
  let isPublishing = $state(false);
  let isRelayDropdownOpen = $state(false);
  let isProtected = $state(false);
  let showProtectedInfo = $state(false);
  let selectedMentions = $state<string[]>([]);
  let replyToProfile = $state<import('@nostr-dev-kit/ndk').NDKUserProfile | null>(null);
  $effect(() => {
    if (!replyTo) {
      replyToProfile = null;
      return;
    }
    replyTo.author.fetchProfile().then(p => { replyToProfile = p; });
  });
  const relaySelection = useModalRelaySelection(() => open);
  const { selectedRelayUrls, allRelays } = $derived(relaySelection);
  async function publishNote() {
    if (!content.trim() || isPublishing || selectedRelayUrls.length === 0) return;
    try {
      isPublishing = true;
      let event: NDKEvent;
      if (replyTo) {
        event = replyTo.reply();
      } else if (quotedEvent) {
        event = new NDKEvent(ndk);
        event.kind = 1;
        event.tags.push(['q', quotedEvent.id]);
        event.tags.push(['p', quotedEvent.pubkey]);
      } else {
        event = new NDKEvent(ndk);
        event.kind = 1;
      }
      event.content = content;
      if (!replyTo) {
        event.isProtected = isProtected;
      }
      // Add mention tags
      selectedMentions.forEach(pubkey => {
        event.tags.push(['p', pubkey]);
      });
      await event.sign();
      // Create a relay set from the selected relay URLs
      const relaySet = NDKRelaySet.fromRelayUrls(selectedRelayUrls, ndk);
      await event.publish(relaySet);
      if (event.publishStatus === 'error') {
        const error = event.publishError;
        console.error('Publish error object:', error);
        console.error('Relay errors:', error?.relayErrors);
        const relayErrors = error?.relayErrors || {};
        const relayErrorEntries = Object.entries(relayErrors);
        if (relayErrorEntries.length > 0) {
          const errorMessages = relayErrorEntries
            .map(([relay, err]) => `‚Ä¢ ${relay.replace('wss://', '')}: ${err}`)
            .join('\n');
          toast.error(`Failed to publish to relays:\n\n${errorMessages}`);
        } else {
          toast.error(`Failed to publish: ${error?.message || 'Not enough relays received the event'}`);
        }
        return;
      }
      content = '';
      selectedMentions = [];
      open = false;
      toast.success(replyTo ? 'Reply published' : quotedEvent ? 'Quote published' : 'Note published');
      onPublished?.();
      onClose?.();
    } catch (error) {
      console.error('Failed to publish note:', error);
      toast.error(`Failed to publish: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      isPublishing = false;
    }
  }
  function toggleRelay(url: string) {
    if (relaySelection.selectedRelayUrls.includes(url)) {
      relaySelection.selectedRelayUrls = relaySelection.selectedRelayUrls.filter(u => u !== url);
    } else {
      relaySelection.selectedRelayUrls = [...relaySelection.selectedRelayUrls, url];
    }
  }
  function selectOnlyRelay(url: string) {
    relaySelection.selectedRelayUrls = [url];
    isRelayDropdownOpen = false;
  }
  function handleRelayDropdownClickOutside() {
    isRelayDropdownOpen = false;
  }
  function handleClose() {
    if (!isPublishing) {
      open = false;
      content = '';
      selectedMentions = [];
      onClose?.();
    }
  }
  function handleKeydown(e: KeyboardEvent) {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      publishNote();
    }
  }
</script>
<svelte:window onkeydown={handleKeydown} />
{#if isDesktop.current}
  <Dialog.Root {open} onOpenChange={(isOpen) => {
      if (!isOpen) {
        handleClose();
      } else {
        open = true;
      }
    }}>
    <Dialog.Content class="md:max-w-2xl !overflow-visible">
      <!-- Header -->
      <div class="flex items-center justify-between -mx-6 -mt-6 px-4 py-3 mb-4 border-b border-border">
        <Button
          variant="ghost"
          size="icon"
          onclick={handleClose}
          disabled={isPublishing}
          class="h-10 w-10"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </Button>
        <Dialog.Title class="text-lg">
          {replyTo ? 'Reply' : quotedEvent ? 'Quote' : 'Compose'}
        </Dialog.Title>
        <Button
          onclick={publishNote}
          disabled={!content.trim() || isPublishing || selectedRelayUrls.length === 0}
          class="rounded-full"
          size="sm"
        >
          {isPublishing ? 'Publishing...' : 'Post'}
        </Button>
      </div>
      <!-- Reply context (if replying) -->
      {#if replyTo && replyToProfile}
        <div class="-mx-6 px-4 py-3 mb-4 border-b border-border bg-card/50">
          <div class="flex gap-3">
            <Avatar {ndk} pubkey={replyTo.pubkey} class="w-10 h-10" />
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-foreground text-sm">
                  {replyToProfile.displayName || replyToProfile.name || `${replyTo.pubkey.slice(0, 8)}...`}
                </span>
                <span class="text-muted-foreground text-xs">
                  @{replyToProfile.name || replyTo.pubkey.slice(0, 8)}
                </span>
              </div>
              <p class="text-muted-foreground text-sm line-clamp-3">
                {replyTo.content}
              </p>
            </div>
          </div>
        </div>
      {/if}
      <!-- Compose area -->
      <div class="relative mb-4">
        <ContentComposer
          bind:value={content}
          bind:selectedMentions
          placeholder={replyTo ? 'Write your reply...' : quotedEvent ? 'Add your thoughts...' : "What's on your mind?"}
          autofocus={true}
          disabled={isPublishing}
        >
          {#snippet relayButton()}
            <div class="relative">
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
                disabled={isPublishing}
                class="h-8 w-8"
                title="Select relays"
              >
                {#if selectedRelayUrls.length <= 2 && selectedRelayUrls.length > 0}
                  <div class="flex items-center -space-x-1">
                    {#each selectedRelayUrls as relayUrl}
                      {@const relay = allRelays.find(r => r.url === relayUrl)}
                      {@const relayInfo = relay ? useRelayInfoCached(relay.url) : null}
                      {#if relayInfo?.info?.icon}
                        <img src={relayInfo.info.icon} alt="" class="w-5 h-5 rounded border border-background" />
                      {:else}
                        <div class="w-5 h-5 rounded bg-muted flex items-center justify-center border border-background">
                          <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                          </svg>
                        </div>
                      {/if}
                    {/each}
                  </div>
                {:else}
                  <div class="relative">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                    </svg>
                    {#if selectedRelayUrls.length > 2}
                      <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                        {selectedRelayUrls.length}
                      </span>
                    {/if}
                  </div>
                {/if}
              </Button>
              <!-- Relay Dropdown -->
              {#if isRelayDropdownOpen}
                <div
                  use:clickOutside={handleRelayDropdownClickOutside}
                  class="absolute top-full left-0 mt-2 bg-popover border border-border rounded-lg shadow-xl z-[100] w-80 max-h-[400px] overflow-y-auto transition-all duration-200"
                >
                  <RelayPublishDropdownContent
                    {selectedRelayUrls}
                    bind:isProtected
                    onToggleRelay={toggleRelay}
                    onSelectOnly={selectOnlyRelay}
                  />
                </div>
              {/if}
            </div>
          {/snippet}
        </ContentComposer>
      </div>
      <!-- Quoted event (if quoting) -->
      {#if quotedEvent}
        <div class="-mx-6 px-4 py-3 mb-4 border-y border-border bg-muted/30">
          <div class="text-xs text-muted-foreground mb-2">Quoting</div>
          <div class="border border-border rounded-lg overflow-hidden bg-card">
            <NoteCard event={quotedEvent} showActions={false} />
          </div>
        </div>
      {/if}
      <!-- Footer hint -->
      <div class="-mx-6 px-4 py-3 border-t border-border">
        <p class="text-xs text-muted-foreground">
          Press <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">Esc</kbd> to cancel,
          <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">‚åò</kbd> +
          <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">Enter</kbd> to post
        </p>
      </div>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root {open} onOpenChange={(isOpen) => {
      if (!isOpen) {
        handleClose();
      } else {
        open = true;
      }
    }}>
    <Drawer.Content class="h-[95vh] flex flex-col !overflow-visible">
      <!-- Header -->
      <div class="flex items-center justify-between px-4 py-3 mb-4 border-b border-border shrink-0">
        <Button
          variant="ghost"
          size="icon"
          onclick={handleClose}
          disabled={isPublishing}
          class="h-10 w-10"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </Button>
        <Drawer.Title class="text-lg">
          {replyTo ? 'Reply' : quotedEvent ? 'Quote' : 'Compose'}
        </Drawer.Title>
        <Button
          onclick={publishNote}
          disabled={!content.trim() || isPublishing || selectedRelayUrls.length === 0}
          class="rounded-full"
          size="sm"
        >
          {isPublishing ? 'Publishing...' : 'Post'}
        </Button>
      </div>
      <!-- Reply context (if replying) -->
      {#if replyTo && replyToProfile}
        <div class="px-4 py-3 mb-4 border-b border-border bg-card/50 shrink-0">
          <div class="flex gap-3">
            <Avatar {ndk} pubkey={replyTo.pubkey} class="w-10 h-10" />
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-foreground text-sm">
                  {replyToProfile.displayName || replyToProfile.name || `${replyTo.pubkey.slice(0, 8)}...`}
                </span>
                <span class="text-muted-foreground text-xs">
                  @{replyToProfile.name || replyTo.pubkey.slice(0, 8)}
                </span>
              </div>
              <p class="text-muted-foreground text-sm line-clamp-3">
                {replyTo.content}
              </p>
            </div>
          </div>
        </div>
      {/if}
      <!-- Compose area -->
      <div class="relative mb-4 flex-1 flex flex-col overflow-hidden px-4">
        <div class="flex-1 overflow-hidden">
          <ContentComposer
            bind:value={content}
            bind:selectedMentions
            placeholder={replyTo ? 'Write your reply...' : quotedEvent ? 'Add your thoughts...' : "What's on your mind?"}
            autofocus={true}
            disabled={isPublishing}
            class="flex-1 overflow-hidden"
          >
            {#snippet relayButton()}
              <div class="relative">
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
                  disabled={isPublishing}
                  class="h-8 w-8"
                  title="Select relays"
                >
                  {#if selectedRelayUrls.length <= 2 && selectedRelayUrls.length > 0}
                    <div class="flex items-center -space-x-1">
                      {#each selectedRelayUrls as relayUrl}
                        {@const relay = allRelays.find(r => r.url === relayUrl)}
                        {@const relayInfo = relay ? useRelayInfoCached(relay.url) : null}
                        {#if relayInfo?.info?.icon}
                          <img src={relayInfo.info.icon} alt="" class="w-5 h-5 rounded border border-background" />
                        {:else}
                          <div class="w-5 h-5 rounded bg-muted flex items-center justify-center border border-background">
                            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                            </svg>
                          </div>
                        {/if}
                      {/each}
                    </div>
                  {:else}
                    <div class="relative">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                      </svg>
                      {#if selectedRelayUrls.length > 2}
                        <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                          {selectedRelayUrls.length}
                        </span>
                      {/if}
                    </div>
                  {/if}
                </Button>
                <!-- Relay Dropdown -->
                {#if isRelayDropdownOpen}
                  <div
                    use:portal
                    role="presentation"
                    onclick={handleRelayDropdownClickOutside}
                    onkeydown={(e) => e.key === 'Escape' && handleRelayDropdownClickOutside()}
                    class="fixed inset-0 bg-black/50 z-[1002] flex items-center justify-center transition-opacity"
                  >
                    <div
                      role="dialog"
                      tabindex="-1"
                      onclick={(e) => e.stopPropagation()}
                      onkeydown={(e) => e.stopPropagation()}
                      class="bg-popover border border-border rounded-lg shadow-xl w-80 max-h-[400px] overflow-y-auto"
                    >
                      <RelayPublishDropdownContent
                        {selectedRelayUrls}
                        bind:isProtected
                        onToggleRelay={toggleRelay}
                        onSelectOnly={selectOnlyRelay}
                      />
                    </div>
                  </div>
                {/if}
              </div>
            {/snippet}
          </ContentComposer>
        </div>
      </div>
      <!-- Quoted event (if quoting) -->
      {#if quotedEvent}
        <div class="px-4 py-3 mb-4 border-y border-border bg-muted/30 shrink-0">
          <div class="text-xs text-muted-foreground mb-2">Quoting</div>
          <div class="border border-border rounded-lg overflow-hidden bg-card">
            <NoteCard event={quotedEvent} showActions={false} />
          </div>
        </div>
      {/if}
      <!-- Footer hint -->
      <div class="px-4 py-3 border-t border-border shrink-0">
        <p class="text-xs text-muted-foreground">
          Press <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">Esc</kbd> to cancel,
          <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">‚åò</kbd> +
          <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">Enter</kbd> to post
        </p>
      </div>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="ContentComposer.svelte">
<script lang="ts">
  import { NDKBlossom } from '@nostr-dev-kit/blossom';
  import { createBlossomUpload } from '@nostr-dev-kit/svelte';
  import { ndk } from '$lib/ndk.svelte';
  import { Button } from '$lib/components/ui/button';
  import { toast } from '$lib/stores/toast.svelte';
  import UserSelector from '$lib/components/UserSelector.svelte';
  import MentionPicker from '$lib/components/MentionPicker.svelte';
  import type { Snippet } from 'svelte';
  interface Props {
    value?: string;
    placeholder?: string;
    autofocus?: boolean;
    disabled?: boolean;
    class?: string;
    relayButton?: Snippet;
    selectedMentions?: string[];
    onMentionsChange?: (mentions: string[]) => void;
  }
  let {
    value = $bindable(''),
    placeholder = "What's on your mind?",
    autofocus = false,
    disabled = false,
    class: className = '',
    relayButton,
    selectedMentions = $bindable([]),
    onMentionsChange
  }: Props = $props();
  const blossom = new NDKBlossom(ndk);
  const upload = createBlossomUpload(blossom);
  let textareaElement: HTMLTextAreaElement;
  let fileInput: HTMLInputElement;
  let isDragging = $state(false);
  let uploadedImages = $state<Array<{ url: string; preview: string }>>([]);
  let isUploading = $state(false);
  // Mention picker state
  let showMentionPicker = $state(false);
  let mentionSearchQuery = $state('');
  let mentionStartIndex = $state(0);
  let mentionPickerPosition = $state({ top: 0, left: 0 });
  async function handleFileSelect(file: File) {
    if (!file.type.startsWith('image/')) {
      toast.error('Please select an image file');
      return;
    }
    // Create preview URL
    const previewUrl = URL.createObjectURL(file);
    // Add to images array with preview
    const imageIndex = uploadedImages.length;
    uploadedImages = [...uploadedImages, { url: '', preview: previewUrl }];
    isUploading = true;
    try {
      await upload.upload(file, {
        fallbackServer: 'https://blossom.primal.net'
      });
      if (upload.result?.url) {
        // Update the image with the actual URL
        uploadedImages[imageIndex] = {
          url: upload.result.url,
          preview: previewUrl
        };
        // Add image URL to content at cursor position
        insertImageUrl(upload.result.url);
        toast.success('Image uploaded');
      }
    } catch (error) {
      console.error('Upload failed:', error);
      toast.error('Failed to upload image');
      // Remove the failed upload
      uploadedImages = uploadedImages.filter((_, i) => i !== imageIndex);
    } finally {
      isUploading = false;
    }
  }
  function insertImageUrl(url: string) {
    const textarea = textareaElement;
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const imageMarkdown = `\n${url}\n`;
    value = value.slice(0, start) + imageMarkdown + value.slice(end);
    // Set cursor position after the inserted URL
    setTimeout(() => {
      textarea.selectionStart = textarea.selectionEnd = start + imageMarkdown.length;
      textarea.focus();
    }, 0);
  }
  function removeImage(index: number) {
    const image = uploadedImages[index];
    // Remove the URL from the content
    if (image.url) {
      value = value.replace(`\n${image.url}\n`, '').replace(image.url, '');
    }
    // Revoke the preview URL to free memory
    URL.revokeObjectURL(image.preview);
    // Remove from array
    uploadedImages = uploadedImages.filter((_, i) => i !== index);
  }
  function handleFileInputChange(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];
    if (file) {
      handleFileSelect(file);
    }
    // Reset input so the same file can be selected again
    input.value = '';
  }
  function handleDragOver(event: DragEvent) {
    event.preventDefault();
    isDragging = true;
  }
  function handleDragLeave(event: DragEvent) {
    event.preventDefault();
    isDragging = false;
  }
  async function handleDrop(event: DragEvent) {
    event.preventDefault();
    isDragging = false;
    const files = event.dataTransfer?.files;
    if (files && files.length > 0) {
      // Handle multiple files
      for (const file of Array.from(files)) {
        if (file.type.startsWith('image/')) {
          await handleFileSelect(file);
        }
      }
    }
  }
  async function handlePaste(event: ClipboardEvent) {
    const items = event.clipboardData?.items;
    if (!items) return;
    for (const item of Array.from(items)) {
      if (item.type.startsWith('image/')) {
        event.preventDefault();
        const file = item.getAsFile();
        if (file) {
          await handleFileSelect(file);
        }
      }
    }
  }
  function triggerFileInput() {
    fileInput?.click();
  }
  function getCaretCoordinates() {
    if (!textareaElement) return { top: 0, left: 0 };
    const textarea = textareaElement;
    const cursorPosition = textarea.selectionStart;
    // Create a mirror div to calculate position
    const div = document.createElement('div');
    const styles = window.getComputedStyle(textarea);
    const properties = [
      'boxSizing', 'width', 'height', 'overflowX', 'overflowY',
      'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth',
      'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
      'fontStyle', 'fontVariant', 'fontWeight', 'fontStretch', 'fontSize',
      'lineHeight', 'fontFamily', 'textAlign', 'textTransform', 'textIndent',
      'textDecoration', 'letterSpacing', 'wordSpacing'
    ];
    properties.forEach(prop => {
      div.style[prop as any] = styles[prop as any];
    });
    div.style.position = 'absolute';
    div.style.visibility = 'hidden';
    div.style.whiteSpace = 'pre-wrap';
    div.style.wordWrap = 'break-word';
    document.body.appendChild(div);
    const textBeforeCursor = textarea.value.substring(0, cursorPosition);
    div.textContent = textBeforeCursor;
    const span = document.createElement('span');
    span.textContent = textarea.value.substring(cursorPosition) || '.';
    div.appendChild(span);
    const rect = textarea.getBoundingClientRect();
    const coordinates = {
      top: rect.top + span.offsetTop + parseInt(styles.borderTopWidth) - textarea.scrollTop + 20,
      left: rect.left + span.offsetLeft + parseInt(styles.borderLeftWidth)
    };
    document.body.removeChild(div);
    return coordinates;
  }
  function handleInput(event: Event) {
    const textarea = event.target as HTMLTextAreaElement;
    const cursorPosition = textarea.selectionStart;
    const textBeforeCursor = textarea.value.substring(0, cursorPosition);
    // Find the last @ before cursor
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    if (lastAtIndex !== -1) {
      // Check if there's a space between @ and cursor
      const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
      // Only show picker if:
      // 1. @ is at start or preceded by whitespace/newline
      // 2. No spaces after @ (still typing the mention)
      const charBeforeAt = lastAtIndex > 0 ? textBeforeCursor[lastAtIndex - 1] : ' ';
      const hasSpaceAfterAt = textAfterAt.includes(' ') || textAfterAt.includes('\n');
      if ((charBeforeAt === ' ' || charBeforeAt === '\n' || lastAtIndex === 0) && !hasSpaceAfterAt) {
        mentionStartIndex = lastAtIndex;
        mentionSearchQuery = textAfterAt;
        mentionPickerPosition = getCaretCoordinates();
        showMentionPicker = true;
        return;
      }
    }
    // Close picker if no valid @ found
    showMentionPicker = false;
  }
  function insertMention(nprofile: string) {
    const textarea = textareaElement;
    if (!textarea) return;
    const cursorPosition = textarea.selectionStart;
    // Replace from @ to cursor with the nprofile
    const beforeMention = value.substring(0, mentionStartIndex);
    const afterMention = value.substring(cursorPosition);
    value = beforeMention + nprofile + ' ' + afterMention;
    // Set cursor position after the mention
    const newCursorPos = mentionStartIndex + nprofile.length + 1;
    setTimeout(() => {
      textarea.selectionStart = textarea.selectionEnd = newCursorPos;
      textarea.focus();
    }, 0);
    showMentionPicker = false;
    mentionSearchQuery = '';
  }
  function closeMentionPicker() {
    showMentionPicker = false;
    mentionSearchQuery = '';
  }
  function handleKeyDown(event: KeyboardEvent) {
    // Stop Enter key from bubbling up to prevent triggering actions on NoteCards
    if (event.key === 'Enter') {
      event.stopPropagation();
    }
  }
</script>
<div class="relative flex-1 flex flex-col {className}">
  <input
    bind:this={fileInput}
    type="file"
    accept="image/*"
    multiple
    onchange={handleFileInputChange}
    class="hidden"
  />
  <div
    class="flex-1 flex flex-col {isDragging ? 'ring-2 ring-primary ring-offset-2 rounded-lg' : ''}"
    ondragover={handleDragOver}
    ondragleave={handleDragLeave}
    ondrop={handleDrop}
  >
    <textarea
      bind:this={textareaElement}
      bind:value={value}
      {placeholder}
      {autofocus}
      {disabled}
      oninput={handleInput}
      onpaste={handlePaste}
      onkeydown={handleKeyDown}
      class="w-full min-h-[120px] max-md:flex-1 max-md:min-h-0 bg-transparent text-foreground placeholder-neutral-500 resize-none focus:outline-none focus:ring-0 text-lg"
    ></textarea>
    <!-- Image previews -->
    {#if uploadedImages.length > 0}
      <div class="flex flex-wrap gap-2 mt-2">
        {#each uploadedImages as image, index (image.preview)}
          <div class="relative group">
            <img
              src={image.preview}
              alt="Upload preview"
              class="w-20 h-20 object-cover rounded-lg border border {image.url ? '' : 'opacity-50 animate-pulse'}"
            />
            {#if !image.url}
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              </div>
            {:else}
              <button
                type="button"
                onclick={() => removeImage(index)}
                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
                aria-label="Remove image"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
  </div>
  <!-- Toolbar -->
  <div class="flex items-center gap-2 mt-2 pt-2 border-t border-border">
    {#if relayButton}
      {@render relayButton()}
    {/if}
    <Button
      type="button"
      variant="ghost"
      size="icon"
      onclick={triggerFileInput}
      disabled={disabled || isUploading}
      class="h-8 w-8"
      title="Add image"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </Button>
    <UserSelector
      bind:selectedPubkeys={selectedMentions}
      onSelect={onMentionsChange}
      {disabled}
    />
  </div>
</div>
{#if showMentionPicker}
  <MentionPicker
    position={mentionPickerPosition}
    searchQuery={mentionSearchQuery}
    onSelect={insertMention}
    onClose={closeMentionPicker}
  />
{/if}
</file>

<file path="CreateFollowPackDialog.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKFollowPack, NDKKind } from '@nostr-dev-kit/ndk';
  import { portal } from '$lib/utils/portal.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import FollowPackMemberItem from './FollowPackMemberItem.svelte';
  import SelectedPackMemberItem from './SelectedPackMemberItem.svelte';
  interface Props {
    open?: boolean;
    onClose?: () => void;
    initialPubkey?: string;
    editingPack?: NDKEvent | null;
  }
  let { open = $bindable(false), onClose, initialPubkey, editingPack }: Props = $props();
  let activeTab = $state<'details' | 'members'>('details');
  let isPublishing = $state(false);
  // Form fields
  let title = $state('');
  let description = $state('');
  let imageUrl = $state('');
  let selectedPubkeys = $state<Set<string>>(new Set(initialPubkey ? [initialPubkey] : []));
  let memberSearchQuery = $state('');
  // Fetch current user's follows
  const contactListSubscription = ndk.$subscribe(
    () => ndk.$currentUser?.pubkey ? ({
      filters: [{ kinds: [3], authors: [ndk.$currentUser.pubkey], limit: 1 }],
      bufferMs: 100,
    }) : undefined
  );
  const userFollows = $derived.by(() => {
    const contactList = contactListSubscription.events[0];
    if (!contactList) return new Set<string>();
    return new Set(contactList.tags.filter(tag => tag[0] === 'p').map(tag => tag[1]));
  });
  let cachedFilteredProfiles = $state<Map<string, { name?: string; displayName?: string; nip05?: string }>>(new Map());
  const filteredFollows = $derived.by(() => {
    if (!memberSearchQuery) return Array.from(userFollows);
    const filtered = Array.from(cachedFilteredProfiles.entries())
      .filter(([pubkey]) => userFollows.has(pubkey))
      .map(([pubkey]) => pubkey);
    return filtered;
  });
  // Update cached profiles when search query changes
  $effect(() => {
    if (!memberSearchQuery.trim() || !ndk.cacheAdapter?.getProfiles) {
      cachedFilteredProfiles = new Map();
      return;
    }
    const search = memberSearchQuery.toLowerCase();
    ndk.cacheAdapter.getProfiles({
      fields: ['name', 'displayName', 'nip05'],
      contains: search
    }).then((profiles) => {
      cachedFilteredProfiles = profiles ?? new Map();
    }).catch(err => {
      console.error('Failed to search profiles:', err);
      cachedFilteredProfiles = new Map();
    });
  });
  function toggleMember(pubkey: string) {
    if (selectedPubkeys.has(pubkey)) {
      selectedPubkeys.delete(pubkey);
    } else {
      selectedPubkeys.add(pubkey);
    }
    selectedPubkeys = new Set(selectedPubkeys);
  }
  async function addByNpubOrNip05() {
    if (!memberSearchQuery.trim()) return;
    try {
      const input = memberSearchQuery.trim();
      // Try to fetch user - handles npub, nprofile, or hex pubkey
      let user = await ndk.fetchUser(input);
      // If that fails and input looks like NIP-05, try resolving it
      if (!user && input.includes('@')) {
        const profile = await ndk.fetchUser(input);
        user = profile;
      }
      if (user?.pubkey) {
        selectedPubkeys.add(user.pubkey);
        selectedPubkeys = new Set(selectedPubkeys);
        memberSearchQuery = '';
        toast.success('User added');
      } else {
        toast.error('User not found');
      }
    } catch (error) {
      console.error('Failed to fetch user:', error);
      toast.error('Failed to fetch user');
    }
  }
  async function publishFollowPack() {
    if (!title.trim() || isPublishing) {
      toast.error('Please provide a title');
      return;
    }
    if (selectedPubkeys.size === 0) {
      toast.error('Please add at least one member');
      return;
    }
    try {
      isPublishing = true;
      const pack = editingPack ? NDKFollowPack.from(editingPack) : new NDKFollowPack(ndk);
      pack.title = title.trim();
      pack.description = description.trim() || undefined;
      pack.image = imageUrl.trim() || undefined;
      pack.pubkeys = Array.from(selectedPubkeys);
      await pack.sign();
      await pack.publishReplaceable();
      if (pack.publishStatus === 'error') {
        const error = pack.publishError;
        const relayErrors = error?.relayErrors || {};
        const errorMessages = Object.entries(relayErrors)
          .map(([relay, err]) => `${relay}: ${err}`)
          .join('\n');
        toast.error(`Failed to publish:\n${errorMessages || 'Unknown error'}`);
        return;
      }
      toast.success(editingPack ? 'Follow pack updated' : 'Follow pack created');
      resetForm();
      open = false;
      onClose?.();
    } catch (error) {
      console.error('Failed to publish follow pack:', error);
      toast.error(`${editingPack ? 'Failed to update' : 'Failed to create'} follow pack: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      isPublishing = false;
    }
  }
  function resetForm() {
    title = '';
    description = '';
    imageUrl = '';
    selectedPubkeys = new Set(initialPubkey ? [initialPubkey] : []);
    memberSearchQuery = '';
    activeTab = 'details';
  }
  function handleClose() {
    if (!isPublishing) {
      resetForm();
      open = false;
      onClose?.();
    }
  }
  function handleBackdropClick(e: MouseEvent) {
    if (e.target === e.currentTarget) {
      handleClose();
    }
  }
  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape' && !isPublishing) {
      handleClose();
    }
  }
  // Load editing pack data when modal opens in edit mode
  $effect(() => {
    if (open && editingPack) {
      title = editingPack.tagValue('title') || '';
      description = editingPack.tagValue('description') || '';
      imageUrl = editingPack.tagValue('image') || '';
      const pubkeys = editingPack.tags.filter(t => t[0] === 'p').map(t => t[1]);
      selectedPubkeys = new Set(pubkeys);
      activeTab = 'details';
    } else if (open && initialPubkey) {
      selectedPubkeys = new Set([initialPubkey]);
    }
  });
</script>
<svelte:window onkeydown={handleKeydown} />
{#if open}
  <div
    use:portal
    class="fixed inset-0 z-50 flex items-start justify-center bg-background/80 backdrop-blur-sm overflow-y-auto py-8"
    onclick={handleBackdropClick}
    role="presentation"
  >
    <div
      class="w-full max-w-3xl mx-4 bg-card rounded-2xl border border-border shadow-2xl my-auto"
      onclick={(e) => e.stopPropagation()}
      role="dialog"
      aria-modal="true"
    >
      <!-- Header -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-border">
        <div class="flex items-center gap-3">
          <button
            onclick={handleClose}
            disabled={isPublishing}
            class="text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50"
            aria-label="Close"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <h2 class="text-xl font-bold text-foreground flex items-center gap-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            {editingPack ? 'Edit Follow Pack' : 'Create Follow Pack'}
          </h2>
        </div>
        <button
          onclick={publishFollowPack}
          disabled={!title.trim() || selectedPubkeys.size === 0 || isPublishing}
          class="px-5 py-2.5 bg-primary hover:bg-accent-dark disabled:bg-muted disabled:cursor-not-allowed text-foreground rounded-lg transition-colors font-semibold text-sm"
        >
          {isPublishing ? (editingPack ? 'Updating...' : 'Creating...') : (editingPack ? 'Update Pack' : 'Create Pack')}
        </button>
      </div>
      <!-- Tabs -->
      <div class="flex border-b border-border">
        <button
          onclick={() => activeTab = 'details'}
          class={`flex-1 px-6 py-3 font-medium transition-colors ${
            activeTab === 'details'
              ? 'text-primary border-b-2 border-primary'
              : 'text-muted-foreground hover:text-muted-foreground'
          }`}
        >
          Details
        </button>
        <button
          onclick={() => activeTab = 'members'}
          class={`flex-1 px-6 py-3 font-medium transition-colors ${
            activeTab === 'members'
              ? 'text-primary border-b-2 border-primary'
              : 'text-muted-foreground hover:text-muted-foreground'
          }`}
        >
          Members ({selectedPubkeys.size})
        </button>
      </div>
      <!-- Tab Content -->
      <div class="p-6">
        {#if activeTab === 'details'}
          <div class="space-y-5">
            <!-- Image URL -->
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">
                Cover Image URL (optional)
              </label>
              <input
                type="url"
                bind:value={imageUrl}
                placeholder="https://example.com/image.jpg"
                class="w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary transition-colors"
              />
              {#if imageUrl.trim()}
                <div class="mt-3 rounded-lg overflow-hidden border border-border">
                  <img
                    src={imageUrl}
                    alt="Preview"
                    class="w-full h-48 object-cover"
                    onerror={(e) => e.currentTarget.style.display = 'none'}
                  />
                </div>
              {/if}
            </div>
            <!-- Title -->
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">
                Title <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                bind:value={title}
                placeholder="e.g., Bitcoin Developers"
                class="w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary transition-colors"
                maxlength="100"
              />
            </div>
            <!-- Description -->
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">
                Description (optional)
              </label>
              <textarea
                bind:value={description}
                placeholder="Describe what this follow pack is about..."
                class="w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary transition-colors resize-none"
                rows="4"
                maxlength="500"
              ></textarea>
              <p class="text-xs text-muted-foreground mt-1">
                {description.length}/500 characters
              </p>
            </div>
          </div>
        {:else}
          <div class="space-y-4">
            <!-- Combined Search/Add Input -->
            <div>
              <label class="block text-sm font-medium text-muted-foreground mb-2">
                Add members
              </label>
              <div class="relative">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  bind:value={memberSearchQuery}
                  placeholder="Search follows or enter npub/NIP-05..."
                  class="w-full pl-10 pr-20 py-3 bg-muted border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary transition-colors"
                  onkeydown={(e) => {
                    if (e.key === 'Enter' && memberSearchQuery.trim()) {
                      addByNpubOrNip05();
                    }
                  }}
                />
                {#if memberSearchQuery.trim() && (memberSearchQuery.includes('npub1') || memberSearchQuery.includes('@'))}
                  <button
                    onclick={addByNpubOrNip05}
                    class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-primary hover:bg-accent-dark text-foreground rounded text-sm font-medium transition-colors"
                  >
                    Add
                  </button>
                {/if}
              </div>
              <p class="text-xs text-muted-foreground mt-1.5">
                Search your follows by name, or paste an npub/NIP-05 to add anyone
              </p>
            </div>
            <!-- Members list -->
            <div>
              <!-- Members list -->
              <div class="max-h-96 overflow-y-auto space-y-2 bg-muted/30 rounded-lg p-2 border border-border">
                {#if filteredFollows.length === 0}
                  <div class="text-center py-8 text-muted-foreground text-sm">
                    {memberSearchQuery ? 'No matches found' : 'You don\'t follow anyone yet'}
                  </div>
                {:else}
                  {#each filteredFollows as pubkey (pubkey)}
                    <FollowPackMemberItem {pubkey} isSelected={selectedPubkeys.has(pubkey)} onToggle={toggleMember} />
                  {/each}
                {/if}
              </div>
            </div>
            <!-- Selected Members Display -->
            {#if selectedPubkeys.size > 0}
              <div class="bg-muted/50 rounded-lg p-4 border border-border">
                <div class="text-sm font-medium text-muted-foreground mb-3">
                  Selected Members ({selectedPubkeys.size})
                </div>
                <div class="space-y-2 max-h-48 overflow-y-auto">
                  {#each Array.from(selectedPubkeys) as pubkey (pubkey)}
                    <SelectedPackMemberItem {pubkey} onRemove={toggleMember} />
                  {/each}
                </div>
              </div>
            {/if}
          </div>
        {/if}
      </div>
      <!-- Footer hint -->
      <div class="px-6 py-4 border-t border-border bg-card/50">
        <p class="text-xs text-muted-foreground">
          Press <kbd class="px-1.5 py-0.5 bg-muted rounded text-muted-foreground">Esc</kbd> to cancel
        </p>
      </div>
    </div>
  </div>
{/if}
</file>

<file path="CreateListingModal.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKClassified, NDKKind } from '@nostr-dev-kit/ndk';
  import { toast } from '$lib/stores/toast.svelte';
  import { goto } from '$app/navigation';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  import { Textarea } from '$lib/components/ui/textarea';
  import { useImageUpload } from '$lib/composables/useImageUpload.svelte';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    open?: boolean;
    onClose?: () => void;
  }
  let { open = $bindable(false), onClose }: Props = $props();
  let isPublishing = $state(false);
  // Form fields
  let title = $state('');
  let summary = $state('');
  let content = $state('');
  let location = $state('');
  let priceAmount = $state('');
  let priceCurrency = $state('USD');
  let priceFrequency = $state<string | undefined>(undefined);
  let categories = $state<string[]>([]);
  let newCategory = $state('');
  // Image upload using blossom
  const imageUpload = useImageUpload(ndk, {
    fallbackServer: 'https://blossom.primal.net'
  });
  let fileInput: HTMLInputElement;
  const COMMON_CATEGORIES = [
    'electronics',
    'furniture',
    'clothing',
    'books',
    'services',
    'vehicles',
    'real-estate',
    'jobs',
    'free',
    'wanted'
  ];
  const CURRENCIES = ['USD', 'EUR', 'GBP', 'BTC', 'SATS'];
  function addCategory() {
    if (newCategory && !categories.includes(newCategory.toLowerCase())) {
      categories = [...categories, newCategory.toLowerCase()];
      newCategory = '';
    }
  }
  function removeCategory(category: string) {
    categories = categories.filter(c => c !== category);
  }
  async function publishListing() {
    if (!title.trim() || !content.trim() || isPublishing) {
      toast.error('Please provide a title and description');
      return;
    }
    if (!ndk.$currentUser) {
      toast.error('Please log in to create a listing');
      return;
    }
    try {
      isPublishing = true;
      const listing = new NDKClassified(ndk);
      listing.title = title.trim();
      listing.summary = summary.trim() || undefined;
      listing.content = content.trim();
      listing.location = location.trim() || undefined;
      listing.published_at = Math.floor(Date.now() / 1000);
      // Add status tag
      listing.tags.push(['status', 'active']);
      // Add price if provided
      if (priceAmount.trim()) {
        listing.price = {
          amount: parseFloat(priceAmount),
          currency: priceCurrency,
          frequency: priceFrequency && priceFrequency !== 'once' ? priceFrequency : undefined
        };
      }
      // Add categories as hashtags
      categories.forEach(category => {
        listing.tags.push(['t', category]);
      });
      // Add images from blossom uploads
      imageUpload.uploadedImages.forEach(image => {
        listing.tags.push(['image', image.url]);
      });
      await listing.sign();
      await listing.publish();
      if (listing.publishStatus === 'error') {
        const error = listing.publishError;
        const relayErrors = error?.relayErrors || {};
        const errorMessages = Object.entries(relayErrors)
          .map(([relay, err]) => `${relay}: ${err}`)
          .join('\n');
        toast.error(`Failed to publish:\n${errorMessages || 'Unknown error'}`);
        return;
      }
      toast.success('Listing created successfully');
      resetForm();
      open = false;
      onClose?.();
      // Navigate to marketplace
      goto('/marketplace');
    } catch (error) {
      console.error('Failed to publish listing:', error);
      toast.error(`Failed to create listing: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      isPublishing = false;
    }
  }
  function resetForm() {
    title = '';
    summary = '';
    content = '';
    location = '';
    priceAmount = '';
    priceCurrency = 'USD';
    priceFrequency = undefined;
    categories = [];
    newCategory = '';
    imageUpload.reset();
  }
  function handleClose() {
    if (!isPublishing) {
      resetForm();
      open = false;
      onClose?.();
    }
  }
  function handleBackdropClick(e: MouseEvent) {
    if (e.target === e.currentTarget) {
      handleClose();
    }
  }
  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape' && !isPublishing) {
      handleClose();
    }
  }
</script>
<svelte:window onkeydown={handleKeydown} />
{#if isDesktop.current}
  <Dialog.Root {open} onOpenChange={(newOpen) => {
      open = newOpen;
      if (!newOpen) handleClose();
    }}>
    <Dialog.Content class="max-w-4xl max-h-[90vh] overflow-y-auto">
      <Dialog.Header>
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <Dialog.Title>Create Listing</Dialog.Title>
        </div>
      </Dialog.Header>
      <div class="space-y-6">
          <!-- Basic Details -->
          <div class="space-y-5">
            <div>
              <Label for="title">
                Title <span class="text-red-500">*</span>
              </Label>
              <Input
                id="title"
                type="text"
                bind:value={title}
                placeholder="What are you listing?"
                maxlength={200}
                class="mt-2"
              />
            </div>
            <div>
              <Label for="summary">Summary</Label>
              <Input
                id="summary"
                type="text"
                bind:value={summary}
                placeholder="Brief description"
                maxlength={200}
                class="mt-2"
              />
            </div>
            <div>
              <Label for="content">
                Description <span class="text-red-500">*</span>
              </Label>
              <Textarea
                id="content"
                bind:value={content}
                placeholder="Detailed description (Markdown supported)"
                rows={6}
                class="mt-2 resize-none"
              />
            </div>
            <div>
              <Label for="location">Location</Label>
              <Input
                id="location"
                type="text"
                bind:value={location}
                placeholder="City, State or Country"
                class="mt-2"
              />
            </div>
          </div>
          <!-- Pricing -->
          <div class="bg-muted/30 rounded-lg p-5 border border-border">
            <h3 class="text-lg font-semibold text-foreground mb-4">Pricing</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <Label for="price-amount">Amount</Label>
                <Input
                  id="price-amount"
                  type="text"
                  bind:value={priceAmount}
                  placeholder="0.00"
                  class="mt-2"
                />
              </div>
              <div>
                <Label for="currency">Currency</Label>
                <select
                  id="currency"
                  bind:value={priceCurrency}
                  class="mt-2 w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground focus:outline-none focus:border-primary transition-colors"
                >
                  {#each CURRENCIES as currency}
                    <option value={currency}>{currency}</option>
                  {/each}
                </select>
              </div>
              <div>
                <Label for="frequency">Frequency</Label>
                <select
                  id="frequency"
                  bind:value={priceFrequency}
                  class="mt-2 w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground focus:outline-none focus:border-primary transition-colors"
                >
                  <option value={undefined}>One time</option>
                  <option value="hour">Per hour</option>
                  <option value="day">Per day</option>
                  <option value="week">Per week</option>
                  <option value="month">Per month</option>
                  <option value="year">Per year</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Categories -->
          <div class="bg-muted/30 rounded-lg p-5 border border-border">
            <h3 class="text-lg font-semibold text-foreground mb-4">Categories</h3>
            <div class="space-y-4">
              <div class="flex gap-2">
                <select
                  bind:value={newCategory}
                  class="flex-1 px-4 py-3 bg-muted border border-border rounded-lg text-foreground focus:outline-none focus:border-primary transition-colors"
                >
                  <option value="">Select a category</option>
                  {#each COMMON_CATEGORIES as cat}
                    <option value={cat}>{cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
                  {/each}
                </select>
                <Input
                  type="text"
                  bind:value={newCategory}
                  placeholder="Or type custom"
                  class="flex-1"
                  onkeydown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      addCategory();
                    }
                  }}
                />
                <Button
                  type="button"
                  onclick={addCategory}
                  size="icon"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </Button>
              </div>
              {#if categories.length > 0}
                <div class="flex flex-wrap gap-2">
                  {#each categories as category}
                    <div class="inline-flex items-center gap-1 px-3 py-1 bg-primary/20 text-primary rounded-full text-sm">
                      <span>{category}</span>
                      <button
                        type="button"
                        onclick={() => removeCategory(category)}
                        class="hover:text-primary"
                      >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  {/each}
                </div>
              {/if}
            </div>
          </div>
          <!-- Images -->
          <div class="bg-muted/30 rounded-lg p-5 border border-border">
            <h3 class="text-lg font-semibold text-foreground mb-4">Images</h3>
            <div class="space-y-4">
              <!-- File input -->
              <input
                bind:this={fileInput}
                type="file"
                accept="image/*"
                multiple
                onchange={imageUpload.handleFileInputChange}
                class="hidden"
              />
              <!-- Upload area -->
              <button
                type="button"
                onclick={() => fileInput?.click()}
                ondragover={imageUpload.handleDragOver}
                ondragleave={imageUpload.handleDragLeave}
                ondrop={imageUpload.handleDrop}
                disabled={imageUpload.uploadStatus === 'uploading'}
                class={`w-full h-32 rounded-lg border-2 border-dashed transition-colors flex flex-col items-center justify-center gap-2 ${imageUpload.isDragging ? 'border-primary bg-muted/40' : 'border-border hover:border-primary bg-muted/20 hover:bg-muted/40'}`}
              >
                {#if imageUpload.uploadStatus === 'uploading'}
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-sm text-muted-foreground">{imageUpload.uploadProgress?.percentage || 0}%</span>
                  </div>
                {:else}
                  <svg class="w-10 h-10 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm text-muted-foreground">Click to upload or drag and drop</span>
                  <span class="text-xs text-muted-foreground">Multiple images supported</span>
                {/if}
              </button>
              <!-- Uploaded images grid -->
              {#if imageUpload.uploadedImages.length > 0}
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {#each imageUpload.uploadedImages as image, index}
                    <div class="relative group">
                      <img
                        src={image.url}
                        alt={`Listing image ${index + 1}`}
                        class="w-full h-32 object-cover rounded-lg border border-border"
                      />
                      <button
                        type="button"
                        onclick={() => imageUpload.removeImage(index)}
                        class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  {/each}
                </div>
              {/if}
            </div>
          </div>
        </div>
      <Dialog.Footer class="flex gap-3 sm:space-x-0">
        <Button
          variant="outline"
          onclick={handleClose}
          disabled={isPublishing}
        >
          Cancel
        </Button>
        <Button
          onclick={publishListing}
          disabled={!title.trim() || !content.trim() || isPublishing}
        >
          {isPublishing ? 'Publishing...' : 'Publish Listing'}
        </Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root {open} onOpenChange={(newOpen) => {
      open = newOpen;
      if (!newOpen) handleClose();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <Drawer.Title>Create Listing</Drawer.Title>
        </div>
      </Drawer.Header>
      <div class="px-4 space-y-6 overflow-auto flex-1">
          <!-- Basic Details -->
          <div class="space-y-5">
            <div>
              <Label for="title">
                Title <span class="text-red-500">*</span>
              </Label>
              <Input
                id="title"
                type="text"
                bind:value={title}
                placeholder="What are you listing?"
                maxlength={200}
                class="mt-2"
              />
            </div>
            <div>
              <Label for="summary">Summary</Label>
              <Input
                id="summary"
                type="text"
                bind:value={summary}
                placeholder="Brief description"
                maxlength={200}
                class="mt-2"
              />
            </div>
            <div>
              <Label for="content">
                Description <span class="text-red-500">*</span>
              </Label>
              <Textarea
                id="content"
                bind:value={content}
                placeholder="Detailed description (Markdown supported)"
                rows={6}
                class="mt-2 resize-none"
              />
            </div>
            <div>
              <Label for="location">Location</Label>
              <Input
                id="location"
                type="text"
                bind:value={location}
                placeholder="City, State or Country"
                class="mt-2"
              />
            </div>
          </div>
          <!-- Pricing -->
          <div class="bg-muted/30 rounded-lg p-5 border border-border">
            <h3 class="text-lg font-semibold text-foreground mb-4">Pricing</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <Label for="price-amount">Amount</Label>
                <Input
                  id="price-amount"
                  type="text"
                  bind:value={priceAmount}
                  placeholder="0.00"
                  class="mt-2"
                />
              </div>
              <div>
                <Label for="currency">Currency</Label>
                <select
                  id="currency"
                  bind:value={priceCurrency}
                  class="mt-2 w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground focus:outline-none focus:border-primary transition-colors"
                >
                  {#each CURRENCIES as currency}
                    <option value={currency}>{currency}</option>
                  {/each}
                </select>
              </div>
              <div>
                <Label for="frequency">Frequency</Label>
                <select
                  id="frequency"
                  bind:value={priceFrequency}
                  class="mt-2 w-full px-4 py-3 bg-muted border border-border rounded-lg text-foreground focus:outline-none focus:border-primary transition-colors"
                >
                  <option value={undefined}>One time</option>
                  <option value="hour">Per hour</option>
                  <option value="day">Per day</option>
                  <option value="week">Per week</option>
                  <option value="month">Per month</option>
                  <option value="year">Per year</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Categories -->
          <div class="bg-muted/30 rounded-lg p-5 border border-border">
            <h3 class="text-lg font-semibold text-foreground mb-4">Categories</h3>
            <div class="space-y-4">
              <div class="flex gap-2">
                <select
                  bind:value={newCategory}
                  class="flex-1 px-4 py-3 bg-muted border border-border rounded-lg text-foreground focus:outline-none focus:border-primary transition-colors"
                >
                  <option value="">Select a category</option>
                  {#each COMMON_CATEGORIES as cat}
                    <option value={cat}>{cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
                  {/each}
                </select>
                <Input
                  type="text"
                  bind:value={newCategory}
                  placeholder="Or type custom"
                  class="flex-1"
                  onkeydown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      addCategory();
                    }
                  }}
                />
                <Button
                  type="button"
                  onclick={addCategory}
                  size="icon"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </Button>
              </div>
              {#if categories.length > 0}
                <div class="flex flex-wrap gap-2">
                  {#each categories as category}
                    <div class="inline-flex items-center gap-1 px-3 py-1 bg-primary/20 text-primary rounded-full text-sm">
                      <span>{category}</span>
                      <button
                        type="button"
                        onclick={() => removeCategory(category)}
                        class="hover:text-primary"
                      >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  {/each}
                </div>
              {/if}
            </div>
          </div>
          <!-- Images -->
          <div class="bg-muted/30 rounded-lg p-5 border border-border">
            <h3 class="text-lg font-semibold text-foreground mb-4">Images</h3>
            <div class="space-y-4">
              <!-- File input -->
              <input
                bind:this={fileInput}
                type="file"
                accept="image/*"
                multiple
                onchange={imageUpload.handleFileInputChange}
                class="hidden"
              />
              <!-- Upload area -->
              <button
                type="button"
                onclick={() => fileInput?.click()}
                ondragover={imageUpload.handleDragOver}
                ondragleave={imageUpload.handleDragLeave}
                ondrop={imageUpload.handleDrop}
                disabled={imageUpload.uploadStatus === 'uploading'}
                class={`w-full h-32 rounded-lg border-2 border-dashed transition-colors flex flex-col items-center justify-center gap-2 ${imageUpload.isDragging ? 'border-primary bg-muted/40' : 'border-border hover:border-primary bg-muted/20 hover:bg-muted/40'}`}
              >
                {#if imageUpload.uploadStatus === 'uploading'}
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-sm text-muted-foreground">{imageUpload.uploadProgress?.percentage || 0}%</span>
                  </div>
                {:else}
                  <svg class="w-10 h-10 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm text-muted-foreground">Click to upload or drag and drop</span>
                  <span class="text-xs text-muted-foreground">Multiple images supported</span>
                {/if}
              </button>
              <!-- Uploaded images grid -->
              {#if imageUpload.uploadedImages.length > 0}
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {#each imageUpload.uploadedImages as image, index}
                    <div class="relative group">
                      <img
                        src={image.url}
                        alt={`Listing image ${index + 1}`}
                        class="w-full h-32 object-cover rounded-lg border border-border"
                      />
                      <button
                        type="button"
                        onclick={() => imageUpload.removeImage(index)}
                        class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  {/each}
                </div>
              {/if}
            </div>
          </div>
        </div>
      <Drawer.Footer class="pt-2">
        <Button
          onclick={publishListing}
          disabled={!title.trim() || !content.trim() || isPublishing}
          class="w-full"
        >
          {isPublishing ? 'Publishing...' : 'Publish Listing'}
        </Button>
        <Button
          variant="outline"
          onclick={handleClose}
          disabled={isPublishing}
          class="w-full"
        >
          Cancel
        </Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="CreateMediaPostModal.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKEvent, NDKRelaySet } from '@nostr-dev-kit/ndk';
  import { NDKBlossom } from '@nostr-dev-kit/blossom';
  import { createBlossomUpload } from '@nostr-dev-kit/svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Textarea } from '$lib/components/ui/textarea';
  import { Label } from '$lib/components/ui/label';
  import UserSelector from '$lib/components/UserSelector.svelte';
  import HashtagSelector from '$lib/components/HashtagSelector.svelte';
  import RelayPublishDropdownContent from '$lib/components/RelayPublishDropdownContent.svelte';
  import { browser } from '$app/environment';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { clickOutside } from '$lib/utils/clickOutside';
  import { portal } from '$lib/utils/portal.svelte';
  import { encodeGeohash } from '$lib/utils/geohash';
  import { useModalRelaySelection } from '$lib/composables/useModalRelaySelection.svelte';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    open?: boolean;
    onClose?: () => void;
  }
  let { open = $bindable(false), onClose }: Props = $props();
  let isPublishing = $state(false);
  let currentImageIndex = $state(0);
  let isRelayDropdownOpen = $state(false);
  let isHashtagSelectorOpen = $state(false);
  let showProtectedInfo = $state(false);
  let isUserSelectorOpen = $state(false);
  // Form fields
  let content = $state('');
  let location = $state('');
  let tags = $state<string[]>([]);
  let mentions = $state<string[]>([]);
  let isNsfw = $state(false);
  // Upload state
  let uploadedImages = $state<Array<{
    url: string;
    mimeType: string;
    hash: string;
    blurhash?: string;
    dimensions?: { width: number; height: number };
  }>>([]);
  let fileInput: HTMLInputElement;
  let isDragging = $state(false);
  let isProtected = $state(false);
  const blossom = new NDKBlossom(ndk);
  const upload = createBlossomUpload(blossom);
  const isMobile = $derived(browser && window.innerWidth < 768);
  const relaySelection = useModalRelaySelection(() => open);
  const { selectedRelayUrls, allRelays } = $derived(relaySelection);
  // Auto-open file picker on mobile when modal opens
  $effect(() => {
    if (open && isMobile && uploadedImages.length === 0) {
      setTimeout(() => {
        fileInput?.click();
      }, 300);
    }
  });
  async function handleFileSelect(file: File) {
    if (!file.type.startsWith('image/')) {
      toast.error('Please select an image file');
      return;
    }
    try {
      await upload.upload(file, {
        fallbackServer: 'https://blossom.primal.net'
      });
      if (upload.result?.url) {
        // Get image dimensions
        const img = new Image();
        const dimensions = await new Promise<{ width: number; height: number }>((resolve) => {
          img.onload = () => resolve({ width: img.width, height: img.height });
          img.src = URL.createObjectURL(file);
        });
        uploadedImages = [...uploadedImages, {
          url: upload.result.url,
          mimeType: file.type,
          hash: upload.result.sha256 || '',
          blurhash: upload.result.blurhash,
          dimensions
        }];
        currentImageIndex = uploadedImages.length - 1;
      }
    } catch (error) {
      console.error('Upload failed:', error);
      toast.error('Failed to upload image');
    }
  }
  function handleFileInputChange(event: Event) {
    const input = event.target as HTMLInputElement;
    const files = input.files;
    if (files) {
      // Handle multiple files
      Array.from(files).forEach(file => handleFileSelect(file));
    }
  }
  function handleDragOver(event: DragEvent) {
    event.preventDefault();
    isDragging = true;
  }
  function handleDragLeave() {
    isDragging = false;
  }
  async function handleDrop(event: DragEvent) {
    event.preventDefault();
    isDragging = false;
    const files = event.dataTransfer?.files;
    if (files) {
      Array.from(files).forEach(file => handleFileSelect(file));
    }
  }
  function triggerFileInput() {
    fileInput?.click();
  }
  function removeImage(index: number) {
    uploadedImages = uploadedImages.filter((_, i) => i !== index);
    if (currentImageIndex >= uploadedImages.length) {
      currentImageIndex = Math.max(0, uploadedImages.length - 1);
    }
  }
  function removeTag(tag: string) {
    tags = tags.filter(t => t !== tag);
  }
  function handleTagsChange(newTags: string[]) {
    tags = newTags;
  }
  function toggleRelay(url: string) {
    if (relaySelection.selectedRelayUrls.includes(url)) {
      relaySelection.selectedRelayUrls = relaySelection.selectedRelayUrls.filter(u => u !== url);
    } else {
      relaySelection.selectedRelayUrls = [...relaySelection.selectedRelayUrls, url];
    }
  }
  function selectOnlyRelay(url: string) {
    relaySelection.selectedRelayUrls = [url];
    isRelayDropdownOpen = false;
  }
  function handleRelayDropdownClickOutside() {
    isRelayDropdownOpen = false;
  }
  function handleLocationRequest() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const gh = encodeGeohash(lat, lon, 5);
          location = `Near ${gh}`;
          toast.success('Location detected');
        },
        (error) => {
          console.error('Error getting location:', error);
          toast.error('Could not get your location');
        }
      );
    } else {
      toast.error('Geolocation is not supported');
    }
  }
  async function publishMediaPost() {
    if (!content.trim() || uploadedImages.length === 0 || isPublishing) {
      if (uploadedImages.length === 0) {
        toast.error('Please add at least one image');
      } else {
        toast.error('Please add a caption');
      }
      return;
    }
    if (!ndk.$currentUser) {
      toast.error('Please log in to create a media post');
      return;
    }
    if (selectedRelayUrls.length === 0) {
      toast.error('Please select at least one relay to publish to');
      return;
    }
    try {
      isPublishing = true;
      const event = new NDKEvent(ndk);
      event.kind = 20;
      event.content = content.trim();
      event.isProtected = isProtected;
      // Add imeta tags for each image
      uploadedImages.forEach(img => {
        const imetaTag = ['imeta', `url ${img.url}`, `m ${img.mimeType}`];
        if (img.hash) imetaTag.push(`x ${img.hash}`);
        if (img.blurhash) imetaTag.push(`blurhash ${img.blurhash}`);
        if (img.dimensions) imetaTag.push(`dim ${img.dimensions.width}x${img.dimensions.height}`);
        event.tags.push(imetaTag);
      });
      // Add hashtags
      tags.forEach(tag => {
        event.tags.push(['t', tag]);
      });
      // Add mentions
      mentions.forEach(mention => {
        event.tags.push(['p', mention]);
      });
      // Add location with geohash
      if (location.trim()) {
        if (location.startsWith('Near ')) {
          const geohash = location.replace('Near ', '');
          // Add multiple precision levels
          for (let i = 3; i <= geohash.length; i++) {
            event.tags.push(['g', geohash.substring(0, i)]);
          }
        } else {
          event.tags.push(['location', location.trim()]);
        }
      }
      // Add content warning if NSFW
      if (isNsfw) {
        event.tags.push(['content-warning', 'nsfw']);
      }
      await event.sign();
      const relaySet = NDKRelaySet.fromRelayUrls(selectedRelayUrls, ndk);
      await event.publish(relaySet);
      if (event.publishStatus === 'error') {
        const error = event.publishError;
        const relayErrors = error?.relayErrors || {};
        const errorMessages = Object.entries(relayErrors)
          .map(([relay, err]) => `${relay}: ${err}`)
          .join('\n');
        toast.error(`Failed to publish:\n${errorMessages || 'Unknown error'}`);
        return;
      }
      toast.success('Posted!');
      resetForm();
      open = false;
      onClose?.();
    } catch (error) {
      console.error('Failed to publish media post:', error);
      toast.error(`Failed to publish: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      isPublishing = false;
    }
  }
  function resetForm() {
    content = '';
    location = '';
    tags = [];
    mentions = [];
    uploadedImages = [];
    currentImageIndex = 0;
    isNsfw = false;
    isRelayDropdownOpen = false;
    isHashtagSelectorOpen = false;
    isUserSelectorOpen = false;
  }
  function handleClose() {
    if (!isPublishing) {
      resetForm();
      open = false;
      onClose?.();
    }
  }
  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape' && !isPublishing) {
      handleClose();
    }
  }
</script>
<svelte:window onkeydown={handleKeydown} />
{#if isDesktop.current}
  <Dialog.Root {open} onOpenChange={(newOpen) => {
      open = newOpen;
      if (!newOpen) handleClose();
    }}>
    <Dialog.Content class="max-md:!max-w-none max-md:!w-full max-md:!h-[100vh] max-md:!m-0 max-md:!rounded-none max-w-6xl max-h-[90vh] overflow-hidden flex flex-col p-0">
      <!-- Header -->
      <div class="flex items-center justify-between px-4 md:px-6 py-3 md:py-4 border-b border-border bg-background">
        <button
          onclick={handleClose}
          disabled={isPublishing}
          title="Close and discard post"
          class="text-foreground hover:text-muted-foreground transition-colors"
          aria-label="Close"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <Dialog.Title class="text-lg md:text-xl font-semibold">New Post</Dialog.Title>
        <Button
          onclick={publishMediaPost}
          disabled={!content.trim() || uploadedImages.length === 0 || isPublishing || selectedRelayUrls.length === 0}
          size="sm"
          class="h-9 px-4"
        >
          {isPublishing ? 'Posting...' : 'Post'}
        </Button>
      </div>
      <!-- Content -->
      <div class="flex-1 overflow-auto">
        <input
          bind:this={fileInput}
          type="file"
          accept="image/*"
          multiple
          onchange={handleFileInputChange}
          class="hidden"
        />
        {#if uploadedImages.length > 0}
          <!-- Mobile: Image-first layout -->
          <div class="md:grid md:grid-cols-[2fr,3fr] md:h-full">
            <!-- Images Section -->
            <div class="md:border-r border-border md:p-6 p-0">
              <!-- Main Image Preview -->
              <div class="relative w-full md:aspect-square md:rounded-lg overflow-hidden bg-black">
                <img
                  src={uploadedImages[currentImageIndex].url}
                  alt={`Image ${currentImageIndex + 1}`}
                  class="w-full h-full object-contain"
                />
                <button
                  onclick={() => removeImage(currentImageIndex)}
                  title="Remove this image"
                  class="absolute top-2 right-2 p-2 bg-black/60 text-white rounded-full hover:bg-black/80 transition-colors backdrop-blur-sm"
                  aria-label="Remove image"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                {#if uploadedImages.length > 1}
                  <div class="absolute bottom-3 left-0 right-0 flex justify-center gap-1">
                    {#each uploadedImages as _, index}
                      <button
                        onclick={() => currentImageIndex = index}
                        title="View image {index + 1}"
                        class="w-2 h-2 rounded-full transition-all {currentImageIndex === index ? 'bg-white w-6' : 'bg-white/50'}"
                        aria-label="View image {index + 1}"
                      ></button>
                    {/each}
                  </div>
                {/if}
              </div>
              <!-- Thumbnail Navigation (desktop only) -->
              <div class="hidden md:flex items-center gap-2 overflow-x-auto pb-2 mt-4">
                {#each uploadedImages as img, index}
                  <button
                    onclick={() => currentImageIndex = index}
                    title="View image {index + 1}"
                    class="w-16 h-16 rounded border-2 transition-all flex-shrink-0 {currentImageIndex === index ? 'border-primary' : 'border-border'}"
                    aria-label="View image {index + 1}"
                  >
                    <img src={img.url} alt="" class="w-full h-full object-cover rounded" />
                  </button>
                {/each}
                <button
                  onclick={triggerFileInput}
                  title="Add more images"
                  class="w-16 h-16 rounded border-2 border-dashed border-border hover:border-primary hover:bg-muted transition-all flex items-center justify-center flex-shrink-0"
                  aria-label="Add more images"
                >
                  <svg class="w-6 h-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </div>
            </div>
            <!-- Caption & Options Section -->
            <div class="p-4 md:p-6 space-y-4 md:overflow-auto">
              <!-- Caption -->
              <Textarea
                bind:value={content}
                placeholder="Write a caption..."
                rows={4}
                autofocus={!isMobile}
                class="resize-none border-0 focus-visible:ring-0 px-3 text-base placeholder:text-muted-foreground"
              />
              <!-- Action buttons -->
              <div class="flex items-center gap-1 border-t border-border pt-3">
                <!-- Add more images -->
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={triggerFileInput}
                  disabled={isPublishing}
                  title="Add more images to your post"
                  class="h-8 w-8"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </Button>
                <!-- Hashtags -->
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={() => isHashtagSelectorOpen = true}
                  disabled={isPublishing}
                  title="Add hashtags to categorize your post and make it discoverable"
                  class="h-8 w-8 {tags.length > 0 ? 'text-primary' : ''}"
                >
                  <div class="relative">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    {#if tags.length > 0}
                      <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                        {tags.length}
                      </span>
                    {/if}
                  </div>
                </Button>
                <!-- Location -->
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={handleLocationRequest}
                  disabled={isPublishing}
                  title="Add location - uses your device's GPS to tag where this was posted"
                  class="h-8 w-8 {location ? 'text-primary' : ''}"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </Button>
                <!-- Mentions -->
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={() => isUserSelectorOpen = true}
                  disabled={isPublishing}
                  title="Tag people in this post - they'll be notified"
                  class="h-8 w-8 {mentions.length > 0 ? 'text-primary' : ''}"
                >
                  <div class="relative">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    {#if mentions.length > 0}
                      <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                        {mentions.length}
                      </span>
                    {/if}
                  </div>
                </Button>
                <!-- NSFW Toggle -->
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={() => isNsfw = !isNsfw}
                  disabled={isPublishing}
                  title="Mark as sensitive content (NSFW)"
                  class="h-8 w-8 {isNsfw ? 'text-primary' : ''}"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </Button>
                <!-- Relays -->
                <div class="relative">
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
                    disabled={isPublishing}
                    title="Choose which relays to publish this post to"
                    class="h-8 w-8"
                  >
                    {#if selectedRelayUrls.length <= 2 && selectedRelayUrls.length > 0}
                      <div class="flex items-center -space-x-1">
                        {#each selectedRelayUrls as relayUrl}
                          {@const relay = allRelays.find(r => r.url === relayUrl)}
                          {@const relayInfo = relay ? useRelayInfoCached(relay.url) : null}
                          {#if relayInfo?.info?.icon}
                            <img src={relayInfo.info.icon} alt="" class="w-5 h-5 rounded border border-background" />
                          {:else}
                            <div class="w-5 h-5 rounded bg-muted flex items-center justify-center border border-background">
                              <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                              </svg>
                            </div>
                          {/if}
                        {/each}
                      </div>
                    {:else}
                      <div class="relative">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                        </svg>
                        {#if selectedRelayUrls.length > 2}
                          <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                            {selectedRelayUrls.length}
                          </span>
                        {/if}
                      </div>
                    {/if}
                  </Button>
                </div>
              </div>
              <!-- Relay Dropdown with backdrop -->
              {#if isRelayDropdownOpen}
                <div
                  use:portal
                  role="presentation"
                  onclick={handleRelayDropdownClickOutside}
                  onkeydown={(e) => e.key === 'Escape' && handleRelayDropdownClickOutside()}
                  class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center transition-opacity {isRelayDropdownOpen ? 'opacity-100' : 'opacity-0'}"
                >
                  <div
                    role="dialog"
                    tabindex="-1"
                    onclick={(e) => e.stopPropagation()}
                    onkeydown={(e) => e.stopPropagation()}
                    class="bg-popover border border-border rounded-lg shadow-xl w-80 max-h-[400px] overflow-y-auto transition-all {isRelayDropdownOpen ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}"
                  >
                    <RelayPublishDropdownContent
                      {selectedRelayUrls}
                      bind:isProtected
                      onToggleRelay={toggleRelay}
                      onSelectOnly={selectOnlyRelay}
                    />
                </div>
              </div>
              {/if}
              <!-- Display sections for selected items -->
              {#if tags.length > 0}
                <div class="flex flex-wrap gap-2 items-center">
                  {#each tags as tag}
                    <button
                      onclick={() => removeTag(tag)}
                      class="inline-flex items-center gap-1 px-2.5 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors"
                    >
                      <span>#{tag}</span>
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  {/each}
                </div>
              {/if}
              {#if location}
                <div class="text-sm text-muted-foreground flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  <span>{location}</span>
                  <button onclick={() => location = ''} class="ml-1 hover:text-foreground transition-colors">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              {/if}
            </div>
          </div>
        {:else}
          <!-- Desktop: Show dropzone when no images -->
          <div class="hidden md:flex items-center justify-center p-12 h-full">
            <div
              role="button"
              tabindex="0"
              onclick={triggerFileInput}
              onkeydown={(e) => e.key === 'Enter' && triggerFileInput()}
              ondragover={handleDragOver}
              ondragleave={handleDragLeave}
              ondrop={handleDrop}
              class="w-full max-w-md aspect-square rounded-lg border-2 border-dashed border-border hover:border-primary hover:bg-muted/50 transition-all flex flex-col items-center justify-center cursor-pointer {isDragging ? 'border-primary bg-muted/50' : ''} {upload.status === 'uploading' ? 'pointer-events-none' : ''}"
            >
              {#if upload.status === 'uploading'}
                <div class="flex flex-col items-center gap-2">
                  <div class="w-12 h-12 border-4 border-border border-t-primary rounded-full animate-spin"></div>
                  {#if upload.progress}
                    <p class="text-sm text-muted-foreground">{upload.progress.percentage}%</p>
                  {/if}
                </div>
              {:else}
                <svg class="w-16 h-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-lg font-medium text-foreground mb-2">Drop images here</p>
                <p class="text-sm text-muted-foreground">or click to browse</p>
                <p class="text-xs text-muted-foreground mt-2">Multiple images supported</p>
              {/if}
            </div>
          </div>
          <!-- Mobile: Show loading or prompt to select from camera roll -->
          <div class="md:hidden flex items-center justify-center p-8 h-full min-h-[60vh]">
            <div class="text-center">
              {#if upload.status === 'uploading'}
                <div class="flex flex-col items-center gap-3">
                  <div class="w-12 h-12 border-4 border-border border-t-primary rounded-full animate-spin"></div>
                  <p class="text-sm text-muted-foreground">Uploading...</p>
                  {#if upload.progress}
                    <p class="text-xs text-muted-foreground">{upload.progress.percentage}%</p>
                  {/if}
                </div>
              {:else}
                <svg class="w-16 h-16 text-muted-foreground mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-muted-foreground mb-4">No images selected</p>
                <Button onclick={triggerFileInput}>
                  Choose Photos
                </Button>
              {/if}
            </div>
          </div>
        {/if}
      </div>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root {open} onOpenChange={(newOpen) => {
      open = newOpen;
      if (!newOpen) handleClose();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>New Post</Drawer.Title>
      </Drawer.Header>
      <div class="px-4 overflow-auto flex-1">
        <input
          bind:this={fileInput}
          type="file"
          accept="image/*"
          multiple
          onchange={handleFileInputChange}
          class="hidden"
        />
        {#if uploadedImages.length > 0}
          <div class="space-y-4">
            <!-- Main Image Preview -->
            <div class="relative w-full overflow-hidden bg-black">
              <img
                src={uploadedImages[currentImageIndex].url}
                alt={`Image ${currentImageIndex + 1}`}
                class="w-full h-full object-contain"
              />
              <button
                onclick={() => removeImage(currentImageIndex)}
                title="Remove this image"
                class="absolute top-2 right-2 p-2 bg-black/60 text-white rounded-full hover:bg-black/80 transition-colors backdrop-blur-sm"
                aria-label="Remove image"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              {#if uploadedImages.length > 1}
                <div class="absolute bottom-3 left-0 right-0 flex justify-center gap-1">
                  {#each uploadedImages as _, index}
                    <button
                      onclick={() => currentImageIndex = index}
                      title="View image {index + 1}"
                      class="w-2 h-2 rounded-full transition-all {currentImageIndex === index ? 'bg-white w-6' : 'bg-white/50'}"
                      aria-label="View image {index + 1}"
                    ></button>
                  {/each}
                </div>
              {/if}
            </div>
            <!-- Caption -->
            <Textarea
              bind:value={content}
              placeholder="Write a caption..."
              rows={4}
              autofocus={!isMobile}
              class="resize-none border-0 focus-visible:ring-0 px-3 text-base placeholder:text-muted-foreground"
            />
            <!-- Action buttons -->
            <div class="flex items-center gap-1 border-t border-border pt-3">
              <!-- Add more images -->
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onclick={triggerFileInput}
                disabled={isPublishing}
                title="Add more images to your post"
                class="h-8 w-8"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </Button>
              <!-- Hashtags -->
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onclick={() => isHashtagSelectorOpen = true}
                disabled={isPublishing}
                title="Add hashtags to categorize your post and make it discoverable"
                class="h-8 w-8 {tags.length > 0 ? 'text-primary' : ''}"
              >
                <div class="relative">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                  </svg>
                  {#if tags.length > 0}
                    <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                      {tags.length}
                    </span>
                  {/if}
                </div>
              </Button>
              <!-- Location -->
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onclick={handleLocationRequest}
                disabled={isPublishing}
                title="Add location - uses your device's GPS to tag where this was posted"
                class="h-8 w-8 {location ? 'text-primary' : ''}"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </Button>
              <!-- Mentions -->
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onclick={() => isUserSelectorOpen = true}
                disabled={isPublishing}
                title="Tag people in this post - they'll be notified"
                class="h-8 w-8 {mentions.length > 0 ? 'text-primary' : ''}"
              >
                <div class="relative">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  {#if mentions.length > 0}
                    <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                      {mentions.length}
                    </span>
                  {/if}
                </div>
              </Button>
              <!-- NSFW Toggle -->
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onclick={() => isNsfw = !isNsfw}
                disabled={isPublishing}
                title="Mark as sensitive content (NSFW)"
                class="h-8 w-8 {isNsfw ? 'text-primary' : ''}"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </Button>
              <!-- Relays -->
              <div class="relative">
                <Button
                  type="button"
                  variant="ghost"
                  size="icon"
                  onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
                  disabled={isPublishing}
                  title="Choose which relays to publish this post to"
                  class="h-8 w-8"
                >
                  {#if selectedRelayUrls.length <= 2 && selectedRelayUrls.length > 0}
                    <div class="flex items-center -space-x-1">
                      {#each selectedRelayUrls as relayUrl}
                        {@const relay = allRelays.find(r => r.url === relayUrl)}
                        {@const relayInfo = relay ? useRelayInfoCached(relay.url) : null}
                        {#if relayInfo?.info?.icon}
                          <img src={relayInfo.info.icon} alt="" class="w-5 h-5 rounded border border-background" />
                        {:else}
                          <div class="w-5 h-5 rounded bg-muted flex items-center justify-center border border-background">
                            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                            </svg>
                          </div>
                        {/if}
                      {/each}
                    </div>
                  {:else}
                    <div class="relative">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                      </svg>
                      {#if selectedRelayUrls.length > 2}
                        <span class="absolute -top-1 -right-1 bg-primary text-primary-foreground text-[10px] font-medium rounded-full min-w-[14px] h-[14px] flex items-center justify-center px-0.5">
                          {selectedRelayUrls.length}
                        </span>
                      {/if}
                    </div>
                  {/if}
                </Button>
              </div>
            </div>
            <!-- Relay Dropdown with backdrop -->
            {#if isRelayDropdownOpen}
              <div
                use:portal
                role="presentation"
                onclick={handleRelayDropdownClickOutside}
                onkeydown={(e) => e.key === 'Escape' && handleRelayDropdownClickOutside()}
                class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center transition-opacity {isRelayDropdownOpen ? 'opacity-100' : 'opacity-0'}"
              >
                <div
                  role="dialog"
                  tabindex="-1"
                  onclick={(e) => e.stopPropagation()}
                  onkeydown={(e) => e.stopPropagation()}
                  class="bg-popover border border-border rounded-lg shadow-xl w-80 max-h-[400px] overflow-y-auto transition-all {isRelayDropdownOpen ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}"
                >
                  <RelayPublishDropdownContent
                    {selectedRelayUrls}
                    bind:isProtected
                    onToggleRelay={toggleRelay}
                    onSelectOnly={selectOnlyRelay}
                  />
              </div>
            </div>
            {/if}
            <!-- Display sections for selected items -->
            {#if tags.length > 0}
              <div class="flex flex-wrap gap-2 items-center">
                {#each tags as tag}
                  <button
                    onclick={() => removeTag(tag)}
                    class="inline-flex items-center gap-1 px-2.5 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors"
                  >
                    <span>#{tag}</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                {/each}
              </div>
            {/if}
            {#if location}
              <div class="text-sm text-muted-foreground flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span>{location}</span>
                <button onclick={() => location = ''} class="ml-1 hover:text-foreground transition-colors">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            {/if}
          </div>
        {:else}
          <div class="flex items-center justify-center p-8 h-full min-h-[60vh]">
            <div class="text-center">
              {#if upload.status === 'uploading'}
                <div class="flex flex-col items-center gap-3">
                  <div class="w-12 h-12 border-4 border-border border-t-primary rounded-full animate-spin"></div>
                  <p class="text-sm text-muted-foreground">Uploading...</p>
                  {#if upload.progress}
                    <p class="text-xs text-muted-foreground">{upload.progress.percentage}%</p>
                  {/if}
                </div>
              {:else}
                <svg class="w-16 h-16 text-muted-foreground mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-muted-foreground mb-4">No images selected</p>
                <Button onclick={triggerFileInput}>
                  Choose Photos
                </Button>
              {/if}
            </div>
          </div>
        {/if}
      </div>
      <Drawer.Footer class="pt-2">
        <Button
          onclick={publishMediaPost}
          disabled={!content.trim() || uploadedImages.length === 0 || isPublishing || selectedRelayUrls.length === 0}
          class="w-full"
        >
          {isPublishing ? 'Posting...' : 'Post'}
        </Button>
        <Button
          variant="outline"
          onclick={handleClose}
          disabled={isPublishing}
          class="w-full"
        >
          Cancel
        </Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
<!-- Hashtag Selector Modal -->
<HashtagSelector
  bind:open={isHashtagSelectorOpen}
  selectedTags={tags}
  onTagsChange={handleTagsChange}
/>
<!-- User Selector Modal -->
<UserSelector
  bind:open={isUserSelectorOpen}
  bind:selectedPubkeys={mentions}
  buttonClass="hidden"
  iconOnly={false}
/>
</file>

<file path="EmbeddedNote.svelte">
<script lang="ts">
  import type { NDKEvent, NDKSvelte } from '@nostr-dev-kit/ndk';
  import { NDKKind, NDKArticle } from '@nostr-dev-kit/ndk';
  import NoteCard from './NoteCard.svelte';
  import ArticlePreviewCard from './ArticlePreviewCard.svelte';
  interface Props {
    ndk: NDKSvelte;
    bech32: string;
    onEventClick?: (bech32: string, event: NDKEvent) => void;
  }
  const { ndk, bech32, onEventClick }: Props = $props();
  let fetchedEvent = $state<NDKEvent | null>(null);
  let loading = $state(true);
  let error = $state<string | null>(null);
  $effect(() => {
    if (!bech32 || !ndk) return;
    loading = true;
    error = null;
    ndk.fetchEvent(bech32)
      .then((event) => {
        if (event) {
          fetchedEvent = event;
        } else {
          error = 'Event not found';
        }
        loading = false;
      })
      .catch((err) => {
        console.error('Failed to fetch event:', err);
        error = 'Failed to load event';
        loading = false;
      });
  });
  function handleNavigate() {
    if (onEventClick && fetchedEvent) {
      onEventClick(bech32, fetchedEvent);
    }
  }
  const isTextNote = $derived(
    fetchedEvent && (fetchedEvent.kind === NDKKind.Text || fetchedEvent.kind === NDKKind.GenericReply)
  );
  const isArticle = $derived(
    fetchedEvent && fetchedEvent.kind === NDKKind.Article
  );
</script>
{#if loading}
  <div class="flex items-center gap-2 p-4 border border-border rounded-lg bg-card/50 my-2">
    <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-muted-foreground border-r-transparent"></div>
    <span class="text-sm text-muted-foreground">Loading event...</span>
  </div>
{:else if error}
  <div class="flex items-center gap-2 p-4 border border-red-200 dark:border-red-900 rounded-lg bg-red-50 dark:bg-red-950/30 my-2">
    <span class="text-red-600 dark:text-red-400">‚ö†Ô∏è</span>
    <span class="text-sm text-red-600 dark:text-red-400">{error}</span>
  </div>
{:else if fetchedEvent}
  {#if isTextNote}
    <!-- Use NoteCard for text notes - it already has the compact mobile layout -->
    <div class="my-2 border border-border rounded-lg overflow-hidden bg-card">
      <NoteCard event={fetchedEvent} showActions={false} onNavigate={handleNavigate} />
    </div>
  {:else if isArticle}
    <!-- Use ArticlePreviewCard for articles (kind 30023) -->
    <div class="my-2">
      <ArticlePreviewCard article={NDKArticle.from(fetchedEvent)} variant="compact" />
    </div>
  {:else}
    <!-- For other event kinds, show a simple preview -->
    <div class="p-4 border border-border rounded-lg bg-card/50 my-2 cursor-pointer hover:bg-card/70 transition-colors" onclick={handleNavigate} role="button" tabindex="0">
      <div class="text-sm text-muted-foreground mb-1">Kind {fetchedEvent.kind} event</div>
      <div class="text-sm text-foreground line-clamp-3">{fetchedEvent.content.slice(0, 200)}{fetchedEvent.content.length > 200 ? '...' : ''}</div>
    </div>
  {/if}
{:else}
  <div class="flex items-center gap-2 p-4 border border-border rounded-lg bg-card/50 my-2">
    <span class="text-muted-foreground">‚ùå</span>
    <span class="text-sm text-muted-foreground">No event to display</span>
  </div>
{/if}
</file>

<file path="EventActions.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { clickOutside } from '$lib/utils/clickOutside';
  import ComposeDialog from './ComposeDialog.svelte';
  import ZapButton from './ZapButton.svelte';
  interface Props {
    event: NDKEvent;
    variant?: 'default' | 'thread-main' | 'tiktok';
  }
  const { event, variant = 'default' }: Props = $props();
  let showReplyDialog = $state(false);
  let showQuoteDialog = $state(false);
  let showRepostMenu = $state(false);
  const interactions = ndk.$subscribe(() => ({
    filters: [{
      kinds: [1, 1111, 6, 16, 7],
      ...event.filter()
    }],
    subId: 'interactions'
  }));
  const replyCount = $derived.by(() =>
    Array.from(interactions.events ?? []).filter(e => e.kind === 1 || e.kind === 1111).length
  );
  const repostCount = $derived.by(() =>
    Array.from(interactions.events ?? []).filter(e => e.kind === 6 || e.kind === 16).length
  );
  const reactionCount = $derived.by(() =>
    Array.from(interactions.events ?? []).filter(e => e.kind === 7).length
  );
  async function handleReact(emoji: string) {
    if (!ndk.signer) {
      toast.error('Please login to react');
      return;
    }
    try {
      await event.react(emoji);
      toast.success('Reaction added');
    } catch (err) {
      console.error('Failed to react:', err);
      toast.error('Failed to add reaction');
    }
  }
  async function handleRepost() {
    if (!ndk.signer) {
      toast.error('Please login to repost');
      return;
    }
    try {
      await event.repost();
      toast.success('Note reposted');
    } catch (err) {
      console.error('Failed to repost:', err);
      toast.error('Failed to repost');
    }
  }
</script>
{#if variant === 'tiktok'}
  <div class="flex flex-col items-center gap-6 text-white">
    <button
      type="button"
      onclick={(e) => { e.stopPropagation(); showReplyDialog = true; }}
      class="flex flex-col items-center gap-1 hover:scale-110 transition-transform group"
    >
      <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </div>
      <span class="text-xs font-semibold">{replyCount}</span>
    </button>
    <div class="relative">
      <button
        type="button"
        onclick={(e) => { e.stopPropagation(); showRepostMenu = !showRepostMenu; }}
        class="flex flex-col items-center gap-1 hover:scale-110 transition-transform group"
      >
        <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        </div>
        <span class="text-xs font-semibold">{repostCount}</span>
      </button>
      {#if showRepostMenu}
        <div
          use:clickOutside={() => showRepostMenu = false}
          class="absolute bottom-full mb-2 right-0 bg-popover border border-border rounded-lg shadow-xl z-50 min-w-[180px] overflow-hidden"
          onclick={(e) => e.stopPropagation()}
        >
          <button
            onclick={(e) => { e.stopPropagation(); showRepostMenu = false; handleRepost(); }}
            class="w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center gap-3"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <div>
              <div class="font-medium">Repost</div>
              <div class="text-xs text-muted-foreground">Share instantly</div>
            </div>
          </button>
          <button
            onclick={(e) => { e.stopPropagation(); showRepostMenu = false; showQuoteDialog = true; }}
            class="w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center gap-3 border-t border-border"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <div>
              <div class="font-medium">Quote</div>
              <div class="text-xs text-muted-foreground">Add your thoughts</div>
            </div>
          </button>
        </div>
      {/if}
    </div>
    <button
      type="button"
      onclick={(e) => { e.stopPropagation(); handleReact('‚ù§Ô∏è'); }}
      class="flex flex-col items-center gap-1 hover:scale-110 transition-transform group"
    >
      <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
        <svg class="w-6 h-6 text-red-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
      </div>
      <span class="text-xs font-semibold">{reactionCount}</span>
    </button>
    <ZapButton {event} variant="tiktok" />
  </div>
{:else}
  <div class="flex items-center gap-3 sm:gap-6 {variant === 'thread-main' ? 'border-t border-border pt-3' : ''} text-muted-foreground">
    <button
      type="button"
      onclick={(e) => { e.stopPropagation(); showReplyDialog = true; }}
      class="flex items-center gap-2 hover:text-primary transition-colors group"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      <span class="text-sm group-hover:underline">{replyCount}</span>
    </button>
  <div class="relative">
    <button
      type="button"
      onclick={(e) => { e.stopPropagation(); showRepostMenu = !showRepostMenu; }}
      class="flex items-center gap-2 hover:text-green-400 transition-colors group"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      <span class="text-sm group-hover:underline">{repostCount}</span>
    </button>
    {#if showRepostMenu}
      <div
        use:clickOutside={() => showRepostMenu = false}
        class="absolute bottom-full mb-2 left-0 bg-popover border border-border rounded-lg shadow-xl z-50 min-w-[180px] overflow-hidden"
        onclick={(e) => e.stopPropagation()}
      >
        <button
          onclick={(e) => { e.stopPropagation(); showRepostMenu = false; handleRepost(); }}
          class="w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center gap-3"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <div>
            <div class="font-medium">Repost</div>
            <div class="text-xs text-muted-foreground">Share instantly</div>
          </div>
        </button>
        <button
          onclick={(e) => { e.stopPropagation(); showRepostMenu = false; showQuoteDialog = true; }}
          class="w-full px-4 py-3 text-left hover:bg-muted transition-colors flex items-center gap-3 border-t border-border"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <div>
            <div class="font-medium">Quote</div>
            <div class="text-xs text-muted-foreground">Add your thoughts</div>
          </div>
        </button>
      </div>
    {/if}
  </div>
  <button
    type="button"
    onclick={(e) => { e.stopPropagation(); handleReact('‚ù§Ô∏è'); }}
    class="flex items-center gap-2 hover:text-red-400 transition-colors group"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
    </svg>
    <span class="text-sm group-hover:underline">{reactionCount}</span>
  </button>
  <ZapButton {event} />
  </div>
{/if}
<ComposeDialog bind:open={showReplyDialog} replyTo={event} />
<ComposeDialog bind:open={showQuoteDialog} quotedEvent={event} />
</file>

<file path="EventCardHeader.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import User from './User.svelte';
  import TimeAgo from './TimeAgo.svelte';
  import EventOptionsMenu from './EventOptionsMenu.svelte';
  interface Props {
    event: NDKEvent;
    avatarClass?: string;
    nameClass?: string;
    variant?: 'compact' | 'full';
  }
  const {
    event,
    avatarClass = 'w-9 h-9 sm:w-12 sm:h-12',
    nameClass = 'text-base font-semibold',
    variant = 'compact'
  }: Props = $props();
</script>
<div class="flex items-center gap-2 sm:gap-3">
  <div class="flex items-center gap-2 flex-1 min-w-0" onclick={(e) => e.stopPropagation()}>
    {#if variant === 'compact'}
      <User
        pubkey={event.pubkey}
        variant="avatar-name-handle"
        avatarSize={avatarClass}
        nameSize={nameClass}
      />
    {:else}
      <User
        pubkey={event.pubkey}
        variant="avatar-name-meta"
        avatarSize={avatarClass}
        nameSize={nameClass}
      />
    {/if}
  </div>
  {#if event.created_at}
    <TimeAgo timestamp={event.created_at} class="text-muted-foreground text-sm flex-shrink-0" />
  {/if}
  <EventOptionsMenu {event} />
</div>
</file>

<file path="EventOptionsMenu.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { toast } from '$lib/stores/toast.svelte';
  import { MediaQuery } from 'svelte/reactivity';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import RelayBadge from './RelayBadge.svelte';
  interface Props {
    event: NDKEvent;
  }
  let { event }: Props = $props();
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let showOptionsMenu = $state(false);
  let showRawEventModal = $state(false);
  async function copyToClipboard(text: string, label: string) {
    try {
      await navigator.clipboard.writeText(text);
      toast.success(`Copied ${label}`);
    } catch (err) {
      console.error('Failed to copy:', err);
      toast.error(`Failed to copy ${label}`);
    }
    showOptionsMenu = false;
  }
  function copyAuthorNprofile() {
    const nprofile = event.author.nprofile;
    copyToClipboard(nprofile, 'author nprofile');
  }
  function copyEventId() {
    const nevent = event.encode();
    copyToClipboard(nevent, 'event ID');
  }
  function copyRawEvent() {
    const raw = event.inspect;
    copyToClipboard(raw, 'raw event');
  }
  function viewRawEvent() {
    showOptionsMenu = false;
    showRawEventModal = true;
  }
  $effect(() => {
    if (!showOptionsMenu) return;
    const handleClickOutside = () => {
      showOptionsMenu = false;
    };
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  });
</script>
<div class="relative flex-shrink-0">
  <button
    onclick={(e) => { e.stopPropagation(); showOptionsMenu = !showOptionsMenu; }}
    class="p-1 hover:bg-muted rounded-full transition-colors"
    type="button"
    aria-label="More options"
  >
    <svg class="w-5 h-5 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
    </svg>
  </button>
  {#if showOptionsMenu}
    <div
      class="absolute right-0 mt-1 w-72 bg-popover border border-border rounded-lg shadow-lg z-10 max-h-96 overflow-y-auto"
      onclick={(e) => e.stopPropagation()}
    >
      <button
        onclick={copyAuthorNprofile}
        class="w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted transition-colors first:rounded-t-lg"
        type="button"
      >
        Copy author (nprofile)
      </button>
      <button
        onclick={copyEventId}
        class="w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted transition-colors"
        type="button"
      >
        Copy ID (nevent)
      </button>
      <button
        onclick={copyRawEvent}
        class="w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted transition-colors"
        type="button"
      >
        Copy raw event
      </button>
      <button
        onclick={viewRawEvent}
        class="w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted transition-colors"
        type="button"
      >
        View raw event
      </button>
      {#if event.onRelays && event.onRelays.size > 0}
        <div class="border-t border-border mt-1 pt-1">
          <div class="px-4 py-2 text-xs text-muted-foreground font-medium">
            Seen on {event.onRelays.size} relay{event.onRelays.size === 1 ? '' : 's'}
          </div>
          <div class="px-2 pb-2 space-y-1">
            {#each Array.from(event.onRelays) as relay (relay.url)}
              <RelayBadge {relay} variant="compact" />
            {/each}
          </div>
        </div>
      {/if}
    </div>
  {/if}
</div>
<!-- Raw Event Modal -->
{#if isDesktop.current}
  <Dialog.Root bind:open={showRawEventModal}>
    <Dialog.Content class="max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
      <Dialog.Header>
        <Dialog.Title>Raw Event</Dialog.Title>
        <Dialog.Description>
          JSON representation of this Nostr event
        </Dialog.Description>
      </Dialog.Header>
      <div class="flex-1 overflow-auto bg-muted/50 rounded-lg p-4 font-mono text-sm">
        <pre class="whitespace-pre-wrap break-words">{event.inspect}</pre>
      </div>
      <Dialog.Footer class="flex justify-end gap-2">
        <Button
          variant="outline"
          onclick={() => copyToClipboard(event.inspect, 'raw event')}
        >
          Copy to Clipboard
        </Button>
        <Button onclick={() => showRawEventModal = false}>
          Close
        </Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root bind:open={showRawEventModal}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>Raw Event</Drawer.Title>
        <Drawer.Description>
          JSON representation of this Nostr event
        </Drawer.Description>
      </Drawer.Header>
      <div class="px-4 flex-1 overflow-auto bg-muted/50 rounded-lg p-4 font-mono text-sm">
        <pre class="whitespace-pre-wrap break-words">{event.inspect}</pre>
      </div>
      <Drawer.Footer class="pt-2">
        <Button
          variant="outline"
          onclick={() => copyToClipboard(event.inspect, 'raw event')}
        >
          Copy to Clipboard
        </Button>
        <Button onclick={() => showRawEventModal = false}>
          Close
        </Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="FeaturedArticleCard.svelte">
<script lang="ts">
  import type { NDKArticle, NDKUser, NDKUserProfile } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import TimeAgo from './TimeAgo.svelte';
  import { getArticleUrl } from '$lib/utils/articleUrl';
  interface Props {
    article: NDKArticle;
  }
  let { article }: Props = $props();
  let author = $state<NDKUser | undefined>(undefined);
  let authorProfile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    author = article.author;
    article.author.fetchProfile().then(p => { authorProfile = p; });
  });
  const title = $derived(article.title || 'Untitled');
  const summary = $derived(article.summary);
  const imageUrl = $derived(article.image);
  const publishedAt = $derived(article.published_at || article.created_at);
  const articleUrl = $derived(getArticleUrl(article, author));
  const authorName = $derived(authorProfile?.name || authorProfile?.displayName || 'Anonymous');
  const excerpt = $derived.by(() => {
    const text = summary || article.content;
    return text.slice(0, 100) + (text.length > 100 ? '...' : '');
  });
</script>
<a
  href={articleUrl}
  class="group block flex-shrink-0 w-[280px] h-[360px] rounded-2xl overflow-hidden bg-card hover:bg-muted transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl hover:shadow-primary/10"
>
  <!-- Cover Image -->
  <div class="relative w-full h-48 overflow-hidden bg-gradient-to-br bg-primary/20">
    {#if imageUrl}
      <img
        src={imageUrl}
        alt={title}
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
        loading="lazy"
      />
      <!-- Gradient overlay for better text readability -->
      <div class="absolute inset-0 bg-gradient-to-t from-neutral-900 via-transparent to-transparent opacity-60" />
    {:else}
      <div class="w-full h-full flex items-center justify-center">
        <svg class="w-16 h-16 text-primary/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      </div>
    {/if}
  </div>
  <!-- Content -->
  <div class="p-4 flex flex-col h-[calc(100%-12rem)]">
    <!-- Title -->
    <h3 class="font-bold text-base text-foreground mb-2 line-clamp-2 leading-snug font-serif">
      {title}
    </h3>
    <!-- Excerpt -->
    <p class="text-muted-foreground text-xs mb-3 line-clamp-3 leading-relaxed flex-1">
      {excerpt}
    </p>
    <!-- Meta -->
    <div class="flex items-center gap-2 mt-auto pt-2 border-t border-border">
      <div class="flex-1 min-w-0">
        <p class="text-xs font-medium text-muted-foreground truncate">{authorName}</p>
        {#if publishedAt}
          <p class="text-xs text-muted-foreground">
            <TimeAgo timestamp={publishedAt} />
          </p>
        {/if}
      </div>
      <svg class="w-5 h-5 text-primary opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </div>
  </div>
</a>
</file>

<file path="FollowButton.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKKind, NDKEvent, NDKUser } from '@nostr-dev-kit/ndk';
  import { t } from 'svelte-i18n';
  import { toast } from '$lib/stores/toast.svelte';
  interface Props {
    pubkey: string;
    variant?: 'default' | 'outline' | 'primary';
    showIcon?: boolean;
    class?: string;
  }
  const { pubkey, variant = 'default', showIcon = true, class: className = '' }: Props = $props();
  const follows = $derived(ndk.$sessions?.follows ?? new Set());
  const isFollowing = $derived.by(() => follows.has(pubkey));
  const isOwnProfile = $derived(ndk.$currentUser?.pubkey === pubkey);
  const buttonClasses = $derived.by(() => {
    if (className) return className;
    if (variant === 'primary') {
      return isFollowing
        ? 'px-4 py-2 rounded-full font-medium transition-colors bg-muted text-foreground hover:bg-red-500 hover:text-white text-sm'
        : 'px-4 py-2 rounded-full font-medium transition-colors bg-accent text-accent-foreground hover:bg-accent/90 text-sm';
    }
    return `text-sm font-medium transition-colors inline-flex items-center gap-1 ${
      isFollowing
        ? 'text-muted-foreground hover:text-red-500'
        : 'text-primary hover:underline'
    }`;
  });
  async function handleToggleFollow(event: MouseEvent) {
    if (!ndk.$currentUser) return;
    const wasFollowing = isFollowing;
    try {
      if (isFollowing) {
        ndk.$currentUser.unfollow(pubkey, follows);
      } else {
        ndk.$currentUser.follow(pubkey, follows);
      }
      // Dispatch success event
      event.currentTarget?.dispatchEvent(
        new CustomEvent('followsuccess', {
          detail: { pubkey, isFollowing: !wasFollowing },
          bubbles: true,
        })
      );
    } catch (error) {
      console.error('Error toggling follow:', error);
      toast.error($t('profile.follow_error'));
    }
  }
</script>
{#if !isOwnProfile && ndk.$currentUser}
  <button
    data-testid="follow-button"
    type="button"
    onclick={handleToggleFollow}
    aria-label={isFollowing ? $t('profile.unfollow') : $t('profile.follow')}
    class={buttonClasses}
  >
    {#if showIcon}
      {#if isFollowing}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
        </svg>
      {:else}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
        </svg>
      {/if}
    {/if}
    {isFollowing ? $t('profile.unfollow') : $t('profile.follow')}
  </button>
{/if}
</file>

<file path="FollowPackMemberItem.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
    isSelected: boolean;
    onToggle: (pubkey: string) => void;
  }
  let { pubkey, isSelected, onToggle }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
</script>
<button
  onclick={() => onToggle(pubkey)}
  class={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${
    isSelected
      ? 'bg-primary/20 border border-primary/50'
      : 'bg-card border border-border hover:border-border'
  }`}
>
  <Avatar {ndk} {pubkey} class="w-10 h-10 flex-shrink-0" />
  <div class="flex-1 min-w-0 text-left">
    <div class="font-medium text-foreground truncate">
      {profile?.displayName || profile?.name || `${pubkey.slice(0, 8)}...`}
    </div>
    <div class="text-xs text-muted-foreground truncate">
      {profile?.nip05 || `${pubkey.slice(0, 16)}...`}
    </div>
  </div>
  <div class={`w-5 h-5 rounded border-2 flex items-center justify-center ${
    isSelected
      ? 'bg-primary border-primary'
      : 'border'
  }`}>
    {#if isSelected}
      <svg class="w-3 h-3 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
      </svg>
    {/if}
  </div>
</button>
</file>

<file path="Hashtag.svelte">
<script lang="ts">
  import HashtagHoverCard from './HashtagHoverCard.svelte';
  interface Props {
    hashtag: string;
    onClick?: (hashtag: string) => void;
    class?: string;
    format?: 'inline' | 'pill';
  }
  let {
    hashtag,
    onClick,
    class: className = '',
    format = 'inline',
  }: Props = $props();
  let isHovering = $state(false);
  let isCardHovering = $state(false);
  let hoverTimeout: ReturnType<typeof setTimeout> | null = null;
  let hideTimeout: ReturnType<typeof setTimeout> | null = null;
  let showCard = $state(false);
  let cardPosition = $state({ x: 0, y: 0 });
  let elementRef: HTMLElement | null = $state(null);
  function handleMouseEnter(e: MouseEvent) {
    isHovering = true;
    // Clear any existing hide timeout
    if (hideTimeout) {
      clearTimeout(hideTimeout);
      hideTimeout = null;
    }
    // Clear any existing show timeout
    if (hoverTimeout) {
      clearTimeout(hoverTimeout);
    }
    // Wait 500ms before showing the card
    hoverTimeout = setTimeout(() => {
      if (isHovering && elementRef) {
        const rect = elementRef.getBoundingClientRect();
        // Position the card below and to the right of the hashtag
        cardPosition = {
          x: rect.left,
          y: rect.bottom + 8
        };
        showCard = true;
      }
    }, 500);
  }
  function handleMouseLeave() {
    isHovering = false;
    // Clear the show timeout if we haven't shown the card yet
    if (hoverTimeout) {
      clearTimeout(hoverTimeout);
      hoverTimeout = null;
    }
    // Wait a bit before hiding to allow moving to the card
    hideTimeout = setTimeout(() => {
      if (!isHovering && !isCardHovering) {
        showCard = false;
      }
    }, 100);
  }
  function handleCardMouseEnter() {
    isCardHovering = true;
    // Clear any pending hide timeout
    if (hideTimeout) {
      clearTimeout(hideTimeout);
      hideTimeout = null;
    }
  }
  function handleCardMouseLeave() {
    isCardHovering = false;
    // Hide the card after a short delay
    hideTimeout = setTimeout(() => {
      if (!isHovering && !isCardHovering) {
        showCard = false;
      }
    }, 100);
  }
  function handleClick(e: MouseEvent) {
    if (onClick) {
      e.preventDefault();
      e.stopPropagation();
      onClick(hashtag);
    }
  }
</script>
{#if format === 'pill'}
  <!-- Pill format: more prominent hashtag display -->
  <button
    bind:this={elementRef}
    class="hashtag-pill {className}"
    onclick={handleClick}
    onmouseenter={handleMouseEnter}
    onmouseleave={handleMouseLeave}
    type="button"
  >
    <span class="hashtag-prefix">#</span>
    <span class="hashtag-text">{hashtag}</span>
  </button>
{:else}
  <!-- Inline format: compact hashtag display -->
  <a
    bind:this={elementRef}
    href={`/t/${hashtag}`}
    class="hashtag-inline {className}"
    onclick={handleClick}
    onmouseenter={handleMouseEnter}
    onmouseleave={handleMouseLeave}
  >
    #{hashtag}
  </a>
{/if}
<HashtagHoverCard
  {hashtag}
  isVisible={showCard}
  position={cardPosition}
  onMouseEnter={handleCardMouseEnter}
  onMouseLeave={handleCardMouseLeave}
/>
<style>
  /* Inline hashtag styles */
  .hashtag-inline {
    color: var(--hashtag-color, #fb923c);
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s;
  }
  .hashtag-inline:hover {
    opacity: 0.8;
    text-decoration: underline;
  }
  /* Pill hashtag styles */
  .hashtag-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.125rem;
    padding: 0.25rem 0.625rem;
    background: var(--hashtag-background, #fed7aa);
    border: 1px solid var(--hashtag-border, #fdba74);
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    margin: 0.125rem;
  }
  .hashtag-pill:hover {
    background: var(--hashtag-hover-background, #fdba74);
    border-color: var(--hashtag-hover-border, #fb923c);
    transform: translateY(-1px);
  }
  .hashtag-prefix {
    color: var(--hashtag-prefix-color, #fb923c);
    font-weight: 400;
  }
  .hashtag-text {
    color: var(--hashtag-text-color, #ea580c);
  }
  /* Dark mode support */
  :global(.dark) .hashtag-pill {
    background: var(--hashtag-background, #431407);
    border-color: var(--hashtag-border, #7c2d12);
  }
  :global(.dark) .hashtag-pill:hover {
    background: var(--hashtag-hover-background, #7c2d12);
    border-color: var(--hashtag-hover-border, #ea580c);
  }
  :global(.dark) .hashtag-inline {
    color: var(--hashtag-color, #fb923c);
  }
  :global(.dark) .hashtag-prefix {
    color: var(--hashtag-prefix-color, #fdba74);
  }
  :global(.dark) .hashtag-text {
    color: var(--hashtag-text-color, #fb923c);
  }
</style>
</file>

<file path="HashtagHoverCard.svelte">
<script lang="ts">
  import { ndk, hashtagInterests } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { EventContent } from '@nostr-dev-kit/svelte';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  interface Props {
    hashtag: string;
    isVisible: boolean;
    position: { x: number; y: number };
    onMouseEnter?: () => void;
    onMouseLeave?: () => void;
  }
  const { hashtag, isVisible, position, onMouseEnter, onMouseLeave }: Props = $props();
  // Check if hashtag is followed
  const isFollowing = $derived(hashtagInterests.interests.includes(hashtag.toLowerCase()));
  let isTogglingFollow = $state(false);
  async function toggleFollow(e: MouseEvent) {
    e.stopPropagation();
    if (isTogglingFollow) return;
    isTogglingFollow = true;
    try {
      await hashtagInterests.toggleHashtag(hashtag);
    } catch (err) {
      console.error('Failed to toggle hashtag:', err);
    } finally {
      isTogglingFollow = false;
    }
  }
  // Subscribe to hashtag notes from the past 24 hours
  const hashtagSubscription = ndk.$subscribe(
    () => hashtag && isVisible ? ({
      filters: [{
        kinds: [1],
        '#t': [hashtag.toLowerCase()],
        since: Math.floor(Date.now() / 1000) - (24 * 60 * 60) // 24 hours ago
      }],
      bufferMs: 100,
    }) : undefined
  );
  // Get unique authors
  const uniqueAuthors = $derived.by(() => {
    const authors = new Set<string>();
    hashtagSubscription.events.forEach(event => authors.add(event.pubkey));
    return Array.from(authors);
  });
  const noteCount = $derived(hashtagSubscription.events.length);
  const authorCount = $derived(uniqueAuthors.length);
  // Get the most recent note from someone the current user follows
  const recentNoteFromFollowing = $derived.by(() => {
    if (!ndk.$currentUser) return null;
    // Get the user's contact list
    const followingPubkeys = new Set<string>();
    // We'll get this from the currentUser's contacts
    // For now, just return the most recent note
    // Sort by created_at descending and get the first one from someone we follow
    const sortedEvents = [...hashtagSubscription.events].sort((a, b) =>
      (b.created_at ?? 0) - (a.created_at ?? 0)
    );
    return sortedEvents[0] || null;
  });
  // Format timestamp
  function formatTimestamp(timestamp: number): string {
    const now = Date.now() / 1000;
    const diff = now - timestamp;
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  }
  // Get profile for the recent note author
  let recentNoteAuthorProfile = $state<import('@nostr-dev-kit/ndk').NDKUserProfile | null>(null);
  $effect(() => {
    if (!recentNoteFromFollowing) {
      recentNoteAuthorProfile = null;
      return;
    }
    ndk.fetchUser(recentNoteFromFollowing.pubkey).then(u => {
      u?.fetchProfile().then(p => { recentNoteAuthorProfile = p; });
    });
  });
</script>
{#if isVisible}
  <div
    class="fixed z-50 pointer-events-none animate-in fade-in duration-200"
    style="left: {position.x}px; top: {position.y}px;"
  >
    <div
      class="relative pointer-events-auto"
      onmouseenter={onMouseEnter}
      onmouseleave={onMouseLeave}
    >
      <!-- Main card -->
      <div class="relative w-80 bg-card border border-border rounded-xl shadow-2xl overflow-hidden">
        <!-- Gradient header -->
        <div class="relative h-20 bg-gradient-to-br bg-primary/30">
          <div class="absolute inset-0 bg-gradient-to-b from-transparent to-neutral-900 opacity-60"></div>
          <!-- Hashtag overlay -->
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-3xl font-bold text-foreground/20 select-none">
              #{hashtag}
            </div>
          </div>
        </div>
        <!-- Content -->
        <div class="relative px-5 pb-5 -mt-8">
          <!-- Hashtag title and Follow button -->
          <div class="flex items-center justify-between mb-4 gap-3">
            <h3 class="text-2xl font-bold text-foreground">
              <span class="text-primary">#</span>{hashtag}
            </h3>
            {#if ndk.$currentUser}
              <button
                onclick={toggleFollow}
                disabled={isTogglingFollow}
                class="px-4 py-2 rounded-full text-sm font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 {
                  isFollowing
                    ? 'bg-muted text-foreground hover:bg-muted border border'
                    : 'bg-primary text-foreground hover:bg-primary'
                }"
              >
                {#if isTogglingFollow}
                  <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                {:else if isFollowing}
                  Following
                {:else}
                  Follow
                {/if}
              </button>
            {/if}
          </div>
          <!-- Stats -->
          <div class="flex items-center gap-4 mb-4 text-sm border-b border-border pb-4">
            <div class="flex items-center gap-1.5">
              <span class="font-medium text-foreground">{noteCount}</span>
              <span class="text-muted-foreground">{noteCount === 1 ? 'note' : 'notes'}</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="font-medium text-foreground">{authorCount}</span>
              <span class="text-muted-foreground">{authorCount === 1 ? 'person' : 'people'}</span>
            </div>
            <div class="flex items-center gap-1.5 text-muted-foreground">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>24h</span>
            </div>
          </div>
          <!-- Recent note from following -->
          {#if recentNoteFromFollowing}
            <div class="space-y-2">
              <div class="text-xs font-medium text-muted-foreground uppercase tracking-wider">
                Recent note
              </div>
              <div class="bg-muted/50 rounded-lg p-3 border border-border">
                <!-- Author info -->
                <div class="flex items-center gap-2 mb-2">
                  <Avatar
                    {ndk}
                    pubkey={recentNoteFromFollowing.pubkey}
                    class="w-6 h-6 rounded-full"
                  />
                  <div class="flex-1 min-w-0">
                    <div class="text-xs font-medium text-foreground truncate">
                      {recentNoteAuthorProfile?.displayName || recentNoteAuthorProfile?.name || 'Anonymous'}
                    </div>
                  </div>
                  <div class="text-xs text-muted-foreground">
                    {formatTimestamp(recentNoteFromFollowing.created_at ?? 0)}
                  </div>
                </div>
                <!-- Note content -->
                <div class="text-sm text-muted-foreground line-clamp-3 leading-relaxed">
                  <EventContent
                    {ndk}
                    content={recentNoteFromFollowing.content}
                    class="text-muted-foreground"
                  />
                </div>
              </div>
            </div>
          {:else if hashtagSubscription.events.length === 0}
            <div class="text-center py-6 text-muted-foreground">
              <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
              </svg>
              <p class="text-sm">No recent notes found</p>
            </div>
          {/if}
        </div>
      </div>
    </div>
  </div>
{/if}
<style>
  @keyframes animate-in {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  .animate-in {
    animation: animate-in 0.2s ease-out;
  }
  .fade-in {
    animation: fade-in 0.2s ease-out;
  }
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
</file>

<file path="HashtagSelector.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { NDKSubscriptionCacheUsage } from '@nostr-dev-kit/ndk';
  import { MediaQuery } from 'svelte/reactivity';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { SvelteMap } from 'svelte/reactivity';
  interface Props {
    selectedTags?: string[];
    onTagsChange?: (tags: string[]) => void;
    open?: boolean;
    onClose?: () => void;
  }
  let { selectedTags = [], onTagsChange, open = $bindable(false), onClose }: Props = $props();
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let popularHashtags = $state<Array<{ tag: string; count: number }>>([]);
  let searchQuery = $state('');
  // Filter hashtags based on search
  const filteredHashtags = $derived.by(() => {
    if (!searchQuery) return popularHashtags;
    const query = searchQuery.toLowerCase();
    return popularHashtags.filter(h => h.tag.toLowerCase().includes(query));
  });
  // Check if search query is a new tag (not in results)
  const isNewTag = $derived.by(() => {
    if (!searchQuery.trim()) return false;
    const normalized = searchQuery.trim().toLowerCase().replace(/^#/, '');
    return !popularHashtags.some(h => h.tag.toLowerCase() === normalized) &&
           !selectedTags.some(t => t.toLowerCase() === normalized);
  });
  const relayUrl = $derived(settings.selectedRelay || settings.relays.find(r => r.enabled && r.read)?.url);
  const hashtagEvents = ndk.$fetchEvents(() => open ? {
    filters: {
      kinds: [1, 20, 21, 22],
      limit: 500
    },
    cacheUsage: relayUrl ? NDKSubscriptionCacheUsage.ONLY_RELAY : NDKSubscriptionCacheUsage.CACHE_FIRST,
    relayUrls: relayUrl ? [relayUrl] : undefined
  } : undefined);
  // Process hashtags from events
  $effect(() => {
    if (!hashtagEvents) {
      popularHashtags = [];
      return;
    }
    const tagCounts = new SvelteMap<string, number>();
    for (const event of hashtagEvents) {
      const tTags = event.tags.filter(t => t[0] === 't' && t[1]);
      for (const tag of tTags) {
        const tagValue = tag[1].toLowerCase();
        tagCounts.set(tagValue, (tagCounts.get(tagValue) || 0) + 1);
      }
    }
    popularHashtags = Array.from(tagCounts.entries())
      .map(([tag, count]) => ({ tag, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 100);
  });
  function toggleTag(tag: string) {
    if (selectedTags.includes(tag)) {
      onTagsChange?.(selectedTags.filter(t => t !== tag));
    } else {
      onTagsChange?.([...selectedTags, tag]);
    }
  }
  function addCustomTag() {
    if (!isNewTag) return;
    const normalized = searchQuery.trim().toLowerCase().replace(/^#/, '');
    onTagsChange?.([...selectedTags, normalized]);
    searchQuery = '';
  }
  function handleSearchKeydown(e: KeyboardEvent) {
    if (e.key === 'Enter' && isNewTag) {
      e.preventDefault();
      addCustomTag();
    }
  }
  function handleClose() {
    open = false;
    searchQuery = '';
    onClose?.();
  }
</script>
{#if isDesktop.current}
  <Dialog.Root {open} onOpenChange={(newOpen) => {
      open = newOpen;
      if (!newOpen) handleClose();
    }}>
    <Dialog.Content class="max-w-xl max-h-[80vh] flex flex-col">
      <Dialog.Header>
        <Dialog.Title>Select Hashtags</Dialog.Title>
      </Dialog.Header>
      <!-- Search -->
      <div class="mb-4">
        <Input
          type="text"
          bind:value={searchQuery}
          onkeydown={handleSearchKeydown}
          placeholder="Search hashtags..."
          autofocus
        />
      </div>
      <!-- Add new tag hint -->
      {#if isNewTag}
        <button
          onclick={addCustomTag}
          class="w-full px-3 py-2 text-sm text-left border border-primary rounded-lg bg-primary/5 hover:bg-primary/10 transition-colors mb-4"
        >
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span class="text-primary font-medium">
              Add custom tag: #{searchQuery.trim().toLowerCase().replace(/^#/, '')}
            </span>
          </div>
          <p class="text-xs text-muted-foreground mt-1 ml-6">
            Press Enter or click to add
          </p>
        </button>
      {/if}
      <!-- Selected tags -->
      {#if selectedTags.length > 0}
        <div class="mb-4 flex flex-wrap gap-2">
          {#each selectedTags as tag (tag)}
            <button
              onclick={() => toggleTag(tag)}
              class="inline-flex items-center gap-1 px-2.5 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors"
            >
              <span>#{tag}</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          {/each}
        </div>
      {/if}
      <!-- Popular hashtags list -->
      <div class="flex-1 overflow-y-auto -mx-6 px-6">
        {#if filteredHashtags.length === 0}
          <div class="text-center py-12">
            <svg class="w-12 h-12 text-muted-foreground mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            <p class="text-muted-foreground">
              {searchQuery ? 'No hashtags found matching your search' : 'No popular hashtags found'}
            </p>
          </div>
        {:else}
          <div class="grid grid-cols-2 gap-2">
            {#each filteredHashtags as { tag, count } (tag)}
              {@const isSelected = selectedTags.includes(tag)}
              <button
                onclick={() => toggleTag(tag)}
                class="flex items-center justify-between px-3 py-2 rounded-lg border transition-colors {
                  isSelected
                    ? 'border-primary bg-primary/10 text-primary'
                    : 'border-border hover:border-primary/50 hover:bg-muted'
                }"
              >
                <span class="font-medium truncate">#{tag}</span>
                <span class="text-xs text-muted-foreground ml-2 flex-shrink-0">
                  {count}
                </span>
              </button>
            {/each}
          </div>
        {/if}
      </div>
      <!-- Footer -->
      <Dialog.Footer class="flex items-center justify-between pt-4 border-t border-border -mx-6 px-6">
        <p class="text-xs text-muted-foreground">
          {selectedTags.length} {selectedTags.length === 1 ? 'tag' : 'tags'} selected
        </p>
        <Button onclick={handleClose}>Done</Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root {open} onOpenChange={(newOpen) => {
      open = newOpen;
      if (!newOpen) handleClose();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>Select Hashtags</Drawer.Title>
      </Drawer.Header>
      <div class="px-4">
        <!-- Search -->
        <div class="mb-4">
          <Input
            type="text"
            bind:value={searchQuery}
            onkeydown={handleSearchKeydown}
            placeholder="Search hashtags..."
            autofocus
          />
        </div>
        <!-- Add new tag hint -->
        {#if isNewTag}
          <button
            onclick={addCustomTag}
            class="w-full px-3 py-2 text-sm text-left border border-primary rounded-lg bg-primary/5 hover:bg-primary/10 transition-colors mb-4"
          >
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              <span class="text-primary font-medium">
                Add custom tag: #{searchQuery.trim().toLowerCase().replace(/^#/, '')}
              </span>
            </div>
            <p class="text-xs text-muted-foreground mt-1 ml-6">
              Press Enter or click to add
            </p>
          </button>
        {/if}
        <!-- Selected tags -->
        {#if selectedTags.length > 0}
          <div class="mb-4 flex flex-wrap gap-2">
            {#each selectedTags as tag (tag)}
              <button
                onclick={() => toggleTag(tag)}
                class="inline-flex items-center gap-1 px-2.5 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors"
              >
                <span>#{tag}</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            {/each}
          </div>
        {/if}
        <!-- Popular hashtags list -->
        <div class="flex-1 overflow-y-auto max-h-[50vh]">
          {#if filteredHashtags.length === 0}
            <div class="text-center py-12">
              <svg class="w-12 h-12 text-muted-foreground mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              <p class="text-muted-foreground">
                {searchQuery ? 'No hashtags found matching your search' : 'No popular hashtags found'}
              </p>
            </div>
          {:else}
            <div class="grid grid-cols-2 gap-2">
              {#each filteredHashtags as { tag, count } (tag)}
                {@const isSelected = selectedTags.includes(tag)}
                <button
                  onclick={() => toggleTag(tag)}
                  class="flex items-center justify-between px-3 py-2 rounded-lg border transition-colors {
                    isSelected
                      ? 'border-primary bg-primary/10 text-primary'
                      : 'border-border hover:border-primary/50 hover:bg-muted'
                  }"
                >
                  <span class="font-medium truncate">#{tag}</span>
                  <span class="text-xs text-muted-foreground ml-2 flex-shrink-0">
                    {count}
                  </span>
                </button>
              {/each}
            </div>
          {/if}
        </div>
      </div>
      <!-- Footer -->
      <Drawer.Footer class="pt-2 flex items-center justify-between">
        <p class="text-xs text-muted-foreground">
          {selectedTags.length} {selectedTags.length === 1 ? 'tag' : 'tags'} selected
        </p>
        <Button onclick={handleClose}>Done</Button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="HighlightCard.svelte">
<script lang="ts">
  import { type NDKEvent, NDKArticle } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import EventCardHeader from './EventCardHeader.svelte';
  import EventActions from './EventActions.svelte';
  import { getArticleUrl } from '$lib/utils/articleUrl';
  import { fetchUrlMetadata, type UrlMetadata } from '$lib/utils/urlMetadata';
  interface Props {
    event: NDKEvent;
    variant?: 'default' | 'compact' | 'feed' | 'grid';
  }
  let { event, variant = 'default' }: Props = $props();
  let authorProfile = $state<import('@nostr-dev-kit/ndk').NDKUserProfile | null>(null);
  $effect(() => {
    event.author.fetchProfile().then(p => { authorProfile = p; });
  });
  const authorName = $derived(authorProfile?.name || authorProfile?.displayName || 'Anonymous');
  // Extract the highlighted content
  const highlightContent = $derived(event.content);
  // Get the source reference (could be 'a', 'e', or 'r' tag)
  const sourceTag = $derived.by(() => {
    const aTag = event.tags.find(t => t[0] === 'a');
    const eTag = event.tags.find(t => t[0] === 'e');
    const rTag = event.tags.find(t => t[0] === 'r');
    return aTag || eTag || rTag;
  });
  // Get context tag if available
  const contextTag = $derived(event.tags.find(t => t[0] === 'context'));
  const contextText = $derived(contextTag?.[1] || highlightContent);
  // Find the position of the highlight within the context
  const highlightPosition = $derived.by(() => {
    if (!contextText || contextText === highlightContent) {
      return { before: '', highlight: highlightContent, after: '' };
    }
    const startIndex = contextText.indexOf(highlightContent);
    if (startIndex === -1) {
      return { before: '', highlight: highlightContent, after: '' };
    }
    return {
      before: contextText.slice(0, startIndex),
      highlight: highlightContent,
      after: contextText.slice(startIndex + highlightContent.length)
    };
  });
  // Calculate dynamic font size based on content length
  const fontSize = $derived.by(() => {
    const totalLength = contextText.length;
    if (variant === 'grid') {
      // Grid variant uses smaller sizes
      if (totalLength < 100) return 'text-base';
      if (totalLength < 200) return 'text-sm';
      return 'text-xs';
    }
    // Feed and default variants
    if (totalLength < 100) return 'text-2xl sm:text-3xl md:text-4xl';
    if (totalLength < 200) return 'text-xl sm:text-2xl md:text-3xl';
    if (totalLength < 350) return 'text-lg sm:text-xl md:text-2xl';
    if (totalLength < 500) return 'text-base sm:text-lg md:text-xl';
    return 'text-sm sm:text-base md:text-lg';
  });
  // State for referenced article
  let referencedArticle = $state<NDKArticle | undefined>(undefined);
  // State for URL metadata
  let urlMetadata = $state<UrlMetadata | null>(null);
  // Fetch article if referenced
  $effect(() => {
    if (!sourceTag || sourceTag[0] !== 'a') {
      referencedArticle = undefined;
      return;
    }
    const aTagValue = sourceTag[1];
    // Parse a tag format: "kind:pubkey:d-tag"
    const parts = aTagValue.split(':');
    if (parts.length !== 3) {
      referencedArticle = undefined;
      return;
    }
    const [kind, pubkey, dTag] = parts;
    // Using raw filter components (not bech32), so disable guardrail
    ndk.guardrailOff('fetch-events-usage').fetchEvent({
      kinds: [parseInt(kind)],
      authors: [pubkey],
      '#d': [dTag]
    }).then((article) => {
      if (article) {
        referencedArticle = NDKArticle.from(article);
      }
    });
  });
  // Fetch URL metadata if it's a web URL
  $effect(() => {
    if (!sourceTag || sourceTag[0] !== 'r') {
      urlMetadata = null;
      return;
    }
    const url = sourceTag[1];
    fetchUrlMetadata(url).then((metadata) => {
      urlMetadata = metadata;
    }).catch((err) => {
      console.error('Failed to fetch URL metadata:', err);
      urlMetadata = null;
    });
  });
  // Determine the source type and get reference
  const sourceInfo = $derived.by(() => {
    if (!sourceTag) return null;
    const type = sourceTag[0];
    const value = sourceTag[1];
    if (type === 'r') {
      // Web URL - use metadata title if available
      const title = urlMetadata?.title || urlMetadata?.siteName;
      if (title) {
        return {
          type: 'web' as const,
          displayText: title,
          url: value
        };
      }
      try {
        const url = new URL(value);
        return {
          type: 'web' as const,
          displayText: url.hostname.replace('www.', ''),
          url: value
        };
      } catch {
        return {
          type: 'web' as const,
          displayText: value,
          url: value
        };
      }
    } else if (type === 'a') {
      // Nostr article reference - extract title from fetched article
      const article = referencedArticle;
      const title = article?.tags.find(t => t[0] === 'title')?.[1];
      return {
        type: 'article' as const,
        displayText: title || 'Article',
        value
      };
    } else if (type === 'e') {
      // Nostr event reference
      return {
        type: 'event' as const,
        displayText: 'Note',
        value
      };
    }
    return null;
  });
  const publishedAt = $derived(event.created_at);
  function navigateToHighlight() {
    const neventId = event.encode();
    window.location.href = `/e/${neventId}`;
  }
  function navigateToSource(e: MouseEvent) {
    e.stopPropagation();
    if (sourceInfo?.type === 'web' && sourceInfo.url) {
      window.open(sourceInfo.url, '_blank', 'noopener,noreferrer');
    } else if (sourceInfo?.type === 'article' && referencedArticle) {
      const articleUrl = getArticleUrl(referencedArticle);
      window.location.href = articleUrl;
    }
  }
</script>
{#if variant === 'feed'}
  <article class="p-3 sm:p-4 hover:bg-card/30 transition-colors border-b border-border">
    <!-- Author header -->
    <div class="mb-3">
      <EventCardHeader {event} avatarClass="w-9 h-9 sm:w-12 sm:h-12" />
    </div>
    <!-- Book page style highlight -->
    <div
      onclick={navigateToHighlight}
      class="relative rounded-lg overflow-hidden bg-card border border-border shadow-lg mb-2 cursor-pointer"
    >
      <!-- Content -->
      <div class="relative flex flex-col items-center justify-center py-12 sm:py-16 px-8 sm:px-12 min-h-[200px] max-h-[600px]">
        <!-- Highlighted text with context -->
        <div class="relative z-10">
          <p class="text-card-foreground {fontSize} font-serif leading-relaxed text-center">
            {highlightPosition.before}<mark class="bg-primary/20 text-card-foreground font-medium">{highlightPosition.highlight}</mark>{highlightPosition.after}
          </p>
        </div>
      </div>
      <!-- Source badge (small, bottom right corner) -->
      {#if sourceInfo}
        <button
          type="button"
          onclick={navigateToSource}
          class="absolute bottom-3 right-3 flex items-center gap-2 px-3 py-1.5 bg-background/80 backdrop-blur-sm border border-border rounded text-xs text-muted-foreground hover:bg-background transition-colors"
        >
          {#if sourceInfo.type === 'web'}
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
          {:else if sourceInfo.type === 'article'}
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          {:else}
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
          {/if}
          <span class="max-w-[200px] truncate">{sourceInfo.displayText}</span>
        </button>
      {/if}
    </div>
    <!-- Actions -->
    <EventActions {event} />
  </article>
{:else if variant === 'compact'}
  <div
    onclick={navigateToHighlight}
    class="block p-4 hover:bg-card/30 transition-colors rounded-lg group cursor-pointer"
  >
    <div class="relative">
      <!-- Highlight marker line on the left -->
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-primary/60 to-primary rounded-full" />
      <div class="pl-4">
        <!-- Highlighted text -->
        <div class="mb-3 relative">
          <p class="relative text-foreground text-base leading-relaxed font-serif italic">
            "{highlightPosition.before}<mark class="bg-primary/20 text-foreground font-medium not-italic">{highlightPosition.highlight}</mark>{highlightPosition.after}"
          </p>
        </div>
        <!-- Meta information -->
        <div class="flex items-center gap-2 text-xs text-muted-foreground">
          <span>{authorName}</span>
          {#if publishedAt}
            <span>¬∑</span>
            <TimeAgo timestamp={publishedAt} />
          {/if}
          {#if sourceInfo}
            <span>¬∑</span>
            <span class="flex items-center gap-1">
              {#if sourceInfo.type === 'web'}
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
              {:else}
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              {/if}
              {sourceInfo.displayText}
            </span>
          {/if}
        </div>
      </div>
    </div>
  </div>
{:else if variant === 'grid'}
  <article class="hover:bg-card/30 transition-colors w-full">
    <!-- Book page style highlight -->
    <div
      onclick={navigateToHighlight}
      class="relative aspect-square rounded-lg overflow-hidden bg-card border border-border shadow-lg w-full cursor-pointer"
    >
      <!-- Content -->
      <div class="relative flex flex-col items-center justify-center p-4 sm:p-6 min-h-[150px]">
        <!-- Highlighted text with context -->
        <div class="relative z-10">
          <p class="text-card-foreground {fontSize} font-serif leading-relaxed text-center line-clamp-6">
            {highlightPosition.before}<mark class="bg-primary/20 text-card-foreground font-medium">{highlightPosition.highlight}</mark>{highlightPosition.after}
          </p>
        </div>
      </div>
      <!-- Highlighter icon (bottom left corner) -->
      <div class="absolute bottom-2 left-2">
        <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.5 1.15a2.25 2.25 0 00-3.18 0L3.78 12.69a2.25 2.25 0 000 3.18l4.35 4.35a2.25 2.25 0 003.18 0L22.85 8.68a2.25 2.25 0 000-3.18l-4.35-4.35zM9.93 18.84L5.16 14.07 15.3 3.93l4.77 4.77-10.14 10.14z"/>
          <path d="M2.5 22.5h10v1.5h-10z" opacity="0.5"/>
        </svg>
      </div>
      <!-- Source badge (small, bottom right corner) -->
      {#if sourceInfo}
        <button
          type="button"
          onclick={navigateToSource}
          class="absolute bottom-2 right-2 flex items-center gap-1.5 px-2 py-1 bg-background/80 backdrop-blur-sm border border-border rounded text-xs text-muted-foreground hover:bg-background transition-colors"
        >
          {#if sourceInfo.type === 'web'}
            <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
          {:else if sourceInfo.type === 'article'}
            <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          {:else}
            <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
          {/if}
          <span class="max-w-[100px] truncate text-[10px]">{sourceInfo.displayText}</span>
        </button>
      {/if}
    </div>
    <!-- Author info below -->
    <div class="flex items-center gap-2 mt-2 px-1">
      <Avatar {ndk} pubkey={event.pubkey} class="w-5 h-5 rounded-full" />
      <span class="text-xs text-muted-foreground truncate">{authorName}</span>
    </div>
  </article>
{:else}
  <article class="p-3 sm:p-4 hover:bg-card/30 transition-colors border-b border-border">
    <!-- Author header -->
    <div class="mb-3">
      <EventCardHeader {event} avatarClass="w-9 h-9 sm:w-12 sm:h-12" />
    </div>
    <!-- Book page style highlight -->
    <div
      onclick={navigateToHighlight}
      class="relative rounded-lg overflow-hidden bg-card border border-border shadow-lg mb-2 cursor-pointer"
    >
      <!-- Content -->
      <div class="relative flex flex-col items-center justify-center py-12 sm:py-16 px-8 sm:px-12 min-h-[200px] max-h-[600px]">
        <!-- Highlighted text with context -->
        <div class="relative z-10">
          <p class="text-card-foreground {fontSize} font-serif leading-relaxed text-center">
            {highlightPosition.before}<mark class="bg-primary/20 text-card-foreground font-medium">{highlightPosition.highlight}</mark>{highlightPosition.after}
          </p>
        </div>
      </div>
      <!-- Source badge (small, bottom right corner) -->
      {#if sourceInfo}
        <button
          type="button"
          onclick={navigateToSource}
          class="absolute bottom-3 right-3 flex items-center gap-2 px-3 py-1.5 bg-background/80 backdrop-blur-sm border border-border rounded text-xs text-muted-foreground hover:bg-background transition-colors"
        >
          {#if sourceInfo.type === 'web'}
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
          {:else if sourceInfo.type === 'article'}
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          {:else}
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
          {/if}
          <span class="max-w-[200px] truncate">{sourceInfo.displayText}</span>
        </button>
      {/if}
    </div>
    <!-- Actions -->
    <EventActions {event} />
  </article>
{/if}
</file>

<file path="HighlightList.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import HighlightCard from './HighlightCard.svelte';
  interface Props {
    highlights: NDKEvent[];
    emptyMessage?: string;
  }
  const { highlights, emptyMessage = 'No highlights yet' }: Props = $props();
</script>
{#if highlights.length === 0}
  <div class="text-center py-8 text-muted-foreground">
    {emptyMessage}
  </div>
{:else}
  <div class="divide-y divide-neutral-800/50">
    {#each highlights as highlight (highlight.id)}
      <HighlightCard event={highlight} />
    {/each}
  </div>
{/if}
</file>

<file path="InvitedByBadge.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { KIND_INVITE_ACCEPTANCE } from '$lib/constants/nostr';
  import type { NDKUser, NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
  }
  let { pubkey }: Props = $props();
  // Subscribe to kind 514 events published by this user
  const inviteAcceptanceSubscription = ndk.$subscribe(
    () => pubkey ? ({
      filters: [{ kinds: [KIND_INVITE_ACCEPTANCE], authors: [pubkey], limit: 1 }],
      bufferMs: 100,
    }) : undefined
  );
  const inviteEvent = $derived(inviteAcceptanceSubscription.events[0]);
  // Extract the inviter's pubkey from the 'p' tag
  const inviterPubkey = $derived.by(() => {
    if (!inviteEvent) return undefined;
    return inviteEvent.tags.find((t) => t[0] === 'p')?.[1];
  });
  let inviterUser = $state<NDKUser | undefined>(undefined);
  let inviterProfile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    if (!inviterPubkey) {
      inviterUser = undefined;
      inviterProfile = null;
      return;
    }
    ndk.fetchUser(inviterPubkey).then(u => {
      inviterUser = u;
      u?.fetchProfile().then(p => { inviterProfile = p; });
    });
  });
</script>
{#if inviterPubkey && inviterUser?.pubkey}
  <a
    href={`/p/${inviterUser.npub}`}
    class="inline-flex items-center gap-2.5 px-3 py-2 rounded-lg bg-card border border-border hover:bg-muted/50 transition-colors text-sm group"
  >
    <div class="flex items-center gap-2">
      <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </svg>
      <Avatar {ndk} pubkey={inviterPubkey} size="xs" class="w-6 h-6 rounded-full" />
    </div>
    <span class="text-gray-400 group-hover:text-gray-300 transition-colors">
      Invited by <span class="font-medium text-gray-200">{inviterProfile?.name || inviterProfile?.displayName || 'Anonymous'}</span>
    </span>
  </a>
{/if}
</file>

<file path="JournalistsSidebar.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { NDKKind, NDKSubscriptionCacheUsage } from '@nostr-dev-kit/ndk';
  import User from './User.svelte';
  import { getRelaysToUse } from '$lib/utils/relayUtils';
  // Get relays to use based on selected relay
  const relaysToUse = $derived(
    getRelaysToUse(
      settings.selectedRelay,
      settings.relays.filter(r => r.enabled && r.read).map(r => r.url)
    )
  );
  // Subscribe to recent articles to find active journalists
  const articlesSubscription = ndk.$subscribe(() => ({
    filters: [{ kinds: [NDKKind.Article], limit: 50 }],
    bufferMs: 500,
    relayUrls: relaysToUse.length > 0 ? relaysToUse : undefined,
    cacheUsage: relaysToUse.length > 0 ? NDKSubscriptionCacheUsage.ONLY_RELAY : NDKSubscriptionCacheUsage.CACHE_FIRST,
    closeOnEose: true,
  }));
  // Get unique journalists (article authors) with their article count
  const journalists = $derived.by(() => {
    const authorMap = new Map<string, number>();
    // Count articles per author
    for (const event of articlesSubscription.events) {
      const count = authorMap.get(event.pubkey) || 0;
      authorMap.set(event.pubkey, count + 1);
    }
    // Convert to array and sort by article count
    return Array.from(authorMap.entries())
      .map(([pubkey, articleCount]) => ({ pubkey, articleCount }))
      .sort((a, b) => b.articleCount - a.articleCount)
      .slice(0, 5); // Show top 5 journalists
  });
  function isFollowing(pubkey: string): boolean {
    return ndk.$follows.includes(pubkey);
  }
  async function toggleFollow(pubkey: string) {
    if (!ndk.$currentUser) return;
    try {
      if (isFollowing(pubkey)) {
        await ndk.$follows.remove(pubkey);
      } else {
        await ndk.$follows.add(pubkey);
      }
    } catch (err) {
      console.error('Failed to toggle follow:', err);
    }
  }
</script>
<div class="p-4 bg-card rounded-lg border border-border">
  <div class="flex items-center gap-2 mb-4">
    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    </svg>
    <h2 class="text-lg font-semibold text-card-foreground">Journalists</h2>
  </div>
  <div class="space-y-3">
    {#if journalists.length === 0}
      <div class="text-center py-4 text-sm text-muted-foreground">
        No journalists found yet
      </div>
    {:else}
      {#each journalists as journalist (journalist.pubkey)}
        {@const isFollowed = isFollowing(journalist.pubkey)}
        <div class="flex items-center gap-3">
          <User
            pubkey={journalist.pubkey}
            variant="avatar-name-meta"
            avatarSize="w-10 h-10"
            nameSize="text-sm font-medium"
          >
            {#snippet meta()}
              <p class="text-xs text-muted-foreground">
                {journalist.articleCount} {journalist.articleCount === 1 ? 'article' : 'articles'}
              </p>
            {/snippet}
          </User>
          {#if ndk.$currentUser && journalist.pubkey !== ndk.$currentUser.pubkey}
            <button
              onclick={() => toggleFollow(journalist.pubkey)}
              class="px-3 py-1 text-xs font-medium rounded-full transition-colors flex-shrink-0 {
                isFollowed
                  ? 'bg-muted text-muted-foreground hover:bg-muted/80'
                  : 'text-primary hover:bg-primary/10'
              }"
            >
              {isFollowed ? 'Following' : 'Follow'}
            </button>
          {/if}
        </div>
      {/each}
    {/if}
  </div>
</div>
</file>

<file path="Layout.svelte">
<script lang="ts">
  import { page } from '$app/stores';
  import { goto } from '$app/navigation';
  import { t } from 'svelte-i18n';
  import { ndk } from '$lib/ndk.svelte';
  import { sidebarStore } from '$lib/stores/sidebar.svelte';
  import { headerStore } from '$lib/stores/header.svelte';
  import { layoutMode } from '$lib/stores/layoutMode.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { createPackModal } from '$lib/stores/createPackModal.svelte';
  import { createListingModal } from '$lib/stores/createListingModal.svelte';
  import { createInviteModal } from '$lib/stores/createInviteModal.svelte';
  import { createMediaPostModal } from '$lib/stores/createMediaPostModal.svelte';
  import { createTradeModal } from '$lib/stores/createTradeModal.svelte';
  import { homePageFilter } from '$lib/stores/homePageFilter.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { AGORA_RELAYS, isAgoraRelay, getRelaysToUse } from '$lib/utils/relayUtils';
  import { messagesStore } from '$lib/stores/messages.svelte';
  import { npubCashMonitor } from '$lib/services/npubcashMonitor.svelte';
  import { NDKKind, NDKArticle, NDKSubscriptionCacheUsage } from '@nostr-dev-kit/ndk';
  import { getArticleUrl } from '$lib/utils/articleUrl';
  import { createNotificationsManager } from '$lib/utils/useNotifications.svelte';
  import { formatBalance, formatBalanceLong } from '$lib/utils/formatBalance';
  import RelaySelector from './RelaySelector.svelte';
  import LoginButton from './LoginButton.svelte';
  import UserMenu from './UserMenu.svelte';
  import MarketplaceSidebar from './MarketplaceSidebar.svelte';
  import NewMembersWidget from './NewMembersWidget.svelte';
  import JournalistsSidebar from './JournalistsSidebar.svelte';
  import MobileBottomNav from './MobileBottomNav.svelte';
  import MobileComposeFAB from './MobileComposeFAB.svelte';
  import type { Snippet } from 'svelte';
  interface Props {
    children: Snippet;
  }
  const { children }: Props = $props();
  const wallet = ndk.$wallet;
  const notificationsManager = createNotificationsManager(ndk);
  let sidebarCollapsed = $state(false);
  const path = $derived($page.url.pathname);
  const hideRightSidebar = $derived(
    layoutMode.mode === 'article' ||
    layoutMode.mode === 'profile' ||
    layoutMode.mode === 'reads' ||
    path.startsWith('/note/') ||
    path.startsWith('/messages/') ||
    path.startsWith('/packs') ||
    path.startsWith('/agora/invites')
  );
  const shouldCollapseSidebar = $derived(layoutMode.mode === 'article');
  // Get relays to use for sidebar subscriptions
  const sidebarRelaysToUse = $derived(
    getRelaysToUse(
      settings.selectedRelay,
      settings.relays.filter(r => r.enabled && r.read).map(r => r.url)
    )
  );
  // Subscribe to recent articles for the sidebar
  const recentArticlesSubscription = $derived.by(() => {
    if (!hideRightSidebar && !sidebarStore.rightSidebar) {
      return ndk.$subscribe(() => ({
        filters: [{ kinds: [NDKKind.Article], limit: 5 }],
        bufferMs: 500,
        relayUrls: sidebarRelaysToUse.length > 0 ? sidebarRelaysToUse : undefined,
        cacheUsage: sidebarRelaysToUse.length > 0 ? NDKSubscriptionCacheUsage.ONLY_RELAY : NDKSubscriptionCacheUsage.CACHE_FIRST,
        closeOnEose: true,
      }));
    }
    return null;
  });
  const recentArticles = $derived.by(() => {
    if (!recentArticlesSubscription) return [];
    return recentArticlesSubscription.events
      .map(e => NDKArticle.from(e))
      .filter(article => article.title && article.content)
      .sort((a, b) => (b.published_at ?? b.created_at ?? 0) - (a.published_at ?? a.created_at ?? 0))
      .slice(0, 5);
  });
  const selectedRelayInfo = $derived.by(() => {
    if (!settings.selectedRelay) return null;
    return useRelayInfoCached(settings.selectedRelay);
  });
  // Auto-collapse sidebar when viewing articles
  $effect(() => {
    if (shouldCollapseSidebar) {
      sidebarCollapsed = true;
    }
  });
  // Handle messages subscription lifecycle
  $effect(() => {
    if (!ndk.$currentUser) {
      messagesStore.stop();
    }
  });
  // Handle npub.cash monitor lifecycle
  $effect(() => {
    if (ndk.$currentUser) {
      npubCashMonitor.start();
    } else {
      npubCashMonitor.stop();
    }
    return () => {
      npubCashMonitor.stop();
    };
  });
</script>
<div class="h-screen bg-background flex justify-center overflow-hidden">
  <div class="flex w-full max-w-full lg:max-w-[1400px] relative">
    <!-- Left Sidebar - Navigation -->
    <aside class="hidden lg:flex {sidebarCollapsed ? 'w-20' : 'w-64'} flex-col border-r border-border p-4 fixed left-0 top-0 bottom-0 overflow-y-auto overflow-x-visible transition-all duration-300 ease-in-out bg-background">
      <!-- Header: Logo and Toggle -->
      <div class="mb-6 flex items-center {sidebarCollapsed ? 'justify-center' : 'justify-between'} gap-2">
        <!-- Agora Branding -->
        <div class="px-2 {sidebarCollapsed ? 'hidden' : 'flex-1'} transition-opacity duration-300 text-foreground">
        <svg viewBox="0 0 686 250" class="w-full h-auto" xmlns="http://www.w3.org/2000/svg">
          <style>
            .st0{fill:#F68E1D;}
            .st1{fill:currentColor;}
            .st2{fill:currentColor;opacity:0.9;}
          </style>
          <path class="st0" d="M109.5,196.1h66.7c17.5,0,31.6-14.2,31.6-31.6V97.8c0-17.5-14.2-31.6-31.6-31.6h-66.7
            c-17.5,0-31.6,14.2-31.6,31.6v66.7C77.9,182,92,196.1,109.5,196.1z"/>
          <g>
            <path class="st1" d="M233.9,165.4v-0.9c3.6-0.3,6.4-1.1,8.4-2.4c2-1.3,3.5-3.2,4.7-5.8l24.2-54.9h3.8l28.5,57.6
              c0.7,1.4,1.7,2.6,3.2,3.6c1.4,1,3.6,1.6,6.4,1.9v0.9h-27.7v-0.9c2.9-0.3,4.7-0.9,5.4-1.9c0.8-1,0.8-2.2,0.1-3.6l-21.5-44.6
              L251,156.3c-1.1,2.6-0.9,4.5,0.5,5.8c1.4,1.3,3.9,2.1,7.6,2.4v0.9H233.9z M273.1,87.7h8.8l-7.8,9.2h-3L273.1,87.7z"/>
            <path class="st1" d="M358.3,135.2c0-1.5-0.6-2.7-1.8-3.7c-1.2-0.9-3.3-1.5-6.1-1.8v-0.9H378v0.9c-2.9,0.3-4.9,0.9-6.1,1.8
              c-1.2,0.9-1.8,2.1-1.8,3.7v32.9c0,1.5,0.6,2.7,1.8,3.7c1.2,0.9,3.3,1.5,6.1,1.8v0.9h-29v-0.9c3.5-0.3,5.9-0.9,7.2-1.8
              c1.3-0.9,2-2.1,2-3.7v-11.1c-1.5,2.9-3.7,5.2-6.7,6.7c-2.9,1.6-6.8,2.3-11.5,2.3c-4.5,0-8.7-0.7-12.3-2.2c-3.7-1.5-6.8-3.6-9.4-6.4
              c-2.6-2.8-4.6-6.2-6-10.2c-1.4-4-2.1-8.6-2.1-13.6c0-5.1,0.7-9.6,2.2-13.7c1.5-4.1,3.7-7.5,6.6-10.4c2.9-2.9,6.5-5.1,10.9-6.7
              c4.4-1.6,9.4-2.3,15.1-2.3c3.8,0,7.5,0.3,11.2,1c3.7,0.7,7.2,1.7,10.6,3v15.6h-1.3c-1.1-2.5-2.3-4.8-3.7-6.8c-1.4-2-3-3.8-4.7-5.3
              c-1.8-1.5-3.7-2.6-5.9-3.4c-2.2-0.8-4.6-1.2-7.3-1.2c-3.6,0-6.8,0.7-9.5,2.1c-2.7,1.4-4.9,3.4-6.7,6c-1.8,2.6-3.2,5.7-4,9.3
              c-0.9,3.6-1.3,7.7-1.3,12.2c0,9.2,1.8,16.2,5.5,20.8c3.7,4.7,8.6,7,14.6,7c4.8,0,8.5-1.6,11.3-4.8c2.7-3.2,4.2-8.5,4.5-15.8V135.2z
              "/>
            <path class="st1" d="M480.2,101.4c12.3,0,21.4,1.4,27.3,4.3c5.8,2.9,8.8,6.9,8.8,12.1c0,3.8-1.6,7.1-4.7,9.7
              c-3.2,2.6-8,4.5-14.7,5.6l19,25.9c0.9,1.3,2.2,2.4,3.8,3.5c1.6,1,3.8,1.7,6.7,2v0.9h-27.7v-0.9c2.9-0.3,4.5-1,4.8-2
              c0.3-1,0-2.2-0.9-3.5l-17.9-24.8c-0.7,0.1-1.4,0.1-2.1,0.1c-0.8,0-1.5,0-2.3,0h-7.1V159c0,1.5,0.6,2.7,1.8,3.7
              c1.2,0.9,3.3,1.5,6.1,1.8v0.9h-27.7v-0.9c2.9-0.3,4.9-0.9,6.1-1.8c1.2-0.9,1.8-2.1,1.8-3.7v-51.2c0-1.5-0.6-2.7-1.8-3.7
              c-1.2-0.9-3.3-1.5-6.1-1.8v-0.9H480.2z M480.2,131.6c8.2,0,14.3-1.2,18.1-3.5c3.8-2.3,5.7-5.7,5.7-10.2c0-4.5-1.9-7.9-5.7-10.2
              c-3.8-2.3-9.8-3.5-18.1-3.5h-7.1v27.5H480.2z"/>
            <path class="st1" d="M528.9,165.4v-0.9c3.6-0.3,6.4-1.1,8.4-2.4c2-1.3,3.5-3.2,4.7-5.8l24.2-54.9h3.8l28.5,57.6
              c0.7,1.4,1.7,2.6,3.2,3.6c1.4,1,3.6,1.6,6.4,1.9v0.9h-27.7v-0.9c2.9-0.3,4.7-0.9,5.4-1.9c0.8-1,0.8-2.2,0.1-3.6l-21.5-44.6
              L546,156.3c-1.1,2.6-0.9,4.5,0.5,5.8c1.4,1.3,3.9,2.1,7.6,2.4v0.9H528.9z"/>
            <path class="st1" d="M445.1,120c-1.5-4-3.7-7.5-6.5-10.3c-2.8-2.9-6.2-5.1-10.1-6.6c-4-1.6-8.4-2.3-13.4-2.3
              c-4.9,0-9.3,0.8-13.3,2.3c-4,1.6-7.4,3.8-10.2,6.6c-2.8,2.9-5,6.3-6.5,10.3c-1.5,4-2.3,8.5-2.3,13.5s0.8,9.4,2.3,13.5
              c1.5,4,3.7,7.5,6.5,10.3c2.8,2.9,6.2,5.1,10.2,6.6c4,1.6,8.4,2.3,13.3,2.3c5,0,9.4-0.8,13.4-2.3c3.9-1.6,7.3-3.8,10.1-6.6
              c2.8-2.9,5-6.3,6.5-10.3c1.5-4,2.3-8.5,2.3-13.5S446.6,124,445.1,120z M415,163.4c-12.4,0-20.9-13.4-20.9-30s8.2-30,20.9-30
              c13,0,20.9,13.4,20.9,30S428,163.4,415,163.4z"/>
          </g>
          <path d="M144.2,133.4h-2.9v0.1C142.3,133.5,143.3,133.5,144.2,133.4z"/>
          <polygon class="st2" points="143.9,97.2 101,109.3 101,113.8 186.8,113.8 186.8,109.3 "/>
          <polygon class="st2" points="104.4,115.4 106,117.6 181.2,117.6 182.6,115.4 "/>
          <path class="st2" d="M125,120.4h-11.8h-0.8h-11.8l-1.5,1.8l6.4,4.6h0.1v34.7h14.6v-34.7h0.1l6.4-4.6L125,120.4z M111.2,157h-2.6
            v-29.2h2.6V157z M117.1,157h-2.6v-29.2h2.6V157z"/>
          <path class="st2" d="M185.3,120.4h-11.8h-0.8h-11.8l-1.5,1.8l6.4,4.6h0.1v34.7h14.6v-34.7h0.1l6.4-4.6L185.3,120.4z M171.4,157h-2.6
            v-29.2h2.6V157z M177.3,157h-2.6v-29.2h2.6V157z"/>
          <path class="st2" d="M155.2,120.4h-11.8h-0.8h-11.8l-1.5,1.8l6.4,4.6h0.1v34.7h14.6v-34.7h0.1l6.4-4.6L155.2,120.4z M141.3,157h-2.6
            v-29.2h2.6V157z M147.2,157h-2.6v-29.2h2.6V157z"/>
          <path class="st1" d="M284.4,150.2h-2.6v0.1C282.7,150.3,283.6,150.3,284.4,150.2z"/>
        </svg>
        </div>
        <!-- Toggle Button -->
        <button
          onclick={() => sidebarCollapsed = !sidebarCollapsed}
          class="p-2 rounded-lg hover:bg-muted transition-colors text-muted-foreground hover:text-primary flex-shrink-0"
          aria-label={sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
        >
          {#if sidebarCollapsed}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
            </svg>
          {:else}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
            </svg>
          {/if}
        </button>
      </div>
      <!-- Navigation -->
      <nav class="flex-1 space-y-2">
        <!-- Following / Relay Selector -->
        <RelaySelector active={path === '/'} collapsed={sidebarCollapsed} />
        <a
          href="/notifications"
          class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'gap-3 px-4 py-3'} rounded-lg transition-colors {path.startsWith('/notifications') ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'}"
          title={sidebarCollapsed ? 'Notifications' : undefined}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          {#if !sidebarCollapsed}
            <span class="font-medium">Notifications</span>
          {/if}
        </a>
        <a
          href="/messages"
          class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'justify-between px-4 py-3'} rounded-lg transition-colors {path.startsWith('/messages') ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'} relative"
          title={sidebarCollapsed ? $t('navigation.messages') : undefined}
        >
          <div class="flex items-center {sidebarCollapsed ? '' : 'gap-3'}">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            {#if !sidebarCollapsed}
              <span class="font-medium">{$t('navigation.messages')}</span>
            {/if}
          </div>
          {#if messagesStore.totalUnreadCount > 0}
            {#if sidebarCollapsed}
              <!-- Badge for collapsed sidebar (top-right of icon) -->
              <div class="absolute top-1.5 right-1.5 min-w-[18px] h-[18px] px-1 rounded-full bg-primary flex items-center justify-center">
                <span class="text-[10px] font-bold text-primary-foreground">
                  {messagesStore.totalUnreadCount > 9 ? '9+' : messagesStore.totalUnreadCount}
                </span>
              </div>
            {:else}
              <!-- Badge for expanded sidebar -->
              <span class="text-xs px-2 py-1 rounded-full bg-primary text-primary-foreground font-medium">
                {messagesStore.totalUnreadCount > 99 ? '99+' : messagesStore.totalUnreadCount}
              </span>
            {/if}
          {/if}
        </a>
        {#if settings.selectedRelay && isAgoraRelay(settings.selectedRelay)}
          <a
            href="/agora/invites"
            class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'gap-3 px-4 py-3'} rounded-lg transition-colors {path.startsWith('/agora/invites') ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'}"
            title={sidebarCollapsed ? 'Community Invites' : undefined}
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            {#if !sidebarCollapsed}
              <span class="font-medium">Community Invites</span>
            {/if}
          </a>
        {/if}
        <a
          href="/packs"
          class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'gap-3 px-4 py-3'} rounded-lg transition-colors {path.startsWith('/packs') ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'}"
          title={sidebarCollapsed ? $t('navigation.followPacks') : undefined}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
          {#if !sidebarCollapsed}
            <span class="font-medium">{$t('navigation.followPacks')}</span>
          {/if}
        </a>
        <a
          href="/wallet"
          class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'justify-between px-4 py-3'} rounded-lg transition-colors {path === '/wallet' ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'}"
          title={sidebarCollapsed ? $t('navigation.wallet') : undefined}
        >
          <div class="flex items-center {sidebarCollapsed ? '' : 'gap-3'}">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3" />
            </svg>
            {#if !sidebarCollapsed}
              <span class="font-medium">{$t('navigation.wallet')}</span>
            {/if}
          </div>
          {#if !sidebarCollapsed}
            <span class="text-xs px-2 py-1 rounded-full bg-primary/20 text-primary font-medium">{formatBalanceLong(wallet.balance)}</span>
          {/if}
        </a>
        <a
          href="/trades"
          class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'gap-3 px-4 py-3'} rounded-lg transition-colors {path === '/trades' ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'}"
          title={sidebarCollapsed ? $t('navigation.trades') : undefined}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
          </svg>
          {#if !sidebarCollapsed}
            <span class="font-medium">{$t('navigation.trades')}</span>
          {/if}
        </a>
        <a
          href="/marketplace"
          class="flex items-center {sidebarCollapsed ? 'justify-center p-3' : 'gap-3 px-4 py-3'} rounded-lg transition-colors {path === '/marketplace' ? 'text-primary bg-primary/10' : 'text-foreground hover:bg-muted'}"
          title={sidebarCollapsed ? $t('navigation.marketplace') : undefined}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          {#if !sidebarCollapsed}
            <span class="font-medium">{$t('navigation.marketplace')}</span>
          {/if}
        </a>
        <button
          onclick={() => {
            if (path === '/marketplace') {
              createListingModal.open();
            } else if (path === '/trades') {
              createTradeModal.open();
            } else if (path.startsWith('/packs')) {
              createPackModal.open();
            } else if (path === '/agora/invites') {
              createInviteModal.open();
            } else if (path === '/' && homePageFilter.selected === 'images') {
              createMediaPostModal.open();
            } else {
              goto('/compose');
            }
          }}
          class="w-full flex items-center justify-center {sidebarCollapsed ? 'p-3' : 'gap-2 px-6 py-3'} bg-primary hover:bg-primary/90 text-foreground font-semibold rounded-full transition-colors mt-4"
          title={sidebarCollapsed ? (path === '/marketplace' ? $t('classifieds.createListing') : path === '/trades' ? 'Create Trade' : path.startsWith('/packs') ? 'Create Pack' : path === '/agora/invites' ? 'Create Invite' : path === '/' && homePageFilter.selected === 'images' ? 'Create media post' : $t('navigation.compose')) : undefined}
        >
          {#if path === '/marketplace'}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            {#if !sidebarCollapsed}
              <span>{$t('classifieds.createListing')}</span>
            {/if}
          {:else if path === '/trades'}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            {#if !sidebarCollapsed}
              <span>Create Trade</span>
            {/if}
          {:else if path.startsWith('/packs')}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            {#if !sidebarCollapsed}
              <span>Create Pack</span>
            {/if}
          {:else if path === '/agora/invites'}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            {#if !sidebarCollapsed}
              <span>Create Invite</span>
            {/if}
          {:else if path === '/' && homePageFilter.selected === 'images'}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            {#if !sidebarCollapsed}
              <span>Create media post</span>
            {/if}
          {:else}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            {#if !sidebarCollapsed}
              <span>{$t('navigation.compose')}</span>
            {/if}
          {/if}
        </button>
      </nav>
      <!-- Login/User Section -->
      <div class="mt-auto pt-4 border-t border-border">
        {#if ndk.$currentUser}
          <UserMenu collapsed={sidebarCollapsed} />
        {:else}
          <LoginButton class="w-full flex items-center justify-center {sidebarCollapsed ? 'p-3' : 'gap-2 px-4 py-3'} bg-primary hover:bg-primary/90 text-primary-foreground font-semibold rounded-full transition-colors" />
        {/if}
      </div>
    </aside>
    <!-- Main Content Container -->
    <div class="flex-1 flex {sidebarCollapsed ? 'lg:ml-20' : 'lg:ml-64'} transition-all duration-300 ease-in-out h-full">
      <!-- Center column - Main content -->
      <div class={`w-full lg:flex-1 ${hideRightSidebar ? 'lg:max-w-[900px]' : 'lg:max-w-[600px]'} min-w-0 flex flex-col h-full border-x border-border`}>
        <!-- Page content -->
        <main class="flex-1 pb-20 lg:pb-0 bg-background max-w-screen overflow-y-auto">
          <!-- Structured Header Config - rendered by Layout for consistency -->
          {#if headerStore.headerConfig}
            <div class="border-b border-border bg-background">
              <div class="px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex items-center gap-3">
                  <!-- Back Button -->
                  {#if headerStore.headerConfig.backNav}
                    {@const backNav = headerStore.headerConfig.backNav}
                    {#if backNav.href}
                      <a
                        href={backNav.href}
                        class="inline-flex items-center justify-center p-2 rounded-lg hover:bg-muted transition-colors text-foreground"
                      >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                      </a>
                    {:else if backNav.onclick}
                      <button
                        onclick={backNav.onclick}
                        class="inline-flex items-center justify-center p-2 rounded-lg hover:bg-muted transition-colors text-foreground"
                      >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                      </button>
                    {/if}
                  {/if}
                  <!-- Title and Subtitle -->
                  <div class="flex-1">
                    <h1 class="text-2xl font-bold text-foreground">
                      {headerStore.headerConfig.title}
                    </h1>
                    {#if headerStore.headerConfig.subtitle}
                      <p class="text-sm text-muted-foreground mt-1">
                        {headerStore.headerConfig.subtitle}
                      </p>
                    {/if}
                  </div>
                  <!-- Actions -->
                  {#if headerStore.headerConfig.actions}
                    {@render headerStore.headerConfig.actions()}
                  {/if}
                  <!-- Mobile-only: Wallet and Notifications -->
                  <div class="lg:hidden flex items-center gap-2">
                    <!-- Notifications -->
                    <a
                      href="/notifications"
                      class="relative flex items-center justify-center p-2 rounded-lg hover:bg-muted transition-colors text-foreground"
                      aria-label="Notifications"
                    >
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                      </svg>
                      {#if notificationsManager.counts.all > 0}
                        <div class="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-primary flex items-center justify-center">
                          <span class="text-[10px] font-bold text-primary-foreground">
                            {notificationsManager.counts.all > 9 ? '9+' : notificationsManager.counts.all}
                          </span>
                        </div>
                      {/if}
                    </a>
                    <!-- Wallet -->
                    <a
                      href="/wallet"
                      class="relative flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg hover:bg-muted transition-colors text-foreground"
                      aria-label="Wallet"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3" />
                      </svg>
                      <span class="text-xs font-medium">{formatBalance(wallet.balance)}</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          {:else if headerStore.header}
            <!-- Custom Header Snippet - for full control -->
            {@render headerStore.header()}
          {:else if headerStore.backNav}
            <!-- Standalone Back Navigation - shown only when no header provided -->
            <div class="border-b border-border bg-background">
              <div class="px-4 sm:px-6 lg:px-8 py-3">
                {#if headerStore.backNav.href}
                  <a
                    href={headerStore.backNav.href}
                    class="inline-flex items-center gap-2 text-foreground hover:text-primary transition-colors"
                  >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    {#if headerStore.backNav.label}
                      <span class="font-medium">{headerStore.backNav.label}</span>
                    {/if}
                  </a>
                {:else if headerStore.backNav.onclick}
                  <button
                    onclick={headerStore.backNav.onclick}
                    class="inline-flex items-center gap-2 text-foreground hover:text-primary transition-colors"
                  >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    {#if headerStore.backNav.label}
                      <span class="font-medium">{headerStore.backNav.label}</span>
                    {/if}
                  </button>
                {/if}
              </div>
            </div>
          {/if}
          <!-- Mobile Sidebar Content - shown before main content on mobile when enabled -->
          {#if sidebarStore.showOnMobile && sidebarStore.rightSidebar && !hideRightSidebar}
            <div class="lg:hidden p-3 border-b border-border bg-background">
              {@render sidebarStore.rightSidebar()}
            </div>
          {/if}
          {@render children()}
        </main>
      </div>
      <!-- Right Sidebar - Widgets -->
      {#if !hideRightSidebar}
        <aside class="hidden lg:block w-80 p-4 space-y-4">
          <div class="sticky top-4 space-y-4">
            {#if sidebarStore.rightSidebar}
              {@render sidebarStore.rightSidebar()}
            {:else}
              <!-- New Members Widget (only shown when a relay is selected) -->
              <NewMembersWidget />
              <!-- Recent Articles Widget -->
              <div class="p-4 bg-card rounded-lg border border-border">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <h2 class="text-lg font-semibold text-card-foreground">{$t('feed.mediaTypes.articles')}</h2>
                </div>
                <div class="space-y-3">
                  {#if recentArticles.length === 0}
                    <div class="h-4 bg-muted rounded animate-pulse"></div>
                    <div class="h-4 bg-muted rounded animate-pulse w-3/4"></div>
                    <div class="h-4 bg-muted rounded animate-pulse"></div>
                  {:else}
                    {#each recentArticles as article (article.id)}
                      <a
                        href={getArticleUrl(article, article.author)}
                        class="block text-sm text-muted-foreground hover:text-primary transition-colors line-clamp-2"
                      >
                        {article.title}
                      </a>
                    {/each}
                  {/if}
                </div>
              </div>
              <!-- Journalists Widget -->
              <JournalistsSidebar />
              <!-- Marketplace Widget -->
              <MarketplaceSidebar />
              <!-- Footer -->
              <div class="text-xs text-muted-foreground space-y-2">
                <div class="flex flex-wrap gap-3">
                  <a href="#" class="hover:text-foreground transition-colors">Terms</a>
                  <a href="#" class="hover:text-foreground transition-colors">Privacy</a>
                  <a href="#" class="hover:text-foreground transition-colors">About</a>
                  <a href="#" class="hover:text-foreground transition-colors">Help</a>
                </div>
                <p>¬© 2024 Agora</p>
              </div>
            {/if}
          </div>
        </aside>
      {/if}
    </div>
  </div>
  <!-- Mobile Bottom Navigation -->
  <MobileBottomNav />
  <!-- Mobile Compose FAB (only on home page, marketplace, and agora invites) -->
  {#if path === '/'}
    <MobileComposeFAB isHomePage={true} />
  {:else if path === '/marketplace'}
    <MobileComposeFAB onclick={() => createListingModal.open()} />
  {:else if path === '/agora/invites'}
    <MobileComposeFAB onclick={() => createInviteModal.open()} />
  {/if}
</div>
</file>

<file path="LoadMoreTrigger.svelte">
<script lang="ts">
  interface Props {
    onIntersect: () => void;
    hasMore: boolean;
    isLoading?: boolean;
  }
  const { onIntersect, hasMore, isLoading = false }: Props = $props();
  let element = $state<HTMLDivElement>();
  $effect(() => {
    if (!element) return;
    const observer = new IntersectionObserver(
      (entries) => {
        const entry = entries[0];
        if (entry.isIntersecting && hasMore && !isLoading) {
          onIntersect();
        }
      },
      {
        rootMargin: '200px', // Trigger 200px before reaching the element
        threshold: 0.1,
      }
    );
    observer.observe(element);
    return () => {
      observer.unobserve(element);
    };
  });
</script>
{#if hasMore}
  <div bind:this={element} class="p-4 text-center">
    {#if isLoading}
      <div class="inline-block w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
    {:else}
      <button
        onclick={onIntersect}
        class="px-4 py-2 text-muted-foreground hover:text-muted-foreground transition-colors"
      >
        Load more
      </button>
    {/if}
  </div>
{/if}
</file>

<file path="LoginButton.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { loginModal } from '$lib/stores/loginModal.svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    class?: string;
  }
  const { class: className = "px-4 py-2 bg-primary hover:bg-accent-dark text-foreground rounded-lg transition-colors font-semibold" }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    const pubkey = ndk.$currentUser?.pubkey;
    if (!pubkey) {
      profile = null;
      return;
    }
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  const displayName = $derived(profile?.name || profile?.displayName || 'Anon');
  function logout() {
    ndk.$sessions.logout();
  }
</script>
{#if ndk.$currentUser}
  <button
    onclick={logout}
    class="flex items-center gap-2 px-4 py-2 bg-muted hover:bg-muted text-foreground rounded-lg transition-colors"
  >
    {#if profile?.image}
      <img src={profile.image} alt={displayName} class="w-6 h-6 rounded-full object-cover" />
    {:else}
      <div class="w-6 h-6 rounded-full bg-primary flex items-center justify-center">
        <span class="text-xs font-bold">{displayName.charAt(0).toUpperCase()}</span>
      </div>
    {/if}
    <span>{displayName}</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
    </svg>
  </button>
{:else}
  <button
    onclick={() => loginModal.open('signup')}
    class={className}
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
    </svg>
    <span>Login</span>
  </button>
{/if}
</file>

<file path="LoginModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { ndk } from '$lib/ndk.svelte';
  import { NDKNip07Signer, NDKPrivateKeySigner } from '@nostr-dev-kit/ndk';
  import { goto } from '$app/navigation';
  import { loginModal } from '$lib/stores/loginModal.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let isLoggingIn = $state(false);
  let loginMethod = $state<'nip07' | 'nsec' | null>(null);
  let nsecInput = $state('');
  let error = $state('');
  async function loginWithNip07() {
    if (!window.nostr) {
      error = 'No Nostr extension found. Please install Alby or nos2x.';
      return;
    }
    try {
      isLoggingIn = true;
      error = '';
      const signer = new NDKNip07Signer();
      await ndk.$sessions.login(signer);
      loginModal.close();
    } catch (err) {
      error = err instanceof Error ? err.message : 'Failed to login';
    } finally {
      isLoggingIn = false;
    }
  }
  async function loginWithNsec() {
    if (!nsecInput.trim()) {
      error = 'Please enter your nsec';
      return;
    }
    try {
      isLoggingIn = true;
      error = '';
      const signer = new NDKPrivateKeySigner(nsecInput.trim());
      await ndk.$sessions.login(signer);
      loginModal.close();
      nsecInput = '';
    } catch (err) {
      error = err instanceof Error ? err.message : 'Invalid nsec';
    } finally {
      isLoggingIn = false;
    }
  }
  function closeModal() {
    loginModal.close();
    loginMethod = null;
    nsecInput = '';
    error = '';
  }
  function handleStartOnboarding() {
    closeModal();
    goto('/onboarding');
  }
</script>
{#if isDesktop.current}
  <Dialog.Root bind:open={loginModal.show}>
    <Dialog.Content
      class={loginModal.state === 'signup' ? 'max-w-lg' : 'max-w-md'}
      onClose={() => loginModal.close()}
    >
        {#if loginModal.state === 'signup'}
          <!-- Signup State - Enticing Welcome Screen -->
          <div class="relative">
            <!-- Hero Banner -->
            <div class="absolute inset-x-0 -mx-6 -mt-6 h-32 bg-primary rounded-t-lg opacity-90"></div>
            <!-- Content -->
            <div class="relative pt-16">
              <Dialog.Header>
                <Dialog.Title class="text-3xl text-center !font-black font-serif">Your Voice Matters</Dialog.Title>
                <Dialog.Description class="text-center text-lg">
                  Join a global community where every story counts
                </Dialog.Description>
              </Dialog.Header>
              <!-- Value Props -->
              <div class="space-y-4 mb-8 mt-6">
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-primary dark:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-1 text-foreground">Own Your Voice</h3>
                    <p class="text-sm text-muted-foreground">
                      No censorship. No gatekeepers. Your content, your control, forever.
                    </p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-1 text-foreground">Earn From Your Stories</h3>
                    <p class="text-sm text-muted-foreground">
                      Get paid instantly in Bitcoin for valuable content. No banks, no fees.
                    </p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-1 text-foreground">Connect With Your Community</h3>
                    <p class="text-sm text-muted-foreground">
                      Trade, share, and build with people who understand your journey.
                    </p>
                  </div>
                </div>
              </div>
              <!-- CTA Buttons -->
              <div class="space-y-3">
                <Button
                  onclick={handleStartOnboarding}
                  class="w-full py-6 text-lg bg-primary hover:opacity-90"
                >
                  Start Your Journey
                  <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                  </svg>
                </Button>
                <Button
                  variant="ghost"
                  onclick={() => loginModal.setState('login')}
                  class="w-full"
                >
                  Already have a Nostr account? <span class="font-semibold underline ml-1">Sign in here</span>
                </Button>
              </div>
            </div>
          </div>
        {:else}
          <!-- Login State - Existing login methods -->
          <Dialog.Header>
            <Dialog.Title>Welcome Back</Dialog.Title>
            <Dialog.Description>Sign in with your existing Nostr account</Dialog.Description>
          </Dialog.Header>
          <div class="space-y-3 pt-4">
            {#if error}
              <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
                {error}
              </div>
            {/if}
            {#if !loginMethod}
              <Button
                variant="outline"
                onclick={() => {
                  loginMethod = 'nip07';
                  loginWithNip07();
                }}
                disabled={isLoggingIn}
                class="w-full p-4 h-auto justify-start"
              >
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                <div class="flex-1 text-left">
                  <div class="font-semibold">Browser Extension (NIP-07)</div>
                  <div class="text-sm text-muted-foreground">Use Alby, nos2x, or similar</div>
                </div>
                {#if isLoggingIn && loginMethod === 'nip07'}
                  <svg class="w-5 h-5 animate-spin ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                {/if}
              </Button>
              <Button
                variant="outline"
                onclick={() => loginMethod = 'nsec'}
                disabled={isLoggingIn}
                class="w-full p-4 h-auto justify-start"
              >
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
                <div class="flex-1 text-left">
                  <div class="font-semibold">Private Key</div>
                  <div class="text-sm text-muted-foreground">Login with your nsec or hex key</div>
                </div>
              </Button>
              <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                  <span class="w-full border-t border-border"></span>
                </div>
                <div class="relative flex justify-center text-xs uppercase">
                  <span class="bg-background px-2 text-muted-foreground">
                    Don't have an account?
                  </span>
                </div>
              </div>
              <Button
                variant="ghost"
                onclick={() => loginModal.setState('signup')}
                class="w-full"
              >
                <span class="font-semibold underline">Create a new account</span>
              </Button>
            {:else if loginMethod === 'nsec'}
              <div class="space-y-4">
                <div class="p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg text-blue-400 text-sm flex gap-2">
                  <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    Enter your private key (nsec or hex format). This will be stored locally in your browser.
                  </div>
                </div>
                <Input
                  type="password"
                  bind:value={nsecInput}
                  placeholder="nsec1... or hex key"
                  disabled={isLoggingIn}
                  onkeydown={(e) => {
                    if (e.key === 'Enter' && nsecInput) {
                      loginWithNsec();
                    }
                  }}
                />
                <div class="flex gap-2">
                  <Button
                    variant="outline"
                    onclick={() => loginMethod = null}
                    disabled={isLoggingIn}
                    class="flex-1"
                  >
                    Back
                  </Button>
                  <Button
                    onclick={loginWithNsec}
                    disabled={isLoggingIn || !nsecInput.trim()}
                    class="flex-1"
                  >
                    {#if isLoggingIn}
                      <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      Logging in...
                    {:else}
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                      </svg>
                      Login
                    {/if}
                  </Button>
                </div>
              </div>
            {/if}
          </div>
        {/if}
      </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root bind:open={loginModal.show}>
    <Drawer.Content onClose={() => loginModal.close()}>
        {#if loginModal.state === 'signup'}
          <!-- Signup State - Enticing Welcome Screen -->
          <div class="relative">
            <!-- Content -->
            <div class="relative">
              <Drawer.Header class="text-left border-b border-border bg-primary/10 pb-6">
                <Drawer.Title class="text-3xl !font-black font-serif">Your Voice Matters</Drawer.Title>
                <Drawer.Description class="text-lg">
                  Join a global community where every story counts
                </Drawer.Description>
              </Drawer.Header>
              <!-- Value Props -->
              <div class="space-y-4 mb-8 mt-6 px-4">
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-primary dark:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-1 text-foreground">Own Your Voice</h3>
                    <p class="text-sm text-muted-foreground">
                      No censorship. No gatekeepers. Your content, your control, forever.
                    </p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-1 text-foreground">Earn From Your Stories</h3>
                    <p class="text-sm text-muted-foreground">
                      Get paid instantly in Bitcoin for valuable content. No banks, no fees.
                    </p>
                  </div>
                </div>
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-1 text-foreground">Connect With Your Community</h3>
                    <p class="text-sm text-muted-foreground">
                      Trade, share, and build with people who understand your journey.
                    </p>
                  </div>
                </div>
              </div>
              <!-- CTA Buttons -->
              <Drawer.Footer class="pt-2">
                <div class="space-y-3">
                  <Button
                    onclick={handleStartOnboarding}
                    class="w-full py-6 text-lg bg-primary hover:opacity-90"
                  >
                    Start Your Journey
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                  </Button>
                  <Button
                    variant="ghost"
                    onclick={() => loginModal.setState('login')}
                    class="w-full"
                  >
                    Already have a Nostr account? <span class="font-semibold underline ml-1">Sign in here</span>
                  </Button>
                </div>
              </Drawer.Footer>
            </div>
          </div>
        {:else}
          <!-- Login State - Existing login methods -->
          <Drawer.Header class="text-left">
            <Drawer.Title>Welcome Back</Drawer.Title>
            <Drawer.Description>Sign in with your existing Nostr account</Drawer.Description>
          </Drawer.Header>
          <div class="space-y-3 pt-4 px-4">
            {#if error}
              <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
                {error}
              </div>
            {/if}
            {#if !loginMethod}
              <Button
                variant="outline"
                onclick={() => {
                  loginMethod = 'nip07';
                  loginWithNip07();
                }}
                disabled={isLoggingIn}
                class="w-full p-4 h-auto justify-start"
              >
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                <div class="flex-1 text-left">
                  <div class="font-semibold">Browser Extension (NIP-07)</div>
                  <div class="text-sm text-muted-foreground">Use Alby, nos2x, or similar</div>
                </div>
                {#if isLoggingIn && loginMethod === 'nip07'}
                  <svg class="w-5 h-5 animate-spin ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                {/if}
              </Button>
              <Button
                variant="outline"
                onclick={() => loginMethod = 'nsec'}
                disabled={isLoggingIn}
                class="w-full p-4 h-auto justify-start"
              >
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
                <div class="flex-1 text-left">
                  <div class="font-semibold">Private Key</div>
                  <div class="text-sm text-muted-foreground">Login with your nsec or hex key</div>
                </div>
              </Button>
              <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                  <span class="w-full border-t border-border"></span>
                </div>
                <div class="relative flex justify-center text-xs uppercase">
                  <span class="bg-background px-2 text-muted-foreground">
                    Don't have an account?
                  </span>
                </div>
              </div>
              <Button
                variant="ghost"
                onclick={() => loginModal.setState('signup')}
                class="w-full"
              >
                <span class="font-semibold underline">Create a new account</span>
              </Button>
            {:else if loginMethod === 'nsec'}
              <div class="space-y-4">
                <div class="p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg text-blue-400 text-sm flex gap-2">
                  <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    Enter your private key (nsec or hex format). This will be stored locally in your browser.
                  </div>
                </div>
                <Input
                  type="password"
                  bind:value={nsecInput}
                  placeholder="nsec1... or hex key"
                  disabled={isLoggingIn}
                  onkeydown={(e) => {
                    if (e.key === 'Enter' && nsecInput) {
                      loginWithNsec();
                    }
                  }}
                />
              </div>
            {/if}
          </div>
          {#if loginMethod === 'nsec'}
            <Drawer.Footer class="pt-2">
              <div class="flex gap-2">
                <Button
                  variant="outline"
                  onclick={() => loginMethod = null}
                  disabled={isLoggingIn}
                  class="flex-1"
                >
                  Back
                </Button>
                <Button
                  onclick={loginWithNsec}
                  disabled={isLoggingIn || !nsecInput.trim()}
                  class="flex-1"
                >
                  {#if isLoggingIn}
                    <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Logging in...
                  {:else}
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    Login
                  {/if}
                </Button>
              </div>
            </Drawer.Footer>
          {/if}
        {/if}
      </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="MarketplaceSidebar.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { NDKKind, NDKSubscriptionCacheUsage } from '@nostr-dev-kit/ndk';
  import { goto } from '$app/navigation';
  import { getRelaysToUse } from '$lib/utils/relayUtils';
  // Get relays to use based on selected relay
  const relaysToUse = $derived(
    getRelaysToUse(
      settings.selectedRelay,
      settings.relays.filter(r => r.enabled && r.read).map(r => r.url)
    )
  );
  // Subscribe to recent marketplace listings
  const subscription = ndk.$subscribe(() => ({
    filters: [{ kinds: [30402 as NDKKind], limit: 5 }], // NDKKind.Classified
    bufferMs: 100,
    relayUrls: relaysToUse.length > 0 ? relaysToUse : undefined,
    cacheUsage: relaysToUse.length > 0 ? NDKSubscriptionCacheUsage.ONLY_RELAY : NDKSubscriptionCacheUsage.PARALLEL,
  }));
  const recentListings = $derived(
    subscription.events
      .filter(event => {
        const status = event.tagValue('status') || 'active';
        return status === 'active';
      })
      .slice(0, 5)
  );
  function getListingImage(listing: typeof subscription.events[0]): string | undefined {
    return listing.tagValue('image');
  }
  function getListingPrice(listing: typeof subscription.events[0]): { amount: string; currency: string } | null {
    const priceTag = listing.tags.find(t => t[0] === 'price');
    if (!priceTag || !priceTag[1] || !priceTag[2]) return null;
    return {
      amount: priceTag[1],
      currency: priceTag[2]
    };
  }
</script>
<div class="bg-card rounded-2xl p-5 border border-border backdrop-blur-sm">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
      </svg>
      <h3 class="text-lg font-semibold text-card-foreground">
        Recent Marketplace
      </h3>
    </div>
    <button
      onclick={() => goto('/marketplace')}
      class="flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors"
    >
      View All
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </button>
  </div>
  <div class="space-y-3">
    {#if recentListings.length === 0}
      <div class="text-center py-6 text-sm text-muted-foreground">
        No marketplace items yet
      </div>
    {:else}
      {#each recentListings as listing (listing.id)}
        {@const price = getListingPrice(listing)}
        <button
          onclick={() => goto(`/marketplace/${listing.encode()}`)}
          class="w-full bg-muted/50 rounded-lg p-3 transition-all hover:bg-muted hover:scale-[1.02] text-left"
        >
          <div class="flex gap-3">
            {#if getListingImage(listing)}
              <div class="w-12 h-12 bg-muted rounded-lg overflow-hidden flex-shrink-0">
                <img
                  src={getListingImage(listing)}
                  alt={listing.tagValue('title') || 'Listing'}
                  class="w-full h-full object-cover"
                />
              </div>
            {/if}
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-card-foreground truncate">
                {listing.tagValue('title') || 'Untitled'}
              </h4>
              {#if price}
                <p class="text-xs text-muted-foreground mt-1">
                  {price.amount} {price.currency}
                </p>
              {/if}
            </div>
          </div>
        </button>
      {/each}
    {/if}
  </div>
</div>
</file>

<file path="MediaGrid.svelte">
<script lang="ts">
  import type { NDKEvent, NDKImetaTag } from '@nostr-dev-kit/ndk';
  import { mapImetaTag } from '@nostr-dev-kit/ndk';
  import MediaViewerModal from './MediaViewerModal.svelte';
  interface Props {
    events: NDKEvent[];
  }
  const { events }: Props = $props();
  let selectedMedia = $state<{ event: NDKEvent; imeta: NDKImetaTag; mediaType: 'image' | 'video' | 'audio' | 'file' } | null>(null);
  function openMediaViewer(event: NDKEvent, imeta: NDKImetaTag, mediaType: 'image' | 'video' | 'audio' | 'file') {
    selectedMedia = { event, imeta, mediaType };
  }
  function closeMediaViewer() {
    selectedMedia = null;
  }
  function extractMediaUrls(content: string): string[] {
    const urlRegex = /(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp|svg|avif|mp4|webm|mov|avi|mkv))/gi;
    return content.match(urlRegex) || [];
  }
  function getMediaType(imeta: NDKImetaTag): 'image' | 'video' | 'audio' | 'file' {
    const mime = imeta.m;
    const url = imeta.url;
    if (mime) {
      if (mime.startsWith('image/')) return 'image';
      if (mime.startsWith('video/')) return 'video';
      if (mime.startsWith('audio/')) return 'audio';
    } else if (url) {
      const ext = url.split('.').pop()?.toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'avif'].includes(ext || '')) return 'image';
      if (['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(ext || '')) return 'video';
      if (['mp3', 'wav', 'ogg', 'flac', 'm4a'].includes(ext || '')) return 'audio';
    }
    return 'file';
  }
  const mediaItems = $derived(events.flatMap(event => {
    const imetaTags = event.tags.filter(tag => tag[0] === 'imeta');
    const imetas = imetaTags.map(tag => mapImetaTag(tag));
    const imetaItems = imetas
      .filter(imeta => imeta.url)
      .map(imeta => ({ event, imeta }));
    if (imetaItems.length > 0) {
      return imetaItems;
    }
    const contentUrls = extractMediaUrls(event.content);
    return contentUrls.map(url => {
      const ext = url.split('.').pop()?.toLowerCase();
      const isVideo = ['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(ext || '');
      return {
        event,
        imeta: {
          url,
          m: isVideo ? 'video/' + ext : 'image/' + ext,
        } as NDKImetaTag
      };
    });
  }));
</script>
{#if mediaItems.length === 0}
  <div class="text-center py-8 text-muted-foreground">
    No media uploaded yet
  </div>
{:else}
  <div class="grid grid-cols-3 gap-1">
    {#each mediaItems as { event, imeta }, index (`${event.id}-${index}`)}
      {@const mediaType = getMediaType(imeta)}
      {@const fileSize = imeta.size ? (parseInt(imeta.size) / (1024 * 1024)).toFixed(1) : null}
      <button
        type="button"
        onclick={() => openMediaViewer(event, imeta, mediaType)}
        class="group relative aspect-square overflow-hidden bg-background cursor-pointer w-full"
      >
        {#if mediaType === 'image'}
          <img
            src={imeta.url}
            alt={imeta.alt || event.content || 'Image'}
            class="w-full h-full object-cover transition-transform group-hover:scale-105"
            loading="lazy"
          />
        {:else if mediaType === 'video'}
          <div class="relative w-full h-full bg-background flex items-center justify-center">
            <video
              src={imeta.url}
              class="max-w-full max-h-full"
              preload="metadata"
            >
              <track kind="captions" />
            </video>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div class="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-neutral-900 ml-1" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </div>
            </div>
          </div>
        {:else if mediaType === 'audio'}
          <div class="w-full h-full bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center">
            <svg class="w-16 h-16 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
          </div>
        {:else}
          <div class="w-full h-full bg-background flex flex-col items-center justify-center gap-2">
            <svg class="w-16 h-16 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            {#if imeta.url}
              <span class="text-xs text-muted-foreground px-2 text-center">
                {imeta.url.split('/').pop()?.substring(0, 20)}...
              </span>
            {/if}
          </div>
        {/if}
        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity">
          {#if event.content}
            <p class="text-foreground text-sm line-clamp-2 mb-1">
              {event.content.trim()}
            </p>
          {/if}
          <div class="flex items-center gap-2 text-foreground/80 text-xs">
            {#if fileSize}
              <span>{fileSize} MB</span>
            {/if}
            {#if imeta.dim}
              <span>{imeta.dim}</span>
            {/if}
          </div>
        </div>
        {#if mediaType !== 'image'}
          <div class="absolute top-2 left-2 bg-background/50 backdrop-blur-sm px-2 py-1 rounded text-foreground text-xs">
            {#if mediaType === 'video'}Video{/if}
            {#if mediaType === 'audio'}Audio{/if}
            {#if mediaType === 'file'}File{/if}
          </div>
        {/if}
      </button>
    {/each}
  </div>
{/if}
{#if selectedMedia}
  <MediaViewerModal
    open={true}
    event={selectedMedia.event}
    imeta={selectedMedia.imeta}
    mediaType={selectedMedia.mediaType}
    onClose={closeMediaViewer}
  />
{/if}
</file>

<file path="MediaTypeFilters.svelte">
<script lang="ts">
  type MediaFilter = 'conversations' | 'images' | 'videos' | 'articles';
  interface Props {
    selectedFilter: MediaFilter;
    onFilterChange: (filter: MediaFilter) => void;
  }
  const { selectedFilter, onFilterChange }: Props = $props();
</script>
<div class="flex justify-around lg:justify-start px-2 lg:px-4 overflow-x-auto">
  <button
    onclick={() => onFilterChange('conversations')}
    class={`flex items-center justify-center lg:justify-start gap-1.5 px-3 lg:px-4 py-3 font-medium whitespace-nowrap ${
      selectedFilter === 'conversations'
        ? 'text-primary border-b-2 border-primary'
        : 'text-muted-foreground hover:text-muted-foreground'
    }`}
    aria-label="Conversations"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
    </svg>
    <span class="hidden lg:inline">Conversations</span>
  </button>
  <button
    onclick={() => onFilterChange('images')}
    class={`flex items-center justify-center lg:justify-start gap-1.5 px-3 lg:px-4 py-3 font-medium whitespace-nowrap ${
      selectedFilter === 'images'
        ? 'text-primary border-b-2 border-primary'
        : 'text-muted-foreground hover:text-muted-foreground'
    }`}
    aria-label="Images"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
    <span class="hidden lg:inline">Images</span>
  </button>
  <button
    onclick={() => onFilterChange('videos')}
    class={`flex items-center justify-center lg:justify-start gap-1.5 px-3 lg:px-4 py-3 font-medium whitespace-nowrap ${
      selectedFilter === 'videos'
        ? 'text-primary border-b-2 border-primary'
        : 'text-muted-foreground hover:text-muted-foreground'
    }`}
    aria-label="Videos"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
    </svg>
    <span class="hidden lg:inline">Videos</span>
  </button>
  <button
    onclick={() => onFilterChange('articles')}
    class={`flex items-center justify-center lg:justify-start gap-1.5 px-3 lg:px-4 py-3 font-medium whitespace-nowrap ${
      selectedFilter === 'articles'
        ? 'text-primary border-b-2 border-primary'
        : 'text-muted-foreground hover:text-muted-foreground'
    }`}
    aria-label="Articles"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <span class="hidden lg:inline">Articles</span>
  </button>
</div>
</file>

<file path="MediaViewerModal.svelte">
<script lang="ts">
  import type { NDKEvent, NDKImetaTag } from '@nostr-dev-kit/ndk';
  import { NDKKind } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { portal } from '$lib/utils/portal.svelte';
  import CommentCard from './CommentCard.svelte';
  import CommentForm from './CommentForm.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { nip19 } from 'nostr-tools';
  import TimeAgo from './TimeAgo.svelte';
  interface Props {
    open: boolean;
    event: NDKEvent;
    imeta: NDKImetaTag;
    mediaType: 'image' | 'video' | 'audio' | 'file';
    onClose: () => void;
  }
  const { open, event, imeta, mediaType, onClose }: Props = $props();
  let errorMessage = $state('');
  let showComments = $state(false);
  let startY = $state(0);
  let currentY = $state(0);
  let isDragging = $state(false);
  const commentsSubscription = ndk.$subscribe(() => {
    if (!open || !event.id) return undefined;
    return {
      filters: [{
        kinds: [NDKKind.Text],
        '#e': [event.id]
      }],
      bufferMs: 100
    };
  });
  const comments = $derived.by(() => {
    return [...commentsSubscription.events].sort((a, b) => (a.created_at || 0) - (b.created_at || 0));
  });
  const isLoadingComments = $derived(!commentsSubscription.eosed);
  let profile = $state<import('@nostr-dev-kit/ndk').NDKUserProfile | null>(null);
  $effect(() => {
    event.author.fetchProfile().then(p => { profile = p; });
  });
  const displayName = $derived(profile?.name || profile?.displayName || 'Anonymous');
  const npub = $derived(nip19.npubEncode(event.pubkey));
  function addComment(comment: NDKEvent) {
    // The subscription will automatically pick up the new comment
  }
  function handleError(error: string) {
    errorMessage = error;
    setTimeout(() => errorMessage = '', 5000);
  }
  function navigateToProfile() {
    window.location.href = `/p/${npub}`;
  }
  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape') {
      onClose();
    }
  }
  function handleTouchStart(e: TouchEvent) {
    startY = e.touches[0].clientY;
    isDragging = true;
  }
  function handleTouchMove(e: TouchEvent) {
    if (!isDragging) return;
    currentY = e.touches[0].clientY;
    const diff = currentY - startY;
    // Only allow pull-up gesture when not showing comments
    if (!showComments && diff < -50) {
      showComments = true;
      isDragging = false;
    }
    // Allow pull-down to hide comments
    else if (showComments && diff > 50) {
      showComments = false;
      isDragging = false;
    }
  }
  function handleTouchEnd() {
    isDragging = false;
  }
  $effect(() => {
    if (open) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
  });
</script>
{#if open}
  <div
    use:portal
    class="fixed inset-0 z-[9999] bg-black"
    role="dialog"
    aria-modal="true"
  >
    <!-- Desktop Layout (md and up) -->
    <div class="hidden md:flex items-center justify-center h-full w-full">
      <!-- Close button (top-left, outside content) -->
      <button
        onclick={onClose}
        class="absolute top-6 left-6 z-[10000] w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm transition-colors flex items-center justify-center"
        type="button"
        aria-label="Close"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <div
        class="relative w-full h-full flex max-w-[1600px] mx-auto"
        onclick={(e) => e.stopPropagation()}
        onkeydown={handleKeydown}
        tabindex="0"
      >
        <!-- Left side - Media (takes most space) -->
        <div class="flex-1 flex items-center justify-center p-8 bg-black min-w-0">
          {#if mediaType === 'image'}
            <img
              src={imeta.url}
              alt={imeta.alt || event.content || 'Image'}
              class="max-w-full max-h-full object-contain"
              onclick={onClose}
            />
          {:else if mediaType === 'video'}
            <video
              src={imeta.url}
              controls
              class="max-w-full max-h-full object-contain"
            >
              <track kind="captions" />
            </video>
          {:else if mediaType === 'audio'}
            <div class="w-full max-w-md p-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg">
              <audio src={imeta.url} controls class="w-full"></audio>
            </div>
          {/if}
        </div>
        <!-- Right side - Comments (fixed width) -->
        <div class="w-[400px] bg-[#1a1a1a] border-l border-neutral-800 flex flex-col shrink-0">
          <!-- Header -->
          <div class="border-b border-neutral-800 p-4">
            <div class="flex items-start gap-3">
              <button type="button" onclick={navigateToProfile} class="flex-shrink-0">
                <Avatar {ndk} pubkey={event.pubkey} class="w-10 h-10 cursor-pointer hover:opacity-80 transition-opacity" />
              </button>
              <div class="flex-1 min-w-0">
                <button type="button" onclick={navigateToProfile} class="hover:underline">
                  <p class="font-semibold text-white">{displayName}</p>
                </button>
                {#if event.created_at}
                  <TimeAgo timestamp={event.created_at} class="text-sm text-gray-400" />
                {/if}
              </div>
            </div>
            {#if event.content}
              <p class="mt-3 text-gray-200 text-sm whitespace-pre-wrap break-words">{event.content}</p>
            {/if}
          </div>
          <!-- Comments list -->
          <div class="flex-1 overflow-y-auto">
            {#if isLoadingComments}
              <div class="flex items-center justify-center p-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
              </div>
            {:else if comments.length === 0}
              <div class="flex flex-col items-center justify-center p-8 text-center">
                <svg class="w-12 h-12 text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p class="text-gray-400 text-sm">No comments yet</p>
                <p class="text-gray-500 text-xs mt-1">Be the first to comment!</p>
              </div>
            {:else}
              <div class="divide-y divide-neutral-800">
                {#each comments as comment (comment.id)}
                  <div class="p-4">
                    <CommentCard event={comment} />
                  </div>
                {/each}
              </div>
            {/if}
          </div>
          <!-- Comment form -->
          <div class="border-t border-neutral-800 p-4 bg-[#1a1a1a]">
            {#if errorMessage}
              <div class="mb-3 p-2 bg-red-500/10 border border-red-500/20 rounded text-red-400 text-sm">
                {errorMessage}
              </div>
            {/if}
            <CommentForm article={event as any} onCommentPublished={addComment} onError={handleError} />
          </div>
        </div>
      </div>
    </div>
    <!-- Mobile Layout -->
    <div class="md:hidden flex flex-col h-full relative">
      <!-- Close button -->
      <button
        onclick={onClose}
        class="absolute top-4 left-4 z-50 w-10 h-10 rounded-full bg-black/50 backdrop-blur-sm transition-colors flex items-center justify-center"
        type="button"
        aria-label="Close"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <!-- Media Container -->
      <div
        class="flex-1 flex flex-col items-center justify-center bg-black overflow-hidden relative"
        ontouchstart={handleTouchStart}
        ontouchmove={handleTouchMove}
        ontouchend={handleTouchEnd}
      >
        {#if mediaType === 'image'}
          <img
            src={imeta.url}
            alt={imeta.alt || event.content || 'Image'}
            class="w-full h-full object-contain"
          />
        {:else if mediaType === 'video'}
          <video
            src={imeta.url}
            controls
            class="w-full h-full object-contain"
          >
            <track kind="captions" />
          </video>
        {:else if mediaType === 'audio'}
          <div class="w-full max-w-md p-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg mx-4">
            <audio src={imeta.url} controls class="w-full"></audio>
          </div>
        {/if}
        <!-- Post info overlay -->
        <div class="absolute top-16 left-0 right-0 p-4 bg-gradient-to-b from-black/60 to-transparent">
          <div class="flex items-start gap-3">
            <button type="button" onclick={navigateToProfile} class="flex-shrink-0">
              <Avatar {ndk} pubkey={event.pubkey} class="w-10 h-10 cursor-pointer hover:opacity-80 transition-opacity" />
            </button>
            <div class="flex-1 min-w-0">
              <button type="button" onclick={navigateToProfile} class="hover:underline">
                <p class="font-semibold text-white">{displayName}</p>
              </button>
              {#if event.created_at}
                <TimeAgo timestamp={event.created_at} class="text-sm text-white/70" />
              {/if}
            </div>
          </div>
          {#if event.content}
            <p class="mt-3 text-white text-sm whitespace-pre-wrap break-words">{event.content}</p>
          {/if}
        </div>
        <!-- Comments button -->
        {#if !showComments}
          <div class="absolute bottom-4 left-0 right-0 flex justify-center px-4">
            <button
              onclick={() => showComments = true}
              class="flex items-center gap-2 px-6 py-3 bg-white/90 hover:bg-white rounded-full transition-colors shadow-lg"
              type="button"
            >
              <svg class="w-5 h-5 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <span class="text-gray-900 font-medium">
                {#if comments.length > 0}
                  View {comments.length} {comments.length === 1 ? 'Comment' : 'Comments'}
                {:else}
                  Add Comment
                {/if}
              </span>
            </button>
          </div>
        {/if}
      </div>
      <!-- Comments Panel (slides up from bottom) -->
      <div
        class="absolute inset-x-0 bottom-0 bg-background flex flex-col transition-transform duration-300 ease-out {showComments ? 'translate-y-0' : 'translate-y-full'}"
        style="height: 80vh; border-top-left-radius: 16px; border-top-right-radius: 16px;"
        ontouchstart={handleTouchStart}
        ontouchmove={handleTouchMove}
        ontouchend={handleTouchEnd}
      >
        <!-- Drag handle -->
        <div class="flex justify-center py-3 border-b border-border">
          <div class="w-12 h-1 bg-muted-foreground/30 rounded-full"></div>
        </div>
        <!-- Comments header -->
        <div class="px-4 py-3 border-b border-border flex items-center justify-between">
          <h3 class="font-semibold text-foreground">
            {comments.length} {comments.length === 1 ? 'Comment' : 'Comments'}
          </h3>
          <button
            onclick={() => showComments = false}
            class="text-muted-foreground hover:text-foreground"
            type="button"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>
        <!-- Comments list -->
        <div class="flex-1 overflow-y-auto">
          {#if isLoadingComments}
            <div class="flex items-center justify-center p-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>
          {:else if comments.length === 0}
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <svg class="w-12 h-12 text-muted-foreground mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <p class="text-muted-foreground text-sm">No comments yet</p>
              <p class="text-muted-foreground text-xs mt-1">Be the first to comment!</p>
            </div>
          {:else}
            <div class="divide-y divide-border">
              {#each comments as comment (comment.id)}
                <div class="p-4">
                  <CommentCard event={comment} />
                </div>
              {/each}
            </div>
          {/if}
        </div>
        <!-- Comment form -->
        <div class="border-t border-border p-4 bg-background">
          {#if errorMessage}
            <div class="mb-3 p-2 bg-red-500/10 border border-red-500/20 rounded text-red-400 text-sm">
              {errorMessage}
            </div>
          {/if}
          <CommentForm article={event as any} onCommentPublished={addComment} onError={handleError} />
        </div>
      </div>
    </div>
  </div>
{/if}
</file>

<file path="Mention.svelte">
<script lang="ts">
  import type { NDKSvelte, NDKUser, NDKUserProfile } from '@nostr-dev-kit/ndk';
  import { Avatar } from '@nostr-dev-kit/svelte';
  interface Props {
    ndk: NDKSvelte;
    bech32: string;
    onClick?: (bech32: string) => void;
    class?: string;
  }
  let {
    ndk,
    bech32,
    onClick,
    class: className = '',
  }: Props = $props();
  let user = $state<NDKUser | undefined>(undefined);
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    if (!ndk || !bech32) {
      user = undefined;
      profile = null;
      return;
    }
    ndk.fetchUser(bech32).then(u => {
      user = u;
      if (u?.pubkey) {
        u.fetchProfile().then(p => { profile = p; });
      }
    });
  });
  const displayName = $derived.by(() => {
    if (profile?.displayName) return profile.displayName.slice(0, 48);
    if (profile?.name) return profile.name.slice(0, 48);
    return `${bech32.slice(0, 12)}...`;
  });
  function handleClick(e: MouseEvent) {
    if (onClick) {
      e.preventDefault();
      e.stopPropagation();
      onClick(bech32);
    }
  }
</script>
{#if !user || !user.pubkey}
  <span class="inline-flex items-center gap-1 text-primary font-medium {className}">
    {bech32.slice(0, 12)}
  </span>
{:else}
  <a
    href={`/p/${bech32}`}
    class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-primary/10 hover:bg-primary/15 text-primary font-medium transition-colors no-underline {className}"
    onclick={handleClick}
  >
    <Avatar {ndk} pubkey={user.pubkey} size={16} class="flex-shrink-0" />
    <span class="text-sm">{displayName}</span>
  </a>
{/if}
</file>

<file path="MentionPicker.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { portal } from '$lib/utils/portal.svelte';
  import { nip19 } from 'nostr-tools';
  import MentionPickerItem from './MentionPickerItem.svelte';
  interface Props {
    position: { top: number; left: number };
    searchQuery: string;
    onSelect: (nprofile: string) => void;
    onClose: () => void;
  }
  let { position, searchQuery, onSelect, onClose }: Props = $props();
  let selectedIndex = $state(0);
  // Fetch current user's follows
  const contactListSubscription = ndk.$subscribe(
    () => ndk.$currentUser?.pubkey ? ({
      filters: [{ kinds: [3], authors: [ndk.$currentUser.pubkey], limit: 1 }],
      bufferMs: 100,
    }) : undefined
  );
  const userFollows = $derived.by(() => {
    const contactList = contactListSubscription.events[0];
    if (!contactList) return new Set<string>();
    return new Set(contactList.tags.filter(tag => tag[0] === 'p').map(tag => tag[1]));
  });
  let cachedFilteredProfiles = $state<Map<string, { name?: string; displayName?: string; nip05?: string }>>(new Map());
  const filteredFollows = $derived.by(() => {
    if (!searchQuery) return Array.from(userFollows).slice(0, 10);
    const filtered = Array.from(cachedFilteredProfiles.entries())
      .filter(([pubkey]) => userFollows.has(pubkey))
      .map(([pubkey]) => pubkey);
    return filtered.slice(0, 10);
  });
  // Update cached profiles when search query changes
  $effect(() => {
    if (!searchQuery.trim() || !ndk.cacheAdapter?.getProfiles) {
      cachedFilteredProfiles = new Map();
      return;
    }
    const search = searchQuery.toLowerCase();
    ndk.cacheAdapter.getProfiles({
      fields: ['name', 'displayName', 'nip05'],
      contains: search
    }).then((profiles) => {
      cachedFilteredProfiles = profiles ?? new Map();
    }).catch(err => {
      console.error('Failed to search profiles:', err);
      cachedFilteredProfiles = new Map();
    });
  });
  // Reset selected index when filtered list changes
  $effect(() => {
    if (selectedIndex >= filteredFollows.length) {
      selectedIndex = Math.max(0, filteredFollows.length - 1);
    }
  });
  function handleSelect(pubkey: string) {
    // Get relays for this user
    const user = ndk.getUser({ pubkey });
    const relays = Array.from(user.relayUrls || []);
    // Create nprofile with relays
    const nprofile = nip19.nprofileEncode({
      pubkey,
      relays: relays.slice(0, 3) // Include up to 3 relays
    });
    onSelect(`nostr:${nprofile}`);
  }
  function handleKeydown(event: KeyboardEvent) {
    switch (event.key) {
      case 'ArrowDown':
        event.preventDefault();
        selectedIndex = (selectedIndex + 1) % filteredFollows.length;
        break;
      case 'ArrowUp':
        event.preventDefault();
        selectedIndex = selectedIndex === 0 ? filteredFollows.length - 1 : selectedIndex - 1;
        break;
      case 'Enter':
        event.preventDefault();
        if (filteredFollows.length > 0) {
          handleSelect(filteredFollows[selectedIndex]);
        }
        break;
      case 'Escape':
        event.preventDefault();
        onClose();
        break;
    }
  }
</script>
<svelte:window onkeydown={handleKeydown} />
{#if filteredFollows.length > 0}
  <div
    use:portal
    style="position: fixed; top: {position.top}px; left: {position.left}px; max-width: 320px;"
    class="bg-card border border-border rounded-lg shadow-xl z-[1003] overflow-hidden"
  >
    <div class="max-h-[300px] overflow-y-auto">
      {#each filteredFollows as pubkey, index (pubkey)}
        <MentionPickerItem
          {pubkey}
          isSelected={index === selectedIndex}
          onSelect={handleSelect}
          onMouseEnter={() => selectedIndex = index}
        />
      {/each}
    </div>
  </div>
{/if}
</file>

<file path="MentionPickerItem.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
    isSelected: boolean;
    onSelect: (pubkey: string) => void;
    onMouseEnter: () => void;
  }
  let { pubkey, isSelected, onSelect, onMouseEnter }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
</script>
<button
  type="button"
  onclick={() => onSelect(pubkey)}
  onmouseenter={onMouseEnter}
  class={`w-full flex items-center gap-2 p-2 transition-colors ${
    isSelected ? 'bg-primary/20' : 'hover:bg-muted'
  }`}
>
  <Avatar {ndk} {pubkey} size={32} class="flex-shrink-0" />
  <div class="flex-1 min-w-0 text-left">
    <div class="text-sm font-medium text-foreground truncate">
      {profile?.displayName || profile?.name || 'Anonymous'}
    </div>
    {#if profile?.nip05}
      <div class="text-xs text-muted-foreground truncate">
        {profile.nip05}
      </div>
    {/if}
  </div>
</button>
</file>

<file path="MissingEventCard.svelte">
<script lang="ts">
  import { nip19 } from 'nostr-tools';
  import MissingEventModal from './MissingEventModal.svelte';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  interface Props {
    eventId: string;
    relayHint?: string;
    showThreadLine?: boolean;
    onEventFound?: (event: NDKEvent) => void;
  }
  let { eventId, relayHint, showThreadLine = false, onEventFound }: Props = $props();
  let showModal = $state(false);
  const neventId = $derived.by(() => {
    try {
      return nip19.neventEncode({
        id: eventId,
        relays: relayHint ? [relayHint] : []
      });
    } catch {
      return eventId;
    }
  });
</script>
<article
  class="p-3 sm:p-4 bg-muted/10 border-b border-border relative min-w-0"
>
  {#if showThreadLine}
    <div class="absolute left-[29px] -top-px h-[73px] w-0.5 bg-muted"></div>
    <div class="absolute left-[29px] top-[73px] bottom-0 w-0.5 bg-muted"></div>
  {/if}
  <div class="p-4 border border-dashed border-muted-foreground/30 rounded-lg bg-muted/20">
    <div class="flex items-start gap-3">
      <!-- Icon -->
      <div class="flex-shrink-0 mt-0.5">
        <svg class="w-6 h-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <!-- Content -->
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium text-foreground mb-1">
          Missing Parent Event
        </p>
        <p class="text-xs text-muted-foreground mb-2">
          This note is replying to an event that couldn't be found on the default relays.
        </p>
        {#if neventId}
          <p class="text-xs text-muted-foreground/70 font-mono truncate mb-3 bg-background/50 p-2 rounded">
            {neventId.slice(0, 40)}...
          </p>
        {/if}
        <button
          type="button"
          onclick={() => showModal = true}
          class="text-sm text-primary hover:text-primary/80 underline transition-colors flex items-center gap-1"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          Try fetching from other relays
        </button>
      </div>
    </div>
  </div>
</article>
<!-- Missing Event Modal -->
{#if showModal}
  <MissingEventModal
    {eventId}
    {relayHint}
    bind:show={showModal}
    {onEventFound}
  />
{/if}
</file>

<file path="MissingEventModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { nip19 } from 'nostr-tools';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    eventId: string;
    relayHint?: string;
    show: boolean;
    onEventFound?: (event: NDKEvent) => void;
  }
  let { eventId, relayHint, show = $bindable(), onEventFound }: Props = $props();
  let customRelayUrl = $state('');
  let relaysToTry = $state<string[]>(relayHint ? [relayHint] : []);
  let isFetching = $state(false);
  let fetchError = $state('');
  let fetchSuccess = $state(false);
  const neventId = $derived.by(() => {
    try {
      return nip19.neventEncode({
        id: eventId,
        relays: relayHint ? [relayHint] : []
      });
    } catch {
      return eventId;
    }
  });
  function addRelay() {
    const url = customRelayUrl.trim();
    if (!url) return;
    // Basic validation
    if (!url.startsWith('wss://') && !url.startsWith('ws://')) {
      fetchError = 'Relay URL must start with wss:// or ws://';
      return;
    }
    if (relaysToTry.includes(url)) {
      fetchError = 'This relay is already in the list';
      return;
    }
    relaysToTry = [...relaysToTry, url];
    customRelayUrl = '';
    fetchError = '';
  }
  function removeRelay(url: string) {
    relaysToTry = relaysToTry.filter(r => r !== url);
  }
  async function tryFetchEvent() {
    if (relaysToTry.length === 0) {
      fetchError = 'Please add at least one relay URL';
      return;
    }
    isFetching = true;
    fetchError = '';
    fetchSuccess = false;
    try {
      // Create a relay set from the relay URLs
      const relaySet = await import('@nostr-dev-kit/ndk').then(({ NDKRelaySet }) =>
        NDKRelaySet.fromRelayUrls(relaysToTry, ndk)
      );
      // Try to fetch the event from the specified relays
      const event = await ndk.fetchEvent(
        { ids: [eventId] },
        { closeOnEose: true },
        relaySet
      );
      if (event) {
        fetchSuccess = true;
        onEventFound?.(event);
        setTimeout(() => {
          show = false;
        }, 1000);
      } else {
        fetchError = 'Event not found on the specified relays';
      }
    } catch (error) {
      console.error('Error fetching event:', error);
      fetchError = error instanceof Error ? error.message : 'Failed to fetch event';
    } finally {
      isFetching = false;
    }
  }
  function handleKeyDown(e: KeyboardEvent) {
    if (e.key === 'Enter') {
      addRelay();
    }
  }
</script>
{#if isDesktop.current}
  <Dialog.Root bind:open={show}>
    <Dialog.Content class="max-w-2xl" onClose={() => show = false}>
      <Dialog.Header>
        <Dialog.Title>Missing Event Explorer</Dialog.Title>
        <Dialog.Description>
          This event couldn't be found on the default relays. Try adding relay URLs where it might be stored.
        </Dialog.Description>
      </Dialog.Header>
      <div class="space-y-4">
        <!-- Event ID Display -->
        <div class="p-3 bg-muted/50 rounded-lg border border-border">
          <div class="text-xs text-muted-foreground mb-1 font-medium">Event ID (nevent)</div>
          <div class="font-mono text-xs break-all text-foreground">
            {neventId}
          </div>
        </div>
        <!-- Add Relay Input -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-foreground">
            Add Relay URL
          </label>
          <div class="flex gap-2">
            <Input
              type="text"
              bind:value={customRelayUrl}
              placeholder="wss://relay.example.com"
              disabled={isFetching}
              onkeydown={handleKeyDown}
              class="flex-1"
            />
            <Button
              type="button"
              onclick={addRelay}
              disabled={isFetching || !customRelayUrl.trim()}
              variant="outline"
            >
              Add
            </Button>
          </div>
          <p class="text-xs text-muted-foreground">
            Enter relay URLs where this event might be stored (e.g., wss://relay.damus.io)
          </p>
        </div>
        <!-- Relays List -->
        {#if relaysToTry.length > 0}
          <div class="space-y-2">
            <div class="text-sm font-medium text-foreground">
              Relays to search ({relaysToTry.length})
            </div>
            <div class="max-h-40 overflow-y-auto space-y-1">
              {#each relaysToTry as relay}
                <div class="flex items-center justify-between p-2 bg-muted/30 rounded border border-border text-sm">
                  <span class="font-mono text-xs truncate flex-1 mr-2">{relay}</span>
                  <button
                    type="button"
                    onclick={() => removeRelay(relay)}
                    disabled={isFetching}
                    class="text-muted-foreground hover:text-destructive transition-colors p-1"
                    aria-label="Remove relay"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              {/each}
            </div>
          </div>
        {/if}
        <!-- Error Message -->
        {#if fetchError}
          <div class="p-3 bg-destructive/10 border border-destructive/20 rounded-lg text-destructive text-sm flex gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{fetchError}</span>
          </div>
        {/if}
        <!-- Success Message -->
        {#if fetchSuccess}
          <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-600 dark:text-green-400 text-sm flex gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Event found! Loading...</span>
          </div>
        {/if}
      </div>
      <Dialog.Footer>
        <Button
          type="button"
          variant="outline"
          onclick={() => show = false}
          disabled={isFetching}
        >
          Cancel
        </Button>
        <Button
          type="button"
          onclick={tryFetchEvent}
          disabled={isFetching || relaysToTry.length === 0 || fetchSuccess}
        >
          {#if isFetching}
            <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Searching...
          {:else}
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            Search for Event
          {/if}
        </Button>
      </Dialog.Footer>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root bind:open={show}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>Missing Event Explorer</Drawer.Title>
        <Drawer.Description>
          This event couldn't be found on the default relays. Try adding relay URLs where it might be stored.
        </Drawer.Description>
      </Drawer.Header>
      <div class="space-y-4 px-4">
        <!-- Event ID Display -->
        <div class="p-3 bg-muted/50 rounded-lg border border-border">
          <div class="text-xs text-muted-foreground mb-1 font-medium">Event ID (nevent)</div>
          <div class="font-mono text-xs break-all text-foreground">
            {neventId}
          </div>
        </div>
        <!-- Add Relay Input -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-foreground">
            Add Relay URL
          </label>
          <div class="flex gap-2">
            <Input
              type="text"
              bind:value={customRelayUrl}
              placeholder="wss://relay.example.com"
              disabled={isFetching}
              onkeydown={handleKeyDown}
              class="flex-1"
            />
            <Button
              type="button"
              onclick={addRelay}
              disabled={isFetching || !customRelayUrl.trim()}
              variant="outline"
            >
              Add
            </Button>
          </div>
          <p class="text-xs text-muted-foreground">
            Enter relay URLs where this event might be stored (e.g., wss://relay.damus.io)
          </p>
        </div>
        <!-- Relays List -->
        {#if relaysToTry.length > 0}
          <div class="space-y-2">
            <div class="text-sm font-medium text-foreground">
              Relays to search ({relaysToTry.length})
            </div>
            <div class="max-h-40 overflow-y-auto space-y-1">
              {#each relaysToTry as relay}
                <div class="flex items-center justify-between p-2 bg-muted/30 rounded border border-border text-sm">
                  <span class="font-mono text-xs truncate flex-1 mr-2">{relay}</span>
                  <button
                    type="button"
                    onclick={() => removeRelay(relay)}
                    disabled={isFetching}
                    class="text-muted-foreground hover:text-destructive transition-colors p-1"
                    aria-label="Remove relay"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              {/each}
            </div>
          </div>
        {/if}
        <!-- Error Message -->
        {#if fetchError}
          <div class="p-3 bg-destructive/10 border border-destructive/20 rounded-lg text-destructive text-sm flex gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{fetchError}</span>
          </div>
        {/if}
        <!-- Success Message -->
        {#if fetchSuccess}
          <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-600 dark:text-green-400 text-sm flex gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Event found! Loading...</span>
          </div>
        {/if}
      </div>
      <Drawer.Footer class="pt-2">
        <div class="flex gap-3">
          <Button
            type="button"
            variant="outline"
            onclick={() => show = false}
            disabled={isFetching}
            class="flex-1"
          >
            Cancel
          </Button>
          <Button
            type="button"
            onclick={tryFetchEvent}
            disabled={isFetching || relaysToTry.length === 0 || fetchSuccess}
            class="flex-1"
          >
            {#if isFetching}
              <svg class="w-4 h-4 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Searching...
            {:else}
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              Search for Event
            {/if}
          </Button>
        </div>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="MobileBottomNav.svelte">
<script lang="ts">
  import { page } from '$app/stores';
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { loginModal } from '$lib/stores/loginModal.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { messagesStore } from '$lib/stores/messages.svelte';
  import { goto } from '$app/navigation';
  import { t } from 'svelte-i18n';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  const currentPath = $derived($page.url.pathname);
  const isActive = (path: string) => {
    if (path === '/') return currentPath === '/';
    return currentPath.startsWith(path);
  };
  const selectedRelayInfo = $derived.by(() => {
    if (!settings.selectedRelay) return null;
    return useRelayInfoCached(settings.selectedRelay);
  });
  let showDropdown = $state(false);
  let dropdownRef: HTMLDivElement | undefined = $state();
  let buttonRef: HTMLButtonElement | undefined = $state();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    const pubkey = ndk.$currentUser?.pubkey;
    if (!pubkey) {
      profile = null;
      return;
    }
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  const displayName = $derived(profile?.displayName || profile?.name || 'Anonymous');
  const npub = $derived(ndk.$currentUser?.npub);
  function handleProfileClick() {
    if (ndk.$currentUser) {
      showDropdown = !showDropdown;
    } else {
      loginModal.open('signup');
    }
  }
  function closeDropdown() {
    showDropdown = false;
  }
  function handleLogout() {
    ndk.$sessions.logout();
    closeDropdown();
  }
  function navigateToProfile() {
    if (npub) {
      goto(`/p/${npub}`);
      closeDropdown();
    }
  }
  function navigateToSettings() {
    goto('/settings');
    closeDropdown();
  }
  function toggleTheme() {
    const currentTheme = settings.theme;
    if (currentTheme === 'light') {
      settings.setTheme('dark');
    } else if (currentTheme === 'dark') {
      settings.setTheme('system');
    } else {
      settings.setTheme('light');
    }
  }
  $effect(() => {
    if (!showDropdown) return;
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef && !dropdownRef.contains(event.target as Node) &&
          buttonRef && !buttonRef.contains(event.target as Node)) {
        showDropdown = false;
      }
    };
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  });
</script>
<nav class="block lg:hidden fixed bottom-0 left-0 right-0 bg-background/95 backdrop-blur-xl border-t border-border z-[1000]">
  <div class="flex justify-around items-center px-2 py-3 safe-bottom">
    <!-- Home / Relay Icon -->
    <a
      href="/"
      class="flex items-center justify-center p-3 rounded-lg transition-colors {isActive('/') ? 'text-primary' : 'text-muted-foreground'}"
      aria-label="Home"
    >
      {#if settings.selectedRelay && selectedRelayInfo?.info?.icon}
        <!-- Relay icon -->
        <img src={selectedRelayInfo.info.icon} alt="" class="w-6 h-6 rounded" />
      {:else if settings.selectedRelay}
        <!-- Fallback relay icon -->
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
        </svg>
      {:else}
        <!-- Following - people icon -->
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      {/if}
    </a>
    <!-- Messages -->
    <a
      href="/messages"
      class="flex items-center justify-center p-3 rounded-lg transition-colors {isActive('/messages') ? 'text-primary' : 'text-muted-foreground'} relative"
      aria-label="Messages"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      {#if messagesStore.totalUnreadCount > 0}
        <div class="absolute top-1.5 right-1.5 min-w-[18px] h-[18px] px-1 rounded-full bg-primary flex items-center justify-center">
          <span class="text-[10px] font-bold text-primary-foreground">
            {messagesStore.totalUnreadCount > 9 ? '9+' : messagesStore.totalUnreadCount}
          </span>
        </div>
      {/if}
    </a>
    <!-- Profile / User Menu -->
    <button
      bind:this={buttonRef}
      onclick={handleProfileClick}
      class="flex items-center justify-center p-2 rounded-lg transition-colors"
      aria-label="Profile"
    >
      {#if ndk.$currentUser}
        <Avatar {ndk} pubkey={ndk.$currentUser.pubkey} class="w-8 h-8 rounded-full" />
      {:else}
        <svg class="w-6 h-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      {/if}
    </button>
  </div>
</nav>
<!-- Dropdown Menu (Same as Desktop UserMenu) -->
{#if showDropdown && buttonRef && ndk.$currentUser}
  {#key showDropdown}
    <svelte:element this={'div'} style="display: contents">
      <div
        bind:this={dropdownRef}
        class="w-56 bg-popover border border-border rounded-lg shadow-xl overflow-hidden"
        style="position: fixed; bottom: {window.innerHeight - buttonRef.getBoundingClientRect().top + 8}px; left: {buttonRef.getBoundingClientRect().left - 224 + buttonRef.getBoundingClientRect().width}px; z-index: 9999;"
      >
        <!-- Profile Link -->
        <button
          onclick={navigateToProfile}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left"
        >
          <Avatar {ndk} pubkey={ndk.$currentUser.pubkey} class="w-12 h-12" />
          <div class="flex-1 min-w-0">
            <p class="font-medium text-sm truncate text-popover-foreground">
              {displayName}
            </p>
            <p class="text-xs text-muted-foreground">{$t('profile.editProfile')}</p>
          </div>
        </button>
        <div class="h-px bg-border"></div>
        <!-- Theme Toggle -->
        <button
          onclick={toggleTheme}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left text-popover-foreground"
        >
          {#if settings.theme === 'light'}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <span>{$t('settings.sections.appearance.themes.light')}</span>
          {:else if settings.theme === 'dark'}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <span>{$t('settings.sections.appearance.themes.dark')}</span>
          {:else}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span>{$t('settings.sections.appearance.themes.system')}</span>
          {/if}
        </button>
        <!-- Settings Link -->
        <button
          onclick={navigateToSettings}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left text-popover-foreground"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span>{$t('navigation.settings')}</span>
        </button>
        <div class="h-px bg-border"></div>
        <!-- Logout Button -->
        <button
          onclick={handleLogout}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left text-destructive hover:text-destructive/90"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>{$t('navigation.logout')}</span>
        </button>
      </div>
    </svelte:element>
  {/key}
{/if}
<style>
  /* Support for iPhone notch/safe area */
  .safe-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
</style>
</file>

<file path="MobileComposeFAB.svelte">
<script lang="ts">
  import { goto } from '$app/navigation';
  import { homePageFilter } from '$lib/stores/homePageFilter.svelte';
  import { createMediaPostModal } from '$lib/stores/createMediaPostModal.svelte';
  interface Props {
    onclick?: () => void;
    isHomePage?: boolean;
  }
  const { onclick, isHomePage = false }: Props = $props();
  const filter = $derived(isHomePage ? homePageFilter.selected : null);
  function handleClick() {
    if (onclick) {
      onclick();
    } else if (filter === 'images') {
      createMediaPostModal.open();
    } else {
      goto('/compose');
    }
  }
  const icon = $derived(
    filter === 'images'
      ? 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z'
      : 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z'
  );
  const label = $derived(
    filter === 'images' ? 'Create media post' : 'Compose'
  );
</script>
<button
  onclick={handleClick}
  class="block lg:hidden fixed bottom-24 right-4 w-14 h-14 bg-primary hover:bg-accent-dark text-foreground rounded-full shadow-lg hover:shadow-xl transition-all z-[500] flex items-center justify-center active:scale-95"
  aria-label={label}
>
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={icon} />
  </svg>
</button>
</file>

<file path="NewMembersWidget.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import { NDKSubscriptionCacheUsage } from '@nostr-dev-kit/ndk';
  import NewMemberCard from './agora/NewMemberCard.svelte';
  // Only show when a specific relay is selected
  const shouldShow = $derived(!!settings.selectedRelay);
  // Subscribe to kind 514 events (community join events) from the selected relay
  const newMembersSubscription = $derived.by(() => {
    if (!settings.selectedRelay) return null;
    return ndk.$subscribe(() => ({
      filters: [{
        kinds: [514],
        limit: 10
      }],
      relayUrls: [settings.selectedRelay],
      cacheUsage: NDKSubscriptionCacheUsage.ONLY_RELAY,
      subId: 'new-members-514'
    }));
  });
  // Get events and extract member info
  const newMembers = $derived.by(() => {
    if (!newMembersSubscription) return [];
    const events = newMembersSubscription.events;
    // Map events to member data
    const members = events
      .map(event => {
        // Find the p-tag that contains the inviter's pubkey
        const inviterPubkey = event.tagValue('p');
        return {
          memberPubkey: event.pubkey,
          inviterPubkey,
          joinedAt: event.created_at || 0
        };
      })
      .sort((a, b) => b.joinedAt - a.joinedAt)
      .slice(0, 5); // Show only the 5 most recent
    return members;
  });
</script>
{#if shouldShow && newMembers.length > 0}
  <div class="p-4 bg-card rounded-lg border border-border">
    <div class="flex items-center gap-2 mb-4">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
      </svg>
      <h2 class="text-lg font-semibold text-card-foreground">New Members</h2>
    </div>
    <div class="space-y-3">
      {#each newMembers as member (member.memberPubkey)}
        <NewMemberCard
          memberPubkey={member.memberPubkey}
          inviterPubkey={member.inviterPubkey}
          joinedAt={member.joinedAt}
        />
      {/each}
    </div>
  </div>
{/if}
</file>

<file path="NoteCard.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { EventContent } from '@nostr-dev-kit/svelte';
  import ReplyIndicator from './ReplyIndicator.svelte';
  import EventCardHeader from './EventCardHeader.svelte';
  import EventActions from './EventActions.svelte';
  interface Props {
    event: NDKEvent;
    showActions?: boolean;
    variant?: 'default' | 'thread-parent' | 'thread-main' | 'thread-reply';
    showThreadLine?: boolean;
    onNavigate?: () => void;
  }
  const {
    event,
    showActions = true,
    variant = 'default',
    showThreadLine = false,
    onNavigate
  }: Props = $props();
  function navigateToEvent() {
    if (onNavigate) {
      onNavigate();
      return;
    }
    // Encode the event as a nevent
    const neventId = event.encode();
    window.location.href = `/e/${neventId}`;
  }
  const avatarSize = $derived(
    variant === 'thread-main' ? 'w-14 h-14' :
    variant === 'thread-reply' ? 'w-10 h-10' :
    'w-9 h-9 sm:w-12 sm:h-12'
  );
  const textSize = $derived(
    variant === 'thread-main' ? 'text-lg leading-relaxed' : 'text-base'
  );
  const nameSize = $derived(
    variant === 'thread-main' ? 'text-lg font-bold' : 'text-base font-semibold'
  );
  const bgClass = $derived(
    variant === 'thread-main' ? 'bg-card/50' :
    variant === 'default' ? 'hover:bg-card/30' :
    'hover:bg-card/30'
  );
  const clickable = $derived(variant === 'default' || (onNavigate !== undefined));
  const headerVariant = $derived(variant === 'thread-main' ? 'full' : 'compact');
</script>
<article
  class="p-3 sm:p-4 flex flex-col max-sm:max-w-screen {bgClass} transition-colors {clickable ? 'cursor-pointer' : ''} border-b border-border relative min-w-0"
  onclick={clickable ? navigateToEvent : undefined}
  role={clickable ? 'button' : undefined}
  tabindex={clickable ? 0 : undefined}
>
  {#if showThreadLine}
    <div class="absolute left-[29px] -top-px h-[73px] w-0.5 bg-muted"></div>
    <div class="absolute left-[29px] top-[73px] bottom-0 w-0.5 bg-muted"></div>
  {/if}
  <!-- Header Row: Avatar + Name/Handle/Time -->
  <div class="{variant === 'thread-main' ? 'mb-2' : 'mb-1.5'}">
    <EventCardHeader
      {event}
      avatarClass={avatarSize}
      nameClass={nameSize}
      variant={headerVariant}
    />
  </div>
  <!-- Reply indicator -->
  {#if variant === 'default'}
    <ReplyIndicator {event} />
  {/if}
  <!-- Content -->
  <div class="text-foreground whitespace-pre-wrap break-words {textSize} mb-2 overflow-hidden">
    <EventContent {ndk} event={event} />
  </div>
  <!-- Actions -->
  {#if showActions}
    <EventActions {event} variant={variant} />
  {/if}
</article>
</file>

<file path="PackCard.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { goto } from '$app/navigation';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { getPackUrl } from '$lib/utils/packUrl';
  import { getProfileUrl } from '$lib/utils/navigation';
  import type { NDKUser } from '@nostr-dev-kit/ndk';
  interface Pack {
    id: string;
    title: string;
    description?: string;
    image?: string;
    pubkeys: string[];
    encode: () => string;
    kind: number;
    pubkey: string;
    created_at: number;
    author?: NDKUser;
  }
  interface Props {
    pack: Pack;
    variant?: 'default' | 'compact';
  }
  const { pack, variant = 'default' }: Props = $props();
  let author = $state<NDKUser | undefined>(undefined);
  $effect(() => {
    if (pack.author) {
      author = pack.author;
    } else {
      ndk.fetchUser(pack.pubkey).then(u => { author = u; });
    }
  });
  const packUrl = $derived(getPackUrl(pack, author));
  function handlePackClick() {
    goto(packUrl);
  }
</script>
<div
  role="button"
  tabindex="0"
  onclick={handlePackClick}
  onkeydown={(e) => e.key === 'Enter' && handlePackClick()}
  class="block bg-card border border-border rounded-xl overflow-hidden hover:border-border transition-colors group cursor-pointer"
>
  {#if pack.image}
    <div class="h-32 w-full">
      <img
        src={pack.image}
        alt={pack.title}
        class="w-full h-full object-cover"
      />
    </div>
  {/if}
  <div class="p-5">
    <div class="mb-4">
      <h3 class="font-semibold text-foreground group-hover:text-primary transition-colors">
        {pack.title}
      </h3>
      <p class="text-sm text-muted-foreground mt-1">
        {pack.pubkeys.length} members
      </p>
    </div>
    {#if pack.description}
      <p class="text-sm text-muted-foreground mb-4 line-clamp-2">
        {pack.description}
      </p>
    {/if}
    <div class="flex -space-x-2">
      {#each pack.pubkeys.slice(0, 4) as pubkey, index (pubkey)}
        <button
          type="button"
          onclick={(e) => { e.stopPropagation(); goto(getProfileUrl(pubkey)); }}
          class="relative cursor-pointer"
          style="z-index: {4 - index}"
        >
          <Avatar {ndk} {pubkey} class="w-8 h-8 rounded-full ring-2 ring-neutral-900 hover:opacity-80 transition-opacity" />
        </button>
      {/each}
      {#if pack.pubkeys.length > 4}
        <div class="w-8 h-8 rounded-full bg-muted ring-2 ring-neutral-900 flex items-center justify-center">
          <span class="text-xs text-muted-foreground">
            +{pack.pubkeys.length - 4}
          </span>
        </div>
      {/if}
    </div>
  </div>
</div>
</file>

<file path="ProfileHeader.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { EventContent } from '@nostr-dev-kit/svelte';
  import FollowButton from '$lib/components/FollowButton.svelte';
  import UserDropdown from '$lib/components/UserDropdown.svelte';
  import InvitedByBadge from '$lib/components/InvitedByBadge.svelte';
  import { generateBannerGradient } from '$lib/utils/bannerGradient';
  import { t } from 'svelte-i18n';
  import type { NDKUserProfile, NDKUser } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey?: string;
    isOwnProfile: boolean;
    notesCount: number;
    followingCount: number;
    onEditProfile?: () => void;
    onShareProfile?: () => void;
    onOpenCreatePack?: () => void;
  }
  let {
    pubkey,
    isOwnProfile,
    notesCount,
    followingCount,
    onEditProfile,
    onShareProfile,
    onOpenCreatePack
  }: Props = $props();
  let user = $state<NDKUser | null | undefined>(null);
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    if (!pubkey) {
      user = null;
      profile = null;
      return;
    }
    ndk.fetchUser(pubkey).then(u => {
      user = u;
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  let isUserDropdownOpen = $state(false);
  function handleClickOutside(event: MouseEvent) {
    const target = event.target as HTMLElement;
    if (!target.closest('[data-user-dropdown]')) {
      isUserDropdownOpen = false;
    }
  }
</script>
<svelte:window onclick={handleClickOutside} />
{#if pubkey}
<div class="bg-background border-b border-border">
  <!-- Cover image -->
  <div class="h-48 sm:h-64 relative" style={profile?.banner ? '' : `background: ${generateBannerGradient(pubkey)}`}>
    {#if profile?.banner}
      <img
        src={profile.banner}
        alt="Banner"
        class="w-full h-full object-cover"
      />
    {/if}
  </div>
  <!-- Profile info -->
  <div class="px-4 sm:px-6 pb-4 relative z-10">
    <!-- Avatar and Name Row -->
    <div class="flex gap-4 items-start -mt-12 sm:-mt-20 mb-4">
      <!-- Avatar -->
      <div class="shrink-0">
        <Avatar {ndk} {pubkey} size="sm" class="w-24 h-24 sm:w-48 sm:h-48 rounded-full border-4 border-black" />
      </div>
      <!-- Name, NIP-05, and Actions -->
      <div class="flex-1 mt-13 sm:mt-20 min-w-0">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div class="flex-1 min-w-0">
            <h1 class="text-xl sm:text-2xl font-bold text-foreground">
              {profile?.name || 'Anonymous'}
            </h1>
            <div class="flex items-center gap-2 mt-1">
              <p class="text-muted-foreground">
                {profile?.nip05 ? `@${profile.nip05.split('@')[0]}` : `${pubkey.slice(0, 12)}...`}
              </p>
              {#if onShareProfile}
                <button
                  onclick={onShareProfile}
                  class="p-1 text-muted-foreground hover:text-muted-foreground transition-colors"
                  aria-label="Share profile"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                  </svg>
                </button>
              {/if}
            </div>
            <div class="mt-2">
              <InvitedByBadge {pubkey} />
            </div>
          </div>
          <div class="flex items-center gap-2">
            {#if isOwnProfile && onEditProfile}
              <button
                onclick={onEditProfile}
                class="px-4 py-2 rounded-full font-medium transition-colors bg-primary text-foreground hover:bg-primary-700 text-sm"
              >
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                {$t('profile.editProfile')}
              </button>
            {:else}
              <FollowButton {pubkey} variant="primary" showIcon={false} class="px-4 py-2 rounded-full font-medium transition-colors bg-accent text-accent-foreground hover:bg-accent/90 text-sm" />
            {/if}
            {#if !isOwnProfile && ndk.$currentUser && onOpenCreatePack}
              <div class="relative" data-user-dropdown>
                <button
                  onclick={(e) => {
                    e.stopPropagation();
                    isUserDropdownOpen = !isUserDropdownOpen;
                  }}
                  class="p-2 rounded-full border border text-muted-foreground hover:bg-muted transition-colors"
                  aria-label="More options"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <UserDropdown
                  {pubkey}
                  isOpen={isUserDropdownOpen}
                  onClose={() => isUserDropdownOpen = false}
                  onOpenCreatePack={onOpenCreatePack}
                />
              </div>
            {/if}
          </div>
        </div>
      </div>
    </div>
    <!-- Bio -->
    {#if profile?.about}
      <div class="mb-4">
        <EventContent
          content={profile.about}
          class="text-muted-foreground"
        />
      </div>
    {/if}
    <!-- Meta info -->
    <div class="flex flex-wrap gap-4 text-sm text-muted-foreground">
      {#if profile?.website}
        <a
          href={profile.website}
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center gap-1 hover:text-primary"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          <span>{profile.website.replace(/^https?:\/\//, '')}</span>
        </a>
      {/if}
    </div>
    <!-- Stats -->
    <div class="flex gap-6 mt-4">
      <div>
        <span class="font-semibold text-foreground">{notesCount}</span>
        <span class="text-muted-foreground ml-1">{$t('profile.tabs.notes')}</span>
      </div>
      <div>
        <span class="font-semibold text-foreground">{followingCount}</span>
        <span class="text-muted-foreground ml-1">{$t('profile.following')}</span>
      </div>
    </div>
  </div>
</div>
{/if}
</file>

<file path="PWAInstallPrompt.svelte">
<script lang="ts">
  import { pwaStore } from '$lib/stores/pwa.svelte';
  import { fly } from 'svelte/transition';
  import * as Drawer from '$lib/components/ui/drawer';
  // Only show on mobile devices when not installed
  const shouldShow = $derived(
    pwaStore.showPrompt &&
    pwaStore.isMobileDevice &&
    !pwaStore.isInstalled
  );
  let showIOSInstructions = $state(false);
  function handleInstall() {
    if (pwaStore.isAndroidDevice && pwaStore.deferredPrompt) {
      // Android - trigger native install prompt
      pwaStore.promptInstall();
    } else if (pwaStore.isIOSDevice) {
      // iOS - show manual instructions
      showIOSInstructions = true;
    }
  }
  function handleDismiss() {
    pwaStore.dismiss();
  }
  function handleNeverAsk() {
    pwaStore.dismissForever();
  }
  function closeIOSInstructions() {
    showIOSInstructions = false;
    pwaStore.dismiss();
  }
</script>
{#if shouldShow && !showIOSInstructions}
  <div
    class="fixed bottom-20 md:bottom-4 left-4 right-4 z-50"
    transition:fly={{ y: 100, duration: 300 }}
  >
    <div class="bg-gradient-to-r bg-primary opacity-90 text-foreground rounded-2xl shadow-2xl p-4 max-w-md mx-auto">
      <!-- Close button -->
      <button
        onclick={handleDismiss}
        class="absolute top-3 right-3 p-1 hover:bg-white/20 rounded-full transition-colors"
        aria-label="Dismiss"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <!-- Content -->
      <div class="flex items-start gap-4 mb-4">
        <div class="flex-shrink-0 w-14 h-14 bg-card rounded-2xl p-2 shadow-lg">
          <img src="/icons/manifest-icon-192.png" alt="Agora icon" class="w-full h-full" />
        </div>
        <div class="flex-1 pr-6">
          <h3 class="text-lg font-bold mb-1">Install Agora</h3>
          <p class="text-sm text-foreground/90">
            Get the full app experience with offline access and quick launch from your home screen.
          </p>
        </div>
      </div>
      <!-- Action buttons -->
      <div class="flex gap-2">
        <button
          onclick={handleInstall}
          class="flex-1 bg-card text-primary font-semibold py-3 px-4 rounded-xl hover:bg-primary-50 transition-colors"
        >
          {#if pwaStore.isIOSDevice}
            View Instructions
          {:else}
            Install Now
          {/if}
        </button>
        <button
          onclick={handleNeverAsk}
          class="px-4 py-3 text-sm text-foreground/80 hover:text-foreground hover:bg-white/10 rounded-xl transition-colors"
        >
          Not Now
        </button>
      </div>
    </div>
  </div>
{/if}
<Drawer.Root bind:open={showIOSInstructions}>
  <Drawer.Content>
    <Drawer.Header class="text-left">
      <Drawer.Title>Install Agora on iOS</Drawer.Title>
      <Drawer.Description>
        Follow these steps to add Agora to your home screen
      </Drawer.Description>
    </Drawer.Header>
    <!-- Instructions -->
    <div class="px-4 pb-4 space-y-6">
      <!-- Step 1 -->
      <div class="flex gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-primary/20 text-primary rounded-full flex items-center justify-center font-bold">
          1
        </div>
        <div class="flex-1">
          <h3 class="text-foreground font-semibold mb-2">Tap the Share button</h3>
          <p class="text-sm text-muted-foreground mb-2">
            Look for the share icon in Safari's bottom menu bar
          </p>
          <div class="inline-flex items-center gap-2 bg-muted px-3 py-2 rounded-lg">
            <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
              <path d="M16.5 6.5v-1.75a.75.75 0 00-1.5 0V6.5h-6V4.75a.75.75 0 00-1.5 0V6.5h-1.75A2.75 2.75 0 003 9.25v9A2.75 2.75 0 005.75 21h12.5A2.75 2.75 0 0021 18.25v-9A2.75 2.75 0 0018.25 6.5H16.5zm-.75 4.25a.75.75 0 011.5 0v4.5a.75.75 0 01-1.5 0v-4.5zm-4.5 0a.75.75 0 011.5 0v4.5a.75.75 0 01-1.5 0v-4.5zm-4.5 0a.75.75 0 011.5 0v4.5a.75.75 0 01-1.5 0v-4.5z"/>
            </svg>
            <span class="text-muted-foreground text-sm">Share</span>
          </div>
        </div>
      </div>
      <!-- Step 2 -->
      <div class="flex gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-primary/20 text-primary rounded-full flex items-center justify-center font-bold">
          2
        </div>
        <div class="flex-1">
          <h3 class="text-foreground font-semibold mb-2">Select "Add to Home Screen"</h3>
          <p class="text-sm text-muted-foreground">
            Scroll down in the share menu and tap "Add to Home Screen"
          </p>
        </div>
      </div>
      <!-- Step 3 -->
      <div class="flex gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-primary/20 text-primary rounded-full flex items-center justify-center font-bold">
          3
        </div>
        <div class="flex-1">
          <h3 class="text-foreground font-semibold mb-2">Confirm installation</h3>
          <p class="text-sm text-muted-foreground">
            Tap "Add" in the top right corner to complete the installation
          </p>
        </div>
      </div>
    </div>
    <Drawer.Footer>
      <button
        onclick={closeIOSInstructions}
        class="w-full bg-primary hover:bg-accent-dark text-foreground font-semibold py-3 px-4 rounded-xl transition-colors"
      >
        Got it!
      </button>
    </Drawer.Footer>
  </Drawer.Content>
</Drawer.Root>
</file>

<file path="RelayAuthModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { relayAuthModal } from '$lib/stores/relayAuthModal.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  function handleConfirm() {
    relayAuthModal.confirm();
  }
  function handleReject() {
    relayAuthModal.reject();
  }
  function handleClose() {
    relayAuthModal.reject();
  }
  const open = $derived(relayAuthModal.show && !!relayAuthModal.request);
</script>
{#if isDesktop.current}
  <Dialog.Root open={open} onOpenChange={(isOpen) => {
      if (!isOpen) handleClose();
    }}>
    <Dialog.Content class="max-w-md">
      <Dialog.Header>
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-primary dark:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <Dialog.Title>Relay Authentication</Dialog.Title>
        </div>
      </Dialog.Header>
      {#if relayAuthModal.request}
        <div class="space-y-4">
          <div>
            <p class="text-muted-foreground mb-2">
              The relay <strong class="font-semibold text-foreground">{relayAuthModal.request.relayUrl}</strong> is requesting authentication.
            </p>
            <p class="text-sm text-muted-foreground">
              This will create a signed authentication event using your Nostr identity. Your decision will be remembered for this relay.
            </p>
          </div>
          <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <div class="flex gap-2">
              <svg class="w-5 h-5 flex-shrink-0 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="text-sm text-blue-800 dark:text-blue-300">
                <strong class="font-semibold">Why authenticate?</strong>
                <p class="mt-1">Some relays require authentication to access content or reduce spam. This proves you're a real Nostr user.</p>
              </div>
            </div>
          </div>
        </div>
        <Dialog.Footer class="flex gap-3 sm:space-x-0">
          <Button variant="outline" onclick={handleReject} class="flex-1">
            Reject
          </Button>
          <Button onclick={handleConfirm} class="flex-1">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            Authenticate
          </Button>
        </Dialog.Footer>
      {/if}
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={open} onOpenChange={(isOpen) => {
      if (!isOpen) handleClose();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-primary dark:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <Drawer.Title>Relay Authentication</Drawer.Title>
        </div>
      </Drawer.Header>
      {#if relayAuthModal.request}
        <div class="space-y-4 px-4">
          <div>
            <p class="text-muted-foreground mb-2">
              The relay <strong class="font-semibold text-foreground">{relayAuthModal.request.relayUrl}</strong> is requesting authentication.
            </p>
            <p class="text-sm text-muted-foreground">
              This will create a signed authentication event using your Nostr identity. Your decision will be remembered for this relay.
            </p>
          </div>
          <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <div class="flex gap-2">
              <svg class="w-5 h-5 flex-shrink-0 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="text-sm text-blue-800 dark:text-blue-300">
                <strong class="font-semibold">Why authenticate?</strong>
                <p class="mt-1">Some relays require authentication to access content or reduce spam. This proves you're a real Nostr user.</p>
              </div>
            </div>
          </div>
        </div>
        <Drawer.Footer class="pt-2">
          <div class="flex gap-3">
            <Button variant="outline" onclick={handleReject} class="flex-1">
              Reject
            </Button>
            <Button onclick={handleConfirm} class="flex-1">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              Authenticate
            </Button>
          </div>
        </Drawer.Footer>
      {/if}
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="RelayBadge.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import type { NDKRelay } from '@nostr-dev-kit/ndk';
  import RelayIcon from './RelayIcon.svelte';
  interface Props {
    relay: NDKRelay;
    variant?: 'default' | 'compact';
  }
  const { relay, variant = 'default' }: Props = $props();
  const relayInfo = $derived(relay.connectivity.nip11);
  const relayName = $derived(relayInfo?.name || new URL(relay.url).hostname);
  const relayDescription = $derived(relayInfo?.description);
</script>
{#if variant === 'compact'}
  <div class="flex items-center gap-1.5 px-2 py-1 bg-muted/50 rounded text-xs text-muted-foreground group relative">
    <RelayIcon relayUrl={relay.url} size="xs" />
    <span class="truncate max-w-[120px]">{relayName}</span>
    {#if relayDescription}
      <div class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-card border border-border rounded-lg shadow-xl z-50 w-64 text-xs">
        <div class="font-semibold text-foreground mb-1">{relayName}</div>
        <div class="text-muted-foreground">{relayDescription}</div>
        <div class="text-muted-foreground mt-1 break-all">{relay.url}</div>
      </div>
    {/if}
  </div>
{:else}
  <div class="flex items-center gap-2 px-3 py-2 bg-muted/50 rounded-lg text-sm text-muted-foreground hover:bg-muted transition-colors">
    <RelayIcon relayUrl={relay.url} size="md" />
    <div class="flex-1 min-w-0">
      <div class="font-medium text-foreground truncate">{relayName}</div>
      {#if relayDescription}
        <div class="text-xs text-muted-foreground truncate">{relayDescription}</div>
      {/if}
    </div>
  </div>
{/if}
</file>

<file path="RelayIcon.svelte">
<script lang="ts">
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  interface Props {
    relayUrl: string;
    size?: 'xs' | 'sm' | 'md' | 'lg';
    class?: string;
  }
  const { relayUrl, size = 'md', class: className = '' }: Props = $props();
  const relayInfo = useRelayInfoCached(relayUrl);
  const sizeClasses = $derived({
    xs: 'w-3 h-3',
    sm: 'w-4 h-4',
    md: 'w-5 h-5',
    lg: 'w-6 h-6'
  }[size]);
  const svgSizeClasses = $derived({
    xs: 'w-2 h-2',
    sm: 'w-2.5 h-2.5',
    md: 'w-3 h-3',
    lg: 'w-4 h-4'
  }[size]);
</script>
{#if relayInfo.info?.icon}
  <img src={relayInfo.info.icon} alt="" class="{sizeClasses} rounded flex-shrink-0 {className}" />
{:else}
  <div class="{sizeClasses} rounded bg-muted flex items-center justify-center flex-shrink-0 {className}">
    <svg class="{svgSizeClasses} text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
    </svg>
  </div>
{/if}
</file>

<file path="RelayPublishDropdownContent.svelte">
<script lang="ts">
  import { settings } from '$lib/stores/settings.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { Button } from '$lib/components/ui/button';
  import { Label } from '$lib/components/ui/label';
  import RelayIcon from './RelayIcon.svelte';
  interface Props {
    selectedRelayUrls: string[];
    isProtected?: boolean;
    onToggleRelay: (url: string) => void;
    onSelectOnly: (url: string) => void;
    onProtectedChange?: (value: boolean) => void;
    showProtected?: boolean;
  }
  let {
    selectedRelayUrls,
    isProtected = $bindable(false),
    onToggleRelay,
    onSelectOnly,
    onProtectedChange,
    showProtected = true
  }: Props = $props();
  let showProtectedInfo = $state(false);
  const allRelays = $derived(settings.relays.filter(r => r.enabled));
  function handleProtectedChange(value: boolean) {
    isProtected = value;
    onProtectedChange?.(value);
  }
</script>
<div class="p-2">
  <!-- Protected mode toggle -->
  {#if showProtected}
    <div class="px-2 py-2 mb-2 border-b border-border">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 {isProtected ? 'text-primary' : 'text-muted-foreground'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <Label for="protected-switch" class="text-sm {isProtected ? 'text-primary font-medium' : 'text-muted-foreground'}">
            Protected
          </Label>
          <div class="relative">
            <button
              onclick={() => showProtectedInfo = !showProtectedInfo}
              onmouseover={() => showProtectedInfo = true}
              onmouseleave={() => showProtectedInfo = false}
              class="text-muted-foreground hover:text-muted-foreground transition-colors"
              aria-label="Info about protected mode"
              type="button"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
            {#if showProtectedInfo}
              <div class="absolute left-0 bottom-full mb-2 w-64 bg-card border border-border rounded-lg shadow-xl z-50 p-2 text-xs">
                <div class="font-semibold text-foreground mb-1">Protected Mode (NIP-70)</div>
                <div class="text-muted-foreground text-xs">
                  Protected events cannot be republished to other relays without your permission.
                </div>
              </div>
            {/if}
          </div>
        </div>
        <button
          type="button"
          role="switch"
          aria-checked={isProtected}
          id="protected-switch"
          onclick={() => handleProtectedChange(!isProtected)}
          class="relative inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent transition-colors focus-visible:outline-none focus-visible:ring-[3px] focus-visible:ring-ring/50 disabled:cursor-not-allowed disabled:opacity-50 {isProtected ? 'bg-primary' : 'bg-input'}"
        >
          <span
            class="pointer-events-none block size-4 rounded-full bg-background ring-0 transition-transform {isProtected ? 'translate-x-[calc(100%-2px)]' : 'translate-x-0'}"
          ></span>
        </button>
      </div>
    </div>
  {/if}
  <div class="text-xs text-muted-foreground px-2 py-1.5 font-medium">Select Relays to Publish</div>
  {#each allRelays as relay (relay.url)}
    {@const relayInfo = useRelayInfoCached(relay.url)}
    {@const isSelected = selectedRelayUrls.includes(relay.url)}
    {@const isReadOnly = !relay.write}
    <div class="group relative flex items-center overflow-hidden">
      <Button
        variant="ghost"
        onclick={() => onToggleRelay(relay.url)}
        class="flex-1 justify-start h-auto py-2 min-w-0 pr-16 {isSelected ? 'bg-muted/50' : ''} {isReadOnly ? 'opacity-60' : ''}"
      >
        <RelayIcon relayUrl={relay.url} size="md" class="mr-3" />
        <div class="flex-1 min-w-0 text-left overflow-hidden">
          <div class="flex items-center gap-2 min-w-0">
            <div class="text-sm font-medium text-foreground truncate flex-1 min-w-0">
              {relayInfo.info?.name || relay.url.replace('wss://', '').replace('ws://', '')}
            </div>
            {#if isReadOnly}
              <span class="text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded whitespace-nowrap flex-shrink-0">read-only</span>
            {/if}
          </div>
          {#if relayInfo.info?.description}
            <div class="text-xs text-muted-foreground truncate overflow-hidden">
              {relayInfo.info.description}
            </div>
          {/if}
        </div>
        {#if isSelected}
          <svg class="w-5 h-5 text-primary flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        {/if}
      </Button>
      <!-- "Only" button - appears on hover (desktop) or always visible (mobile) -->
      <Button
        size="sm"
        onclick={(e) => { e.stopPropagation(); onSelectOnly(relay.url); }}
        title="Publish to only this relay (deselects all others)"
        class="absolute right-2 px-2 py-1 h-auto text-xs md:opacity-0 md:group-hover:opacity-100 transition-opacity md:pointer-events-none md:group-hover:pointer-events-auto"
      >
        Only
      </Button>
    </div>
  {/each}
</div>
</file>

<file path="RelayPublishSelector.svelte">
<script lang="ts">
  import { settings } from '$lib/stores/settings.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { clickOutside } from '$lib/utils/clickOutside';
  import { Button } from '$lib/components/ui/button';
  import { Switch } from '$lib/components/ui/switch';
  import { Label } from '$lib/components/ui/label';
  import RelayIcon from './RelayIcon.svelte';
  interface Props {
    selectedRelayUrls?: string[];
    isProtected?: boolean;
    disabled?: boolean;
  }
  let { selectedRelayUrls = $bindable([]), isProtected = $bindable(false), disabled = false }: Props = $props();
  let isRelayDropdownOpen = $state(false);
  let showProtectedInfo = $state(false);
  const allRelays = $derived(settings.relays.filter(r => r.enabled));
  // Initialize selected relays from current relay filter or use all write relays
  $effect(() => {
    if (selectedRelayUrls.length === 0) {
      if (settings.selectedRelay) {
        selectedRelayUrls = [settings.selectedRelay];
      } else {
        selectedRelayUrls = allRelays.filter(r => r.write).map(r => r.url);
      }
    }
  });
  function toggleRelay(url: string) {
    if (selectedRelayUrls.includes(url)) {
      selectedRelayUrls = selectedRelayUrls.filter(u => u !== url);
    } else {
      selectedRelayUrls = [...selectedRelayUrls, url];
    }
  }
  function selectOnlyRelay(url: string) {
    selectedRelayUrls = [url];
    isRelayDropdownOpen = false;
  }
  function handleRelayDropdownClickOutside() {
    isRelayDropdownOpen = false;
  }
</script>
<div class="relative" use:clickOutside={handleRelayDropdownClickOutside}>
  <Button
    variant="outline"
    onclick={() => isRelayDropdownOpen = !isRelayDropdownOpen}
    {disabled}
    class="w-full justify-start"
  >
    {#if selectedRelayUrls.length === 0}
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
      </svg>
      <span class="flex-1 text-left">Select relays</span>
    {:else if selectedRelayUrls.length < 3}
      <div class="flex items-center gap-1.5 flex-1">
        {#each selectedRelayUrls as relayUrl}
          <RelayIcon {relayUrl} size="md" />
        {/each}
      </div>
    {:else}
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
      </svg>
      <span class="flex-1 text-left">
        {selectedRelayUrls.length} relays selected
      </span>
    {/if}
    <svg
      class="w-4 h-4 ml-2 transition-transform {isRelayDropdownOpen ? 'rotate-180' : ''}"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </Button>
  {#if isRelayDropdownOpen}
    <div class="absolute top-full left-0 right-0 mt-2 bg-popover border border-border rounded-lg shadow-xl z-50 max-h-[400px] max-md:max-h-[50vh] overflow-y-auto">
      <div class="p-2">
        <!-- Protected mode toggle -->
        <div class="px-2 py-2 mb-2 border-b border-border">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 {isProtected ? 'text-primary' : 'text-muted-foreground'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <Label for="protected-switch" class="text-sm {isProtected ? 'text-primary font-medium' : 'text-muted-foreground'}">
                Protected
              </Label>
              <div class="relative">
                <button
                  onclick={() => showProtectedInfo = !showProtectedInfo}
                  onmouseover={() => showProtectedInfo = true}
                  onmouseleave={() => showProtectedInfo = false}
                  class="text-muted-foreground hover:text-muted-foreground transition-colors"
                  aria-label="Info about protected mode"
                  type="button"
                >
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
                {#if showProtectedInfo}
                  <div class="absolute left-0 bottom-full mb-2 w-64 bg-card border border-border rounded-lg shadow-xl z-50 p-2 text-xs">
                    <div class="font-semibold text-foreground mb-1">Protected Mode (NIP-70)</div>
                    <div class="text-muted-foreground text-xs">
                      Protected events cannot be republished to other relays without your permission.
                    </div>
                  </div>
                {/if}
              </div>
            </div>
            <Switch id="protected-switch" bind:checked={isProtected} />
          </div>
        </div>
        <div class="text-xs text-muted-foreground px-2 py-1.5 font-medium">Select Relays to Publish</div>
        {#each allRelays as relay (relay.url)}
          {@const relayInfo = useRelayInfoCached(relay.url)}
          {@const isSelected = selectedRelayUrls.includes(relay.url)}
          {@const isReadOnly = !relay.write}
          <div class="group relative flex items-center">
            <Button
              variant="ghost"
              onclick={() => toggleRelay(relay.url)}
              class="flex-1 justify-start h-auto py-2 {isSelected ? 'bg-muted/50' : ''} {isReadOnly ? 'opacity-60' : ''}"
            >
              <RelayIcon relayUrl={relay.url} size="md" class="mr-3" />
              <div class="flex-1 min-w-0 text-left">
                <div class="flex items-center gap-2">
                  <div class="text-sm font-medium text-foreground truncate">
                    {relayInfo.info?.name || relay.url.replace('wss://', '').replace('ws://', '')}
                  </div>
                  {#if isReadOnly}
                    <span class="text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded">read-only</span>
                  {/if}
                </div>
                {#if relayInfo.info?.description}
                  <div class="text-xs text-muted-foreground truncate">
                    {relayInfo.info.description}
                  </div>
                {/if}
              </div>
              {#if isSelected}
                <svg class="w-5 h-5 text-primary flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              {/if}
            </Button>
            <!-- "Only" button - appears on hover -->
            <Button
              size="sm"
              onclick={(e) => { e.stopPropagation(); selectOnlyRelay(relay.url); }}
              class="absolute right-2 px-2 py-1 h-auto text-xs opacity-0 group-hover:opacity-100 transition-opacity"
              title="Publish only to this relay"
            >
              Only
            </Button>
          </div>
        {/each}
      </div>
    </div>
  {/if}
</div>
</file>

<file path="RelaySelector.svelte">
<script lang="ts">
  import { goto } from '$app/navigation';
  import { settings } from '$lib/stores/settings.svelte';
  import { useRelayInfoCached } from '$lib/utils/relayInfo.svelte';
  import { clickOutside } from '$lib/utils/clickOutside';
  import { isAgoraRelay, AGORA_RELAYS } from '$lib/utils/relayUtils';
  import { portal } from '$lib/utils/portal.svelte';
  import { ndk } from '$lib/ndk.svelte';
  import { followPacksStore } from '$lib/stores/followPacks.svelte';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import RelayIcon from './RelayIcon.svelte';
  interface Props {
    active?: boolean;
    collapsed?: boolean;
    iconOnly?: boolean;
  }
  const { active = false, collapsed = false, iconOnly = false }: Props = $props();
  let isOpen = $state(false);
  let enabledRelays = $derived(settings.relays.filter(r => r.enabled && r.read));
  let otherRelays = $derived(enabledRelays.filter(r => !isAgoraRelay(r.url)));
  let buttonElement: HTMLElement | null = $state(null);
  let dropdownPosition = $state({ top: 0, left: 0, width: 0 });
  // Get follows and check if user has any
  const follows = $derived(ndk.$sessions?.follows || []);
  const hasFollows = $derived(follows.size > 0);
  const shouldShowFollowing = $derived(!!ndk.$currentUser && hasFollows);
  // Fetch favorite follow pack events
  let favoritePackEvents = $state<NDKEvent[]>([]);
  let userCreatedPackEvents = $state<NDKEvent[]>([]);
  $effect(() => {
    const favoriteIds = followPacksStore.favoritePacks;
    if (favoriteIds.length === 0) {
      favoritePackEvents = [];
      return;
    }
    // Fetch all favorite pack events
    Promise.all(
      favoriteIds.map(packId => ndk.fetchEvent(packId))
    ).then(events => {
      favoritePackEvents = events.filter((e): e is NDKEvent => e !== null);
    }).catch(err => {
      console.error('Failed to fetch favorite packs:', err);
      favoritePackEvents = [];
    });
  });
  // Fetch user's own created follow packs
  $effect(() => {
    if (!ndk.$currentUser) {
      userCreatedPackEvents = [];
      return;
    }
    ndk.fetchEvents({
      kinds: [39089], // NDKKind.FollowPack
      authors: [ndk.$currentUser.pubkey]
    }).then(events => {
      userCreatedPackEvents = Array.from(events);
    }).catch(err => {
      console.error('Failed to fetch user packs:', err);
      userCreatedPackEvents = [];
    });
  });
  // Combine and deduplicate all packs (favorites + user created)
  const allPacks = $derived.by(() => {
    const packMap = new Map<string, NDKEvent>();
    // Add user created packs first
    for (const pack of userCreatedPackEvents) {
      packMap.set(pack.id, pack);
    }
    // Add favorite packs (will override if same ID)
    for (const pack of favoritePackEvents) {
      packMap.set(pack.id, pack);
    }
    return Array.from(packMap.values());
  });
  const selectedRelayInfo = $derived.by(() => {
    if (!settings.selectedRelay) return null;
    if (isFollowPackSelection(settings.selectedRelay)) return null;
    return useRelayInfoCached(settings.selectedRelay);
  });
  // Helper to check if selection is a follow pack
  function isFollowPackSelection(value: string | null): boolean {
    return value?.startsWith('followpack:') ?? false;
  }
  // Get selected follow pack event
  const selectedFollowPack = $derived.by(() => {
    if (!settings.selectedRelay || !isFollowPackSelection(settings.selectedRelay)) return null;
    const packId = settings.selectedRelay.replace('followpack:', '');
    return allPacks.find(e => e.id === packId || e.encode() === packId);
  });
  const displayName = $derived.by(() => {
    if (isFollowPackSelection(settings.selectedRelay) && selectedFollowPack) {
      return selectedFollowPack.tagValue('title') || 'Untitled Pack';
    }
    if (settings.selectedRelay && selectedRelayInfo?.info?.name) {
      return selectedRelayInfo.info.name;
    }
    if (settings.selectedRelay) {
      return settings.selectedRelay.replace('wss://', '').replace('ws://', '');
    }
    return 'Following';
  });
  function handleClick() {
    if (active || iconOnly) {
      // On home page or icon-only mode: toggle dropdown
      if (!isOpen && buttonElement && !iconOnly) {
        const rect = buttonElement.getBoundingClientRect();
        dropdownPosition = {
          top: rect.bottom + 4,
          left: rect.left,
          width: rect.width
        };
      }
      isOpen = !isOpen;
    } else {
      // Not on home page: navigate to home
      goto('/');
    }
  }
  function selectRelay(url: string) {
    settings.setSelectedRelay(url);
    isOpen = false;
  }
  function selectFollowing() {
    settings.setSelectedRelay(null);
    isOpen = false;
  }
  function selectFollowPack(packId: string) {
    settings.setSelectedRelay(`followpack:${packId}`);
    isOpen = false;
  }
  function handleClickOutside() {
    isOpen = false;
  }
</script>
<div class="relative">
  <!-- Navigation Button -->
  <button
    bind:this={buttonElement}
    onclick={handleClick}
    class="{iconOnly
      ? 'flex items-center justify-center w-8 h-8 rounded-full hover:bg-muted/50 transition-colors'
      : collapsed
        ? 'flex items-center justify-center p-3 rounded-lg transition-colors w-full ' + (active ? 'text-primary bg-primary/10' : 'text-muted-foreground hover:bg-muted/50')
        : 'flex items-center gap-3 px-4 py-3 rounded-lg transition-colors w-full ' + (active ? 'text-primary bg-primary/10' : 'text-muted-foreground hover:bg-muted/50')
    }"
    aria-label={settings.selectedRelay ? 'Change filter' : 'Change following filter'}
    title={collapsed ? displayName : undefined}
  >
    <!-- Icon - changes based on selection -->
    {#if isFollowPackSelection(settings.selectedRelay)}
      <!-- Follow Pack icon -->
      {#if selectedFollowPack?.tagValue('image')}
        <img src={selectedFollowPack.tagValue('image')} alt="" class="{iconOnly ? 'w-5 h-5' : 'w-6 h-6'} rounded flex-shrink-0" />
      {:else}
        <div class="{iconOnly ? 'w-5 h-5' : 'w-6 h-6'} rounded bg-primary flex items-center justify-center flex-shrink-0">
          <svg class="{iconOnly ? 'w-3 h-3' : 'w-4 h-4'} text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </div>
      {/if}
    {:else if settings.selectedRelay}
      <RelayIcon relayUrl={settings.selectedRelay} size={iconOnly ? 'md' : 'lg'} />
    {:else}
      <!-- Users icon for "Following" -->
      <svg class="{iconOnly ? 'w-5 h-5 text-muted-foreground' : 'w-6 h-6'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    {/if}
    {#if !collapsed && !iconOnly}
      <span class="font-medium flex-1 text-left whitespace-nowrap overflow-hidden text-ellipsis">{displayName}</span>
      <!-- Chevron -->
      <svg
        class="w-4 h-4 transition-transform {isOpen ? 'rotate-180' : ''}"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    {/if}
  </button>
  {#snippet dropdownContent()}
      <!-- Following option (only show if user has follows) -->
      {#if shouldShowFollowing}
        <button
          onclick={selectFollowing}
          class="w-full px-4 py-3 hover:bg-muted transition-colors text-left flex items-center gap-3 {!settings.selectedRelay ? 'bg-muted/50' : ''}"
        >
          <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <div class="flex-1">
            <div class="font-medium text-foreground">Following</div>
            <div class="text-xs text-muted-foreground">All posts from people you follow</div>
          </div>
          {#if !settings.selectedRelay}
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          {/if}
        </button>
      {/if}
      <!-- Follow Packs -->
      {#if allPacks.length > 0}
        {#if shouldShowFollowing}
          <!-- Divider -->
          <div class="border-t border-border my-1"></div>
        {/if}
        <div class="px-2 py-1">
          <div class="text-xs text-muted-foreground px-2 py-1 font-medium">Follow Packs</div>
          {#each allPacks as pack (pack.id)}
            {@const packTitle = pack.tagValue('title') || 'Untitled Pack'}
            {@const packImage = pack.tagValue('image')}
            {@const packDescription = pack.tagValue('description')}
            {@const memberCount = pack.tags.filter(t => t[0] === 'p').length}
            {@const isSelected = isFollowPackSelection(settings.selectedRelay) && selectedFollowPack?.id === pack.id}
            <button
              onclick={() => selectFollowPack(pack.id)}
              class="w-full px-3 py-2.5 rounded-lg hover:bg-muted transition-colors text-left flex items-center gap-3 {isSelected ? 'bg-muted/50' : ''}"
            >
              {#if packImage}
                <img src={packImage} alt="" class="w-5 h-5 rounded flex-shrink-0" />
              {:else}
                <div class="w-5 h-5 rounded bg-muted flex items-center justify-center flex-shrink-0">
                  <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                </div>
              {/if}
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-foreground truncate">
                  {packTitle}
                </div>
                <div class="text-xs text-muted-foreground truncate">
                  {packDescription || `${memberCount} members`}
                </div>
              </div>
              {#if isSelected}
                <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              {/if}
            </button>
          {/each}
        </div>
      {/if}
      <!-- Divider -->
      <div class="border-t border-border my-1"></div>
      <!-- Agoras section -->
      <div class="px-2 py-1">
        <div class="text-xs text-muted-foreground px-2 py-1 font-medium">Agoras</div>
        {#each AGORA_RELAYS as relayUrl (relayUrl)}
          {@const relayInfo = useRelayInfoCached(relayUrl)}
          <button
            onclick={() => selectRelay(relayUrl)}
            class="w-full px-3 py-2.5 rounded-lg hover:bg-muted transition-colors text-left flex items-center gap-3 {settings.selectedRelay === relayUrl ? 'bg-muted/50' : ''}"
          >
            <RelayIcon {relayUrl} size="md" />
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-1.5">
                <div class="text-sm font-medium text-foreground truncate">
                  {relayInfo.info?.name || relayUrl.replace('wss://', '').replace('ws://', '')}
                </div>
                <span class="flex-shrink-0 px-1.5 py-0.5 text-[10px] font-semibold bg-primary/20 text-primary rounded uppercase tracking-wide">
                  Agora
                </span>
              </div>
              {#if relayInfo.info?.description}
                <div class="text-xs text-muted-foreground truncate">
                  {relayInfo.info.description}
                </div>
              {/if}
            </div>
            {#if settings.selectedRelay === relayUrl}
              <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            {/if}
          </button>
        {/each}
      </div>
      <!-- Other relays section -->
      {#if otherRelays.length > 0}
        <div class="border-t border-border my-1"></div>
        <div class="px-2 py-1">
          <div class="text-xs text-muted-foreground px-2 py-1 font-medium">Other relays</div>
          {#each otherRelays as relay (relay.url)}
            {@const relayInfo = useRelayInfoCached(relay.url)}
            <button
              onclick={() => selectRelay(relay.url)}
              class="w-full px-3 py-2.5 rounded-lg hover:bg-muted transition-colors text-left flex items-center gap-3 {settings.selectedRelay === relay.url ? 'bg-muted/50' : ''}"
            >
              <RelayIcon relayUrl={relay.url} size="md" />
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5">
                  <div class="text-sm font-medium text-foreground truncate">
                    {relayInfo.info?.name || relay.url.replace('wss://', '').replace('ws://', '')}
                  </div>
                </div>
                {#if relayInfo.info?.description}
                  <div class="text-xs text-muted-foreground truncate">
                    {relayInfo.info.description}
                  </div>
                {/if}
              </div>
              {#if settings.selectedRelay === relay.url}
                <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              {/if}
            </button>
          {/each}
        </div>
      {/if}
      <!-- Manage relays link -->
      <div class="border-t border-border mt-1">
        <a
          href="/settings"
          class="block w-full px-4 py-2.5 text-sm text-center text-primary hover:bg-muted transition-colors"
          onclick={() => isOpen = false}
        >
          Manage Relays ‚Üí
        </a>
      </div>
  {/snippet}
  <!-- Dropdown Menu -->
  {#if isOpen && (active || iconOnly)}
    {#if iconOnly}
      <div
        use:clickOutside={handleClickOutside}
        class="absolute left-0 mt-1 w-64 bg-popover border border-border rounded-lg shadow-xl z-50 overflow-hidden"
      >
        {@render dropdownContent()}
      </div>
    {:else}
      <div
        use:portal
        use:clickOutside={handleClickOutside}
        style="position: fixed; top: {dropdownPosition.top}px; left: {dropdownPosition.left}px; min-width: {dropdownPosition.width}px;"
        class="w-80 bg-card border border-border rounded-lg shadow-xl z-50 overflow-hidden"
      >
        {@render dropdownContent()}
      </div>
    {/if}
  {/if}
</div>
</file>

<file path="ReplyIndicator.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { nip19 } from 'nostr-tools';
  interface Props {
    event: NDKEvent;
  }
  const { event }: Props = $props();
  let replyToEvent = $state<NDKEvent | null>(null);
  let replyToProfile = $state<any>(null);
  // Determine what this note is replying to
  const replyToTag = $derived.by(() => {
    // First, check for explicit 'reply' marker
    const replyTag = event.tags.find(tag =>
      tag[0] === 'e' && tag[3] === 'reply'
    );
    if (replyTag) {
      return replyTag;
    }
    // Check for 'root' marker as fallback
    const rootTag = event.tags.find(tag =>
      tag[0] === 'e' && tag[3] === 'root'
    );
    if (rootTag) {
      return rootTag;
    }
    // If there's only a single 'e' tag with no marker, it's likely a reply to that event
    const eTags = event.tags.filter(tag => tag[0] === 'e');
    if (eTags.length === 1) {
      return eTags[0];
    }
    return undefined;
  });
  // Fetch the event being replied to
  $effect(() => {
    if (replyToTag) {
      ndk.fetchEventFromTag(replyToTag, event).then((fetchedEvent) => {
        if (fetchedEvent) {
          replyToEvent = fetchedEvent;
          // Fetch the profile of the replied-to event's author
          fetchedEvent.author.fetchProfile().then((profile) => {
            replyToProfile = profile;
          });
        }
      });
    }
  });
  // Derive the display name for the replied-to user
  const replyToDisplayName = $derived.by(() => {
    if (!replyToEvent) return '';
    if (replyToProfile?.name) return replyToProfile.name;
    if (replyToProfile?.displayName) return replyToProfile.displayName;
    return `${replyToEvent.pubkey.slice(0, 8)}...`;
  });
  // Derive the npub for the profile link
  const replyToNpub = $derived.by(() => {
    return replyToEvent ? nip19.npubEncode(replyToEvent.pubkey) : '';
  });
</script>
{#if replyToEvent && replyToProfile}
  <div class="flex items-center gap-1 mb-2 text-sm text-muted-foreground">
    <span>Replying to</span>
    <a
      href="/p/{replyToNpub}"
      class="font-medium hover:underline text-muted-foreground"
    >
      @{replyToDisplayName}
    </a>
  </div>
{:else if replyToTag && !replyToEvent}
  <div class="flex items-center gap-1 mb-2 text-sm text-muted-foreground">
    <span>Replying to event</span>
  </div>
{/if}
</file>

<file path="ReportModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { NDKEvent, NDKUser } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Textarea } from '$lib/components/ui/textarea';
  import { t } from 'svelte-i18n';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    target: NDKUser | NDKEvent;
    open: boolean;
    onClose: () => void;
  }
  let { target, open, onClose }: Props = $props();
  let selectedReportType = $state<string>('');
  let additionalInfo = $state('');
  let isSubmitting = $state(false);
  const reportTypes = [
    { value: 'nudity', labelKey: 'report.types.nudity' },
    { value: 'malware', labelKey: 'report.types.malware' },
    { value: 'profanity', labelKey: 'report.types.profanity' },
    { value: 'illegal', labelKey: 'report.types.illegal' },
    { value: 'spam', labelKey: 'report.types.spam' },
    { value: 'impersonation', labelKey: 'report.types.impersonation' },
    { value: 'other', labelKey: 'report.types.other' }
  ];
  async function handleSubmit() {
    if (!selectedReportType) {
      toast.error($t('report.errors.selectType'));
      return;
    }
    const currentUser = ndk.activeUser;
    if (!currentUser) {
      toast.error($t('report.errors.notLoggedIn'));
      return;
    }
    try {
      isSubmitting = true;
      // Create NIP-56 report event (kind 1984)
      const reportEvent = new NDKEvent(ndk);
      reportEvent.kind = 1984;
      // NDK automatically adds the correct tag (e or p) based on the target type
      reportEvent.tag(target, selectedReportType);
      // Add additional info as content if provided
      if (additionalInfo.trim()) {
        reportEvent.content = additionalInfo.trim();
      }
      await reportEvent.publish();
      toast.success($t('report.success'));
      onClose();
      // Reset form
      selectedReportType = '';
      additionalInfo = '';
    } catch (error) {
      console.error('Failed to submit report:', error);
      toast.error($t('report.errors.failed'));
    } finally {
      isSubmitting = false;
    }
  }
  function handleClose() {
    if (!isSubmitting) {
      selectedReportType = '';
      additionalInfo = '';
      onClose();
    }
  }
  // Watch for dialog close
  $effect(() => {
    if (!open) {
      handleClose();
    }
  });
</script>
{#if isDesktop.current}
  <Dialog.Root bind:open>
    <Dialog.Content class="max-w-md">
      <Dialog.Header>
        <Dialog.Title>{$t('report.title')}</Dialog.Title>
        <Dialog.Description>
          {$t('report.description')}
        </Dialog.Description>
      </Dialog.Header>
      <div class="space-y-4 py-4">
        <!-- Report Type Selection -->
        <div>
          <label class="text-sm font-medium mb-2 block">
            {$t('report.selectReason')}
          </label>
          <div class="space-y-2">
            {#each reportTypes as type}
              <label class="flex items-center gap-3 p-3 border border-border rounded-lg hover:bg-muted cursor-pointer transition-colors">
                <input
                  type="radio"
                  name="reportType"
                  value={type.value}
                  bind:group={selectedReportType}
                  disabled={isSubmitting}
                  class="w-4 h-4"
                />
                <span class="text-sm">{$t(type.labelKey)}</span>
              </label>
            {/each}
          </div>
        </div>
        <!-- Additional Information -->
        <div>
          <label for="report-additional-info" class="text-sm font-medium mb-2 block">
            {$t('report.additionalInfo')} {$t('common.optional')}
          </label>
          <Textarea
            id="report-additional-info"
            bind:value={additionalInfo}
            placeholder={$t('report.additionalInfoPlaceholder')}
            disabled={isSubmitting}
            class="resize-none"
            rows={3}
          />
        </div>
        <!-- Warning -->
        <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
          <p class="text-sm text-yellow-600 dark:text-yellow-400">
            {$t('report.warning')}
          </p>
        </div>
      </div>
      <div class="flex gap-3 justify-end">
        <Button
          variant="outline"
          onclick={handleClose}
          disabled={isSubmitting}
        >
          {$t('common.cancel')}
        </Button>
        <Button
          onclick={handleSubmit}
          disabled={!selectedReportType || isSubmitting}
          variant="destructive"
        >
          {#if isSubmitting}
            {$t('report.submitting')}
          {:else}
            {$t('report.submit')}
          {/if}
        </Button>
      </div>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root bind:open>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>{$t('report.title')}</Drawer.Title>
        <Drawer.Description>
          {$t('report.description')}
        </Drawer.Description>
      </Drawer.Header>
      <div class="space-y-4 py-4 px-4">
        <!-- Report Type Selection -->
        <div>
          <label class="text-sm font-medium mb-2 block">
            {$t('report.selectReason')}
          </label>
          <div class="space-y-2">
            {#each reportTypes as type}
              <label class="flex items-center gap-3 p-3 border border-border rounded-lg hover:bg-muted cursor-pointer transition-colors">
                <input
                  type="radio"
                  name="reportType"
                  value={type.value}
                  bind:group={selectedReportType}
                  disabled={isSubmitting}
                  class="w-4 h-4"
                />
                <span class="text-sm">{$t(type.labelKey)}</span>
              </label>
            {/each}
          </div>
        </div>
        <!-- Additional Information -->
        <div>
          <label for="report-additional-info" class="text-sm font-medium mb-2 block">
            {$t('report.additionalInfo')} {$t('common.optional')}
          </label>
          <Textarea
            id="report-additional-info"
            bind:value={additionalInfo}
            placeholder={$t('report.additionalInfoPlaceholder')}
            disabled={isSubmitting}
            class="resize-none"
            rows={3}
          />
        </div>
        <!-- Warning -->
        <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
          <p class="text-sm text-yellow-600 dark:text-yellow-400">
            {$t('report.warning')}
          </p>
        </div>
      </div>
      <Drawer.Footer class="pt-2">
        <div class="flex gap-3">
          <Button
            variant="outline"
            onclick={handleClose}
            disabled={isSubmitting}
            class="flex-1"
          >
            {$t('common.cancel')}
          </Button>
          <Button
            onclick={handleSubmit}
            disabled={!selectedReportType || isSubmitting}
            variant="destructive"
            class="flex-1"
          >
            {#if isSubmitting}
              {$t('report.submitting')}
            {:else}
              {$t('report.submit')}
            {/if}
          </Button>
        </div>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="SelectedPackMemberItem.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
    onRemove: (pubkey: string) => void;
  }
  let { pubkey, onRemove }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
</script>
<div class="flex items-center gap-3 p-2 rounded-lg bg-card/50">
  <Avatar {ndk} {pubkey} class="w-8 h-8 flex-shrink-0" />
  <div class="flex-1 min-w-0">
    <div class="text-sm font-medium text-foreground truncate">
      {profile?.displayName || profile?.name || `${pubkey.slice(0, 8)}...`}
    </div>
    <div class="text-xs text-muted-foreground truncate">
      {profile?.nip05 || `${pubkey.slice(0, 16)}...`}
    </div>
  </div>
  <button
    onclick={() => onRemove(pubkey)}
    class="p-1 text-muted-foreground hover:text-red-500 transition-colors"
    aria-label="Remove member"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
</div>
</file>

<file path="ShareProfileModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { ndk } from '$lib/ndk.svelte';
  import QRCode from './wallet/QRCode.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    isOpen: boolean;
    onClose: () => void;
    pubkey: string;
    npub: string;
  }
  let { isOpen = $bindable(), onClose, pubkey, npub }: Props = $props();
  const isDesktop = new MediaQuery('(min-width: 768px)');
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  let copiedUrl = $state(false);
  let copiedNpub = $state(false);
  const profileUrl = `https://njump.me/${npub}`;
  const shareMessage = $derived(`Find me on Nostr: ${profileUrl}`);
  async function copyToClipboard(text: string, type: 'url' | 'npub') {
    await navigator.clipboard.writeText(text);
    if (type === 'url') {
      copiedUrl = true;
      setTimeout(() => copiedUrl = false, 2000);
    } else {
      copiedNpub = true;
      setTimeout(() => copiedNpub = false, 2000);
    }
  }
  function shareOnPlatform(platform: 'whatsapp' | 'twitter' | 'telegram' | 'facebook') {
    const encodedMessage = encodeURIComponent(shareMessage);
    const encodedUrl = encodeURIComponent(profileUrl);
    const urls = {
      whatsapp: `https://wa.me/?text=${encodedMessage}`,
      twitter: `https://twitter.com/intent/tweet?text=${encodedMessage}`,
      telegram: `https://t.me/share/url?url=${encodedUrl}&text=${encodeURIComponent('Find me on Nostr')}`,
      facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`
    };
    window.open(urls[platform], '_blank');
  }
  async function handleNativeShare() {
    if (navigator.share) {
      try {
        await navigator.share({
          title: `${profile?.name || 'Anonymous'} on Nostr`,
          text: 'Find me on Nostr',
          url: profileUrl
        });
      } catch (err) {
        console.error('Error sharing:', err);
      }
    }
  }
</script>
{#if isDesktop.current}
  <Dialog.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) onClose();
    }}>
    <Dialog.Content class="max-w-md">
      <Dialog.Header>
        <Dialog.Title>Share Profile</Dialog.Title>
      </Dialog.Header>
      <div class="space-y-4">
        <div class="bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl p-6 mb-6">
          <div class="flex flex-col items-center text-foreground">
            <div class="relative mb-4">
              <Avatar {ndk} {pubkey} class="w-20 h-20 ring-4 ring-white/20" />
            </div>
            <h3 class="text-xl font-bold mb-1">{profile?.name || 'Anonymous'}</h3>
            {#if profile?.nip05}
              <p class="text-foreground/80 text-sm">@{profile.nip05.split('@')[0]}</p>
            {/if}
          </div>
        </div>
        <div class="flex justify-center mb-6">
          <QRCode value={profileUrl} size={200} />
        </div>
        <div class="space-y-3">
          <Button
            variant="outline"
            onclick={() => copyToClipboard(profileUrl, 'url')}
            class="w-full justify-between"
          >
            <span class="text-sm font-medium">njump.me/{npub.slice(0, 8)}...</span>
            {#if copiedUrl}
              <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            {:else}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            {/if}
          </Button>
          <Button
            variant="outline"
            onclick={() => copyToClipboard(npub, 'npub')}
            class="w-full justify-between"
          >
            <span class="text-sm font-medium">Copy npub</span>
            {#if copiedNpub}
              <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            {:else}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            {/if}
          </Button>
        </div>
        <div class="space-y-2">
          <p class="text-sm text-muted-foreground">Share on:</p>
          <div class="grid grid-cols-2 gap-3">
            <Button
              onclick={() => shareOnPlatform('whatsapp')}
              class="bg-green-500 hover:bg-green-600 text-white dark:text-white"
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
              WhatsApp
            </Button>
            <Button
              variant="outline"
              onclick={() => shareOnPlatform('twitter')}
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              X
            </Button>
            <Button
              onclick={() => shareOnPlatform('telegram')}
              class="bg-blue-500 hover:bg-blue-600 text-white dark:text-white"
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
              </svg>
              Telegram
            </Button>
            <Button
              onclick={() => shareOnPlatform('facebook')}
              class="bg-blue-600 hover:bg-blue-700 text-white dark:text-white"
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              Facebook
            </Button>
          </div>
          {#if typeof navigator !== 'undefined' && navigator.share}
            <Button
              onclick={handleNativeShare}
              class="w-full mt-3"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
              More Options
            </Button>
          {/if}
        </div>
      </div>
    </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={isOpen} onOpenChange={(newOpen) => {
      isOpen = newOpen;
      if (!newOpen) onClose();
    }}>
    <Drawer.Content>
      <Drawer.Header class="text-left">
        <Drawer.Title>Share Profile</Drawer.Title>
      </Drawer.Header>
      <div class="space-y-4 px-4">
        <div class="bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl p-6 mb-6">
          <div class="flex flex-col items-center text-foreground">
            <div class="relative mb-4">
              <Avatar {ndk} {pubkey} class="w-20 h-20 ring-4 ring-white/20" />
            </div>
            <h3 class="text-xl font-bold mb-1">{profile?.name || 'Anonymous'}</h3>
            {#if profile?.nip05}
              <p class="text-foreground/80 text-sm">@{profile.nip05.split('@')[0]}</p>
            {/if}
          </div>
        </div>
        <div class="flex justify-center mb-6">
          <QRCode value={profileUrl} size={200} />
        </div>
        <div class="space-y-3">
          <Button
            variant="outline"
            onclick={() => copyToClipboard(profileUrl, 'url')}
            class="w-full justify-between"
          >
            <span class="text-sm font-medium">njump.me/{npub.slice(0, 8)}...</span>
            {#if copiedUrl}
              <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            {:else}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            {/if}
          </Button>
          <Button
            variant="outline"
            onclick={() => copyToClipboard(npub, 'npub')}
            class="w-full justify-between"
          >
            <span class="text-sm font-medium">Copy npub</span>
            {#if copiedNpub}
              <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            {:else}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            {/if}
          </Button>
        </div>
        <div class="space-y-2">
          <p class="text-sm text-muted-foreground">Share on:</p>
          <div class="grid grid-cols-2 gap-3">
            <Button
              onclick={() => shareOnPlatform('whatsapp')}
              class="bg-green-500 hover:bg-green-600 text-white dark:text-white"
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
              WhatsApp
            </Button>
            <Button
              variant="outline"
              onclick={() => shareOnPlatform('twitter')}
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              X
            </Button>
            <Button
              onclick={() => shareOnPlatform('telegram')}
              class="bg-blue-500 hover:bg-blue-600 text-white dark:text-white"
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
              </svg>
              Telegram
            </Button>
            <Button
              onclick={() => shareOnPlatform('facebook')}
              class="bg-blue-600 hover:bg-blue-700 text-white dark:text-white"
            >
              <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              Facebook
            </Button>
          </div>
          {#if typeof navigator !== 'undefined' && navigator.share}
            <Button
              onclick={handleNativeShare}
              class="w-full mt-3"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
              More Options
            </Button>
          {/if}
        </div>
      </div>
      <Drawer.Footer class="pt-2">
        <button
          type="button"
          onclick={() => { isOpen = false; onClose(); }}
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-background shadow-xs hover:bg-accent hover:text-accent-foreground border h-9 px-4 py-2 w-full"
        >
          Close
        </button>
      </Drawer.Footer>
    </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="SplashScreen.svelte">
<script lang="ts">
	import { fade } from 'svelte/transition';
	let { visible = true }: { visible: boolean } = $props();
</script>
{#if visible}
	<div class="splash-screen" transition:fade={{ duration: 300 }}>
		<div class="splash-content">
			<div class="logo">
				<img src="/logo.svg" alt="Agora" />
			</div>
		</div>
	</div>
{/if}
<style>
	.splash-screen {
		position: fixed;
		inset: 0;
		background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary) / 0.8) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 9999;
	}
	.splash-content {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1.5rem;
	}
	.logo {
		width: 280px;
		height: auto;
		animation: pulse 2s ease-in-out infinite;
	}
	.logo img {
		width: 100%;
		height: auto;
		display: block;
	}
	@keyframes pulse {
		0%, 100% {
			opacity: 1;
			transform: scale(1);
		}
		50% {
			opacity: 0.8;
			transform: scale(1.05);
		}
	}
</style>
</file>

<file path="TextHighlightToolbar.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKEvent, type NDKArticle } from '@nostr-dev-kit/ndk';
  interface Props {
    article: NDKArticle;
    selectedText: string;
    position: { x: number; y: number };
    onHighlightCreated: () => void;
    onCancel: () => void;
  }
  let { article, selectedText, position, onHighlightCreated, onCancel }: Props = $props();
  let isCreating = $state(false);
  let error = $state<string | null>(null);
  async function createHighlight() {
    if (!ndk.$currentUser) {
      error = 'You must be logged in to create highlights';
      return;
    }
    if (!selectedText.trim()) {
      error = 'No text selected';
      return;
    }
    isCreating = true;
    error = null;
    try {
      const highlight = new NDKEvent(ndk);
      highlight.kind = 9802; // NIP-84 Highlight
      highlight.content = selectedText.trim();
      highlight.tags = [
        ['a', article.tagId()], // Reference to the article
        ['p', article.pubkey, '', 'author'], // Original author
      ];
      await highlight.publish();
      onHighlightCreated();
    } catch (err) {
      error = err instanceof Error ? err.message : 'Failed to create highlight';
      console.error('Failed to create highlight:', err);
      isCreating = false;
    }
  }
</script>
<div
  class="fixed z-50 bg-card text-foreground rounded-lg shadow-xl border border-border overflow-hidden"
  style="left: {position.x}px; top: {position.y}px; transform: translate(-50%, -100%) translateY(-12px);"
>
  {#if error}
    <div class="px-4 py-2 bg-red-900/20 text-red-400 text-sm border-b border-red-800">
      {error}
    </div>
  {/if}
  <div class="flex items-center">
    <button
      type="button"
      onclick={createHighlight}
      disabled={isCreating}
      class="flex items-center gap-2 px-4 py-3 hover:bg-muted transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      title="Create highlight"
    >
      {#if isCreating}
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      {:else}
        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      {/if}
      <span class="text-sm font-medium">Highlight</span>
    </button>
    <div class="w-px h-6 bg-muted" />
    <button
      type="button"
      onclick={onCancel}
      class="px-3 py-3 hover:bg-muted transition-colors"
      title="Cancel"
      disabled={isCreating}
    >
      <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
</div>
<!-- Triangle pointer -->
<div
  class="fixed z-50"
  style="left: {position.x}px; top: {position.y}px; transform: translate(-50%, -100%);"
>
  <div class="w-3 h-3 bg-card border-r border-b border-border rotate-45 translate-y-1.5" />
</div>
</file>

<file path="TikTokVideoFeed.svelte">
<script lang="ts">
  import type { NDKEvent, NDKImetaTag } from '@nostr-dev-kit/ndk';
  import { mapImetaTag } from '@nostr-dev-kit/ndk';
  import { onMount } from 'svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { ndk } from '$lib/ndk.svelte';
  import EventActions from './EventActions.svelte';
  interface Props {
    events: NDKEvent[];
  }
  const { events }: Props = $props();
  interface VideoItem {
    event: NDKEvent;
    imeta: NDKImetaTag;
    element?: HTMLVideoElement;
  }
  let containerRef = $state<HTMLDivElement | null>(null);
  let isMuted = $state(true);
  let currentVideoIndex = $state(0);
  function extractMediaUrls(content: string): string[] {
    const urlRegex = /(https?:\/\/[^\s]+\.(mp4|webm|mov|avi|mkv))/gi;
    return content.match(urlRegex) || [];
  }
  function getMediaType(imeta: NDKImetaTag): 'video' | 'other' {
    const mime = imeta.m;
    const url = imeta.url;
    if (mime && mime.startsWith('video/')) return 'video';
    if (url) {
      const ext = url.split('.').pop()?.toLowerCase();
      if (['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(ext || '')) return 'video';
    }
    return 'other';
  }
  const videoItems = $derived<VideoItem[]>(events.flatMap(event => {
    const imetaTags = event.tags.filter(tag => tag[0] === 'imeta');
    const imetas = imetaTags.map(tag => mapImetaTag(tag));
    const imetaItems = imetas
      .filter(imeta => imeta.url && getMediaType(imeta) === 'video')
      .map(imeta => ({ event, imeta }));
    if (imetaItems.length > 0) {
      return imetaItems;
    }
    const contentUrls = extractMediaUrls(event.content);
    return contentUrls.map(url => {
      const ext = url.split('.').pop()?.toLowerCase();
      return {
        event,
        imeta: {
          url,
          m: 'video/' + ext,
        } as NDKImetaTag
      };
    });
  }));
  let observer: IntersectionObserver | null = null;
  let videoElements = new Map<number, HTMLVideoElement>();
  onMount(() => {
    observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const videoElement = entry.target as HTMLVideoElement;
          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
            videoElement.play().catch(err => {
              console.log('Auto-play prevented:', err);
            });
          } else {
            videoElement.pause();
          }
        });
      },
      {
        root: null,
        threshold: [0.5],
      }
    );
    // Auto-play the first video
    setTimeout(() => {
      const firstVideo = videoElements.get(0);
      if (firstVideo) {
        firstVideo.play().catch(err => {
          console.log('Auto-play prevented:', err);
        });
      }
    }, 100);
    return () => {
      observer?.disconnect();
    };
  });
  function registerVideoRef(videoElement: HTMLVideoElement, index: number) {
    videoElements.set(index, videoElement);
    if (observer) {
      observer.observe(videoElement);
    }
    return {
      destroy() {
        videoElements.delete(index);
        if (observer) {
          observer.unobserve(videoElement);
        }
      }
    };
  }
</script>
{#if videoItems.length === 0}
  <div class="flex items-center justify-center h-[calc(100vh-12rem)] text-muted-foreground">
    No videos found
  </div>
{:else}
  <div
    bind:this={containerRef}
    class="fixed inset-0 overflow-y-scroll snap-y snap-mandatory scrollbar-hide bg-black lg:bottom-0 bottom-[72px]"
  >
    {#each videoItems as { event, imeta }, index (`${event.id}-${index}`)}
      <div class="relative w-screen snap-start snap-always flex items-center justify-center bg-black h-screen lg:h-screen">
        <video
          use:registerVideoRef={index}
          src={imeta.url}
          class="w-full h-full object-contain"
          loop
          playsinline
          preload="auto"
          muted={isMuted}
        >
          <track kind="captions" />
        </video>
        <!-- Video Overlay UI -->
        <div class="absolute inset-0 pointer-events-none">
          <!-- Top gradient with author info -->
          <div class="absolute top-0 left-0 right-0 bg-gradient-to-b from-black/70 via-black/20 to-transparent p-4 pointer-events-auto">
            <div class="flex items-center gap-3">
              <Avatar {ndk} pubkey={event.pubkey} class="w-10 h-10 rounded-full border-2 border-white" />
              <div class="flex-1 min-w-0">
                <div class="text-white font-semibold text-sm truncate">
                  {event.author?.profile?.name || event.author?.npub?.substring(0, 8)}
                </div>
              </div>
            </div>
          </div>
          <!-- Mute/Unmute button (right side, middle) -->
          <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-auto">
            <button
              onclick={() => isMuted = !isMuted}
              class="w-12 h-12 rounded-full bg-black/50 hover:bg-black/70 backdrop-blur-sm flex items-center justify-center transition-colors"
              type="button"
              aria-label={isMuted ? 'Unmute' : 'Mute'}
            >
              {#if isMuted}
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                </svg>
              {:else}
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
              {/if}
            </button>
          </div>
          <!-- Bottom content and actions -->
          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent p-4 pointer-events-auto">
            <div class="flex items-end gap-4">
              <!-- Content area -->
              <div class="flex-1 min-w-0 mb-2">
                {#if event.content}
                  <p class="text-white text-sm mb-3 line-clamp-3">
                    {event.content.replace(imeta.url || '', '').trim()}
                  </p>
                {/if}
              </div>
              <!-- Action buttons -->
              <div class="flex flex-col items-center gap-4 pb-2">
                <EventActions {event} variant="tiktok" />
              </div>
            </div>
          </div>
        </div>
      </div>
    {/each}
  </div>
{/if}
<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
</file>

<file path="TimeAgo.svelte">
<script lang="ts">
  import { formatTimeAgo } from '$lib/utils/formatTime';
  interface Props {
    timestamp: number;
    class?: string;
  }
  const { timestamp, class: className = '' }: Props = $props();
  let formattedTime = $state(formatTimeAgo(timestamp));
  // Calculate update interval based on how old the timestamp is
  function getUpdateInterval(ts: number): number {
    const now = Date.now();
    const diff = now - (ts * 1000);
    const seconds = Math.floor(diff / 1000);
    if (seconds < 60) {
      return 1000; // Update every second for "just now"
    } else if (seconds < 3600) {
      return 60000; // Update every minute for minutes
    } else if (seconds < 86400) {
      return 3600000; // Update every hour for hours
    } else {
      return 86400000; // Update every day for days and beyond
    }
  }
  function updateTime() {
    formattedTime = formatTimeAgo(timestamp);
  }
  $effect(() => {
    // Set up interval to update the time
    const interval = getUpdateInterval(timestamp);
    const intervalId = setInterval(updateTime, interval);
    return () => {
      clearInterval(intervalId);
    };
  });
</script>
<time datetime={new Date(timestamp * 1000).toISOString()} class={className} title={new Date(timestamp * 1000).toLocaleString()}>
  {formattedTime}
</time>
</file>

<file path="Toaster.svelte">
<script lang="ts">
  import { toast } from '$lib/stores/toast.svelte';
  function getTypeStyles(type: 'success' | 'error' | 'info') {
    switch (type) {
      case 'success':
        return 'bg-green-600 border-green-500';
      case 'error':
        return 'bg-red-600 border-red-500';
      case 'info':
      default:
        return 'bg-blue-600 border-blue-500';
    }
  }
  function getIcon(type: 'success' | 'error' | 'info') {
    switch (type) {
      case 'success':
        return `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;
      case 'error':
        return `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
      case 'info':
      default:
        return `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
    }
  }
</script>
<div class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
  {#each toast.messages as message (message.id)}
    <div
      class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg border shadow-lg text-foreground animate-in slide-in-from-top duration-300 {getTypeStyles(message.type)}"
    >
      <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        {@html getIcon(message.type)}
      </svg>
      <span class="text-sm font-medium">{message.message}</span>
      <button
        onclick={() => toast.dismiss(message.id)}
        class="ml-2 hover:opacity-70 transition-opacity"
        aria-label="Dismiss"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  {/each}
</div>
</file>

<file path="User.svelte">
<script lang="ts">
	import type { Snippet } from 'svelte';
	import { ndk } from '$lib/ndk.svelte';
	import { Avatar } from '@nostr-dev-kit/svelte';
	import UserHoverCard from './UserHoverCard.svelte';
    import type { NDKUserProfile, NDKUser } from '@nostr-dev-kit/ndk';
	interface Props {
		pubkey: string;
		variant?: 'avatar' | 'avatar-name' | 'avatar-name-handle' | 'avatar-name-bio' | 'avatar-name-meta';
		avatarSize?: string;
		nameSize?: string;
		handleSize?: string;
		bioSize?: string;
		meta?: Snippet;
		showHoverCard?: boolean;
		onclick?: (e: MouseEvent) => void;
		class?: string;
	}
	const {
		pubkey,
		variant = 'avatar',
		avatarSize = 'w-10 h-10',
		nameSize = 'text-base font-semibold',
		handleSize = 'text-sm text-muted-foreground',
		bioSize = 'text-sm text-muted-foreground',
		meta,
		showHoverCard = true,
		onclick,
		class: className = ''
	}: Props = $props();
	let user = $state<NDKUser | undefined>(undefined);
	let profile = $state<NDKUserProfile | null>(null);
	$effect(() => { ndk.fetchUser(pubkey).then(u => {
		user = u;
		u?.fetchProfile().then(p => { profile = p; });
	}) });
	let showUserHoverCard = $state(false);
	let hoverCardPosition = $state({ x: 0, y: 0 });
	let hoverTimer: ReturnType<typeof setTimeout> | null = null;
	let containerElement = $state<HTMLElement | null>(null);
	function handleClick(e: MouseEvent) {
		if (onclick) {
			onclick(e);
		} else {
			window.location.href = `/p/${user?.npub}`;
		}
	}
	function handleMouseEnter() {
		if (!showHoverCard) return;
		if (hoverTimer) clearTimeout(hoverTimer);
		hoverTimer = setTimeout(() => {
			if (containerElement) {
				const rect = containerElement.getBoundingClientRect();
				const viewportWidth = window.innerWidth;
				const cardWidth = 320; // w-80 = 320px
				const spacing = 16;
				let x = rect.right + spacing;
				if (x + cardWidth > viewportWidth - spacing) {
					x = rect.left - cardWidth - spacing;
				}
				const y = rect.top;
				hoverCardPosition = { x, y };
				showUserHoverCard = true;
			}
		}, 500);
	}
	function handleMouseLeave() {
		if (hoverTimer) {
			clearTimeout(hoverTimer);
			hoverTimer = null;
		}
		hoverTimer = setTimeout(() => {
			showUserHoverCard = false;
		}, 100);
	}
	function handleHoverCardMouseEnter() {
		if (hoverTimer) {
			clearTimeout(hoverTimer);
			hoverTimer = null;
		}
	}
	function handleHoverCardMouseLeave() {
		showUserHoverCard = false;
	}
	const displayName = $derived(profile?.displayName || profile?.name || `${pubkey?.slice(0, 8)}...`);
	const handle = $derived(profile?.name || pubkey?.slice(0, 8));
</script>
{#if variant === 'avatar'}
	<button
		bind:this={containerElement}
		type="button"
		onclick={handleClick}
		onmouseenter={handleMouseEnter}
		onmouseleave={handleMouseLeave}
		class="flex-shrink-0 {className}"
	>
		<Avatar {ndk} {pubkey} class="{avatarSize} cursor-pointer hover:opacity-80 transition-opacity" />
	</button>
{:else if variant === 'avatar-name'}
	<button
		bind:this={containerElement}
		type="button"
		onclick={handleClick}
		onmouseenter={handleMouseEnter}
		onmouseleave={handleMouseLeave}
		class="flex items-center gap-3 cursor-pointer {className}"
	>
		<Avatar {ndk} {pubkey} class="{avatarSize} hover:opacity-80 transition-opacity" />
		<p class="{nameSize} text-foreground truncate hover:underline flex-1 min-w-0 text-left">{displayName}</p>
	</button>
{:else if variant === 'avatar-name-handle'}
	<button
		bind:this={containerElement}
		type="button"
		onclick={handleClick}
		onmouseenter={handleMouseEnter}
		onmouseleave={handleMouseLeave}
		class="flex items-center gap-3 cursor-pointer text-left w-full {className}"
	>
		<Avatar {ndk} {pubkey} class="{avatarSize} hover:opacity-80 transition-opacity flex-shrink-0" />
		<div class="flex-1 min-w-0">
			<p class="{nameSize} text-foreground truncate hover:underline">{displayName}</p>
			<p class="{handleSize} truncate">@{handle}</p>
		</div>
	</button>
{:else if variant === 'avatar-name-bio'}
	<button
		bind:this={containerElement}
		type="button"
		onclick={handleClick}
		onmouseenter={handleMouseEnter}
		onmouseleave={handleMouseLeave}
		class="flex items-center gap-3 cursor-pointer text-left w-full {className}"
	>
		<Avatar {ndk} {pubkey} class="{avatarSize} hover:opacity-80 transition-opacity flex-shrink-0" />
		<div class="flex-1 min-w-0">
			<p class="{nameSize} text-foreground truncate hover:underline">{displayName}</p>
			{#if profile?.about}
				<p class="{bioSize} truncate line-clamp-2">{profile.about}</p>
			{/if}
		</div>
	</button>
{:else if variant === 'avatar-name-meta'}
	<div
		bind:this={containerElement}
		onmouseenter={handleMouseEnter}
		onmouseleave={handleMouseLeave}
		class="flex items-center gap-3 {className}"
	>
		<button
			type="button"
			onclick={handleClick}
			class="flex-shrink-0"
		>
			<Avatar {ndk} {pubkey} class="{avatarSize} cursor-pointer hover:opacity-80 transition-opacity" />
		</button>
		<div class="flex-1 min-w-0">
			<button
				type="button"
				onclick={handleClick}
				class="text-left"
			>
				<p class="{nameSize} text-foreground truncate hover:underline">{displayName}</p>
			</button>
			{#if meta}
				{@render meta()}
			{/if}
		</div>
	</div>
{/if}
<!-- User Hover Card -->
<div
	onmouseenter={handleHoverCardMouseEnter}
	onmouseleave={handleHoverCardMouseLeave}
>
	<UserHoverCard
		{pubkey}
		isVisible={showUserHoverCard}
		position={hoverCardPosition}
	/>
</div>
<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
</file>

<file path="UserCard.svelte">
<script lang="ts">
	import { ndk } from '$lib/ndk.svelte';
	import { Avatar } from '@nostr-dev-kit/svelte';
	import FollowButton from './FollowButton.svelte';
	import { formatTimeAgo } from '$lib/utils/formatTime';
	import type { NDKUser, NDKUserProfile } from '@nostr-dev-kit/ndk';
	interface Props {
		pubkey: string;
		showFollow?: boolean;
		showAbout?: boolean;
		joinedAt?: number;
		inviterPubkey?: string | null;
		clickable?: boolean;
		class?: string;
	}
	let {
		pubkey,
		showFollow = true,
		showAbout = true,
		joinedAt,
		inviterPubkey,
		clickable = true,
		class: className = ''
	}: Props = $props();
	let user = $state<NDKUser | undefined>(undefined);
	let profile = $state<NDKUserProfile | null>(null);
	let inviterUser = $state<NDKUser | undefined>(undefined);
	let inviterProfile = $state<NDKUserProfile | null>(null);
	$effect(() => {
		ndk.fetchUser(pubkey).then(u => {
			user = u;
			u?.fetchProfile().then(p => { profile = p; });
		});
	});
	$effect(() => {
		if (!inviterPubkey) {
			inviterUser = undefined;
			inviterProfile = null;
			return;
		}
		ndk.fetchUser(inviterPubkey).then(u => {
			inviterUser = u;
			u?.fetchProfile().then(p => { inviterProfile = p; });
		});
	});
</script>
<div class="flex items-start gap-3 p-4 bg-card rounded-lg border border-border hover:border-primary/30 transition-colors {className}">
	<Avatar {ndk} {pubkey} class="w-12 h-12 rounded-full" />
	<div class="flex-1 min-w-0">
		<div class="flex items-start justify-between gap-2">
			<div class="flex-1 min-w-0">
				{#if clickable}
					<a href="/p/{user.npub}" class="block group">
						<h4 class="font-semibold text-foreground group-hover:text-primary transition-colors truncate">
							{profile?.displayName || profile?.name || 'Anon'}
						</h4>
						{#if profile?.nip05}
							<p class="text-sm text-muted-foreground truncate">
								{profile.nip05}
							</p>
						{/if}
					</a>
				{:else}
					<h4 class="font-semibold text-foreground truncate">
						{profile?.displayName || profile?.name || 'Anon'}
					</h4>
					{#if profile?.nip05}
						<p class="text-sm text-muted-foreground truncate">
							{profile.nip05}
						</p>
					{/if}
				{/if}
				{#if joinedAt || inviterPubkey}
					<div class="flex items-center gap-2 mt-1 text-xs text-muted-foreground">
						{#if joinedAt}
							<span>Joined {formatTimeAgo(joinedAt)}</span>
						{/if}
						{#if inviterPubkey && inviterProfile}
							{#if joinedAt}
								<span>‚Ä¢</span>
							{/if}
							<span>
								Invited by
								<a href="/p/{inviterUser?.npub}" class="text-primary hover:underline">
									{inviterProfile.displayName || inviterProfile.name || 'someone'}
								</a>
							</span>
						{/if}
					</div>
				{/if}
				{#if showAbout && profile?.about}
					<p class="mt-2 text-sm text-foreground/80 line-clamp-2">
						{profile.about}
					</p>
				{/if}
			</div>
			{#if showFollow}
				<div class="flex-shrink-0">
					<FollowButton {pubkey} iconOnly={true} />
				</div>
			{/if}
		</div>
	</div>
</div>
</file>

<file path="UserDropdown.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { NDKKind, NDKEvent, NDKUser } from '@nostr-dev-kit/ndk';
  import { toast } from '$lib/stores/toast.svelte';
  import { t } from 'svelte-i18n';
  import { createLazyFeed } from '$lib/utils/lazyFeed.svelte';
  import ReportModal from '$lib/components/ReportModal.svelte';
  interface Props {
    pubkey: string;
    isOpen: boolean;
    onClose: () => void;
    onOpenCreatePack: () => void;
  }
  let { pubkey, isOpen, onClose, onOpenCreatePack }: Props = $props();
  const reportTarget = $derived(new NDKUser({ pubkey }));
  // Fetch current user's created follow packs
  const userPacksFeed = createLazyFeed(
    ndk,
    () => ndk.$currentUser?.pubkey ? {
      filters: [{ kinds: [39089, 39092], authors: [ndk.$currentUser.pubkey], limit: 100 }]
    } : undefined,
    { initialLimit: 100, pageSize: 100 }
  );
  // Fetch current user's mute list
  const muteListSubscription = ndk.$subscribe(
    () => ndk.$currentUser?.pubkey ? ({
      filters: [{ kinds: [10000], authors: [ndk.$currentUser.pubkey], limit: 1 }],
      bufferMs: 100,
    }) : undefined
  );
  interface UserPack {
    id: string;
    title: string;
    pubkeys: string[];
  }
  const userPacks = $derived.by((): UserPack[] => {
    return userPacksFeed.events.map(event => ({
      id: event.id || '',
      title: event.tagValue('title') || 'Untitled Pack',
      pubkeys: event.tags.filter(t => t[0] === 'p').map(t => t[1]),
    }));
  });
  const isMuted = $derived.by(() => {
    const muteList = muteListSubscription.events[0];
    if (!muteList) return false;
    return muteList.tags.some(tag => tag[0] === 'p' && tag[1] === pubkey);
  });
  let isReportModalOpen = $state(false);
  async function addToExistingPack(packId: string) {
    if (!pubkey) return;
    const packEvent = userPacksFeed.events.find(e => e.id === packId);
    if (!packEvent) return;
    try {
      const existingPubkeys = packEvent.tags.filter(t => t[0] === 'p').map(t => t[1]);
      if (existingPubkeys.includes(pubkey)) {
        return;
      }
      packEvent.tags.push(['p', pubkey]);
      await packEvent.sign();
      await packEvent.publishReplaceable();
      if (packEvent.publishStatus === 'error') {
        const error = packEvent.publishError;
        const relayErrors = error?.relayErrors || {};
        const errorMessages = Object.entries(relayErrors)
          .map(([relay, err]) => `${relay}: ${err}`)
          .join('\n');
        toast.error(`Failed to publish:\n${errorMessages || 'Unknown error'}`);
        return;
      }
      toast.success('Added to pack');
      onClose();
    } catch (error) {
      console.error('Failed to add to pack:', error);
      toast.error(`Failed to add to pack: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }
  async function toggleMute() {
    if (!ndk.$currentUser?.pubkey) return;
    try {
      let muteList = muteListSubscription.events[0];
      if (!muteList) {
        // Create new mute list
        muteList = new NDKEvent(ndk);
        muteList.kind = 10000;
        muteList.content = '';
        muteList.tags = [];
      }
      if (isMuted) {
        // Remove from mute list
        muteList.tags = muteList.tags.filter(tag => !(tag[0] === 'p' && tag[1] === pubkey));
        toast.success('User unmuted');
      } else {
        // Add to mute list
        muteList.tags.push(['p', pubkey]);
        toast.success('User muted');
      }
      await muteList.sign();
      await muteList.publishReplaceable();
      if (muteList.publishStatus === 'error') {
        const error = muteList.publishError;
        const relayErrors = error?.relayErrors || {};
        const errorMessages = Object.entries(relayErrors)
          .map(([relay, err]) => `${relay}: ${err}`)
          .join('\n');
        toast.error(`Failed to publish:\n${errorMessages || 'Unknown error'}`);
        return;
      }
      onClose();
    } catch (error) {
      console.error('Failed to toggle mute:', error);
      toast.error(`Failed to ${isMuted ? 'unmute' : 'mute'} user: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }
  function handleCreatePack() {
    onClose();
    onOpenCreatePack();
  }
  function handleOpenReport() {
    isReportModalOpen = true;
    onClose();
  }
</script>
{#if isOpen}
  <div class="absolute right-0 mt-2 w-64 bg-popover border border-border rounded-lg shadow-xl overflow-hidden z-50">
    <div class="py-1">
      <!-- Mute/Unmute button -->
      <button
        onclick={toggleMute}
        class="w-full px-4 py-3 text-left text-sm text-muted-foreground hover:bg-muted transition-colors flex items-center gap-3"
      >
        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          {#if isMuted}
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          {:else}
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          {/if}
        </svg>
        {isMuted ? $t('userDropdown.unmute') : $t('userDropdown.mute')}
      </button>
      <!-- Report button -->
      <button
        onclick={handleOpenReport}
        class="w-full px-4 py-3 text-left text-sm text-muted-foreground hover:bg-muted transition-colors flex items-center gap-3"
      >
        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        {$t('userDropdown.report')}
      </button>
      <div class="border-t border-border my-1"></div>
      <!-- Create new pack button -->
      <button
        onclick={handleCreatePack}
        class="w-full px-4 py-3 text-left text-sm text-muted-foreground hover:bg-muted transition-colors flex items-center gap-3"
      >
        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        {$t('followPacks.createNew')}
      </button>
      {#if userPacks.length > 0}
        <div class="border-t border-border mt-1 pt-1">
          <div class="px-4 py-2 text-xs text-muted-foreground font-medium">
            {$t('followPacks.addToExisting')}
          </div>
          {#each userPacks as pack (pack.id)}
            {@const alreadyInPack = pack.pubkeys.includes(pubkey)}
            <button
              onclick={() => addToExistingPack(pack.id)}
              disabled={alreadyInPack}
              class="w-full px-4 py-2.5 text-left text-sm text-muted-foreground hover:bg-muted transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-between gap-2"
            >
              <span class="truncate">{pack.title}</span>
              {#if alreadyInPack}
                <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              {/if}
            </button>
          {/each}
        </div>
      {/if}
    </div>
  </div>
{/if}
<ReportModal
  target={reportTarget}
  open={isReportModalOpen}
  onClose={() => isReportModalOpen = false}
/>
</file>

<file path="UserHoverCard.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { EventContent } from '@nostr-dev-kit/svelte';
  import FollowButton from './FollowButton.svelte';
  import { generateBannerGradient } from '$lib/utils/bannerGradient';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    pubkey: string;
    isVisible: boolean;
    position: { x: number; y: number };
  }
  const { pubkey, isVisible, position }: Props = $props();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  const isOwnProfile = $derived(ndk.$currentUser?.pubkey === pubkey);
  // Subscribe to user's notes to get note count
  const notesSubscription = ndk.$subscribe(
    () => pubkey && isVisible ? ({
      filters: [{ kinds: [1], authors: [pubkey], limit: 100 }],
      bufferMs: 100,
    }) : undefined
  );
  // Subscribe to contact list to get following count
  const contactListSubscription = ndk.$subscribe(
    () => pubkey && isVisible ? ({
      filters: [{ kinds: [3], authors: [pubkey], limit: 1 }],
      bufferMs: 100,
    }) : undefined
  );
  const noteCount = $derived.by(() => {
    return notesSubscription.events.filter(e => !e.tags.some(tag => tag[0] === 'e')).length;
  });
  const followingCount = $derived.by(() => {
    const contactList = contactListSubscription.events[0];
    if (!contactList) return 0;
    return contactList.tags.filter(tag => tag[0] === 'p').length;
  });
</script>
{#if isVisible}
  <div
    class="fixed z-50 pointer-events-none animate-in fade-in duration-200"
    style="left: {position.x}px; top: {position.y}px;"
  >
    <div class="relative pointer-events-auto">
      <!-- Main card -->
      <div class="relative w-80 bg-card border border-border rounded-xl shadow-2xl overflow-hidden">
        <!-- Banner section -->
        <div class="relative h-20" style={`background: ${profile?.banner ? 'transparent' : generateBannerGradient(pubkey)}`}>
          {#if profile?.banner}
            <img
              src={profile.banner}
              alt="Banner"
              class="w-full h-full object-cover opacity-80"
            />
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-neutral-900"></div>
          {/if}
        </div>
        <!-- Profile content -->
        <div class="relative px-5 pb-5 -mt-10">
          <!-- Avatar -->
          <div class="relative inline-block mb-3">
            <Avatar
              {ndk}
              {pubkey}
              class="w-20 h-20 rounded-full border-4 border-foreground shadow-xl"
            />
          </div>
          <!-- Name and username -->
          <div class="mb-3">
            <h3 class="text-base font-semibold text-foreground flex items-center gap-1.5 mb-0.5">
              <span class="truncate">
                {profile?.displayName || profile?.name || 'Anonymous'}
              </span>
              {#if profile?.nip05}
                <svg class="w-3.5 h-3.5 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              {/if}
            </h3>
            <p class="text-sm text-muted-foreground truncate">
              {#if profile?.nip05}
                {profile.nip05}
              {:else}
                {pubkey.slice(0, 16)}...
              {/if}
            </p>
          </div>
          <!-- Bio -->
          {#if profile?.about}
            <div class="mb-4">
              <div class="text-sm text-muted-foreground line-clamp-3 leading-relaxed">
                <EventContent
                  content={profile.about}
                  class="text-muted-foreground"
                />
              </div>
            </div>
          {/if}
          <!-- Stats -->
          <div class="flex items-center gap-4 mb-4 text-sm border-t border-border pt-3">
            <div class="flex items-center gap-1.5">
              <span class="font-medium text-foreground">{noteCount}</span>
              <span class="text-muted-foreground">notes</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="font-medium text-foreground">{followingCount}</span>
              <span class="text-muted-foreground">following</span>
            </div>
          </div>
          <!-- Follow button -->
          {#if !isOwnProfile}
            <FollowButton {pubkey} />
          {/if}
        </div>
      </div>
    </div>
  </div>
{/if}
<style>
  @keyframes animate-in {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  .animate-in {
    animation: animate-in 0.2s ease-out;
  }
  .fade-in {
    animation: fade-in 0.2s ease-out;
  }
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
</file>

<file path="UserMenu.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import { goto } from '$app/navigation';
  import { t } from 'svelte-i18n';
  import { settings } from '$lib/stores/settings.svelte';
  import type { NDKUserProfile } from '@nostr-dev-kit/ndk';
  interface Props {
    collapsed?: boolean;
  }
  const { collapsed = false }: Props = $props();
  let showDropdown = $state(false);
  let dropdownRef: HTMLDivElement | undefined = $state();
  let buttonRef: HTMLButtonElement | undefined = $state();
  let profile = $state<NDKUserProfile | null>(null);
  $effect(() => {
    const pubkey = ndk.$currentUser?.pubkey;
    if (!pubkey) {
      profile = null;
      return;
    }
    ndk.fetchUser(pubkey).then(u => {
      u?.fetchProfile().then(p => { profile = p; });
    });
  });
  const displayName = $derived(profile?.displayName || profile?.name || 'Anonymous');
  const npub = $derived(ndk.$currentUser?.npub);
  function toggleDropdown() {
    showDropdown = !showDropdown;
  }
  function closeDropdown() {
    showDropdown = false;
  }
  function handleLogout() {
    ndk.$sessions.logout();
    closeDropdown();
  }
  function navigateToProfile() {
    if (npub) {
      goto(`/p/${npub}`);
      closeDropdown();
    }
  }
  function navigateToSettings() {
    goto('/settings');
    closeDropdown();
  }
  function toggleTheme() {
    const currentTheme = settings.theme;
    if (currentTheme === 'light') {
      settings.setTheme('dark');
    } else if (currentTheme === 'dark') {
      settings.setTheme('system');
    } else {
      settings.setTheme('light');
    }
  }
  $effect(() => {
    if (!showDropdown) return;
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef && !dropdownRef.contains(event.target as Node) &&
          buttonRef && !buttonRef.contains(event.target as Node)) {
        showDropdown = false;
      }
    };
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  });
</script>
{#if ndk.$currentUser}
  <!-- Trigger Button -->
  <button
    bind:this={buttonRef}
    onclick={toggleDropdown}
    class="w-full flex items-center {collapsed ? 'justify-center p-3' : 'gap-3 px-2 py-2'} rounded-lg hover:bg-muted transition-colors cursor-pointer"
    title={collapsed ? displayName : undefined}
  >
    <Avatar {ndk} pubkey={ndk.$currentUser.pubkey} class="w-10 h-10" />
    {#if !collapsed}
      <div class="flex-1 min-w-0 text-left">
        <p class="font-medium text-sm truncate text-foreground">
          {displayName}
        </p>
        <p class="text-xs text-muted-foreground truncate">
          {profile?.nip05 || (npub ? `${npub.slice(0, 16)}...` : '')}
        </p>
      </div>
    {/if}
  </button>
{/if}
{#if showDropdown && buttonRef}
  {#key showDropdown}
    <svelte:element this={'div'} style="display: contents">
      <div
        bind:this={dropdownRef}
        class="w-56 bg-popover border border-border rounded-lg shadow-xl overflow-hidden"
        style="position: fixed; bottom: {window.innerHeight - buttonRef.getBoundingClientRect().top + 8}px; left: {buttonRef.getBoundingClientRect().left}px; z-index: 9999;"
      >
        <!-- Profile Link -->
        <button
          onclick={navigateToProfile}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left"
        >
          <Avatar {ndk} pubkey={ndk.$currentUser.pubkey} class="w-12 h-12" />
          <div class="flex-1 min-w-0">
            <p class="font-medium text-sm truncate text-popover-foreground">
              {displayName}
            </p>
            <p class="text-xs text-muted-foreground">{$t('profile.editProfile')}</p>
          </div>
        </button>
        <div class="h-px bg-border"></div>
        <!-- Theme Toggle -->
        <button
          onclick={toggleTheme}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left text-popover-foreground"
        >
          {#if settings.theme === 'light'}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <span>{$t('settings.sections.appearance.themes.light')}</span>
          {:else if settings.theme === 'dark'}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <span>{$t('settings.sections.appearance.themes.dark')}</span>
          {:else}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span>{$t('settings.sections.appearance.themes.system')}</span>
          {/if}
        </button>
        <!-- Settings Link -->
        <button
          onclick={navigateToSettings}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left text-popover-foreground"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span>{$t('navigation.settings')}</span>
        </button>
        <div class="h-px bg-border"></div>
        <!-- Logout Button -->
        <button
          onclick={handleLogout}
          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-muted transition-colors text-left text-destructive hover:text-destructive/90"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>{$t('navigation.logout')}</span>
        </button>
      </div>
    </svelte:element>
  {/key}
{/if}
</file>

<file path="UserSelectableItem.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { Avatar } from '@nostr-dev-kit/svelte';
  import type { NDKUser } from '@nostr-dev-kit/ndk';
  interface Props {
    user: NDKUser;
    onClick: (user: NDKUser) => void;
    showArrow?: boolean;
    size?: 'sm' | 'md' | 'lg';
    class?: string;
  }
  let { user, onClick, showArrow = false, size = 'md', class: className = '' }: Props = $props();
  const profile = $derived(user.profile);
  const avatarSize = $derived(size === 'sm' ? 32 : size === 'md' ? 40 : 48);
  const nameClass = $derived(size === 'sm' ? 'text-sm' : size === 'md' ? 'text-base' : 'text-lg');
  const subTextClass = $derived(size === 'sm' ? 'text-xs' : 'text-sm');
</script>
<button
  onclick={() => onClick(user)}
  class={`w-full flex items-center gap-3 px-4 py-4 hover:bg-muted transition-colors text-left ${className}`}
>
  <Avatar {ndk} pubkey={user.pubkey} size={avatarSize} class="flex-shrink-0" />
  <div class="flex-1 min-w-0">
    <div class={`font-semibold text-foreground truncate ${nameClass}`}>
      {profile?.displayName || profile?.name || 'Anonymous'}
    </div>
    {#if profile?.nip05}
      <div class={`text-muted-foreground truncate ${subTextClass}`}>
        {profile.nip05}
      </div>
    {:else if profile?.about}
      <div class={`text-muted-foreground truncate ${subTextClass}`}>
        {profile.about}
      </div>
    {/if}
  </div>
  {#if showArrow}
    <svg class="w-5 h-5 text-muted-foreground flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  {/if}
</button>
</file>

<file path="UserSelector.svelte">
<script lang="ts">
  import { ndk } from '$lib/ndk.svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { Button } from '$lib/components/ui/button';
  import { clickOutside } from '$lib/utils/clickOutside';
  import { portal } from '$lib/utils/portal.svelte';
  import UserSelectorDropdown from './UserSelector/UserSelectorDropdown.svelte';
  interface Props {
    selectedPubkeys?: string[];
    onSelect?: (pubkeys: string[]) => void;
    multiple?: boolean;
    buttonClass?: string;
    buttonLabel?: string;
    disabled?: boolean;
    iconOnly?: boolean;
    open?: boolean;
  }
  let {
    selectedPubkeys = $bindable([]),
    onSelect,
    multiple = true,
    buttonClass = '',
    buttonLabel,
    disabled = false,
    iconOnly = true,
    open = $bindable(false)
  }: Props = $props();
  let searchQuery = $state('');
  let buttonElement: HTMLButtonElement | null = null;
  let dropdownPosition = $state({ top: 0, left: 0, width: 0 });
  // Fetch current user's follows
  const contactListSubscription = ndk.$subscribe(
    () => ndk.$currentUser?.pubkey ? ({
      filters: [{ kinds: [3], authors: [ndk.$currentUser.pubkey], limit: 1 }],
      bufferMs: 100,
    }) : undefined
  );
  const userFollows = $derived.by(() => {
    const contactList = contactListSubscription.events[0];
    if (!contactList) return new Set<string>();
    return new Set(contactList.tags.filter(tag => tag[0] === 'p').map(tag => tag[1]));
  });
  let cachedFilteredProfiles = $state<Map<string, { name?: string; displayName?: string; nip05?: string }>>(new Map());
  const filteredFollows = $derived.by(() => {
    if (!searchQuery) return Array.from(userFollows).slice(0, 50);
    // Filter cached profiles that are also in follows
    const filtered = Array.from(cachedFilteredProfiles.entries())
      .filter(([pubkey]) => userFollows.has(pubkey))
      .map(([pubkey]) => pubkey);
    return filtered.slice(0, 50);
  });
  // Update cached profiles when search query changes
  $effect(() => {
    if (!searchQuery.trim() || !ndk.cacheAdapter?.getProfiles) {
      cachedFilteredProfiles = new Map();
      return;
    }
    const search = searchQuery.toLowerCase();
    // Use cache adapter to efficiently search across name, displayName, and nip05
    ndk.cacheAdapter.getProfiles({
      fields: ['name', 'displayName', 'nip05'],
      contains: search
    }).then((profiles) => {
      cachedFilteredProfiles = profiles ?? new Map();
    }).catch(err => {
      console.error('Failed to search profiles:', err);
      cachedFilteredProfiles = new Map();
    });
  });
  function handleClick() {
    if (!open && buttonElement) {
      const rect = buttonElement.getBoundingClientRect();
      dropdownPosition = {
        top: rect.bottom + 4,
        left: rect.left,
        width: Math.max(rect.width, 380)
      };
    }
    open = !open;
  }
  // When used as a modal (button hidden), center the dropdown
  const isModalMode = $derived(buttonClass.includes('hidden'));
  $effect(() => {
    if (open && isModalMode) {
      // Center the dropdown on screen
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const dropdownWidth = 380;
      const dropdownHeight = 400;
      dropdownPosition = {
        top: (viewportHeight - dropdownHeight) / 2,
        left: (viewportWidth - dropdownWidth) / 2,
        width: dropdownWidth
      };
    }
  });
  function toggleUser(pubkey: string) {
    if (multiple) {
      if (selectedPubkeys.includes(pubkey)) {
        selectedPubkeys = selectedPubkeys.filter(p => p !== pubkey);
      } else {
        selectedPubkeys = [...selectedPubkeys, pubkey];
      }
    } else {
      selectedPubkeys = [pubkey];
      open = false;
    }
    onSelect?.(selectedPubkeys);
  }
  function removeUser(pubkey: string) {
    selectedPubkeys = selectedPubkeys.filter(p => p !== pubkey);
    onSelect?.(selectedPubkeys);
  }
  async function addByIdentifier() {
    if (!searchQuery.trim()) return;
    try {
      const input = searchQuery.trim();
      const user = await ndk.fetchUser(input);
      if (user?.pubkey) {
        if (multiple) {
          if (!selectedPubkeys.includes(user.pubkey)) {
            selectedPubkeys = [...selectedPubkeys, user.pubkey];
            onSelect?.(selectedPubkeys);
            toast.success('User added');
          }
        } else {
          selectedPubkeys = [user.pubkey];
          onSelect?.(selectedPubkeys);
          open = false;
        }
        searchQuery = '';
      } else {
        toast.error('User not found');
      }
    } catch (error) {
      console.error('Failed to fetch user:', error);
      toast.error('Failed to fetch user');
    }
  }
  function handleClickOutside() {
    open = false;
  }
  // Check if input looks like an identifier (npub, hex, or NIP-05)
  const isIdentifierInput = $derived.by(() => {
    const query = searchQuery.trim();
    return query.length > 0 && (
      query.startsWith('npub1') ||
      query.startsWith('nprofile1') ||
      query.includes('@') ||
      (query.length === 64 && /^[0-9a-f]+$/i.test(query))
    );
  });
</script>
<div class="relative">
  <Button
    bind:ref={buttonElement}
    type="button"
    variant="ghost"
    size={iconOnly ? 'icon' : 'default'}
    class="{iconOnly ? 'h-8 w-8' : 'w-full justify-start'} {buttonClass}"
    {disabled}
    onclick={handleClick}
    title={buttonLabel || 'Tag people'}
  >
    {#if !iconOnly && buttonLabel}
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      <span>{buttonLabel}</span>
      {#if selectedPubkeys.length > 0}
        <span class="ml-auto text-xs bg-primary/20 text-primary rounded-full px-2 py-0.5">
          {selectedPubkeys.length}
        </span>
      {/if}
    {:else}
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      {#if selectedPubkeys.length > 0}
        <span class="absolute -top-1 -right-1 text-[10px] bg-primary text-primary-foreground rounded-full w-4 h-4 flex items-center justify-center">
          {selectedPubkeys.length}
        </span>
      {/if}
    {/if}
  </Button>
  {#if open}
    {#if isModalMode}
      <div
        use:portal
        role="presentation"
        onclick={handleClickOutside}
        onkeydown={(e) => e.key === 'Escape' && handleClickOutside()}
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center"
      >
        <div
          role="dialog"
          tabindex="-1"
          onclick={(e) => e.stopPropagation()}
          onkeydown={(e) => e.stopPropagation()}
          style="width: 380px;"
          class="bg-card border border-border rounded-lg shadow-xl overflow-hidden"
        >
          <UserSelectorDropdown
            bind:searchQuery
            {isIdentifierInput}
            {selectedPubkeys}
            {filteredFollows}
            {multiple}
            onSearchQueryChange={(value) => searchQuery = value}
            onAddByIdentifier={addByIdentifier}
            onRemoveUser={removeUser}
            onToggleUser={toggleUser}
          />
        </div>
      </div>
    {:else}
      <div
        use:portal
        use:clickOutside={handleClickOutside}
        style="position: fixed; top: {dropdownPosition.top}px; left: {dropdownPosition.left}px; width: 380px;"
        class="bg-card border border-border rounded-lg shadow-xl z-50 overflow-hidden"
      >
        <UserSelectorDropdown
          bind:searchQuery
          {isIdentifierInput}
          {selectedPubkeys}
          {filteredFollows}
          {multiple}
          onSearchQueryChange={(value) => searchQuery = value}
          onAddByIdentifier={addByIdentifier}
          onRemoveUser={removeUser}
          onToggleUser={toggleUser}
        />
      </div>
    {/if}
  {/if}
</div>
</file>

<file path="ZapAmountModal.svelte">
<script lang="ts">
  import { MediaQuery } from 'svelte/reactivity';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { settings } from '$lib/stores/settings.svelte';
  import * as Dialog from '$lib/components/ui/dialog';
  import * as Drawer from '$lib/components/ui/drawer';
  import { Button } from '$lib/components/ui/button';
  import { Input } from '$lib/components/ui/input';
  import { Label } from '$lib/components/ui/label';
  const isDesktop = new MediaQuery('(min-width: 768px)');
  interface Props {
    open?: boolean;
    event: NDKEvent;
    onZap: (amount: number) => void;
    onCancel: () => void;
  }
  let { open = $bindable(false), event, onZap, onCancel }: Props = $props();
  const amounts = [
    { value: 10, label: '10', emoji: '‚òï' },
    { value: 21, label: '21', emoji: '‚ö°' },
    { value: 50, label: '50', emoji: 'ü§ô' },
    { value: 100, label: '100', emoji: 'üíØ' },
    { value: 500, label: '500', emoji: 'üî•' },
    { value: 1000, label: '1K', emoji: 'üíé' },
    { value: 2100, label: '2.1K', emoji: 'üöÄ' },
    { value: 5000, label: '5K', emoji: 'üëë' }
  ];
  let selectedAmount = $state(settings.zap.defaultAmount);
  let customAmount = $state('');
  let isCustom = $state(false);
  function handleAmountSelect(amount: number) {
    selectedAmount = amount;
    isCustom = false;
    customAmount = '';
  }
  function handleCustomInput() {
    isCustom = true;
    const parsed = Number.parseInt(customAmount);
    if (!Number.isNaN(parsed) && parsed > 0) {
      selectedAmount = parsed;
    }
  }
  function handleZap() {
    if (selectedAmount > 0) {
      onZap(selectedAmount);
    }
  }
  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Enter' && selectedAmount > 0) {
      handleZap();
    }
  }
</script>
<svelte:window onkeydown={handleKeydown} />
{#if isDesktop.current}
  <Dialog.Root open={open} onOpenChange={(isOpen) => {
      if (!isOpen) {
        onCancel();
      } else {
        open = true;
      }
    }}>
      <Dialog.Content class="max-w-md bg-background border-2 border-primary/30 shadow-2xl shadow-primary/50">
        <!-- Header with glow effect -->
        <div class="relative -mx-6 -mt-6 px-6 py-6 mb-6 border-b border-border bg-primary/10">
          <div class="absolute inset-0 bg-primary/5 blur-xl"></div>
          <div class="relative flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center shadow-lg shadow-primary/50">
              <span class="text-2xl">‚ö°</span>
            </div>
            <div>
              <Dialog.Title class="text-xl text-foreground">Zap Amount</Dialog.Title>
              <Dialog.Description class="text-sm text-muted-foreground">Choose your zap amount</Dialog.Description>
            </div>
          </div>
        </div>
        <!-- Amount Grid -->
        <div class="space-y-6">
          <div class="grid grid-cols-4 gap-3">
            {#each amounts as amount}
              <Button
                variant="ghost"
                onclick={() => handleAmountSelect(amount.value)}
                class="group relative overflow-hidden rounded-2xl p-4 h-auto transition-all duration-200 {selectedAmount === amount.value && !isCustom
                  ? 'bg-primary shadow-lg shadow-primary/50 scale-105'
                  : 'bg-muted hover:bg-muted/80 hover:scale-105'}"
              >
                <div class="absolute inset-0 bg-primary/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex flex-col items-center gap-2">
                  <span class="text-2xl">{amount.emoji}</span>
                  <span class="text-xs font-bold {selectedAmount === amount.value && !isCustom ? 'text-primary-foreground' : 'text-foreground'}">{amount.label}</span>
                </div>
              </Button>
            {/each}
          </div>
          <!-- Custom Amount Input -->
          <div class="space-y-2">
            <Label for="custom-amount" class="text-sm font-semibold text-muted-foreground">
              Custom Amount
            </Label>
            <div class="relative">
              <Input
                id="custom-amount"
                type="number"
                bind:value={customAmount}
                oninput={handleCustomInput}
                placeholder="Enter custom amount..."
                class="w-full px-4 py-4 bg-muted border-2 {isCustom ? 'border-primary' : 'border-border'} rounded-2xl text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:border-primary transition-colors text-lg font-semibold pr-16"
              />
              <div class="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground font-semibold">
                sats
              </div>
            </div>
          </div>
          <!-- Selected Amount Display -->
          {#if selectedAmount > 0}
            <div class="p-4 rounded-2xl bg-primary/20 border-2 border-primary/30">
              <div class="flex items-center justify-between">
                <span class="text-sm text-foreground/70">Selected Amount:</span>
                <span class="text-2xl font-bold text-foreground">
                  {selectedAmount.toLocaleString()} sats
                </span>
              </div>
            </div>
          {/if}
          <!-- Action Buttons -->
          <Dialog.Footer class="flex gap-3 sm:space-x-0">
            <Button
              variant="outline"
              onclick={onCancel}
              class="flex-1 px-6 py-4 rounded-2xl"
            >
              Cancel
            </Button>
            <Button
              onclick={handleZap}
              disabled={selectedAmount <= 0}
              class="flex-1 px-6 py-4 rounded-2xl bg-primary hover:opacity-90 shadow-lg shadow-primary/50 hover:shadow-primary/70 disabled:opacity-50 disabled:shadow-none"
            >
              <span class="text-xl mr-2">‚ö°</span>
              Zap {selectedAmount > 0 ? selectedAmount.toLocaleString() : ''}
            </Button>
          </Dialog.Footer>
        </div>
      </Dialog.Content>
  </Dialog.Root>
{:else}
  <Drawer.Root open={open} onOpenChange={(isOpen) => {
      if (!isOpen) {
        onCancel();
      } else {
        open = true;
      }
    }}>
      <Drawer.Content>
        <!-- Header with glow effect -->
        <div class="relative px-6 py-6 mb-6 border-b border-border bg-primary/10">
          <div class="absolute inset-0 bg-primary/5 blur-xl"></div>
          <div class="relative flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center shadow-lg shadow-primary/50">
              <span class="text-2xl">‚ö°</span>
            </div>
            <div>
              <Drawer.Title class="text-xl text-foreground">Zap Amount</Drawer.Title>
              <Drawer.Description class="text-sm text-muted-foreground">Choose your zap amount</Drawer.Description>
            </div>
          </div>
        </div>
        <!-- Amount Grid -->
        <div class="space-y-6 px-4">
          <div class="grid grid-cols-4 gap-3">
            {#each amounts as amount}
              <Button
                variant="ghost"
                onclick={() => handleAmountSelect(amount.value)}
                class="group relative overflow-hidden rounded-2xl p-4 h-auto transition-all duration-200 {selectedAmount === amount.value && !isCustom
                  ? 'bg-primary shadow-lg shadow-primary/50 scale-105'
                  : 'bg-muted hover:bg-muted/80 hover:scale-105'}"
              >
                <div class="absolute inset-0 bg-primary/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex flex-col items-center gap-2">
                  <span class="text-2xl">{amount.emoji}</span>
                  <span class="text-xs font-bold {selectedAmount === amount.value && !isCustom ? 'text-primary-foreground' : 'text-foreground'}">{amount.label}</span>
                </div>
              </Button>
            {/each}
          </div>
          <!-- Custom Amount Input -->
          <div class="space-y-2">
            <Label for="custom-amount" class="text-sm font-semibold text-muted-foreground">
              Custom Amount
            </Label>
            <div class="relative">
              <Input
                id="custom-amount"
                type="number"
                bind:value={customAmount}
                oninput={handleCustomInput}
                placeholder="Enter custom amount..."
                class="w-full px-4 py-4 bg-muted border-2 {isCustom ? 'border-primary' : 'border-border'} rounded-2xl text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:border-primary transition-colors text-lg font-semibold pr-16"
              />
              <div class="absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground font-semibold">
                sats
              </div>
            </div>
          </div>
          <!-- Selected Amount Display -->
          {#if selectedAmount > 0}
            <div class="p-4 rounded-2xl bg-primary/20 border-2 border-primary/30">
              <div class="flex items-center justify-between">
                <span class="text-sm text-foreground/70">Selected Amount:</span>
                <span class="text-2xl font-bold text-foreground">
                  {selectedAmount.toLocaleString()} sats
                </span>
              </div>
            </div>
          {/if}
        </div>
        <!-- Action Buttons -->
        <Drawer.Footer class="pt-2">
          <div class="flex gap-3">
            <Button
              variant="outline"
              onclick={onCancel}
              class="flex-1 px-6 py-4 rounded-2xl"
            >
              Cancel
            </Button>
            <Button
              onclick={handleZap}
              disabled={selectedAmount <= 0}
              class="flex-1 px-6 py-4 rounded-2xl bg-primary hover:opacity-90 shadow-lg shadow-primary/50 hover:shadow-primary/70 disabled:opacity-50 disabled:shadow-none"
            >
              <span class="text-xl mr-2">‚ö°</span>
              Zap {selectedAmount > 0 ? selectedAmount.toLocaleString() : ''}
            </Button>
          </div>
        </Drawer.Footer>
      </Drawer.Content>
  </Drawer.Root>
{/if}
</file>

<file path="ZapButton.svelte">
<script lang="ts">
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import { ndk } from '$lib/ndk.svelte';
  import { zap, getZapSender, hasZappedBy } from '@nostr-dev-kit/svelte';
  import { toast } from '$lib/stores/toast.svelte';
  import { settings } from '$lib/stores/settings.svelte';
  import ZapAmountModal from './ZapAmountModal.svelte';
  interface Props {
    event: NDKEvent;
    variant?: 'default' | 'tiktok';
  }
  const { event, variant = 'default' }: Props = $props();
  // Subscribe to zaps for this event
  const zaps = ndk.$zaps(() => ({ target: event, validated: true }));
  // Check if current user has zapped
  const userHasZapped = $derived.by(() => {
    const currentPubkey = ndk.$currentPubkey;
    if (!currentPubkey) return false;
    return hasZappedBy(zaps.events, currentPubkey);
  });
  // Format large numbers
  const formattedAmount = $derived.by(() => {
    const amount = zaps.totalAmount;
    if (amount >= 1000000) {
      return `${(amount / 1000000).toFixed(1)}M`;
    } else if (amount >= 1000) {
      return `${(amount / 1000).toFixed(1)}K`;
    }
    return amount.toString();
  });
  let showZapModal = $state(false);
  let isZapping = $state(false);
  let zapSuccess = $state(false);
  let longPressTimer: ReturnType<typeof setTimeout> | null = null;
  async function performZap(amount: number) {
    if (!ndk.signer) {
      toast.error('Please login to zap');
      return;
    }
    isZapping = true;
    try {
      await zap(ndk, event, amount * 1000);
      zapSuccess = true;
      setTimeout(() => zapSuccess = false, 2000);
      toast.success(`Zapped ${amount} sats!`);
    } catch (err) {
      console.error('Failed to zap:', err);
      const errorMessage = err instanceof Error ? err.message : 'Failed to send zap';
      if (errorMessage.includes('wallet') || errorMessage.includes('NWC')) {
        toast.error('Lightning wallet error. Please check your wallet connection in settings.');
      } else if (errorMessage.includes('invoice')) {
        toast.error('Failed to create invoice. The recipient may not have a Lightning address configured.');
      } else {
        toast.error('Failed to send zap. Please try again.');
      }
    } finally {
      isZapping = false;
    }
  }
  async function handleQuickZap(e: MouseEvent) {
    e.stopPropagation();
    if (isZapping || !ndk.signer) return;
    await performZap(settings.zap.defaultAmount);
  }
  function handleZapModalZap(amount: number) {
    showZapModal = false;
    performZap(amount);
  }
  function handleZapLongPressStart(e: MouseEvent | TouchEvent) {
    e.preventDefault();
    e.stopPropagation();
    longPressTimer = setTimeout(() => {
      showZapModal = true;
      longPressTimer = null;
    }, 500);
  }
  function handleZapLongPressEnd(e: MouseEvent | TouchEvent) {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
      if (e.type === 'mouseup' || e.type === 'touchend') {
        handleQuickZap(e as MouseEvent);
      }
    }
  }
  function handleZapLongPressCancel() {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
  }
</script>
{#if variant === 'tiktok'}
  <!-- TikTok vertical variant -->
  <button
    type="button"
    onmousedown={handleZapLongPressStart}
    onmouseup={handleZapLongPressEnd}
    onmouseleave={handleZapLongPressCancel}
    ontouchstart={handleZapLongPressStart}
    ontouchend={handleZapLongPressEnd}
    ontouchcancel={handleZapLongPressCancel}
    disabled={isZapping}
    class="flex flex-col items-center gap-1 hover:scale-110 transition-transform group {isZapping ? 'opacity-50 cursor-wait' : ''}"
  >
    <div class="w-12 h-12 rounded-full backdrop-blur-sm flex items-center justify-center transition-colors {
      zapSuccess ? 'bg-yellow-400/30' :
      userHasZapped ? 'bg-yellow-400/20' :
      'bg-white/20'
    }">
      {#if isZapping}
        <svg class="w-6 h-6 animate-spin text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      {:else}
        <svg
          class="w-6 h-6 transition-colors {userHasZapped ? 'text-yellow-400' : 'text-white'}"
          fill={userHasZapped ? 'currentColor' : 'none'}
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          {#if userHasZapped}
            <path d="M13 10V3L4 14h7v7l9-11h-7z" />
          {:else}
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          {/if}
        </svg>
      {/if}
    </div>
    <span class="text-xs font-semibold text-white">
      {#if zaps.totalAmount > 0}
        {formattedAmount}
      {:else}
        Zap
      {/if}
    </span>
  </button>
{:else}
  <!-- Default horizontal variant -->
  <button
    type="button"
    onmousedown={handleZapLongPressStart}
    onmouseup={handleZapLongPressEnd}
    onmouseleave={handleZapLongPressCancel}
    ontouchstart={handleZapLongPressStart}
    ontouchend={handleZapLongPressEnd}
    ontouchcancel={handleZapLongPressCancel}
    disabled={isZapping}
    class="relative flex items-center gap-2 transition-colors group {
      zapSuccess ? 'text-yellow-400' :
      userHasZapped ? 'text-yellow-400' :
      'text-muted-foreground hover:text-yellow-400'
    } {isZapping ? 'opacity-50 cursor-wait' : ''}"
  >
    {#if isZapping}
      <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    {:else if zapSuccess}
      <svg class="w-5 h-5 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
        <path d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
    {:else}
      <svg
        class="w-5 h-5"
        fill={userHasZapped ? 'currentColor' : 'none'}
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        {#if userHasZapped}
          <path d="M13 10V3L4 14h7v7l9-11h-7z" />
        {:else}
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        {/if}
      </svg>
    {/if}
    <span class="text-sm group-hover:underline">
      {#if zapSuccess}
        Zapped!
      {:else if isZapping}
        Zapping...
      {:else if zaps.totalAmount > 0}
        {formattedAmount}
        {#if zaps.count > 0}
          <span class="text-xs opacity-70">({zaps.count})</span>
        {/if}
      {:else}
        Zap
      {/if}
    </span>
  </button>
{/if}
<ZapAmountModal
  bind:open={showZapModal}
  {event}
  onZap={handleZapModalZap}
  onCancel={() => showZapModal = false}
/>
</file>

</files>
