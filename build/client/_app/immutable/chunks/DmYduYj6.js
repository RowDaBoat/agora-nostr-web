import{s as p,b as v,g as S,a as f}from"./-h67YDCL.js";import{j as m,s as r,d as y,n as l,e as b,W as I}from"./CAJmB2zv.js";import{a as g}from"./CIoNh8li.js";import{n as h}from"./CKCu7fRq.js";const c={invite:null,currentStep:1,selectedCommunity:null,selectedPacks:[],profileData:{name:"",bio:"",location:"",banner:void 0,picture:void 0,nip05:""},introductionText:void 0,hasPublishedInviteConfirmation:!1,hasCompletedInviteSetup:!1};function w(){if(typeof window>"u")return console.log("[Store] Server-side, returning DEFAULT_STATE"),c;try{const n=sessionStorage.getItem("voces-onboarding");if(n){const t=JSON.parse(n);return console.log("[Store] Loaded state from sessionStorage:",t),t.invite?{...c,...t}:(console.log("[Store] No active invite, ignoring stored state and starting fresh"),c)}else console.log("[Store] No stored state found, using DEFAULT_STATE")}catch(n){console.error("[Store] Failed to load onboarding state:",n)}return c}function o(n){if(!(typeof window>"u"))try{sessionStorage.setItem("voces-onboarding",JSON.stringify(n))}catch(t){console.error("Failed to save onboarding state:",t)}}class C{#e=p(v(w()));get state(){return S(this.#e)}set state(t){f(this.#e,t,!0)}get invite(){return this.state.invite}get currentStep(){return this.state.currentStep}get selectedCommunity(){return this.state.selectedCommunity}get selectedPacks(){return this.state.selectedPacks}get profileData(){return this.state.profileData}get introductionText(){return this.state.introductionText}get hasInvite(){return!!this.state.invite}get hasCompletedInviteSetup(){return this.state.hasCompletedInviteSetup}get totalSteps(){return this.hasInvite?4:6}get minStep(){return this.hasInvite?3:1}setInvite(t){if(console.log("[Store] setInvite called with:",t),this.state.invite=t,t.recipientName&&!this.state.profileData.name&&(console.log("[Store] Pre-filling profile name:",t.recipientName),this.state.profileData.name=t.recipientName),t.inviteRelay){const e=m(t.inviteRelay);e&&(console.log(`[Store] Setting language to ${e} based on agora relay ${t.inviteRelay}`),r.setLanguage(e),g.set(e))}console.log("[Store] Setting step to 3 (features)"),this.state.currentStep=3,o(this.state),console.log("[Store] ✓ Invite data saved to sessionStorage")}setStep(t){this.state.currentStep=t,o(this.state)}setSelectedCommunity(t){if(this.state.selectedCommunity=t,t){const i={venezuela:"es",nicaragua:"es",cambodia:"km",zimbabwe:"sn",afghanistan:"fa",iran:"fa"}[t];i&&(console.log(`[Store] Setting language to ${i} based on community ${t}`),r.setLanguage(i),g.set(i))}o(this.state)}setSelectedPacks(t){this.state.selectedPacks=t,o(this.state)}setProfileData(t){this.state.profileData={...this.state.profileData,...t},o(this.state)}setIntroductionText(t){this.state.introductionText=t,o(this.state)}async publishInviteConfirmation(t){if(console.log("[Store] publishInviteConfirmation called:",{hasPublished:this.state.hasPublishedInviteConfirmation,inviteData:this.state.invite}),this.state.hasPublishedInviteConfirmation){console.log("[Store] ⊘ Invite confirmation already published");return}const e=this.state.invite;if(console.log("[Store] Checking invite data:",{hasInvite:!!e,inviteEventId:e?.inviteEventId,inviter:e?.inviter,inviteRelay:e?.inviteRelay,inviteCode:e?.inviteCode}),!e?.inviteEventId||!e?.inviter||!e?.inviteRelay||!e?.inviteCode){console.warn("[Store] ✗ Missing required invite data for confirmation");return}try{console.log("[Store] Creating kind:514 event...");const i=new y(l);i.kind=514,i.content="",i.tags=[["e",e.inviteEventId],["p",e.inviter],["code",e.inviteCode]],i.isProtected=!0,console.log("[Store] Signing event..."),await i.sign(),console.log("[Store] ✓ Event signed"),console.log("[Store] Getting relay:",e.inviteRelay);const s=l.pool.getRelay(e.inviteRelay,!0);if(s){console.log("[Store] ✓ Relay obtained:",s.url);const a=new b(new Set([s]),l);console.log("[Store] Publishing kind:514 invite confirmation to",e.inviteRelay),await i.publish(a),console.log("[Store] ✓ Successfully published kind:514 invite confirmation"),console.log("[Store] Setting selected relay in settings..."),r.setSelectedRelay(e.inviteRelay),r.relays.find(d=>d.url===e.inviteRelay)?console.log("[Store] Relay already in settings"):(console.log("[Store] Adding relay to settings..."),r.addRelay({url:e.inviteRelay,read:!0,write:!0,enabled:!0})),this.state.hasPublishedInviteConfirmation=!0,o(this.state),console.log("[Store] ✓ Marked as published in state")}else console.error("[Store] ✗ Failed to get relay:",e.inviteRelay)}catch(i){throw console.error("[Store] ✗ Error publishing invite confirmation:",i),i}}async publishProfileAndSetup(t){console.log("[Store] publishProfileAndSetup called for non-invited user");const e=this.state.profileData;if(!e.name){console.warn("[Store] ✗ No profile name, skipping");return}if(!l.$sessions){console.error("[Store] ✗ No sessions manager available");return}try{const i=await t.user();h.setEnabled(!0);const s=h.getLightningAddress(),a=new Set;a.add("wss://purplepag.es"),a.add("wss://relay.primal.net"),console.log("[Store] Creating account with createAccount() using existing signer...");const{events:u}=await l.$sessions.createAccount({profile:{name:e.name,about:e.bio,...e.location&&{location:e.location},...e.picture&&{picture:e.picture},...e.nip05&&{nip05:e.nip05},...s&&{lud16:s}},relays:Array.from(a),wallet:{mints:["https://mint.minibits.cash/Bitcoin"],relays:[...I]}},{publish:!1,signer:t});console.log("[Store] ✓ Created signed events:",u.length),console.log("[Store] Publishing events to default relays...");for(const d of u)await d.publish(),console.log(`[Store] ✓ Published kind:${d.kind} to default relays`);console.log("[Store] ✓ Profile and setup complete")}catch(i){throw console.error("[Store] ✗ Error publishing profile and setup:",i),i}}async completeInviteSetup(t){if(console.log("[Store] completeInviteSetup called:",{hasCompletedSetup:this.state.hasCompletedInviteSetup,hasInvite:this.hasInvite}),this.state.hasCompletedInviteSetup){console.log("[Store] ⊘ Invite setup already completed, skipping");return}if(!this.hasInvite){console.log("[Store] ⊘ No invite data, skipping invite setup");return}try{console.log("[Store] Publishing kind:514 invite confirmation..."),await this.publishInviteConfirmation(t),this.state.hasCompletedInviteSetup=!0,o(this.state),console.log("[Store] ✓ Invite acceptance complete (kind:514 published)")}catch(e){await this.publishInviteConfirmation(t),console.error("[Store] ✗ Error during invite acceptance:",e)}}clear(){this.state={...c},typeof window<"u"&&sessionStorage.removeItem("voces-onboarding")}}const T=new C;export{T as o};
