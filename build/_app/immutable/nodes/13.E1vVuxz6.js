import{d as ne,f as h,i as me,a as i,c as ee,s as I,t as ge,j as de}from"../chunks/CiPFrJr-.js";import{p as ie,a as ce,f as K,e as o,r as s,g as e,b as S,s as n,d as k,c as le,u as te,t as L,z as he,x as xe}from"../chunks/CSbKtK4P.js";import{i as C,s as _e,a as be}from"../chunks/87vUJtvC.js";import{p as ye}from"../chunks/fk9xBW3Y.js";import{g as ue}from"../chunks/CTwadDAE.js";import{e as ke,d as oe,n as A,S as we,m as De,f as Se}from"../chunks/D0X4VYcq.js";import{m as se}from"../chunks/CBcsBXzE.js";import{b as fe}from"../chunks/I2MJeYPS.js";import{b as Ce}from"../chunks/DphWBL27.js";import{t as Me}from"../chunks/B0fEDaa-.js";var ze=h('<div class="flex items-center justify-center h-full"><div class="text-center text-neutral-500"><p>No messages yet</p> <p class="text-sm mt-1">Start the conversation!</p></div></div>'),je=h('<div class="flex items-center justify-center my-6"><div class="px-3 py-1 bg-neutral-900 rounded-full text-xs text-neutral-400 font-medium"> </div></div>'),Be=h('<!> <div><div><div><div class="whitespace-pre-wrap break-words line-clamp-[20] hover:line-clamp-none transition-all"><!></div></div> <div class="text-xs text-neutral-500 px-2"> </div></div></div>',1),Te=(w,a,l)=>{n(a,!0),l()},Ue=h('<button class="fixed bottom-24 right-8 p-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-full shadow-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg></button>'),He=h('<div class="flex-1 overflow-y-auto px-4 py-6 space-y-4"><!></div> <!>',1);function Ae(w,a){ie(a,!0);let l=S(null),x=S(!0);function M(t=!0){e(l)&&e(x)&&e(l).scrollTo({top:e(l).scrollHeight,behavior:t?"smooth":"instant"})}function F(){if(!e(l))return;const{scrollTop:t,scrollHeight:r,clientHeight:b}=e(l),p=r-t-b<100;n(x,p)}ce(()=>{a.messages.length>0&&M(a.messages.length>1)});function u(t){return new Date(t*1e3).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}function N(t,r){if(!r)return!0;const b=new Date(t.timestamp*1e3).toDateString(),p=new Date(r.timestamp*1e3).toDateString();return b!==p}function f(t){const r=new Date(t*1e3),b=new Date,p=new Date(b);return p.setDate(p.getDate()-1),r.toDateString()===b.toDateString()?"Today":r.toDateString()===p.toDateString()?"Yesterday":r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:r.getFullYear()!==b.getFullYear()?"numeric":void 0})}var c=He(),_=K(c),T=o(_);{var U=t=>{var r=ze();i(t,r)},z=t=>{var r=ee(),b=K(r);ke(b,19,()=>a.messages,p=>p.id,(p,D,W)=>{const re=te(()=>e(W)>0?a.messages[e(W)-1]:null);var X=Be(),Z=K(X);{var ae=d=>{var g=je(),y=o(g),B=o(y,!0);s(y),s(g),L(q=>I(B,q),[()=>f(e(D).timestamp)]),i(d,g)};C(Z,d=>{N(e(D),e(re))&&d(ae)})}var G=k(Z,2),v=o(G),m=o(v),P=o(m),Y=o(P);{var E=d=>{{let g=te(()=>new De(A,e(D).rumor));we(d,{get ndk(){return A},get event(){return e(g)}})}},j=d=>{var g=ge();L(()=>I(g,e(D).content)),i(d,g)};C(Y,d=>{e(D).rumor?d(E):d(j,!1)})}s(P),s(m);var H=k(m,2),J=o(H,!0);s(H),s(v),s(G),L(d=>{oe(G,1,`flex ${e(D).sender.pubkey===A.activeUser?.pubkey?"justify-end":"justify-start"}`),oe(v,1,`max-w-[70%] ${e(D).sender.pubkey===A.activeUser?.pubkey?"items-end":"items-start"} flex flex-col gap-1`),oe(m,1,`px-4 py-2 rounded-2xl ${e(D).sender.pubkey===A.activeUser?.pubkey?"bg-primary text-primary-foreground rounded-tr-sm":"bg-neutral-900 text-white rounded-tl-sm"}`),I(J,d)},[()=>u(e(D).timestamp)]),i(p,X)}),i(t,r)};C(T,t=>{a.messages.length===0?t(U):t(z,!1)})}s(_),fe(_,t=>n(l,t),()=>e(l));var V=k(_,2);{var R=t=>{var r=Ue();r.__click=[Te,x,M],i(t,r)};C(V,t=>{!e(x)&&a.messages.length>0&&t(R)})}me("scroll",_,F),i(w,c),le()}ne(["click"]);function Fe(w,a){w.key==="Enter"&&!w.shiftKey&&(w.preventDefault(),a())}function Ne(w,a){e(a)&&(e(a).style.height="auto",e(a).style.height=`${Math.min(e(a).scrollHeight,200)}px`)}var Ve=de('<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>'),Ke=de('<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>'),Pe=h('<div class="sticky bottom-0 border-t border-neutral-800/50 bg-black p-4"><div class="flex items-end gap-3"><div class="flex-1 relative"><textarea placeholder="Type a message..." rows="1" class="w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none min-h-[48px] max-h-[200px]"></textarea> <div class="absolute right-3 bottom-3 text-xs text-neutral-600"> </div></div> <button class="px-6 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 h-[48px]"><!></button></div></div>');function Ye(w,a){ie(a,!0);let l=S(""),x=S(!1),M=S(null);async function F(){if(!(!e(l).trim()||e(x))){n(x,!0);try{await se.sendMessage(a.recipient.npub,e(l).trim()),n(l,""),a.onMessageSent?.(),e(M)&&(e(M).style.height="auto")}catch(t){console.error("Failed to send message:",t),Me.error("Failed to send message")}finally{n(x,!1)}}}var u=Pe(),N=o(u),f=o(N),c=o(f);he(c),c.__keydown=[Fe,F],c.__input=[Ne,M],fe(c,t=>n(M,t),()=>e(M));var _=k(c,2),T=o(_,!0);s(_),s(f);var U=k(f,2);U.__click=F;var z=o(U);{var V=t=>{var r=Ve();i(t,r)},R=t=>{var r=Ke();i(t,r)};C(z,t=>{e(x)?t(V):t(R,!1)})}s(U),s(N),s(u),L(t=>{c.disabled=e(x),I(T,e(l).length),U.disabled=t},[()=>!e(l).trim()||e(x)]),Ce(c,()=>e(l),t=>n(l,t)),i(w,u),le()}ne(["keydown","input","click"]);function Ee(){ue("/messages")}var Ie=h('<p class="text-xs text-neutral-500 truncate"> </p>'),Le=(w,a)=>ue(`/p/${e(a).npub}`),Re=h('<!> <div class="flex-1 min-w-0"><h1 class="text-lg font-bold text-white truncate"> </h1> <!></div> <button class="p-2 rounded-lg hover:bg-neutral-800/50 transition-colors text-neutral-400 hover:text-primary" title="View profile"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>',1),qe=h('<div class="flex-1"><div class="h-5 w-32 bg-neutral-800 rounded animate-pulse"></div></div>'),Ge=h('<div class="flex-1 flex items-center justify-center px-6 text-center"><div><svg class="w-20 h-20 text-neutral-700 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> <h3 class="text-xl font-semibold text-white mb-2">Sign in required</h3> <p class="text-neutral-400 max-w-sm">Please sign in to view and send direct messages</p></div></div>'),Je=h('<div class="flex-1 flex items-center justify-center"><svg class="w-8 h-8 text-primary animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>'),Oe=h('<div class="flex-1 flex items-center justify-center px-6 text-center"><div><svg class="w-20 h-20 text-red-500 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <h3 class="text-xl font-semibold text-white mb-2">Error</h3> <p class="text-neutral-400"> </p> <button class="mt-4 px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg transition-colors">Retry</button></div></div>'),Qe=h("<!> <!>",1),We=h('<div class="h-screen fixed top-0 left-0 right-0 bottom-0 z-[10000] md:h-full md:relative md:z-auto flex flex-col"><div class="sticky top-0 z-10 bg-black border-b border-neutral-800/50 px-4 py-3"><div class="flex items-center gap-3"><button class="p-2 rounded-lg hover:bg-neutral-800/50 transition-colors text-neutral-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button> <!></div></div> <!></div>');function it(w,a){ie(a,!0);const l=()=>be(ye,"$page",x),[x,M]=_e(),F=A.$currentUser;let u=S(null),N=S(null),f=S(null),c=S(xe([])),_=S(!0),T=S(null),U=S("");const z=te(()=>l().params.npub),V=te(()=>e(N)?A.$fetchProfile(()=>e(N)):null);async function R(){if(!e(z)||!F){n(T,"Invalid conversation"),n(_,!1);return}if(!(e(z)===e(U)&&e(u)))try{n(_,!0),n(T,null),n(U,e(z),!0),n(u,A.getUser({npub:e(z)}),!0),n(N,e(u).pubkey,!0),n(f,await se.getConversation(e(z)),!0),e(f)&&(n(c,await e(f).getMessages(100),!0),await se.markConversationAsRead(e(f).id),e(f).on("message",async()=>{n(c,await e(f).getMessages(100),!0)}))}catch(v){console.error("Failed to load conversation:",v),n(T,"Failed to load conversation")}finally{n(_,!1)}}async function t(){e(f)&&n(c,await e(f).getMessages(100),!0)}ce(()=>{e(z)&&F&&R()});var r=We(),b=o(r),p=o(b),D=o(p);D.__click=[Ee];var W=k(D,2);{var re=v=>{var m=Re(),P=K(m);Se(P,{get ndk(){return A},get pubkey(){return e(u).pubkey},class:"w-10 h-10"});var Y=k(P,2),E=o(Y),j=o(E,!0);s(E);var H=k(E,2);{var J=g=>{var y=Ie(),B=o(y,!0);s(y),L(()=>I(B,e(V).nip05)),i(g,y)};C(H,g=>{e(V)?.nip05&&g(J)})}s(Y);var d=k(Y,2);d.__click=[Le,u],L(()=>I(j,e(V)?.name||e(V)?.displayName||"Anonymous")),i(v,m)},X=v=>{var m=qe();i(v,m)};C(W,v=>{e(u)?v(re):v(X,!1)})}s(p),s(b);var Z=k(b,2);{var ae=v=>{var m=Ge();i(v,m)},G=v=>{var m=ee(),P=K(m);{var Y=j=>{var H=Je();i(j,H)},E=j=>{var H=ee(),J=K(H);{var d=y=>{var B=Oe(),q=o(B),O=k(o(q),4),Q=o(O,!0);s(O);var $=k(O,2);$.__click=R,s(q),s(B),L(()=>I(Q,e(T))),i(y,B)},g=y=>{var B=ee(),q=K(B);{var O=Q=>{var $=Qe(),ve=K($);Ae(ve,{get messages(){return e(c)}});var pe=k(ve,2);Ye(pe,{get recipient(){return e(u)},onMessageSent:t}),i(Q,$)};C(q,Q=>{e(u)&&Q(O)},!0)}i(y,B)};C(J,y=>{e(T)?y(d):y(g,!1)},!0)}i(j,H)};C(P,j=>{e(_)?j(Y):j(E,!1)},!0)}i(v,m)};C(Z,v=>{F?v(G,!1):v(ae)})}s(r),i(w,r),le(),M()}ne(["click"]);export{it as component};
